<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Code walkthrough – &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Exeter Oncology Model: Renal Cell Carcinoma edition</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../images/exeter_pentag_small.png" alt="Exeter PenTAG" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Exeter Oncology Model: Renal Cell Carcinoma edition</span>
    </a>
  </div>
          <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/pythonhealthdatascience/stars-eom-rcc/"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          <div class="quarto-navbar-tools">
</div>
            <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Code walkthrough</li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/acronyms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Acryonyms</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Context</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/appraisals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">NICE appraisals</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/publication.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">List of articles and reports</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Model overview</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/model_overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Detailed summary</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/plain_english.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Plain english summary</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/installation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Installation</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Code walkthrough</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/walkthrough_preface.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/input_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Input data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/walkthrough/code1_setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Set-up</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/walkthrough/code2_extrapolate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Extrapolate real-world evidence</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/report.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Report</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">Annotated reporting guidelines</span></span>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">Model validation</span></span>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/license.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">License</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/citation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Citation</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">Contributing</span></span>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/changelog.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Changelog</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#load-required-packages" id="toc-load-required-packages" class="nav-link active" data-scroll-target="#load-required-packages">Load required packages</a></li>
  <li><a href="#set-file-paths" id="toc-set-file-paths" class="nav-link" data-scroll-target="#set-file-paths">Set file paths</a></li>
  <li><a href="#define-some-of-the-model-settings" id="toc-define-some-of-the-model-settings" class="nav-link" data-scroll-target="#define-some-of-the-model-settings">Define some of the model settings</a></li>
  <li><a href="#import-model-functions" id="toc-import-model-functions" class="nav-link" data-scroll-target="#import-model-functions">Import model functions</a></li>
  <li><a href="#get-some-of-the-model-inputs" id="toc-get-some-of-the-model-inputs" class="nav-link" data-scroll-target="#get-some-of-the-model-inputs">Get some of the model inputs</a>
  <ul class="collapse">
  <li><a href="#introductory-comments" id="toc-introductory-comments" class="nav-link" data-scroll-target="#introductory-comments">Introductory comments</a></li>
  <li><a href="#get-inputs-from-excel-workbook-and-save-as-list-i" id="toc-get-inputs-from-excel-workbook-and-save-as-list-i" class="nav-link" data-scroll-target="#get-inputs-from-excel-workbook-and-save-as-list-i">Get inputs from excel workbook and save as list <code>i</code></a></li>
  <li><a href="#manually-add-some-extra-inputs-to-i" id="toc-manually-add-some-extra-inputs-to-i" class="nav-link" data-scroll-target="#manually-add-some-extra-inputs-to-i">Manually add some extra inputs to <code>i</code></a></li>
  <li><a href="#use-i-to-make-another-list-p" id="toc-use-i-to-make-another-list-p" class="nav-link" data-scroll-target="#use-i-to-make-another-list-p">Use <code>i</code> to make another list <code>p</code></a></li>
  </ul></li>
  <li><a href="#treatment-sequences" id="toc-treatment-sequences" class="nav-link" data-scroll-target="#treatment-sequences">Treatment sequences</a>
  <ul class="collapse">
  <li><a href="#find-all-possible-sequences" id="toc-find-all-possible-sequences" class="nav-link" data-scroll-target="#find-all-possible-sequences">Find all possible sequences</a></li>
  <li><a href="#filter-to-valid-sequences" id="toc-filter-to-valid-sequences" class="nav-link" data-scroll-target="#filter-to-valid-sequences">Filter to valid sequences</a></li>
  </ul></li>
  <li><a href="#import-patient-level-data" id="toc-import-patient-level-data" class="nav-link" data-scroll-target="#import-patient-level-data">Import patient-level data</a></li>
  <li><a href="#create-look-ups-to-convert-between-numeric-categories-and-labels" id="toc-create-look-ups-to-convert-between-numeric-categories-and-labels" class="nav-link" data-scroll-target="#create-look-ups-to-convert-between-numeric-categories-and-labels">Create look-ups to convert between numeric categories and labels</a></li>
  <li><a href="#further-pre-processing-before-survival-analysis" id="toc-further-pre-processing-before-survival-analysis" class="nav-link" data-scroll-target="#further-pre-processing-before-survival-analysis">Further pre-processing before survival analysis</a></li>
  <li><a href="#run-model" id="toc-run-model" class="nav-link" data-scroll-target="#run-model">Run model</a></li>
  <li><a href="#load-pre-run-survival-analysis" id="toc-load-pre-run-survival-analysis" class="nav-link" data-scroll-target="#load-pre-run-survival-analysis">Load pre-run survival analysis</a></li>
  <li><a href="#make-survival-analysis-report" id="toc-make-survival-analysis-report" class="nav-link" data-scroll-target="#make-survival-analysis-report">Make survival analysis report</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/pythonhealthdatascience/stars-eom-rcc/edit/main/pages/walkthrough/code0a_walkthrough.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/pythonhealthdatascience/stars-eom-rcc/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Code walkthrough</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>This is a single <code>.qmd</code> file that walks through the code in <code>Model_Structure.R</code>. It is rendered as a single file, then the output <code>.md</code> file is split into seperate <code>.md</code> files that can be incorporated into seperate <code>.qmd</code> pages.</p>
<p>This is done as running the code within seperate <code>.qmd</code> pages requires that the global environment is shared between them, which is difficult to achieve without long run times or very large files containing the environment.</p>
<p>SPLITMD_CODE1_START</p>
<p>This page contains some of the basic set-up steps like <strong>loading the functions</strong> and lots of the <strong>model inputs</strong>, as well as establishing the <strong>possible treatment sequences</strong>.</p>
<section id="load-required-packages" class="level2">
<h2 class="anchored" data-anchor-id="load-required-packages">Load required packages</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### 1. Installation ###########</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="do">#### This code has been created using R version 4.3.1</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="do">#### All packages used by this model are provided here</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="do">#### Comment out the below section which installs the relevant packages after the first run of the model</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("shiny", quiet = TRUE)   </span><span class="al">###</span><span class="co"> the quiet argument is used to avoid warnings appearing in the console (useful for later conversion to web app)</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("gtools", quiet = TRUE)</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("openxlsx", quiet = TRUE)</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("flexsurv", quiet = TRUE)</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("tidyverse", quiet = TRUE)</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("data.table", quiet = TRUE)</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("heemod", quiet = TRUE)</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("logOfGamma", quiet = TRUE)</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("ggplot2", quiet = TRUE)</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("survminer", quiet = TRUE)</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("officer", quiet = TRUE)</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("officedown", quiet = TRUE)</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("magrittr", quiet = TRUE)</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("Hmisc", quiet = TRUE)</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("future.apply", quiet = TRUE)</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("crosstable", quiet = TRUE)</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("flextable", quiet = TRUE)</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("stringr", quiet = TRUE)</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("BCEA", quiet = TRUE)</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("collapse", quiet = TRUE)</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("scales", quiet = TRUE)</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("Matrix", quiet = TRUE)</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("dplyr", quiet = TRUE)</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("progressr", quiet = TRUE)</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("microbenchmark", quiet = TRUE)</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="do">### Loading libraries </span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="do">#### This section needs to be run every time and calls each package from the library </span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(shiny, <span class="at">quiet =</span> <span class="cn">TRUE</span>)   </span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gtools, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(openxlsx, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(flexsurv, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(heemod, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(logOfGamma, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survminer, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(officer, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(officedown, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Hmisc, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(future.apply, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(crosstable, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(flextable, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(BCEA, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(collapse, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Matrix, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(progressr, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(microbenchmark, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="set-file-paths" class="level2">
<h2 class="anchored" data-anchor-id="set-file-paths">Set file paths</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set path to folders</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>d_path <span class="ot">=</span> <span class="st">"../../../1_Data"</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>f_path <span class="ot">=</span> <span class="st">"../../../3_Functions"</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>o_path <span class="ot">=</span> <span class="st">"../../../4_Output"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="define-some-of-the-model-settings" class="level2">
<h2 class="anchored" data-anchor-id="define-some-of-the-model-settings">Define some of the model settings</h2>
<p>The majority of this code block is dedicated to setting the model to <strong>run sequentially or in parallel</strong>. If running the base case using <code>Model_Structure.R</code> as provided (e.g.&nbsp;with pre-run survival analysis), you may find that the quickest option is to run the model sequentially. This is already set up by default, with <code>keep_free_cores &lt;- NA</code>. For reference, the run time for this on an Intel Core i7-12700H with 32GB RAM running Ubuntu 22.04.4 Linux was 40 minutes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Multi-core processing:</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Instructions.</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># This model is highly RAM intensive. You need a lot of RAM on your computer</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># to run this model due to the large amount of very large matrix multiplications</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># (up to approximately 15,000 discrete health states in the model). Therefore,</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co"># in order to efficiently run the model, it is a balancing act between RAM</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co"># usage and CPU usage. </span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Some rough guidance is:</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co"># - If you have 8GB of RAM on your computer, you can run this model with 2 cores only</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co">#   but it may even be faster to run in series if you have other things open on your</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co">#   computer at the same time. Therefore, please set keep_free_cores to NA and run</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="co">#   the model in series. This is because when the RAM on your computer runs out</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co">#   your computer will use the hard-disk instead which is extremely slow.</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="co"># - If you have 16GB of RAM on your computer, parallel should be a lot faster.</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="co">#   On my laptop (I7 8th gen, 16GB RAM, running Linux for low RAM usage) I can</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="co">#   run with 5 cores whilst using about 12GB of RAM running this model. </span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="co"># - if you have 24GB or 32GB of RAM, you should be able to run the model with 8</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="co">#   and up to around 14 cores before running out of RAM whilst running the model.</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="co"># - if you are using a HPC, you should be able to run this model with many cores</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="co">#   due to the typically large amount of RAM available per core in a HPC</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="co"># IF YOU DO NOT WANT MULTICORE SET keep_free_cores TO NA</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>keep_free_cores <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">any</span>(<span class="fu">is.na</span>(keep_free_cores), keep_free_cores<span class="sc">&lt;</span><span class="dv">0</span>)) {</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plan</span>(sequential)</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plan</span>(<span class="fu">multisession</span>(<span class="at">workers =</span> <span class="fu">max</span>(<span class="fu">availableCores</span>()<span class="sc">-</span>keep_free_cores,<span class="dv">1</span>)))</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The three settings in this code block:</p>
<ul>
<li><code>progressr::handlers("progress")</code> - one of the settings for how progress is reported whilst code is running</li>
<li><code>crosstable::options(crosstable_units="cm")</code> - the <code>crosstable</code> package generates descriptive statistics with function <code>crosstable()</code>, and this sets the unit for it, although it should be noted that this appears to be legacy code as it doesn’t appear that <code>crosstable()</code> is used anywhere in the repository</li>
<li><code>qc_mode</code> - the input for <code>verbose</code> in <code>f_NMA_AddAssumptionsToNetwork()</code> which, if true, will mean that extra outputs are printed to the console</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Other generic settings for the progress bar and units for table widths</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">handlers</span>(<span class="st">"progress"</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">crosstable_units=</span><span class="st">"cm"</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="do">#### 2. Loading functions ###########</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co"># This variable is used throughout the model to define whether to provide additional outputs useful for QC or not</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co"># The model will take longer to run when this is set to TRUE</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>qc_mode <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="import-model-functions" class="level2">
<h2 class="anchored" data-anchor-id="import-model-functions">Import model functions</h2>
<p>The functions for the analysis in <code>Model_Structure.R</code> are stored in the <code>3_Functions/</code> folder. Here, they are imported into our environment.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 2.1. Excel data extraction functions -----------------------------------------</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="do">#### These functions are used to extract parameters from the Excel input workbook for use in R</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="do">#### During Phase 2 a Shiny front-end will be added to the model which will allow an alternative mechanism to upload these types of inputs</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(f_path, <span class="st">"excel/extract.R"</span>))</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 2.2. Treatment sequencing functions ----------------------------------------</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="do">#### Function: filter to active treatments and lines</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="do">##### Takes as an input the defined sequences, evaluation type and line to start the evaluation from </span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="do">##### Other input is % receiving each subs therapy at each line dependent on previous treatments received </span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="do">##### Reweights so that the % receiving each treatment sums to 100% within each arm / line being studied</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="do">##### Outputs a matrix that has the % receiving each possible combination</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(f_path, <span class="st">"sequencing/sequences.R"</span>))</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 2.3. Survival analysis functions ---------------------------------------------</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Function: conduct survival analysis</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="do">##### by treatment, line, population and outcome fitted survival curves using Flexsurvreg (exp, Weibull, lognormal, loglog, Gompertz, gen gamma)</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="do">##### calculation of and adjustment for general population</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="do">##### adjustment for treatment effect waning</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(f_path, <span class="st">"survival/Survival_functions.R"</span>))</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(f_path, <span class="st">"survival/other_cause_mortality.R"</span>))</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(f_path, <span class="st">"survival/treatment_effect_waning.R"</span>))</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a><span class="co"># 2.4 Misc functions ----------------------------------------------------------</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="do">### these functions enable smoother data cleaning and manipulation</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(f_path, <span class="st">"misc/other.R"</span>))</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(f_path, <span class="st">"misc/shift_and_pad.R"</span>))</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(f_path, <span class="st">"misc/cleaning.R"</span>))</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a><span class="co"># 2.4.1 Functions imposing list structures -----------------------------------</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(f_path, <span class="st">"misc/nesting.R"</span>))</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(f_path, <span class="st">"misc/discounting.R"</span>))</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(f_path, <span class="st">"misc/qdirichlet.R"</span>))</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(f_path, <span class="st">"misc/plotting.R"</span>))</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(f_path, <span class="st">"misc/structure.R"</span>))</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a><span class="co"># 2.4.2 Functions calculating HRs from FPNMA coefficients and other FPNMA manipulation ------</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(f_path, <span class="st">"misc/fpnma_fns.R"</span>))</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a><span class="co"># 2.5 Utility functions -------------------------------------------------------</span></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(f_path, <span class="st">"utility/age_related.R"</span>))</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(f_path, <span class="st">"costs_and_QALYs/utility_processing.R"</span>))</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a><span class="co"># 2.6 AE functions --------------------------------------------------------</span></span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(f_path, <span class="st">"adverse_events/AE_steps.R"</span>))</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a><span class="co"># 2.7 Cost calculation functions --------------------------------------------</span></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(f_path, <span class="st">"costs_and_QALYs/cost_processing.R"</span>))</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a><span class="co"># 2.8 State transition modelling functions --------------------------------</span></span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(f_path, <span class="st">"markov/markov.R"</span>))</span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a><span class="co"># 2.9 Patient flow functions ----------------------------------------------</span></span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(f_path, <span class="st">"patient_flow/overarching.R"</span>))</span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(f_path, <span class="st">"patient_flow/partitioned_survival.R"</span>))</span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(f_path, <span class="st">"patient_flow/markov.R"</span>))</span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(f_path, <span class="st">"patient_flow/drug_costs.R"</span>))</span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(f_path, <span class="st">"patient_flow/hcru_costs.R"</span>))</span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(f_path, <span class="st">"patient_flow/qalys.R"</span>))</span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(f_path, <span class="st">"patient_flow/ae.R"</span>))</span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a><span class="co"># 2.10 Results processing functions ---------------------------------------</span></span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(f_path, <span class="st">"results/incremental_analysis.R"</span>))</span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(f_path, <span class="st">"results/model_averaging.R"</span>))</span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(f_path, <span class="st">"results/partitioned_survival.R"</span>))</span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(f_path, <span class="st">"misc/severity_modifier.R"</span>))</span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(f_path, <span class="st">"results/results_tables.R"</span>))</span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(f_path, <span class="st">"psa/psa functions.R"</span>))</span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a><span class="co"># 2.11 Office software outputs --------------------------------------------</span></span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(f_path, <span class="st">"reporting/word_document_output.R"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="get-some-of-the-model-inputs" class="level2">
<h2 class="anchored" data-anchor-id="get-some-of-the-model-inputs">Get some of the model inputs</h2>
<section id="introductory-comments" class="level3">
<h3 class="anchored" data-anchor-id="introductory-comments">Introductory comments</h3>
<p>This section of the code is mostly comments that describe:</p>
<ul>
<li>The structure of <code>i</code> which contains model inputs</li>
<li>That survival analysis will be conducted using state transition (markov) models and partitioned survival analysis (partSA)</li>
<li>The five input files, which are detailed within the documentation on the page <a href="../../pages/input_data.html">Input data</a></li>
</ul>
<p>There is a line of code to define <code>User_types</code>, but this appears to be legacy as it is not used anywhere.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Model inputs structure --------------------------------------------------</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Model inputs should be in a list called i. This list then contains all of the</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># inputs for the model, NOT the parameters used to calculate the model. In effect,</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co"># this is a place to store all model information BEFORE it gets boiled down to</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co"># what's needed to run 1 model.</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co"># using i allows subsetting by categorisation, which makes things a lot easier</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co"># to find and avoids all long variable names</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co"># the structure of i should be by category. There are the following </span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co"># categories:</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="co"># dd - dropdown inputs taken from Excel</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co"># i - parameter inputs taken from Excel</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="co"># r_ tables taken from Excel</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="co"># List, id and lookup - lists defined and used within the code</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="co"># basic - basic inputs (time horizon, cycle length, discount rates, so on so forth)</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="co"># surv  - survival analysis inputs including raw data</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="co"># sequences and seq - inputs and outputs related to the possible sequences of treatments</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="co"># cost  - drug and hcru costs. All costs are here to keep things together (dosing is not cost)</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="co"># util and QALYs  - utility and QALY inputs</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="co"># misc  - misc inputs e.g. graph labelling</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="do">#### 3.1 Loading input parameters ###########</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a><span class="co"># This model allows two possible structures to be analysed: state transition with a user definable number of lines</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a><span class="co"># with health states based on time to discontinuation (drug costs) and progression status (quality of life and movement </span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a><span class="co"># between lines) and PartSA with 3 health states (pre-progression, post-progression and death)</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a><span class="co"># During Phase 1 of this pilot we use the model to evaluate the decision problem for a single therapy </span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a><span class="co"># (cabo+nivo, defined as molecule 1) starting at 1st line</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a><span class="co"># During Phase 2 we will adapt this code to evaluate the cost-effectiveness of sequences starting at a user-defined line</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Inputs to this model need to be downloaded from NICEdocs </span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>User_types <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Submitting company"</span>, <span class="st">"NICE"</span>, <span class="st">"EAG"</span>, <span class="st">"Committee"</span>, <span class="st">"NHSE"</span>, <span class="st">"Clinical expert"</span>, <span class="st">"Patient expert"</span>, <span class="st">"Non-intervention stakeholder"</span>, <span class="st">"Public"</span>)</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a><span class="co"># The submitting company are able to see their own CIC and AIC data (marked up blue / yellow in reporting but not anything else: green marking</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a><span class="co"># green marked data has been either be replaced with 0 [PAS discounts, RWE IPD] or dummy data)</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a><span class="co"># NICE users will be able to see everything</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Other users will not be able to see any marked data, this is replaced with dummy data</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a><span class="co"># The way raw data is fed into the model currently works as follows</span></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the path to where the data file lives using the select file functionality</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a><span class="co"># The model then processes the file the user selected</span></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a><span class="co"># There are a number of files which contain raw or intermediate inputs:</span></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. The Excel user interface - this contains information from company data and the UK RWE</span></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. The proportional hazards NMA CODA RDS file - this contains information from company data</span></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. The fractional polynomials NMA RDS file - this contains information from company data </span></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Either the raw data file containing the pseudo-IPD for all trials for survival analysis (RWE and company data included); or</span></span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. The RDS output from the survival analysis using both RWE and company data</span></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a><span class="co"># You will need to manually select the inputs file relevant to your user type, this is not stored on Github as access to CIC information differs by user type</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="get-inputs-from-excel-workbook-and-save-as-list-i" class="level3">
<h3 class="anchored" data-anchor-id="get-inputs-from-excel-workbook-and-save-as-list-i">Get inputs from excel workbook and save as list <code>i</code></h3>
<p>Import the file at <code>excel_path</code> using <code>f_excel_extract()</code>, and then tidy <code>i$R_table_param</code> using <code>f_excel_cleanParams()</code>.</p>
<p>If the file doesn’t exist, assuming the user is in RStudio, a dialog box will appear with the system files, and the user should then select a file from their directory. The dialog will open in <code>1_Data/</code>, show only <code>.xlsm</code> files, and the accept/ok button has the text <code>ID6184_RCC_model inputs....xlsm</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The first part of this code pulls all of the named ranges from the excel workbook, expand the parameters table</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co">#Option to define Excel path on local machine - comment in this and comment out the code below to select file</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>excel_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(d_path, <span class="st">"ID6184_RCC_model inputs FAD version [UK RWE unredacted, ACIC redacted, cPAS redacted].xlsm"</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co">#i &lt;- f_excel_extract(excel_path, verbose = TRUE)</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(excel_path)) {</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  i <span class="ot">&lt;-</span> <span class="fu">f_excel_extract</span>(excel_path, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  i <span class="ot">&lt;-</span> <span class="fu">f_excel_extract</span>(rstudioapi<span class="sc">::</span><span class="fu">selectFile</span>(</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Select the Excel inputs file (ID6184_RCC_model inputs....xlsm)"</span>,</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"ID6184_RCC_model inputs....xlsm"</span>,</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">path =</span> <span class="st">"./1_Data/"</span>,</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">filter =</span> <span class="st">"Excel Files (*.xlsm)"</span>,</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">existing =</span> <span class="cn">TRUE</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  ), <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>i <span class="ot">&lt;-</span> <span class="fu">c</span>(i,<span class="fu">f_excel_cleanParams</span>(i<span class="sc">$</span>R_table_param))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What does <code>f_excel_extract()</code> do?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>This function uses <code>openxlsx::getNamedRegions()</code> to find named regions in the workbook. These are all stored in a sheet called <code>named ranges</code>. As illustrated in <a href="../../pages/input_data.html">Input data</a>, these consist of two columns:</p>
<ul>
<li>A name for the region (e.g.&nbsp;<code>List_pop1_allowed</code>)</li>
<li>The region, which consists of the: sheet, column/s and row/s (e.g.&nbsp;<code>=Lists!$BA$11:$BA$22</code>)</li>
</ul>
<p><img src="../../images/excel_named_range.png" class="img-fluid"></p>
<p>The function <code>f_excel_extract()</code> extracts each of these, saving them into a nested list called <code>i</code>. Each element in the list is a row from the <code>named ranges</code> sheet - for example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>List_pop1_allowed</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "avelumab_plus_axitinib"      "axitinib"                   
 [3] "cabozantinib"                "everolimus"                 
 [5] "lenvatinib_plus_everolimus"  "cabozantinib_plus_nivolumab"
 [7] "nivolumab_monotherapy"       "pazopanib"                  
 [9] "sunitinib"                   "tivozanib"                  </code></pre>
</div>
</div>
<p>The exception is the first element which is a copy of the named ranges sheet:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">head</span>(i[[<span class="dv">1</span>]]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 48%">
<col style="width: 51%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Name</th>
<th style="text-align: left;">Cell.Range</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">apply_waning_to</td>
<td style="text-align: left;">=Lists!$Y<span class="math inline">\(10:\)</span>Y<span class="math inline">\(11      |
|bc_settings_rng        |=Lists!\)</span>B<span class="math inline">\(99:\)</span>B<span class="math inline">\(174     |
|cabo_nivo_outcome_from |=Lists!\)</span>W<span class="math inline">\(10            |
|cabo_nivo_outcomes     |=Lists!\)</span>X<span class="math inline">\(10:\)</span>X<span class="math inline">\(12      |
|count_bc_settings      |=Lists!\)</span>B<span class="math inline">\(97            |
|dd_2ndline_NMA         |='Model settings'!\)</span>G$40</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What does <code>f_excel_cleanParams()</code> do?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>This function is applied to <code>i$R_table_param</code> which is the full table from the sheet <code>All parameters</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">head</span>(i<span class="sc">$</span>R_table_param))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 51%">
<col style="width: 23%">
<col style="width: 24%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Parameter.description</th>
<th style="text-align: left;">Parameter.name</th>
<th style="text-align: left;">Mean.current.value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Include cabo nivo? (1=yes, 0=no)</td>
<td style="text-align: left;">cabo_nivo_include</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">Include pem len? (1=yes, 0=no)</td>
<td style="text-align: left;">pem_len_include</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Include panzopanib? (1=yes, 0=no)</td>
<td style="text-align: left;">pazopanib_include</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">Include tivozanib? (1=yes, 0=no)</td>
<td style="text-align: left;">tivozanib_include</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Include sunitinib? (1=yes, 0=no)</td>
<td style="text-align: left;">sunitinib_include</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">Include cabo monotherapy? (1=yes, 0=no)</td>
<td style="text-align: left;">cabo_include</td>
<td style="text-align: left;">1</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The function <code>f_excel_cleanParams()</code>:</p>
<ul>
<li>Converts each row of the table into a list, with value from <code>Parameter.name</code> used as the list name</li>
<li>Adds <code>Mean</code> which is simply <code>Mean.current.value</code> converted to numeric</li>
</ul>
<p>These lists were then concatenated with <code>i</code>, so we can access them from <code>i</code> as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>cabo_nivo_include</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$Parameter.description
[1] "Include cabo nivo? (1=yes, 0=no)"

$Parameter.name
[1] "cabo_nivo_include"

$Mean.current.value
[1] "1"

$Mean
[1] 1</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="manually-add-some-extra-inputs-to-i" class="level3">
<h3 class="anchored" data-anchor-id="manually-add-some-extra-inputs-to-i">Manually add some extra inputs to <code>i</code></h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set which decision problem to look at, initially functionality has been geared towards the decision problem for cabozantinib plus nivolumab</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>decision_problem <span class="ot">&lt;-</span> <span class="st">"cabo+nivo"</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># We then create a place for identifiers. Adding in an object to i full of lookup tables makes automated translation</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co"># possible even when one doesn't know the number of items ex ante, or how they combine.</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co"># If the lookup table is correct one can translate id numbers to text strings which are</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co"># consistent throughout the entire model. This is extremely useful as the model can</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co"># be expanded to any number of treatments and potentially even any number of lines </span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co"># (up to a reasonable maximum)</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>id     <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">ipd =</span> <span class="fu">list</span>())</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>lookup <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">ipd =</span> <span class="fu">list</span>())</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Add distribution names to i</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="co"># This model only includes standard parametric distributions as more complex distributions were not deemed to be required for the included treatments</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>distnames <span class="ot">&lt;-</span> </span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">gengamma      =</span> <span class="st">"gengamma"</span>,</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">exp           =</span> <span class="st">"exp"</span>,</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">weibull       =</span> <span class="st">"weibull"</span>,</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">lnorm         =</span> <span class="st">"lnorm"</span>,</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">gamma         =</span> <span class="st">"gamma"</span>,</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">gompertz      =</span> <span class="st">"gompertz"</span>,</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">llogis        =</span> <span class="st">"llogis"</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="use-i-to-make-another-list-p" class="level3">
<h3 class="anchored" data-anchor-id="use-i-to-make-another-list-p">Use <code>i</code> to make another list <code>p</code></h3>
<p>The list <code>p</code> is based on <code>i</code>, either copying over parameters or using them to calculate new parameters. The list is first created by <code>f_misc_param_generate_p()</code>. A few extra additions are then made to <code>p</code> in this code block, such as to set a maximum of 4 treatment lines before best supportive care.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The next step is to then "tidy up" i into another object, p. p doesn't necessarily</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co"># have to house everything, only things that will change in PSA</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">f_misc_param_generate_p</span>(i)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Set seed for PSA - note this is done in the script to run the PSA, not here!</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co"># set.seed(1475)</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Max lines within the R model</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>basic<span class="sc">$</span>R_maxlines <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Pass this into p so that p can be used to exclusively compute the model:</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>basic<span class="sc">$</span>decision_problem <span class="ot">&lt;-</span> i<span class="sc">$</span>decision_problem</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What does <code>f_misc_param_generate_p()</code> do?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>This function consists of relatively simple calculations using parameters from <code>i</code> to generate <code>p</code>. For the full overview of these calculations, check out the code for the function. To give an example though, the function code includes:</p>
<pre><code>p &lt;- list(
    basic = list(
      th   = ceiling(i$ui_time_horizon * 365.25 / 7), 
      th_y = i$ui_time_horizon, 
      ...
    )
    ...
)</code></pre>
<p>In this example, we can see that is makes a copy of <code>i$ui_time_horizon</code> which has time horizon of model in years (40 years) (<code>p$basic$th_y</code>). It also converts the time horizon into weeks (<code>p$basic$th</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>ui_time_horizon</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 40</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>basic<span class="sc">$</span>th</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2088</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>basic<span class="sc">$</span>th_y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 40</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="treatment-sequences" class="level2">
<h2 class="anchored" data-anchor-id="treatment-sequences">Treatment sequences</h2>
<section id="find-all-possible-sequences" class="level3">
<h3 class="anchored" data-anchor-id="find-all-possible-sequences">Find all possible sequences</h3>
<p>The first step in determining the possible treatment sequences is to determine all possible combinations and orders of treatment, saving this as <code>i$sequences</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### 3.2 Define sequences  ###########</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="do">#### This code produces a list of possible sequences per population based upon the rules defined for RCC</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="do">#### and the user input number of lines</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Add drug names to comparators vector extracted from inputs list.</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>sequences <span class="ot">&lt;-</span> <span class="fu">f_generate_sequences</span>(</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">comparators =</span> i<span class="sc">$</span>List_comparators, </span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">maxlines    =</span> p<span class="sc">$</span>basic<span class="sc">$</span>R_maxlines</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What does <code>f_generate_sequences()</code> do?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The input to this function is a list of all the possible treatments (14 options), and the maximum number of treatment lines (4).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>List_comparators</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "nivolumab_monotherapy"         "cabozantinib_plus_nivolumab"  
 [3] "nivolumab_plus_ipilimumab"     "lenvatinib_plus_pembrolizumab"
 [5] "avelumab_plus_axitinib"        "pazopanib"                    
 [7] "tivozanib"                     "sunitinib"                    
 [9] "cabozantinib"                  "lenvatinib_plus_everolimus"   
[11] "everolimus"                    "axitinib"                     
[13] "sorafenib"                     "placebo_BSC"                  </code></pre>
</div>
</div>
<p>The function <code>f_generate_sequences()</code> outputs a table saved as <code>i$sequences</code>. This contains every possible order and combination of treatments.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">head</span>(i<span class="sc">$</span>sequences, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 29%">
<col style="width: 11%">
<col style="width: 16%">
<col style="width: 36%">
<col style="width: 5%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">V1</th>
<th style="text-align: left;">V2</th>
<th style="text-align: left;">V3</th>
<th style="text-align: left;">V4</th>
<th style="text-align: left;">V5</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">avelumab_plus_axitinib</td>
<td style="text-align: left;">axitinib</td>
<td style="text-align: left;">cabozantinib</td>
<td style="text-align: left;">cabozantinib_plus_nivolumab</td>
<td style="text-align: left;">BSC</td>
</tr>
<tr class="even">
<td style="text-align: left;">avelumab_plus_axitinib</td>
<td style="text-align: left;">axitinib</td>
<td style="text-align: left;">cabozantinib</td>
<td style="text-align: left;">everolimus</td>
<td style="text-align: left;">BSC</td>
</tr>
<tr class="odd">
<td style="text-align: left;">avelumab_plus_axitinib</td>
<td style="text-align: left;">axitinib</td>
<td style="text-align: left;">cabozantinib</td>
<td style="text-align: left;">lenvatinib_plus_everolimus</td>
<td style="text-align: left;">BSC</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(i<span class="sc">$</span>sequences)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 26404     5</code></pre>
</div>
</div>
<p>These varied from a single treatment to up to four subsequent treatments, but always ended with best supportive case (BSC).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">head</span>(i<span class="sc">$</span>sequences[i<span class="sc">$</span>sequences<span class="sc">$</span>V3<span class="sc">==</span><span class="st">""</span>,], <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">V1</th>
<th style="text-align: left;">V2</th>
<th style="text-align: left;">V3</th>
<th style="text-align: left;">V4</th>
<th style="text-align: left;">V5</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">avelumab_plus_axitinib</td>
<td style="text-align: left;">BSC</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">axitinib</td>
<td style="text-align: left;">BSC</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">cabozantinib</td>
<td style="text-align: left;">BSC</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="filter-to-valid-sequences" class="level3">
<h3 class="anchored" data-anchor-id="filter-to-valid-sequences">Filter to valid sequences</h3>
<p>The table of all possible treatment sequences is then filtered down to valid sequences (for example, removing drugs if not allowed for a given population, or after another particular drug).</p>
<!-- This section is set to eval FALSE as the progress statements are from cat() so cannot suppress output. Instead, actually run in dropdown below, where there, hide the code but can still see the output -->
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># restrict the pathways to those that are possible and permitted.</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>sequences <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(i<span class="sc">$</span>sequences)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>populations <span class="ot">&lt;-</span> i<span class="sc">$</span>i_nr_populations</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>seqs <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="fu">invisible</span>(</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a> <span class="cf">for</span> (population <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>populations) {</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Applying sequence restrictions to population"</span>, population,<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>  s <span class="ot">&lt;-</span> <span class="fu">f_path_tx_restrict</span>(</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">sequences                =</span> i<span class="sc">$</span>sequences,</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">allowed                  =</span> <span class="fu">f_get_allowed_lists</span>(i, population), <span class="co">#overall list of allowed drugs in this popn</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">L1                       =</span> <span class="fu">f_get_L1_lists</span>(i, population), <span class="co"># 1L drugs allowed in this popn</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">L2                       =</span> <span class="fu">f_get_L2_lists</span>(i, population), <span class="co"># 2L drugs allowed in this popn</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">L3                       =</span> <span class="fu">f_get_L3_lists</span>(i, population), <span class="co"># 3L drugs allowed in this popn</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">L4                       =</span> <span class="fu">f_get_L4_lists</span>(i, population), <span class="co"># 4L drugs allowed in this popn</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">only_after               =</span> <span class="fu">f_get_only_after_lists</span>(i, population), <span class="co">#list of restrictions where tx can be only after the listed txs</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">not_immediate_after      =</span> <span class="fu">f_get_not_immediate_after_lists</span>(i, population), <span class="co">#list of restrictions where tx can be only immediately before the listed txs</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">one_in_list              =</span> <span class="fu">f_get_one_in_list_lists</span>(i, population), <span class="co">#list of restrictions where only one of the tx in each list is allowed </span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">only_after_one           =</span> <span class="fu">f_get_only_after_one_lists</span>(i, population), <span class="co">#list of restrictions where only one of the listed treatments is allowed prior to current therapy </span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">L2_only_after            =</span> <span class="fu">f_get_2L_only_after_lists</span>(i, population), <span class="co">#list of 2L+ restrictions: if drug is used 2L, 3L or 4L, can only be after drug x</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">L2_only_immediate_after  =</span> <span class="fu">f_get_2L_only_immediate_after_lists</span>(i, population), <span class="co">#list of 2L+ restrictions: if drug is used 2L, 3L or 4L, can only be immediately after drug x</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">L2_only_one              =</span> <span class="fu">f_get_2L_only_one_lists</span>(i, population) <span class="co">#list of 2L+ drugs where only one of them allowed in a given sequence</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>  s <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="fu">rep</span>(<span class="fu">paste0</span>(<span class="st">"pop"</span>, population),<span class="fu">nrow</span>(s)), s)</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(s) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">'V'</span>, <span class="fu">seq_len</span>(<span class="fu">ncol</span>(s))) <span class="co"># rbind no longer likes un-named columns so added this</span></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>  seqs <span class="ot">&lt;-</span> <span class="fu">rbind</span>(seqs, s)</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>} </span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(seqs) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>sequences <span class="ot">&lt;-</span> seqs</span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a><span class="do">#### Uncomment this code to view the sequences and write the sequences defined to csv</span></span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a><span class="co"># i$sequences</span></span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a><span class="co"># write.csv(seqs, "4_Output/sequences.csv", row.names = F)</span></span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(s, seqs, populations)</span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a><span class="co"># define number of cycles and a vector of the cycles </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
About the populations being looped through
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>This code chunk restricted to valid sequences by population. In this analysis, there are four populations defined by time since an immuno-oncology (IO) treatment, and International Metastatic Renal Cell Carcinoma Database Consortium (IMDC) risk status. They are:</p>
<ul>
<li>pop1 &gt;12m since IO, favourable risk</li>
<li>pop2 &gt;12m since IO, intermediate/poor risk</li>
<li>pop3 &lt;12m since IO, favourable risk</li>
<li>pop4 &lt;12m since IO, intermediate/poor risk</li>
</ul>
<p>Each risk group has to be broken down by time since IO as there are five treatments that cannot be used within 12 months of an adjuvant IO treatment (4.3.5.6 in Assessment Report <span class="citation" data-cites="lee_treatments_2023-1">@lee_treatments_2023-1</span>). An adjuvant treatment is one given alongside the primary treatment.</p>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What criteria are there for valid treatments?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<section id="by-population-and-line" class="level3">
<h3 class="anchored" data-anchor-id="by-population-and-line">By population and line</h3>
<p>For <strong>each population</strong>, there are a list of valid treatments at <strong>each line</strong> of therapy (first-line through to fourth). For example, valid first-line treatments for population 1 are:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Pop1 1L treatments</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">f_get_L1_lists</span>(i, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "avelumab_plus_axitinib"      "cabozantinib_plus_nivolumab"
[3] "pazopanib"                   "sunitinib"                  
[5] "tivozanib"                  </code></pre>
</div>
</div>
</section>
<section id="only-after" class="level3">
<h3 class="anchored" data-anchor-id="only-after">Only after</h3>
<p>There are some treatments that can only come after other treatments. For example, for population 1:</p>
<ul>
<li>Axitinib can only be administered <strong>after</strong> a tyrosine kinase inhibitor (TKI) or cytokine treatment</li>
<li>Everolimus can only be administered <strong>after</strong> a vascular endothelial growth factor (VEGF) treatment</li>
<li>At 2L 3L or 4L, cabozantinib can only be administered <strong>after</strong> one of the listed treatments</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">f_get_only_after_lists</span>(i, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$axitinib
[1] "avelumab_plus_axitinib"        "cabozantinib"                 
[3] "lenvatinib_plus_everolimus"    "cabozantinib_plus_nivolumab"  
[5] "pazopanib"                     "lenvatinib_plus_pembrolizumab"
[7] "sunitinib"                     "tivozanib"                    

$everolimus
[1] "avelumab_plus_axitinib"        "axitinib"                     
[3] "cabozantinib"                  "lenvatinib_plus_everolimus"   
[5] "cabozantinib_plus_nivolumab"   "pazopanib"                    
[7] "lenvatinib_plus_pembrolizumab" "sunitinib"                    
[9] "tivozanib"                    </code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">f_get_2L_only_after_lists</span>(i, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$cabozantinib
[1] "avelumab_plus_axitinib"        "axitinib"                     
[3] "lenvatinib_plus_everolimus"    "cabozantinib_plus_nivolumab"  
[5] "pazopanib"                     "lenvatinib_plus_pembrolizumab"
[7] "sunitinib"                     "tivozanib"                    </code></pre>
</div>
</div>
</section>
<section id="not-immediately-after" class="level3">
<h3 class="anchored" data-anchor-id="not-immediately-after">Not immediately after</h3>
<p>Some treatments cannot come immediately after another treatment. For example, for population 1:</p>
<ul>
<li>Lenvatinib plus everolimus must <strong>not come immediately after</strong> nivolumab plus ipilimumab</li>
<li>At 2L 3L or 4L, pazopanib and sunitinib and tivozanib must <strong>not come immediately after</strong> their respective listed treatments</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">f_get_not_immediate_after_lists</span>(i, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$lenvatinib_plus_everolimus
[1] "nivolumab_plus_ipilimumab"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">f_get_2L_only_immediate_after_lists</span>(i, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$pazopanib
[1] "avelumab_plus_axitinib"        "lenvatinib_plus_pembrolizumab"
[3] "cabozantinib_plus_nivolumab"   "nivolumab_plus_ipilimumab"    

$sunitinib
[1] "avelumab_plus_axitinib"        "lenvatinib_plus_pembrolizumab"
[3] "cabozantinib_plus_nivolumab"   "nivolumab_plus_ipilimumab"    

$tivozanib
[1] "avelumab_plus_axitinib"        "lenvatinib_plus_pembrolizumab"
[3] "cabozantinib_plus_nivolumab"   "nivolumab_plus_ipilimumab"    </code></pre>
</div>
</div>
</section>
<section id="only-one-from-list" class="level3">
<h3 class="anchored" data-anchor-id="only-one-from-list">Only one from list</h3>
<p>Some treatments are not allowed if another has already been given at any point prior.</p>
<p>For example, for population 1 there are five lists of treatments where <strong>only one treatment from each list</strong> is allowed.</p>
<p>There are no restrictions like this for population 1 specific to just 2L 3L or 4L treatments (hence, empty list).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">f_get_one_in_list_lists</span>(i, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$axitinib
[1] "avelumab_plus_axitinib" "axitinib"              

$cabozantinib
[1] "cabozantinib"                "cabozantinib_plus_nivolumab"

$everolimus
[1] "lenvatinib_plus_everolimus" "everolimus"                

$io
[1] "avelumab_plus_axitinib"        "nivolumab_plus_ipilimumab"    
[3] "cabozantinib_plus_nivolumab"   "nivolumab_monotherapy"        
[5] "lenvatinib_plus_pembrolizumab"

$nivolumab
[1] "nivolumab_plus_ipilimumab"   "cabozantinib_plus_nivolumab"
[3] "nivolumab_monotherapy"      

$TKIs
[1] "sunitinib" "pazopanib" "tivozanib"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">f_get_2L_only_one_lists</span>(i, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>named list()</code></pre>
</div>
</div>
</section>
<section id="only-one-allowed-before" class="level3">
<h3 class="anchored" data-anchor-id="only-one-allowed-before">Only one allowed before</h3>
<p>In other cases, a treatment is not allowed if more than one of a particular category of treatment has been given. For example, for population 1:</p>
<ul>
<li>Of the listed treatments, <strong>only one is allowed before</strong> lenvatinib plus everolimus</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">f_get_only_after_one_lists</span>(i, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$lenvatinib_plus_everolimus
[1] "avelumab_plus_axitinib"        "axitinib"                     
[3] "cabozantinib"                  "cabozantinib_plus_nivolumab"  
[5] "pazopanib"                     "lenvatinib_plus_pembrolizumab"
[7] "sunitinib"                     "tivozanib"                    </code></pre>
</div>
</div>
</section>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What does <code>f_path_tx_restrict()</code> do?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The function <code>f_path_tx_restrict()</code> is defined in <code>sequences.R</code> (there is also a function of the same name in <code>rccFunctions.R</code> but this is not sourced).</p>
<p>Its purpose is to restrict the table of all possible sequences to just the valid sequences for each population, restricting it from <strong>26404</strong> rows with possible treatment sequences to just <strong>744</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(i<span class="sc">$</span>sequences)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 26404     5</code></pre>
</div>
</div>
<p>The inputs to this function are lists defining valid treatments by different criteria (e.g.&nbsp;line of therapy, subsequent treatments), as detailed in the note above.</p>
<p>Within <code>f_path_tx_restrict()</code>, there are then several other functions which take these lists and use them to remove invalid sequences from the table.</p>
<p>For example, the allowed treatments identified using <code>f_get_allowed_lists()</code> are input to <code>f_path_tx_restrict()</code> as <code>allowed</code>. The function <code>f_path_allowed()</code> then uses that list to remove invalid drugs for a given population:</p>
<pre><code>s &lt;- f_path_allowed(s, allowed[[1]])</code></pre>
<p>Looking at an excerpt of the code for <code>f_path_allowed()</code>, we can see that is adds “BSC” and no treatment (““) as valid options, and then only keeps rows if their treatments are in (<code>%in%</code>) the list of valid treatments.</p>
<pre><code>rule &lt;- c(rule, "BSC", "")

for (n in 1:ncol(perms)) {
  perms &lt;- perms[perms[,n] %in% rule,]
}</code></pre>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-8-contents" aria-controls="callout-8" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
View the sequence restrictions applied
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-8" class="callout-8-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Applying sequence restrictions to population 1 
Dropping drugs not allowed for this population.
applying rule: avelumab_plus_axitinib axitinib cabozantinib everolimus lenvatinib_plus_everolimus cabozantinib_plus_nivolumab nivolumab_monotherapy pazopanib sunitinib tivozanib are only allowed treatments.
Permutations before applying rule: 26404 
Permutations after applying rule : 5860 
applying rule: drug line restrictions.
Permutations before applying rule: 5860 
Permutations after applying rule : 628 
[1] "axitinib"
applying rule. axitinib is only allowed after avelumab_plus_axitinib cabozantinib lenvatinib_plus_everolimus cabozantinib_plus_nivolumab pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 628 
Permutations after applying rule : 628 
[1] "everolimus"
applying rule. everolimus is only allowed after avelumab_plus_axitinib axitinib cabozantinib lenvatinib_plus_everolimus cabozantinib_plus_nivolumab pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 628 
Permutations after applying rule : 628 
[1] "lenvatinib_plus_everolimus"
applying rule. lenvatinib_plus_everolimus is not allowed immediately after nivolumab_plus_ipilimumab 
Permutations before applying rule: 628 
Permutations after applying rule : 628 
[1] "axitinib"
applying rule axitinib : avelumab_plus_axitinib axitinib cannot be in one permutation
Permutations before applying rule: 628 
Permutations after applying rule : 559 
[1] "cabozantinib"
applying rule cabozantinib : cabozantinib cabozantinib_plus_nivolumab cannot be in one permutation
Permutations before applying rule: 559 
Permutations after applying rule : 520 
[1] "everolimus"
applying rule everolimus : lenvatinib_plus_everolimus everolimus cannot be in one permutation
Permutations before applying rule: 520 
Permutations after applying rule : 452 
[1] "io"
applying rule io : avelumab_plus_axitinib nivolumab_plus_ipilimumab cabozantinib_plus_nivolumab nivolumab_monotherapy lenvatinib_plus_pembrolizumab cannot be in one permutation
Permutations before applying rule: 452 
Permutations after applying rule : 400 
[1] "nivolumab"
applying rule nivolumab : nivolumab_plus_ipilimumab cabozantinib_plus_nivolumab nivolumab_monotherapy cannot be in one permutation
Permutations before applying rule: 400 
Permutations after applying rule : 400 
[1] "TKIs"
applying rule TKIs : sunitinib pazopanib tivozanib cannot be in one permutation
Permutations before applying rule: 400 
Permutations after applying rule : 202 
[1] "lenvatinib_plus_everolimus"
applying rule: lenvatinib_plus_everolimus can only be after ONE of avelumab_plus_axitinib axitinib cabozantinib cabozantinib_plus_nivolumab pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 202 
Permutations after applying rule : 182 
[1] "cabozantinib"
applying rule: cabozantinib as 2L+ only allowed after avelumab_plus_axitinib axitinib lenvatinib_plus_everolimus cabozantinib_plus_nivolumab pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 182 
Permutations after applying rule : 182 
[1] "pazopanib"
applying rule: pazopanib as 2L+ only allowed immediately after avelumab_plus_axitinib lenvatinib_plus_pembrolizumab cabozantinib_plus_nivolumab nivolumab_plus_ipilimumab 
Permutations before applying rule: 182 
Permutations after applying rule : 172 
[1] "sunitinib"
applying rule: sunitinib as 2L+ only allowed immediately after avelumab_plus_axitinib lenvatinib_plus_pembrolizumab cabozantinib_plus_nivolumab nivolumab_plus_ipilimumab 
Permutations before applying rule: 172 
Permutations after applying rule : 162 
[1] "tivozanib"
applying rule: tivozanib as 2L+ only allowed immediately after avelumab_plus_axitinib lenvatinib_plus_pembrolizumab cabozantinib_plus_nivolumab nivolumab_plus_ipilimumab 
Permutations before applying rule: 162 
Permutations after applying rule : 152 
Applying sequence restrictions to population 2 
Dropping drugs not allowed for this population.
applying rule: avelumab_plus_axitinib axitinib cabozantinib everolimus nivolumab_plus_ipilimumab lenvatinib_plus_everolimus cabozantinib_plus_nivolumab nivolumab_monotherapy pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib are only allowed treatments.
Permutations before applying rule: 26404 
Permutations after applying rule : 13344 
applying rule: drug line restrictions.
Permutations before applying rule: 13344 
Permutations after applying rule : 1036 
[1] "axitinib"
applying rule. axitinib is only allowed after avelumab_plus_axitinib cabozantinib lenvatinib_plus_everolimus cabozantinib_plus_nivolumab pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 1036 
Permutations after applying rule : 1017 
[1] "everolimus"
applying rule. everolimus is only allowed after avelumab_plus_axitinib axitinib cabozantinib lenvatinib_plus_everolimus cabozantinib_plus_nivolumab pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 1017 
Permutations after applying rule : 1004 
[1] "lenvatinib_plus_everolimus"
applying rule. lenvatinib_plus_everolimus is not allowed immediately after nivolumab_plus_ipilimumab 
Permutations before applying rule: 1004 
Permutations after applying rule : 984 
[1] "axitinib"
applying rule axitinib : avelumab_plus_axitinib axitinib cannot be in one permutation
Permutations before applying rule: 984 
Permutations after applying rule : 915 
[1] "cabozantinib"
applying rule cabozantinib : cabozantinib cabozantinib_plus_nivolumab cannot be in one permutation
Permutations before applying rule: 915 
Permutations after applying rule : 876 
[1] "everolimus"
applying rule everolimus : lenvatinib_plus_everolimus everolimus cannot be in one permutation
Permutations before applying rule: 876 
Permutations after applying rule : 773 
[1] "io"
applying rule io : avelumab_plus_axitinib nivolumab_plus_ipilimumab cabozantinib_plus_nivolumab nivolumab_monotherapy lenvatinib_plus_pembrolizumab cannot be in one permutation
Permutations before applying rule: 773 
Permutations after applying rule : 657 
[1] "lenvatinib_plus_everolimus"
applying rule lenvatinib_plus_everolimus : lenvatinib_plus_everolimus lenvatinib_plus_pembrolizumab cannot be in one permutation
Permutations before applying rule: 657 
Permutations after applying rule : 638 
[1] "nivolumab"
applying rule nivolumab : nivolumab_plus_ipilimumab cabozantinib_plus_nivolumab nivolumab_monotherapy cannot be in one permutation
Permutations before applying rule: 638 
Permutations after applying rule : 638 
[1] "TKIs"
applying rule TKIs : sunitinib pazopanib tivozanib cannot be in one permutation
Permutations before applying rule: 638 
Permutations after applying rule : 386 
[1] "lenvatinib_plus_everolimus"
applying rule: lenvatinib_plus_everolimus can only be after ONE of avelumab_plus_axitinib axitinib cabozantinib cabozantinib_plus_nivolumab pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 386 
Permutations after applying rule : 359 
[1] "cabozantinib"
applying rule: cabozantinib as 2L+ only allowed after avelumab_plus_axitinib axitinib nivolumab_plus_ipilimumab lenvatinib_plus_everolimus cabozantinib_plus_nivolumab pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 359 
Permutations after applying rule : 359 
[1] "pazopanib"
applying rule: pazopanib as 2L+ only allowed immediately after avelumab_plus_axitinib lenvatinib_plus_pembrolizumab cabozantinib_plus_nivolumab nivolumab_plus_ipilimumab 
Permutations before applying rule: 359 
Permutations after applying rule : 339 
[1] "sunitinib"
applying rule: sunitinib as 2L+ only allowed immediately after avelumab_plus_axitinib lenvatinib_plus_pembrolizumab cabozantinib_plus_nivolumab nivolumab_plus_ipilimumab 
Permutations before applying rule: 339 
Permutations after applying rule : 319 
[1] "tivozanib"
applying rule: tivozanib as 2L+ only allowed immediately after avelumab_plus_axitinib lenvatinib_plus_pembrolizumab cabozantinib_plus_nivolumab nivolumab_plus_ipilimumab 
Permutations before applying rule: 319 
Permutations after applying rule : 299 
Applying sequence restrictions to population 3 
Dropping drugs not allowed for this population.
applying rule: axitinib cabozantinib everolimus lenvatinib_plus_everolimus nivolumab_monotherapy pazopanib sunitinib tivozanib are only allowed treatments.
Permutations before applying rule: 26404 
Permutations after applying rule : 2080 
applying rule: drug line restrictions.
Permutations before applying rule: 2080 
Permutations after applying rule : 330 
[1] "axitinib"
applying rule. axitinib is only allowed after avelumab_plus_axitinib cabozantinib lenvatinib_plus_everolimus cabozantinib_plus_nivolumab pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 330 
Permutations after applying rule : 330 
[1] "everolimus"
applying rule. everolimus is only allowed after avelumab_plus_axitinib axitinib cabozantinib lenvatinib_plus_everolimus cabozantinib_plus_nivolumab pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 330 
Permutations after applying rule : 330 
[1] "lenvatinib_plus_everolimus"
applying rule. lenvatinib_plus_everolimus is not allowed immediately after nivolumab_plus_ipilimumab 
Permutations before applying rule: 330 
Permutations after applying rule : 330 
[1] "axitinib"
applying rule axitinib : avelumab_plus_axitinib axitinib cannot be in one permutation
Permutations before applying rule: 330 
Permutations after applying rule : 330 
[1] "everolimus"
applying rule everolimus : lenvatinib_plus_everolimus everolimus cannot be in one permutation
Permutations before applying rule: 330 
Permutations after applying rule : 288 
[1] "lenvatinib_plus_everolimus"
applying rule lenvatinib_plus_everolimus : lenvatinib_plus_everolimus lenvatinib_plus_pembrolizumab cannot be in one permutation
Permutations before applying rule: 288 
Permutations after applying rule : 288 
[1] "TKIs"
applying rule TKIs : sunitinib pazopanib tivozanib cannot be in one permutation
Permutations before applying rule: 288 
Permutations after applying rule : 120 
[1] "lenvatinib_plus_everolimus"
applying rule: lenvatinib_plus_everolimus can only be after ONE of axitinib cabozantinib pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 120 
Permutations after applying rule : 111 
[1] "cabozantinib"
applying rule: cabozantinib as 2L+ only allowed after avelumab_plus_axitinib axitinib lenvatinib_plus_everolimus cabozantinib_plus_nivolumab pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 111 
Permutations after applying rule : 111 
[1] "pazopanib"
applying rule: pazopanib as 2L+ only allowed immediately after avelumab_plus_axitinib lenvatinib_plus_pembrolizumab cabozantinib_plus_nivolumab nivolumab_plus_ipilimumab 
Permutations before applying rule: 111 
Permutations after applying rule : 111 
[1] "sunitinib"
applying rule: sunitinib as 2L+ only allowed immediately after avelumab_plus_axitinib lenvatinib_plus_pembrolizumab cabozantinib_plus_nivolumab nivolumab_plus_ipilimumab 
Permutations before applying rule: 111 
Permutations after applying rule : 111 
[1] "tivozanib"
applying rule: tivozanib as 2L+ only allowed immediately after avelumab_plus_axitinib lenvatinib_plus_pembrolizumab cabozantinib_plus_nivolumab nivolumab_plus_ipilimumab 
Permutations before applying rule: 111 
Permutations after applying rule : 111 
Applying sequence restrictions to population 4 
Dropping drugs not allowed for this population.
applying rule: axitinib cabozantinib everolimus lenvatinib_plus_everolimus nivolumab_monotherapy pazopanib sunitinib tivozanib are only allowed treatments.
Permutations before applying rule: 26404 
Permutations after applying rule : 2080 
applying rule: drug line restrictions.
Permutations before applying rule: 2080 
Permutations after applying rule : 440 
[1] "axitinib"
applying rule. axitinib is only allowed after avelumab_plus_axitinib cabozantinib lenvatinib_plus_everolimus cabozantinib_plus_nivolumab pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 440 
Permutations after applying rule : 440 
[1] "everolimus"
applying rule. everolimus is only allowed after avelumab_plus_axitinib axitinib cabozantinib lenvatinib_plus_everolimus cabozantinib_plus_nivolumab pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 440 
Permutations after applying rule : 440 
[1] "lenvatinib_plus_everolimus"
applying rule. lenvatinib_plus_everolimus is not allowed immediately after nivolumab_plus_ipilimumab 
Permutations before applying rule: 440 
Permutations after applying rule : 440 
[1] "axitinib"
applying rule axitinib : avelumab_plus_axitinib axitinib cannot be in one permutation
Permutations before applying rule: 440 
Permutations after applying rule : 440 
[1] "everolimus"
applying rule everolimus : lenvatinib_plus_everolimus everolimus cannot be in one permutation
Permutations before applying rule: 440 
Permutations after applying rule : 384 
[1] "lenvatinib_plus_everolimus"
applying rule lenvatinib_plus_everolimus : lenvatinib_plus_everolimus lenvatinib_plus_pembrolizumab cannot be in one permutation
Permutations before applying rule: 384 
Permutations after applying rule : 384 
[1] "TKIs"
applying rule TKIs : sunitinib pazopanib tivozanib cannot be in one permutation
Permutations before applying rule: 384 
Permutations after applying rule : 198 
[1] "lenvatinib_plus_everolimus"
applying rule: lenvatinib_plus_everolimus can only be after ONE of axitinib cabozantinib pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 198 
Permutations after applying rule : 182 
[1] "cabozantinib"
applying rule: cabozantinib as 2L+ only allowed after avelumab_plus_axitinib axitinib lenvatinib_plus_everolimus cabozantinib_plus_nivolumab pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 182 
Permutations after applying rule : 182 
[1] "pazopanib"
applying rule: pazopanib as 2L+ only allowed immediately after avelumab_plus_axitinib lenvatinib_plus_pembrolizumab cabozantinib_plus_nivolumab nivolumab_plus_ipilimumab 
Permutations before applying rule: 182 
Permutations after applying rule : 182 
[1] "sunitinib"
applying rule: sunitinib as 2L+ only allowed immediately after avelumab_plus_axitinib lenvatinib_plus_pembrolizumab cabozantinib_plus_nivolumab nivolumab_plus_ipilimumab 
Permutations before applying rule: 182 
Permutations after applying rule : 182 
[1] "tivozanib"
applying rule: tivozanib as 2L+ only allowed immediately after avelumab_plus_axitinib lenvatinib_plus_pembrolizumab cabozantinib_plus_nivolumab nivolumab_plus_ipilimumab 
Permutations before applying rule: 182 
Permutations after applying rule : 182 </code></pre>
</div>
</div>
</div>
</div>
</div>
<p>SPLITMD_CODE1_END</p>
<p>SPLITMD_CODE2_START</p>
<p>This page performs a <strong>partitioned survival analysis</strong> on the patient-level data, which is <strong>real-world evidence (RWE)</strong> sent by the data owners for that observational study. The analysis is performed in order to <strong>extrapolate the survival curves</strong> so they cover the full time horizon of the economic model (40 years).</p>
</section>
</section>
<section id="import-patient-level-data" class="level2">
<h2 class="anchored" data-anchor-id="import-patient-level-data">Import patient-level data</h2>
<p>The patient-level data (or individual patient data (IPD)) is imported from <code>IPD_R_input_noACIC.xlsx</code>. This data has a row for each statement which states their population, line, treatment and trial, and then the time taken for them to experience an endpoint (e.g.&nbsp;overall survival) or be censored (i.e.&nbsp;stopped timing for some other reason). For more information, see the <a href="../../pages/input_data.html">Input data</a> page.</p>
<p>The data is imported using <code>f_excel_extract()</code> which produces the object <code>wb</code> which is a list with a single item: the table from the <code>IPD</code> sheet of the workbook. The code chunk converts this to a data table and filters it just the relevant columns.</p>
<p>As a survival time of 0 is not allowed, these are converted to 1 day (hence, <code>1/7</code> as the time unit of the analysis is weeks).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 3.3. Survival analysis -------------------------------------------------------</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="co"># All objects here go in i$surv initially, and are then streamlined down to </span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="co"># what's needed to run models in the transition from i to p.</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Some values of p are used during the below (primarily p$surv$distNames, which</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="co"># controls which distributions are included in the flexsurv runs)</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 3.3.1 Survival input structure ------------------------------------------</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a><span class="do">#### Read in survival data from Excel workbook </span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Pull out the raw data from the IPD excel book - one named range per treatment at each line</span></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Each reference curve is defined in Excel as time (weeks), event/censor (event coded as 1, censor as 0), patient group, line, molecule, trial and endpoint</span></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Pull all of the named ranges from the excel workbook, expand the parameters table</span></span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>excel_path2 <span class="ot">&lt;-</span> <span class="fu">file.path</span>(d_path, <span class="st">"IPD_R_input_noACIC.xlsx"</span>)</span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(excel_path2)) {</span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>  wb <span class="ot">&lt;-</span> <span class="fu">f_excel_extract</span>(excel_path2, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a>  i<span class="sc">$</span>surv<span class="sc">$</span>pld <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(wb<span class="sc">$</span><span class="st">`</span><span class="at">_xlnm._FilterDatabase</span><span class="st">`</span>)</span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(wb)</span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a>  wb <span class="ot">&lt;-</span> <span class="fu">f_excel_extract</span>(rstudioapi<span class="sc">::</span><span class="fu">selectFile</span>(</span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Select the IPD file (IPD_R_input_noACIC.xlsx)"</span>,</span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"IPD_R_input_noACIC.xlsx"</span>,</span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">path =</span> <span class="st">"./1_Data/"</span>,</span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">filter =</span> <span class="st">"Excel Files (*.xlsx)"</span>,</span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">existing =</span> <span class="cn">TRUE</span></span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a>  ), <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a>  i<span class="sc">$</span>surv<span class="sc">$</span>pld <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(wb<span class="sc">$</span><span class="st">`</span><span class="at">_xlnm._FilterDatabase</span><span class="st">`</span>)</span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-35"><a href="#cb52-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb52-36"><a href="#cb52-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-37"><a href="#cb52-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-38"><a href="#cb52-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Some small cleaning of the PLD.</span></span>
<span id="cb52-39"><a href="#cb52-39" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>pld <span class="ot">&lt;-</span> i<span class="sc">$</span>surv<span class="sc">$</span>pld[,<span class="fu">list</span>(population,line,molecule,trial,endpoint,timew,event_censor)]</span>
<span id="cb52-40"><a href="#cb52-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-41"><a href="#cb52-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Do not allow zero survival times, they have to be at least 1 day. the TUotA is</span></span>
<span id="cb52-42"><a href="#cb52-42" aria-hidden="true" tabindex="-1"></a><span class="co"># weeks, so 1 day is 1/7 weeks:</span></span>
<span id="cb52-43"><a href="#cb52-43" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>pld[timew <span class="sc">==</span><span class="dv">0</span>,<span class="st">"timew"</span>] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">7</span></span>
<span id="cb52-44"><a href="#cb52-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-45"><a href="#cb52-45" aria-hidden="true" tabindex="-1"></a><span class="co"># The named range r_pld has numeric identifiers for:</span></span>
<span id="cb52-46"><a href="#cb52-46" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb52-47"><a href="#cb52-47" aria-hidden="true" tabindex="-1"></a><span class="co"># - pop</span></span>
<span id="cb52-48"><a href="#cb52-48" aria-hidden="true" tabindex="-1"></a><span class="co"># - line</span></span>
<span id="cb52-49"><a href="#cb52-49" aria-hidden="true" tabindex="-1"></a><span class="co"># - mol (i.e., regimen - combination therapies are under the same number)</span></span>
<span id="cb52-50"><a href="#cb52-50" aria-hidden="true" tabindex="-1"></a><span class="co"># - trial (trial id WITHIN population line and molecule to set them apart from each other - usually just 1!)</span></span>
<span id="cb52-51"><a href="#cb52-51" aria-hidden="true" tabindex="-1"></a><span class="co"># - endpoint</span></span>
<span id="cb52-52"><a href="#cb52-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-53"><a href="#cb52-53" aria-hidden="true" tabindex="-1"></a><span class="co"># These numeric identifiers are then used to create a nested list of survival regression models and</span></span>
<span id="cb52-54"><a href="#cb52-54" aria-hidden="true" tabindex="-1"></a><span class="co"># extrapolations. The extrapolations are filtered down to the extrapolations that are selected</span></span>
<span id="cb52-55"><a href="#cb52-55" aria-hidden="true" tabindex="-1"></a><span class="co"># within the excel input sheet, but the rest are kept here in i in case of scenario analysis.</span></span>
<span id="cb52-56"><a href="#cb52-56" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb52-57"><a href="#cb52-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Note that the lookup tables in the next section are used to translate these numbers</span></span>
<span id="cb52-58"><a href="#cb52-58" aria-hidden="true" tabindex="-1"></a><span class="co"># into human-readable identifiers.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-9-contents" aria-controls="callout-9" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Preview <code>i$surv$pld</code>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-9" class="callout-9-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">head</span>(i<span class="sc">$</span>surv<span class="sc">$</span>pld))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">population</th>
<th style="text-align: right;">line</th>
<th style="text-align: right;">molecule</th>
<th style="text-align: right;">trial</th>
<th style="text-align: right;">endpoint</th>
<th style="text-align: right;">timew</th>
<th style="text-align: right;">event_censor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">205.28572</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">40.00357</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">145.42857</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">108.85714</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">86.85714</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">53.42857</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="create-look-ups-to-convert-between-numeric-categories-and-labels" class="level2">
<h2 class="anchored" data-anchor-id="create-look-ups-to-convert-between-numeric-categories-and-labels">Create look-ups to convert between numeric categories and labels</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 3.3.2 Data identification ------------------------------------------</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="co"># There is a lot of nesting involved in this part of the analysis, with population line, regimen trial and endpoint</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="co"># making a total of 5 layers of nesting to automatically go through each endpoint for each trial for</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="co"># each regimen for each line for each population, perform all regression analyses, produce parameters</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="co"># and have an easily identifiable (and therefore programmable) spaces for the results of each analysis</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="co"># which can then be spat out into reporting.</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a><span class="co"># The first step is to break up r_pld into separate datasets depending on the identifiers. A function</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="co"># is used to do this which returns nothing if such data for one id set doesn't exist. </span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Note that at this stage it is just those contexts which HAVE got PLD which are to be organised.</span></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a><span class="co"># For those endpoints and so on that do not have data, a separate step after this one to populate </span></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a><span class="co"># every endpoint for every treatment line for every treatment sequence is performed.</span></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>id<span class="sc">$</span>ipd <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">pop      =</span> i<span class="sc">$</span>r_pld_lookup_pop<span class="sc">$</span>Number[<span class="sc">!</span><span class="fu">is.na</span>(i<span class="sc">$</span>r_pld_lookup_pop<span class="sc">$</span>Number)],</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">line     =</span> i<span class="sc">$</span>r_pld_lookup_line<span class="sc">$</span>Number[<span class="sc">!</span><span class="fu">is.na</span>(i<span class="sc">$</span>r_pld_lookup_line<span class="sc">$</span>Number)],</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">mol      =</span> i<span class="sc">$</span>r_pld_lookup_mol<span class="sc">$</span>Number[<span class="sc">!</span><span class="fu">is.na</span>(i<span class="sc">$</span>r_pld_lookup_mol<span class="sc">$</span>Number)],</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">trial    =</span> i<span class="sc">$</span>r_pld_lookup_trial<span class="sc">$</span>Number[<span class="sc">!</span><span class="fu">is.na</span>(i<span class="sc">$</span>r_pld_lookup_trial<span class="sc">$</span>Number)],</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">endpoint =</span> i<span class="sc">$</span>r_pld_lookup_endpoint<span class="sc">$</span>Number[<span class="sc">!</span><span class="fu">is.na</span>(i<span class="sc">$</span>r_pld_lookup_endpoint<span class="sc">$</span>Number)]</span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(i<span class="sc">$</span>id<span class="sc">$</span>ipd<span class="sc">$</span>pop)      <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"pop_"</span>     , i<span class="sc">$</span>id<span class="sc">$</span>ipd<span class="sc">$</span>pop)</span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(i<span class="sc">$</span>id<span class="sc">$</span>ipd<span class="sc">$</span>line)     <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"line_"</span>    , i<span class="sc">$</span>id<span class="sc">$</span>ipd<span class="sc">$</span>line)</span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(i<span class="sc">$</span>id<span class="sc">$</span>ipd<span class="sc">$</span>mol)      <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"mol_"</span>     , i<span class="sc">$</span>id<span class="sc">$</span>ipd<span class="sc">$</span>mol)</span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(i<span class="sc">$</span>id<span class="sc">$</span>ipd<span class="sc">$</span>trial)    <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"trial_"</span>   , i<span class="sc">$</span>id<span class="sc">$</span>ipd<span class="sc">$</span>trial)</span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(i<span class="sc">$</span>id<span class="sc">$</span>ipd<span class="sc">$</span>endpoint) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"endpoint_"</span>, i<span class="sc">$</span>id<span class="sc">$</span>ipd<span class="sc">$</span>endpoint)</span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a><span class="co"># to see this, we have:</span></span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a><span class="co">#i$id$ipd</span></span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Generating the same structure but with the translation table from number to</span></span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a><span class="co"># text:</span></span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>lookup<span class="sc">$</span>ipd <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">pop      =</span> <span class="fu">data.table</span>(i<span class="sc">$</span>r_pld_lookup_pop)[Description <span class="sc">!=</span> <span class="dv">0</span>],</span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">line     =</span> <span class="fu">data.table</span>(i<span class="sc">$</span>r_pld_lookup_line)[Description <span class="sc">!=</span> <span class="dv">0</span>],</span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">mol      =</span> <span class="fu">data.table</span>(i<span class="sc">$</span>r_pld_lookup_mol)[Description <span class="sc">!=</span> <span class="dv">0</span>],</span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">trial    =</span> <span class="fu">data.table</span>(i<span class="sc">$</span>r_pld_lookup_trial)[Description <span class="sc">!=</span> <span class="dv">0</span>],</span>
<span id="cb54-42"><a href="#cb54-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">endpoint =</span> <span class="fu">data.table</span>(i<span class="sc">$</span>r_pld_lookup_endpoint)[Description <span class="sc">!=</span> <span class="dv">0</span>]</span>
<span id="cb54-43"><a href="#cb54-43" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb54-44"><a href="#cb54-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-45"><a href="#cb54-45" aria-hidden="true" tabindex="-1"></a><span class="co"># For treatment line, add a translator for the column in the sequences output:</span></span>
<span id="cb54-46"><a href="#cb54-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-47"><a href="#cb54-47" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>line<span class="sc">$</span>seq_col <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"V"</span>,<span class="dv">2</span><span class="sc">:</span>(<span class="fu">nrow</span>(i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>line)<span class="sc">+</span><span class="dv">1</span>))</span>
<span id="cb54-48"><a href="#cb54-48" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>line<span class="sc">$</span>R_id    <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"line_"</span>,<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>line))</span>
<span id="cb54-49"><a href="#cb54-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-50"><a href="#cb54-50" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>lookup<span class="sc">$</span>dist <span class="ot">&lt;-</span> i<span class="sc">$</span>r_pld_lookup_dist</span>
<span id="cb54-51"><a href="#cb54-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-52"><a href="#cb54-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-53"><a href="#cb54-53" aria-hidden="true" tabindex="-1"></a><span class="co"># This means that you can easily look up things like so:</span></span>
<span id="cb54-54"><a href="#cb54-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-55"><a href="#cb54-55" aria-hidden="true" tabindex="-1"></a><span class="co"># i$lookup$ipd$mol[Number == 1,list(Description,RCC_input_desc)]</span></span>
<span id="cb54-56"><a href="#cb54-56" aria-hidden="true" tabindex="-1"></a><span class="co"># i$lookup$ipd$mol[Number == 2,list(Description,RCC_input_desc)]</span></span>
<span id="cb54-57"><a href="#cb54-57" aria-hidden="true" tabindex="-1"></a><span class="co"># i$lookup$ipd$line[Number == 1,list(Description,RCC_input_desc)]</span></span>
<span id="cb54-58"><a href="#cb54-58" aria-hidden="true" tabindex="-1"></a><span class="co"># i$lookup$ipd$pop[Number == 0,list(Description,RCC_input_desc)]</span></span>
<span id="cb54-59"><a href="#cb54-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-60"><a href="#cb54-60" aria-hidden="true" tabindex="-1"></a><span class="co"># One can also do the opposite, translating input file descriptions into numbers:</span></span>
<span id="cb54-61"><a href="#cb54-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-62"><a href="#cb54-62" aria-hidden="true" tabindex="-1"></a><span class="co"># i$lookup$ipd$mol[RCC_input_desc == "ipi_nivo",list(Description,Number)]</span></span>
<span id="cb54-63"><a href="#cb54-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-64"><a href="#cb54-64" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>lookup<span class="sc">$</span>trt <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>mol<span class="sc">$</span>Number</span>
<span id="cb54-65"><a href="#cb54-65" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(i<span class="sc">$</span>lookup<span class="sc">$</span>trt) <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>mol<span class="sc">$</span>RCC_input_desc</span>
<span id="cb54-66"><a href="#cb54-66" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(i<span class="sc">$</span>lookup<span class="sc">$</span>trt)[<span class="fu">length</span>(i<span class="sc">$</span>lookup<span class="sc">$</span>trt)] <span class="ot">&lt;-</span> <span class="st">"BSC"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="further-pre-processing-before-survival-analysis" class="level2">
<h2 class="anchored" data-anchor-id="further-pre-processing-before-survival-analysis">Further pre-processing before survival analysis</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pass to p whenever i$lookup has been populated/updated.</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>basic<span class="sc">$</span>lookup <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>basic<span class="sc">$</span>id <span class="ot">&lt;-</span> i<span class="sc">$</span>id</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="co"># one can then simply i$lookup$trt["nivolumab"] or i$lookup$trt["sorafenib"] to </span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a><span class="co"># get the id numbers.</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a><span class="co"># This then means that one can translate the treatment sequence data generated earlier</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a><span class="co"># into numerical versions in one go:</span></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Start by making the id for population fit with the rest of the model (pop_ with pop</span></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a><span class="co"># starting from 0). </span><span class="al">NOTE</span><span class="co"> that there is 1 more population in treatment sequences than</span></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a><span class="co"># in the rest of the model...</span></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>seq_clean <span class="ot">&lt;-</span> <span class="fu">data.table</span>(i<span class="sc">$</span>sequences)</span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>seq_clean<span class="sc">$</span>V1 <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"pop_"</span>,<span class="fu">as.numeric</span>(<span class="fu">substr</span>(i<span class="sc">$</span>seq_clean<span class="sc">$</span>V1,<span class="dv">4</span>,<span class="dv">4</span>)) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>seq_pops <span class="ot">&lt;-</span> <span class="fu">unique</span>(i<span class="sc">$</span>seq_clean<span class="sc">$</span>V1)</span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(i<span class="sc">$</span>seq_pops) <span class="ot">&lt;-</span> i<span class="sc">$</span>seq_pops</span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a><span class="co"># The "clean" version of sequences - first with words, then with numbers, then references</span></span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>seq_clean <span class="ot">&lt;-</span> <span class="fu">lapply</span>(i<span class="sc">$</span>seq_pops, <span class="cf">function</span>(popu) {</span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a>  tmp <span class="ot">&lt;-</span> i<span class="sc">$</span>seq_clean[V1 <span class="sc">==</span> popu,<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(tmp) <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>line<span class="sc">$</span>R_id[<span class="dv">1</span><span class="sc">:</span>(p<span class="sc">$</span>basic<span class="sc">$</span>R_maxlines <span class="sc">+</span> <span class="dv">1</span>)]</span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a>  tmp</span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true" tabindex="-1"></a><span class="co"># It's pretty nested this but simplifies upon explanation: lapply on a data.frame</span></span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true" tabindex="-1"></a><span class="co"># or data.table goes column-wise, so going across columns substitute the values</span></span>
<span id="cb55-32"><a href="#cb55-32" aria-hidden="true" tabindex="-1"></a><span class="co"># for the values in i$lookup$trt which have corresponding names, returning the numbers</span></span>
<span id="cb55-33"><a href="#cb55-33" aria-hidden="true" tabindex="-1"></a><span class="co"># which are consistent throughout the model. The way of looking inside e.g. network</span></span>
<span id="cb55-34"><a href="#cb55-34" aria-hidden="true" tabindex="-1"></a><span class="co"># is e.g. pop_2$line_5$mol_2$endpoint_1, so now we can use the tables produced below</span></span>
<span id="cb55-35"><a href="#cb55-35" aria-hidden="true" tabindex="-1"></a><span class="co"># to "order" the inputs for a treatment pathway </span></span>
<span id="cb55-36"><a href="#cb55-36" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>seq_n <span class="ot">&lt;-</span> <span class="fu">lapply</span>(i<span class="sc">$</span>seq_clean, <span class="cf">function</span>(popu) {</span>
<span id="cb55-37"><a href="#cb55-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.table</span>(<span class="fu">lapply</span>(popu, <span class="cf">function</span>(co) i<span class="sc">$</span>lookup<span class="sc">$</span>trt[co]))</span>
<span id="cb55-38"><a href="#cb55-38" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb55-39"><a href="#cb55-39" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>seq_ref <span class="ot">&lt;-</span> <span class="fu">lapply</span>(i<span class="sc">$</span>seq_clean, <span class="cf">function</span>(popu) {</span>
<span id="cb55-40"><a href="#cb55-40" aria-hidden="true" tabindex="-1"></a>  tmp <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">lapply</span>(popu, <span class="cf">function</span>(co) {</span>
<span id="cb55-41"><a href="#cb55-41" aria-hidden="true" tabindex="-1"></a>    vals <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"mol_"</span>,i<span class="sc">$</span>lookup<span class="sc">$</span>trt[co])</span>
<span id="cb55-42"><a href="#cb55-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(vals <span class="sc">==</span> <span class="st">"mol_NA"</span>,<span class="cn">NA</span>,vals)</span>
<span id="cb55-43"><a href="#cb55-43" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb55-44"><a href="#cb55-44" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb55-45"><a href="#cb55-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-46"><a href="#cb55-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-47"><a href="#cb55-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Now that we have the final sequence list, we can add them to p:</span></span>
<span id="cb55-48"><a href="#cb55-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-49"><a href="#cb55-49" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>seq<span class="sc">$</span>n   <span class="ot">&lt;-</span> i<span class="sc">$</span>seq_n</span>
<span id="cb55-50"><a href="#cb55-50" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>seq<span class="sc">$</span>ref <span class="ot">&lt;-</span> i<span class="sc">$</span>seq_ref</span>
<span id="cb55-51"><a href="#cb55-51" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>seq<span class="sc">$</span>qc <span class="ot">&lt;-</span> i<span class="sc">$</span>seq_clean</span>
<span id="cb55-52"><a href="#cb55-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-53"><a href="#cb55-53" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: QC check here is for NAs that are not beyond a 999 (i.e. past BSC)</span></span>
<span id="cb55-54"><a href="#cb55-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-55"><a href="#cb55-55" aria-hidden="true" tabindex="-1"></a><span class="co"># We now have all the treatment sequences in the form of the molecule</span></span>
<span id="cb55-56"><a href="#cb55-56" aria-hidden="true" tabindex="-1"></a><span class="co"># number and the consistent reference linking right back to the named range</span></span>
<span id="cb55-57"><a href="#cb55-57" aria-hidden="true" tabindex="-1"></a><span class="co"># r_pld_lookup_mol in the excel front end. This ensures that the R model is</span></span>
<span id="cb55-58"><a href="#cb55-58" aria-hidden="true" tabindex="-1"></a><span class="co"># consistent with the R model in terms of which drugs are feeding through</span></span>
<span id="cb55-59"><a href="#cb55-59" aria-hidden="true" tabindex="-1"></a><span class="co"># to different places, as manually checking that is a very difficult and time </span></span>
<span id="cb55-60"><a href="#cb55-60" aria-hidden="true" tabindex="-1"></a><span class="co"># consuming task.</span></span>
<span id="cb55-61"><a href="#cb55-61" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb55-62"><a href="#cb55-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Long story short:</span></span>
<span id="cb55-63"><a href="#cb55-63" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb55-64"><a href="#cb55-64" aria-hidden="true" tabindex="-1"></a><span class="co">#  - i$seq_clean: names of treatments per excel front end in order for all populations. use i$lookup$ipd$mol as reference table.</span></span>
<span id="cb55-65"><a href="#cb55-65" aria-hidden="true" tabindex="-1"></a><span class="co">#  - i$seq_n: corresponding treatment numbers per named range r_pld_lookup_mol in excel</span></span>
<span id="cb55-66"><a href="#cb55-66" aria-hidden="true" tabindex="-1"></a><span class="co">#  - i$seq_ref: reference name for pulling things out of R lists (e.g. p$drug[unlist(i$seq_ref$pop_0[1,])]) pulls pop 0 first sequence drug info IN ORDER :)</span></span>
<span id="cb55-67"><a href="#cb55-67" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb55-68"><a href="#cb55-68" aria-hidden="true" tabindex="-1"></a><span class="co"># This is automatically in line with the reference tables in the excel front end</span></span>
<span id="cb55-69"><a href="#cb55-69" aria-hidden="true" tabindex="-1"></a><span class="co"># loaded at the time. If the ordering is changed there it needs updating in the IPD</span></span>
<span id="cb55-70"><a href="#cb55-70" aria-hidden="true" tabindex="-1"></a><span class="co"># and in the lookup tables in the lists sheet of excel (and throughout excel!)</span></span>
<span id="cb55-71"><a href="#cb55-71" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb55-72"><a href="#cb55-72" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb55-73"><a href="#cb55-73" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb55-74"><a href="#cb55-74" aria-hidden="true" tabindex="-1"></a><span class="co"># i.e, if Excel lookup tables are wrong, this will be wrong!!!</span></span>
<span id="cb55-75"><a href="#cb55-75" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb55-76"><a href="#cb55-76" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb55-77"><a href="#cb55-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-78"><a href="#cb55-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-79"><a href="#cb55-79" aria-hidden="true" tabindex="-1"></a><span class="co"># 3.3.3 TSD14 survival analysis ------------------------------------------</span></span>
<span id="cb55-80"><a href="#cb55-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-81"><a href="#cb55-81" aria-hidden="true" tabindex="-1"></a><span class="co"># Now that treatment sequences are brought in and cleaned up ready for use, we</span></span>
<span id="cb55-82"><a href="#cb55-82" aria-hidden="true" tabindex="-1"></a><span class="co"># can perform the survival analysis.</span></span>
<span id="cb55-83"><a href="#cb55-83" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb55-84"><a href="#cb55-84" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the function in Survival_functions.R to perform "simple" extrapolations</span></span>
<span id="cb55-85"><a href="#cb55-85" aria-hidden="true" tabindex="-1"></a><span class="co"># on all pop line mol trial endpoint combinations with available data and return</span></span>
<span id="cb55-86"><a href="#cb55-86" aria-hidden="true" tabindex="-1"></a><span class="co"># NULL for the rest</span></span>
<span id="cb55-87"><a href="#cb55-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-88"><a href="#cb55-88" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's  perform some labelling like we did for treatment sequences for convenience/QC</span></span>
<span id="cb55-89"><a href="#cb55-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-90"><a href="#cb55-90" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb55-91"><a href="#cb55-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-92"><a href="#cb55-92" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>population <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>pop<span class="sc">$</span>Number</span>
<span id="cb55-93"><a href="#cb55-93" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>population) <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>pop<span class="sc">$</span>Description</span>
<span id="cb55-94"><a href="#cb55-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-95"><a href="#cb55-95" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>line <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>line<span class="sc">$</span>Number</span>
<span id="cb55-96"><a href="#cb55-96" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>line) <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>line<span class="sc">$</span>Description</span>
<span id="cb55-97"><a href="#cb55-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-98"><a href="#cb55-98" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>molecule <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>mol<span class="sc">$</span>Number</span>
<span id="cb55-99"><a href="#cb55-99" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>molecule) <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>mol<span class="sc">$</span>Description</span>
<span id="cb55-100"><a href="#cb55-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-101"><a href="#cb55-101" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>trial <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>trial<span class="sc">$</span>Number</span>
<span id="cb55-102"><a href="#cb55-102" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>trial) <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>trial<span class="sc">$</span>Description</span>
<span id="cb55-103"><a href="#cb55-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-104"><a href="#cb55-104" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>endpoint <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>endpoint<span class="sc">$</span>Number</span>
<span id="cb55-105"><a href="#cb55-105" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>endpoint) <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>endpoint<span class="sc">$</span>Description</span>
<span id="cb55-106"><a href="#cb55-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-107"><a href="#cb55-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-108"><a href="#cb55-108" aria-hidden="true" tabindex="-1"></a><span class="co"># Now, put the data in a space and replace numbers with labels:</span></span>
<span id="cb55-109"><a href="#cb55-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-110"><a href="#cb55-110" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>dat <span class="ot">&lt;-</span> i<span class="sc">$</span>surv<span class="sc">$</span>pld</span>
<span id="cb55-111"><a href="#cb55-111" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>dat<span class="sc">$</span>population <span class="ot">&lt;-</span> <span class="fu">names</span>(i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>population)[<span class="fu">match</span>(i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>dat<span class="sc">$</span>population,i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>population)]</span>
<span id="cb55-112"><a href="#cb55-112" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>dat<span class="sc">$</span>line       <span class="ot">&lt;-</span> <span class="fu">names</span>(i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>line)[<span class="fu">match</span>(i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>dat<span class="sc">$</span>line,i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>line)]</span>
<span id="cb55-113"><a href="#cb55-113" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>dat<span class="sc">$</span>molecule   <span class="ot">&lt;-</span> <span class="fu">names</span>(i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>molecule)[<span class="fu">match</span>(i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>dat<span class="sc">$</span>molecule,i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>molecule)]</span>
<span id="cb55-114"><a href="#cb55-114" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>dat<span class="sc">$</span>trial      <span class="ot">&lt;-</span> <span class="fu">names</span>(i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>trial)[<span class="fu">match</span>(i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>dat<span class="sc">$</span>trial,i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>trial)]</span>
<span id="cb55-115"><a href="#cb55-115" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>dat<span class="sc">$</span>endpoint   <span class="ot">&lt;-</span> <span class="fu">names</span>(i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>endpoint)[<span class="fu">match</span>(i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>dat<span class="sc">$</span>endpoint,i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>endpoint)]</span>
<span id="cb55-116"><a href="#cb55-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-117"><a href="#cb55-117" aria-hidden="true" tabindex="-1"></a><span class="co"># Now we have a labelled version which is a bit easier to QC.</span></span>
<span id="cb55-118"><a href="#cb55-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-119"><a href="#cb55-119" aria-hidden="true" tabindex="-1"></a><span class="co"># Note to debug it is very helpful to set verbose to TRUE below so that you can identify</span></span>
<span id="cb55-120"><a href="#cb55-120" aria-hidden="true" tabindex="-1"></a><span class="co"># the datasets which are problematic (e.g. not converging, 0 time values)</span></span>
<span id="cb55-121"><a href="#cb55-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-122"><a href="#cb55-122" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>n_by_plmte <span class="ot">&lt;-</span> i<span class="sc">$</span>surv<span class="sc">$</span>pld[, .N, by <span class="ot">=</span> <span class="fu">list</span>(population, line,molecule,trial,endpoint)] <span class="sc">%&gt;%</span></span>
<span id="cb55-123"><a href="#cb55-123" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(population,line, molecule,trial,endpoint)</span>
<span id="cb55-124"><a href="#cb55-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-125"><a href="#cb55-125" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>n_by_plmte<span class="sc">$</span>population <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>pop[<span class="fu">match</span>(i<span class="sc">$</span>surv<span class="sc">$</span>n_by_plmte<span class="sc">$</span>population       ,i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>pop<span class="sc">$</span>Number),Description]</span>
<span id="cb55-126"><a href="#cb55-126" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>n_by_plmte<span class="sc">$</span>line       <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>line[<span class="fu">match</span>(i<span class="sc">$</span>surv<span class="sc">$</span>n_by_plmte<span class="sc">$</span>line       ,i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>line<span class="sc">$</span>Number),Description]</span>
<span id="cb55-127"><a href="#cb55-127" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>n_by_plmte<span class="sc">$</span>molecule   <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>mol[<span class="fu">match</span>(i<span class="sc">$</span>surv<span class="sc">$</span>n_by_plmte<span class="sc">$</span>molecule       ,i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>mol<span class="sc">$</span>Number),Description]</span>
<span id="cb55-128"><a href="#cb55-128" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>n_by_plmte<span class="sc">$</span>molecule[<span class="fu">which</span>(<span class="fu">is.na</span>(i<span class="sc">$</span>surv<span class="sc">$</span>n_by_plmte<span class="sc">$</span>molecule))]   <span class="ot">&lt;-</span> <span class="st">"Non-UK treatments (pooled)"</span></span>
<span id="cb55-129"><a href="#cb55-129" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>n_by_plmte<span class="sc">$</span>trial      <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>trial[<span class="fu">match</span>(i<span class="sc">$</span>surv<span class="sc">$</span>n_by_plmte<span class="sc">$</span>trial       ,i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>trial<span class="sc">$</span>Number),Description]</span>
<span id="cb55-130"><a href="#cb55-130" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>n_by_plmte<span class="sc">$</span>endpoint   <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>endpoint[<span class="fu">match</span>(i<span class="sc">$</span>surv<span class="sc">$</span>n_by_plmte<span class="sc">$</span>endpoint       ,i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>endpoint<span class="sc">$</span>Number),Description]</span>
<span id="cb55-131"><a href="#cb55-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-132"><a href="#cb55-132" aria-hidden="true" tabindex="-1"></a><span class="co"># The number of rows in this table is the number of SETS of regression analyses</span></span>
<span id="cb55-133"><a href="#cb55-133" aria-hidden="true" tabindex="-1"></a><span class="co"># that are going to be run (each is 7 regressions)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="run-model" class="level2">
<h2 class="anchored" data-anchor-id="run-model">Run model</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The below code runs the survival analysis and saves as an RDS file for upload, this will only run if you set </span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="co"># i$dd_run_surv_reg to "Yes" either in the Excel input or here</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (i<span class="sc">$</span>dd_run_surv_reg <span class="sc">==</span> <span class="st">"Yes"</span>) {</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>  i<span class="sc">$</span>surv<span class="sc">$</span>reg <span class="ot">&lt;-</span> <span class="fu">f_surv_runAllTSD14</span>(</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">r_pld             =</span> i<span class="sc">$</span>surv<span class="sc">$</span>pld,</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">id                =</span> i<span class="sc">$</span>id<span class="sc">$</span>ipd,</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">lookups           =</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd,</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">draw_plots        =</span> <span class="cn">FALSE</span>,</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">distnames         =</span> i<span class="sc">$</span>distnames,</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">cl_y              =</span> p<span class="sc">$</span>basic<span class="sc">$</span>cl_y,</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">t_cyc             =</span> p<span class="sc">$</span>basic<span class="sc">$</span>t_cyc,</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlim_survplots_yr =</span> p<span class="sc">$</span>misc<span class="sc">$</span>plot<span class="sc">$</span>xlim_survplots_yr,</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">t_yr              =</span> p<span class="sc">$</span>basic<span class="sc">$</span>t_yr,</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose           =</span> qc_mode,</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_obs           =</span> <span class="dv">28</span></span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># now, there is very little information available on BSC overall survival,</span></span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># for those people that decide they do not want further treatment</span></span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">#</span></span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The best data available currently is pooled PPS data on 4L patients, these</span></span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># are then 5L+ patients and given that there are currently 4 lines of therapy</span></span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># the proportion that receive something active subsequently is likely to be</span></span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># small. Consequently, this is likely a pooled analysis which can inform</span></span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># early (and 5L) BSC OVERALL SURVIVAL.</span></span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a>  <span class="co">#</span></span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Therefore the molecule 999 4th line PPS should be informed by a pooled analysis</span></span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># of all molecules' PPS at 4th line. That is, i$surv$pld[line == 4 &amp; trial == 2 &amp; endpoint == 4,]</span></span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># is the data that should inform endpoint 0 for all BSC.</span></span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># MANUALLY RUN SURVIVAL FOR BSC PPS AS POOLED!!!</span></span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-35"><a href="#cb56-35" aria-hidden="true" tabindex="-1"></a>  i<span class="sc">$</span>surv<span class="sc">$</span>reg<span class="sc">$</span>pop_0<span class="sc">$</span>line_4<span class="sc">$</span>mol_999<span class="sc">$</span>trial_2<span class="sc">$</span>endpoint_4 <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">1</span>,<span class="cf">function</span>(x) {</span>
<span id="cb56-36"><a href="#cb56-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-37"><a href="#cb56-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter down to the parameters above associated with this combination:</span></span>
<span id="cb56-38"><a href="#cb56-38" aria-hidden="true" tabindex="-1"></a>    ipd <span class="ot">&lt;-</span> i<span class="sc">$</span>surv<span class="sc">$</span>pld[line<span class="sc">==</span><span class="dv">4</span> <span class="sc">&amp;</span> endpoint<span class="sc">==</span><span class="dv">4</span>,<span class="fu">list</span>(timew,event_censor)]</span>
<span id="cb56-39"><a href="#cb56-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-40"><a href="#cb56-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(ipd) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"t"</span>,<span class="st">"e"</span>)</span>
<span id="cb56-41"><a href="#cb56-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-42"><a href="#cb56-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">paste0</span>(</span>
<span id="cb56-43"><a href="#cb56-43" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Survival analysis - population: "</span>, i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>pop[Number      <span class="sc">==</span> <span class="dv">0</span>, Description],</span>
<span id="cb56-44"><a href="#cb56-44" aria-hidden="true" tabindex="-1"></a>      <span class="st">"</span><span class="sc">\t</span><span class="st"> line: "</span>                       , i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>line[Number     <span class="sc">==</span> <span class="dv">4</span>, Description],</span>
<span id="cb56-45"><a href="#cb56-45" aria-hidden="true" tabindex="-1"></a>      <span class="st">"</span><span class="sc">\t</span><span class="st"> molecule: "</span>                   , i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>mol[Number     <span class="sc">==</span> <span class="dv">999</span>, Description],</span>
<span id="cb56-46"><a href="#cb56-46" aria-hidden="true" tabindex="-1"></a>      <span class="st">"</span><span class="sc">\t</span><span class="st"> trial: "</span>                      , i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>trial[Number     <span class="sc">==</span> <span class="dv">2</span>, Description],</span>
<span id="cb56-47"><a href="#cb56-47" aria-hidden="true" tabindex="-1"></a>      <span class="st">"</span><span class="sc">\t</span><span class="st"> endpoint: "</span>                   , i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>endpoint[Number <span class="sc">==</span> <span class="dv">4</span>, Description], <span class="st">"</span><span class="sc">\n</span><span class="st">"</span></span>
<span id="cb56-48"><a href="#cb56-48" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb56-49"><a href="#cb56-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-50"><a href="#cb56-50" aria-hidden="true" tabindex="-1"></a>    fs_fits <span class="ot">&lt;-</span> <span class="fu">lapply</span>(i<span class="sc">$</span>distnames, <span class="cf">function</span>(dist) {  <span class="co"># applying all parametric survival curves in the list of distNames</span></span>
<span id="cb56-51"><a href="#cb56-51" aria-hidden="true" tabindex="-1"></a>      fs_fit <span class="ot">&lt;-</span> <span class="fu">flexsurvreg</span>(</span>
<span id="cb56-52"><a href="#cb56-52" aria-hidden="true" tabindex="-1"></a>        <span class="at">formula =</span> <span class="fu">Surv</span>(t, e) <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb56-53"><a href="#cb56-53" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> ipd,</span>
<span id="cb56-54"><a href="#cb56-54" aria-hidden="true" tabindex="-1"></a>        <span class="at">dist =</span> dist</span>
<span id="cb56-55"><a href="#cb56-55" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb56-56"><a href="#cb56-56" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb56-57"><a href="#cb56-57" aria-hidden="true" tabindex="-1"></a>        <span class="at">coefs =</span> <span class="fu">coefficients</span>(fs_fit),                                         <span class="co"># coefficients for the fitted model</span></span>
<span id="cb56-58"><a href="#cb56-58" aria-hidden="true" tabindex="-1"></a>        <span class="at">vcov  =</span> <span class="fu">vcov</span>(fs_fit),                                                 <span class="co"># variance covariance matrix for the fitted model</span></span>
<span id="cb56-59"><a href="#cb56-59" aria-hidden="true" tabindex="-1"></a>        <span class="at">fit   =</span> <span class="fu">c</span>(<span class="at">AIC=</span> <span class="fu">AIC</span>(fs_fit), <span class="at">BIC=</span><span class="fu">BIC</span>(fs_fit), <span class="at">logLik =</span> <span class="fu">logLik</span>(fs_fit)) <span class="co"># goodness of fit statistics for the fitted model</span></span>
<span id="cb56-60"><a href="#cb56-60" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb56-61"><a href="#cb56-61" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb56-62"><a href="#cb56-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-63"><a href="#cb56-63" aria-hidden="true" tabindex="-1"></a>    gof <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(i<span class="sc">$</span>distnames, <span class="cf">function</span>(dist) fs_fits[[dist]]<span class="sc">$</span>fit))</span>
<span id="cb56-64"><a href="#cb56-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-65"><a href="#cb56-65" aria-hidden="true" tabindex="-1"></a>    st <span class="ot">&lt;-</span> <span class="fu">matrix</span>(</span>
<span id="cb56-66"><a href="#cb56-66" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unlist</span>(<span class="fu">lapply</span>(i<span class="sc">$</span>distnames, <span class="cf">function</span>(dist) {</span>
<span id="cb56-67"><a href="#cb56-67" aria-hidden="true" tabindex="-1"></a>        <span class="fu">f_extrapolate</span>(p<span class="sc">$</span>basic<span class="sc">$</span>t_cyc, fs_fits[[dist]]<span class="sc">$</span>coefs, dist)</span>
<span id="cb56-68"><a href="#cb56-68" aria-hidden="true" tabindex="-1"></a>      })),</span>
<span id="cb56-69"><a href="#cb56-69" aria-hidden="true" tabindex="-1"></a>      <span class="at">ncol =</span> <span class="fu">length</span>(i<span class="sc">$</span>distnames),</span>
<span id="cb56-70"><a href="#cb56-70" aria-hidden="true" tabindex="-1"></a>      <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="cn">NULL</span>, i<span class="sc">$</span>distnames),</span>
<span id="cb56-71"><a href="#cb56-71" aria-hidden="true" tabindex="-1"></a>      <span class="at">byrow =</span> <span class="cn">FALSE</span></span>
<span id="cb56-72"><a href="#cb56-72" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-73"><a href="#cb56-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-74"><a href="#cb56-74" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-75"><a href="#cb56-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># curly braces on their own mean do this stuff and only return the last thing</span></span>
<span id="cb56-76"><a href="#cb56-76" aria-hidden="true" tabindex="-1"></a>    <span class="co"># or what's in a return call</span></span>
<span id="cb56-77"><a href="#cb56-77" aria-hidden="true" tabindex="-1"></a>    plot <span class="ot">&lt;-</span> {</span>
<span id="cb56-78"><a href="#cb56-78" aria-hidden="true" tabindex="-1"></a>      <span class="co"># First the IPD is produced in a format that survminer will accept. Data must all be</span></span>
<span id="cb56-79"><a href="#cb56-79" aria-hidden="true" tabindex="-1"></a>      <span class="co"># the same format with the same column names.</span></span>
<span id="cb56-80"><a href="#cb56-80" aria-hidden="true" tabindex="-1"></a>      <span class="co"># this assumes no covariate adjustment</span></span>
<span id="cb56-81"><a href="#cb56-81" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb56-82"><a href="#cb56-82" aria-hidden="true" tabindex="-1"></a>      sm_ipd <span class="ot">&lt;-</span> <span class="fu">f_ce_km_MakeDatSurvFriendly</span>(</span>
<span id="cb56-83"><a href="#cb56-83" aria-hidden="true" tabindex="-1"></a>        <span class="at">Data_required =</span> ipd,</span>
<span id="cb56-84"><a href="#cb56-84" aria-hidden="true" tabindex="-1"></a>        <span class="at">time_column   =</span> <span class="st">"t"</span>,                 <span class="co"># note that this is taking IPD in weeks</span></span>
<span id="cb56-85"><a href="#cb56-85" aria-hidden="true" tabindex="-1"></a>        <span class="at">event_column  =</span> <span class="st">"e"</span>,</span>
<span id="cb56-86"><a href="#cb56-86" aria-hidden="true" tabindex="-1"></a>        <span class="at">t_multiplier  =</span> p<span class="sc">$</span>basic<span class="sc">$</span>cl_y             <span class="co"># data in weeks, cycle length in plot years</span></span>
<span id="cb56-87"><a href="#cb56-87" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb56-88"><a href="#cb56-88" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb56-89"><a href="#cb56-89" aria-hidden="true" tabindex="-1"></a>      <span class="co"># get the survival analysis in the form we need for survminer</span></span>
<span id="cb56-90"><a href="#cb56-90" aria-hidden="true" tabindex="-1"></a>      <span class="co"># and make the extrapolations we need for survminer</span></span>
<span id="cb56-91"><a href="#cb56-91" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb56-92"><a href="#cb56-92" aria-hidden="true" tabindex="-1"></a>      form          <span class="ot">&lt;-</span> <span class="fu">Surv</span>(t, ec) <span class="sc">~</span> <span class="dv">1</span></span>
<span id="cb56-93"><a href="#cb56-93" aria-hidden="true" tabindex="-1"></a>      sm_surv_est   <span class="ot">&lt;-</span> <span class="fu">surv_fit</span>(<span class="at">formula =</span> form, <span class="at">data =</span> sm_ipd)</span>
<span id="cb56-94"><a href="#cb56-94" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb56-95"><a href="#cb56-95" aria-hidden="true" tabindex="-1"></a>      <span class="co"># make the plot with the input data:</span></span>
<span id="cb56-96"><a href="#cb56-96" aria-hidden="true" tabindex="-1"></a>      survival_plot <span class="ot">&lt;-</span> <span class="fu">suppressMessages</span>(<span class="fu">f_extrap_plot</span>(</span>
<span id="cb56-97"><a href="#cb56-97" aria-hidden="true" tabindex="-1"></a>        <span class="at">SurvEstimate   =</span> sm_surv_est,</span>
<span id="cb56-98"><a href="#cb56-98" aria-hidden="true" tabindex="-1"></a>        <span class="at">Data_required  =</span> sm_ipd,</span>
<span id="cb56-99"><a href="#cb56-99" aria-hidden="true" tabindex="-1"></a>        <span class="at">curvefits_data =</span> st,</span>
<span id="cb56-100"><a href="#cb56-100" aria-hidden="true" tabindex="-1"></a>        <span class="at">time_vector    =</span> p<span class="sc">$</span>basic<span class="sc">$</span>t_yr,</span>
<span id="cb56-101"><a href="#cb56-101" aria-hidden="true" tabindex="-1"></a>        <span class="at">xlim           =</span> p<span class="sc">$</span>misc<span class="sc">$</span>plot<span class="sc">$</span>xlim_survplots_yr,   <span class="do">#### this will need replacing dependent on how many years we decide to show per time horizon</span></span>
<span id="cb56-102"><a href="#cb56-102" aria-hidden="true" tabindex="-1"></a>        <span class="at">break_by       =</span> <span class="fu">round</span>(<span class="dv">20</span><span class="sc">/</span><span class="dv">8</span>,<span class="dv">0</span>) <span class="do">#### this will need replacing dependent on how many years we decide to show per time horizon</span></span>
<span id="cb56-103"><a href="#cb56-103" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb56-104"><a href="#cb56-104" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(</span>
<span id="cb56-105"><a href="#cb56-105" aria-hidden="true" tabindex="-1"></a>        <span class="at">ipd     =</span> sm_ipd,</span>
<span id="cb56-106"><a href="#cb56-106" aria-hidden="true" tabindex="-1"></a>        <span class="at">formula =</span> form,</span>
<span id="cb56-107"><a href="#cb56-107" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot    =</span> survival_plot</span>
<span id="cb56-108"><a href="#cb56-108" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb56-109"><a href="#cb56-109" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb56-110"><a href="#cb56-110" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-111"><a href="#cb56-111" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-112"><a href="#cb56-112" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Now that we've done everything for this dataset, return a list of the stuff</span></span>
<span id="cb56-113"><a href="#cb56-113" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we need for it:</span></span>
<span id="cb56-114"><a href="#cb56-114" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb56-115"><a href="#cb56-115" aria-hidden="true" tabindex="-1"></a>      <span class="at">pop      =</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>pop[     Number <span class="sc">==</span> <span class="dv">0</span>,Description],</span>
<span id="cb56-116"><a href="#cb56-116" aria-hidden="true" tabindex="-1"></a>      <span class="at">line     =</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>line[    Number <span class="sc">==</span> <span class="dv">4</span>,Description],</span>
<span id="cb56-117"><a href="#cb56-117" aria-hidden="true" tabindex="-1"></a>      <span class="at">mol      =</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>mol[     Number <span class="sc">==</span> <span class="dv">999</span>,Description],</span>
<span id="cb56-118"><a href="#cb56-118" aria-hidden="true" tabindex="-1"></a>      <span class="at">tr       =</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>trial[     Number <span class="sc">==</span> <span class="dv">2</span>,Description],</span>
<span id="cb56-119"><a href="#cb56-119" aria-hidden="true" tabindex="-1"></a>      <span class="at">endpoint =</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>endpoint[Number <span class="sc">==</span> <span class="dv">4</span>,Description],</span>
<span id="cb56-120"><a href="#cb56-120" aria-hidden="true" tabindex="-1"></a>      <span class="at">ipd      =</span> ipd,</span>
<span id="cb56-121"><a href="#cb56-121" aria-hidden="true" tabindex="-1"></a>      <span class="at">fs_fits  =</span> fs_fits,</span>
<span id="cb56-122"><a href="#cb56-122" aria-hidden="true" tabindex="-1"></a>      <span class="at">gof      =</span> gof,</span>
<span id="cb56-123"><a href="#cb56-123" aria-hidden="true" tabindex="-1"></a>      <span class="at">st       =</span> st,</span>
<span id="cb56-124"><a href="#cb56-124" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot     =</span> plot</span>
<span id="cb56-125"><a href="#cb56-125" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb56-126"><a href="#cb56-126" aria-hidden="true" tabindex="-1"></a>  })[[<span class="dv">1</span>]]</span>
<span id="cb56-127"><a href="#cb56-127" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-128"><a href="#cb56-128" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(i<span class="sc">$</span>surv<span class="sc">$</span>reg, <span class="at">file =</span> <span class="fu">file.path</span>(d_path, <span class="st">"Survival_analysis.rds"</span>))</span>
<span id="cb56-129"><a href="#cb56-129" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-130"><a href="#cb56-130" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="load-pre-run-survival-analysis" class="level2">
<h2 class="anchored" data-anchor-id="load-pre-run-survival-analysis">Load pre-run survival analysis</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># to load in pre-run survival analysis select the RDS file here</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="co"># option to load from pre-specified file path on local machine, uncomment this and comment out the line below to use</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>RDS_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(d_path, <span class="st">"survival_analysis_no_ipd_CompanyTTDTTPPPS_redacted.rds"</span>)</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(RDS_path)) {</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>  i<span class="sc">$</span>surv<span class="sc">$</span>reg <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(RDS_path)</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>  i<span class="sc">$</span>surv<span class="sc">$</span>reg <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(rstudioapi<span class="sc">::</span><span class="fu">selectFile</span>(</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Please select 'Survival_analysis_noTTDorTTPorPPS[NoACIC].rds'"</span>,</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Survival_analysis_noTTDorTTPorPPS[NoACIC].rds"</span>,</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">path =</span> <span class="st">"./1_Data/"</span>,</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">filter =</span> <span class="st">"R Files (*.rds)"</span>,</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">existing =</span> <span class="cn">TRUE</span></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Limit to model time horizon</span></span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>TH <span class="ot">&lt;-</span> p<span class="sc">$</span>basic<span class="sc">$</span>th <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>reg <span class="ot">&lt;-</span><span class="fu">lapply</span>(i<span class="sc">$</span>surv<span class="sc">$</span>reg, <span class="cf">function</span>(popu) {</span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(popu, <span class="cf">function</span>(li) {</span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapply</span>(li, <span class="cf">function</span>(mol) {</span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">lapply</span>(mol, <span class="cf">function</span>(tr) {</span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lapply</span>(tr, <span class="cf">function</span>(endp) {</span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (<span class="fu">is.null</span>(endp<span class="sc">$</span>st)) {</span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(endp)</span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> {</span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a>            endp<span class="sc">$</span>st <span class="ot">&lt;-</span> endp<span class="sc">$</span>st[<span class="dv">1</span><span class="sc">:</span>TH,]</span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(endp)</span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb57-34"><a href="#cb57-34" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb57-35"><a href="#cb57-35" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb57-36"><a href="#cb57-36" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb57-37"><a href="#cb57-37" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb57-38"><a href="#cb57-38" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb57-39"><a href="#cb57-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-40"><a href="#cb57-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-41"><a href="#cb57-41" aria-hidden="true" tabindex="-1"></a><span class="co"># !!!!!!</span></span>
<span id="cb57-42"><a href="#cb57-42" aria-hidden="true" tabindex="-1"></a><span class="co"># !!!!!!</span></span>
<span id="cb57-43"><a href="#cb57-43" aria-hidden="true" tabindex="-1"></a><span class="co"># !!!!!!</span></span>
<span id="cb57-44"><a href="#cb57-44" aria-hidden="true" tabindex="-1"></a><span class="co"># !!!!!!</span></span>
<span id="cb57-45"><a href="#cb57-45" aria-hidden="true" tabindex="-1"></a><span class="co"># !!!!!!</span></span>
<span id="cb57-46"><a href="#cb57-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: i$surv$reg$pop_0$line_4$mol_999$trial_2$endpoint_4 is used</span></span>
<span id="cb57-47"><a href="#cb57-47" aria-hidden="true" tabindex="-1"></a><span class="co"># to inform ALL BSC OS. This will be decided in the EXCEL FILE, which </span></span>
<span id="cb57-48"><a href="#cb57-48" aria-hidden="true" tabindex="-1"></a><span class="co"># dropdowns for BSC OS should link to 4L PPS for mol 999</span></span>
<span id="cb57-49"><a href="#cb57-49" aria-hidden="true" tabindex="-1"></a><span class="co"># !!!!!!</span></span>
<span id="cb57-50"><a href="#cb57-50" aria-hidden="true" tabindex="-1"></a><span class="co"># !!!!!!</span></span>
<span id="cb57-51"><a href="#cb57-51" aria-hidden="true" tabindex="-1"></a><span class="co"># !!!!!!</span></span>
<span id="cb57-52"><a href="#cb57-52" aria-hidden="true" tabindex="-1"></a><span class="co"># !!!!!!</span></span>
<span id="cb57-53"><a href="#cb57-53" aria-hidden="true" tabindex="-1"></a><span class="co"># !!!!!!</span></span>
<span id="cb57-54"><a href="#cb57-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-55"><a href="#cb57-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-56"><a href="#cb57-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-57"><a href="#cb57-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Note that draw_plots will be a switch in the shiny application.</span></span>
<span id="cb57-58"><a href="#cb57-58" aria-hidden="true" tabindex="-1"></a><span class="co"># In this case we draw plots because we need those plots later (for word output</span></span>
<span id="cb57-59"><a href="#cb57-59" aria-hidden="true" tabindex="-1"></a><span class="co"># assisting with model selection)</span></span>
<span id="cb57-60"><a href="#cb57-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-61"><a href="#cb57-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-62"><a href="#cb57-62" aria-hidden="true" tabindex="-1"></a><span class="co"># So that's all of the TSD14 survival analysis done. The next step is to programmatically </span></span>
<span id="cb57-63"><a href="#cb57-63" aria-hidden="true" tabindex="-1"></a><span class="co"># proliferate comparative efficacy </span></span>
<span id="cb57-64"><a href="#cb57-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-65"><a href="#cb57-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-66"><a href="#cb57-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-67"><a href="#cb57-67" aria-hidden="true" tabindex="-1"></a><span class="co"># On a tablet with very little computational power this takes a couple of minutes to run. on a new</span></span>
<span id="cb57-68"><a href="#cb57-68" aria-hidden="true" tabindex="-1"></a><span class="co"># laptop its not long at all</span></span>
<span id="cb57-69"><a href="#cb57-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-70"><a href="#cb57-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-71"><a href="#cb57-71" aria-hidden="true" tabindex="-1"></a><span class="co"># So, to pull out the visual fit of the analysis of TTD for a population</span></span>
<span id="cb57-72"><a href="#cb57-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-73"><a href="#cb57-73" aria-hidden="true" tabindex="-1"></a><span class="co"># i$surv$reg$pop_0$line_1$mol_7$trial_0$endpoint_0$plot$plot</span></span>
<span id="cb57-74"><a href="#cb57-74" aria-hidden="true" tabindex="-1"></a><span class="co"># i$surv$reg$pop_0$line_1$mol_1$trial_0$endpoint_3$plot$plot</span></span>
<span id="cb57-75"><a href="#cb57-75" aria-hidden="true" tabindex="-1"></a><span class="co"># i$surv$reg$pop_0$line_1$mol_7$trial_0$endpoint_1$plot$plot</span></span>
<span id="cb57-76"><a href="#cb57-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-77"><a href="#cb57-77" aria-hidden="true" tabindex="-1"></a><span class="co"># More importantly, to pull a particular extrapolation:</span></span>
<span id="cb57-78"><a href="#cb57-78" aria-hidden="true" tabindex="-1"></a><span class="co"># i$surv$reg$pop_0$line_1$mol_1$trial_0$endpoint_1$st[,"weibull"]</span></span>
<span id="cb57-79"><a href="#cb57-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-80"><a href="#cb57-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Where the "weibull" part would come from a dropdown list in the Excel front-end of the model specific</span></span>
<span id="cb57-81"><a href="#cb57-81" aria-hidden="true" tabindex="-1"></a><span class="co"># to that endpoint for that treatment for that line for that population (i.e. a lot of selections need to be made!)</span></span>
<span id="cb57-82"><a href="#cb57-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-83"><a href="#cb57-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-84"><a href="#cb57-84" aria-hidden="true" tabindex="-1"></a><span class="co"># The stuff inside of i$surv$reg can be used to automatically populate a report presenting the full plot, regression summaries,</span></span>
<span id="cb57-85"><a href="#cb57-85" aria-hidden="true" tabindex="-1"></a><span class="co"># goodness-of-fit results and the fit of the selected (via excel) distribution. The output can then be manually appended to include</span></span>
<span id="cb57-86"><a href="#cb57-86" aria-hidden="true" tabindex="-1"></a><span class="co"># written justification for the selection(s) to drastically reduce the overhead associated with reporting survival analysis</span></span>
<span id="cb57-87"><a href="#cb57-87" aria-hidden="true" tabindex="-1"></a><span class="co"># results and decisions made.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="make-survival-analysis-report" class="level2">
<h2 class="anchored" data-anchor-id="make-survival-analysis-report">Make survival analysis report</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 3.3.4 Survival analysis reporting ---------------------------------------</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="co"># the next step is to go through all of the results based directly on survival data</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="co"># and produce a readout containing:</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="co"># - Regression summary tables</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a><span class="co"># - goodness of fit</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a><span class="co"># - extrapolations (short and long-term) for visual fit assessment</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Each of these should have a separate section which at least states the identifiers</span></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a><span class="co"># (i.e., translating from numbers to text as in Section 3.4.2 above)</span></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a><span class="co"># The best way to do this is with either Reduce or base for loops:</span></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Produce all the KM, extrapolations and gof tables for decisions on the front-end</span></span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Note whether or not the survival analysis report is run by the code is set in Excel as this takes a long time to produce</span></span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a><span class="co"># This cannot be produced without access to PLD</span></span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (i<span class="sc">$</span>dd_report_req_surv_reg<span class="sc">==</span><span class="st">"Yes"</span>) {</span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>  doc_surv <span class="ot">&lt;-</span> <span class="fu">f_surv_makeTSD14Report</span>(</span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">fs_res =</span> i<span class="sc">$</span>surv<span class="sc">$</span>reg,</span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">id     =</span> i<span class="sc">$</span>id<span class="sc">$</span>ipd,</span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">lookup =</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd</span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(doc_surv, <span class="at">target =</span> <span class="fu">file.path</span>(o_path, <span class="st">"Survival_Analysis.docx"</span>))</span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(doc_surv)</span>
<span id="cb58-31"><a href="#cb58-31" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>SPLITMD_CODE2_END</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/pythonhealthdatascience\.github\.io\/stars-eom-rcc\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/pythonhealthdatascience/stars-eom-rcc/edit/main/pages/walkthrough/code0a_walkthrough.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/pythonhealthdatascience/stars-eom-rcc/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>