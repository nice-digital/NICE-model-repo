<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Model code walkthrough</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="code_walkthrough_files/libs/clipboard/clipboard.min.js"></script>
<script src="code_walkthrough_files/libs/quarto-html/quarto.js"></script>
<script src="code_walkthrough_files/libs/quarto-html/popper.min.js"></script>
<script src="code_walkthrough_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="code_walkthrough_files/libs/quarto-html/anchor.min.js"></script>
<link href="code_walkthrough_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="code_walkthrough_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="code_walkthrough_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="code_walkthrough_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="code_walkthrough_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#purpose-of-this-notebook" id="toc-purpose-of-this-notebook" class="nav-link active" data-scroll-target="#purpose-of-this-notebook">Purpose of this notebook</a></li>
  <li><a href="#set-up" id="toc-set-up" class="nav-link" data-scroll-target="#set-up">Set up</a>
  <ul class="collapse">
  <li><a href="#import-libraries" id="toc-import-libraries" class="nav-link" data-scroll-target="#import-libraries">Import libraries</a></li>
  <li><a href="#define-some-project-settings" id="toc-define-some-project-settings" class="nav-link" data-scroll-target="#define-some-project-settings">Define some project settings</a></li>
  <li><a href="#get-functions" id="toc-get-functions" class="nav-link" data-scroll-target="#get-functions">Get functions</a></li>
  </ul></li>
  <li><a href="#define-model-parameters" id="toc-define-model-parameters" class="nav-link" data-scroll-target="#define-model-parameters">Define model parameters</a>
  <ul class="collapse">
  <li><a href="#get-inputs-from-excel-workbook-and-save-as-list-i" id="toc-get-inputs-from-excel-workbook-and-save-as-list-i" class="nav-link" data-scroll-target="#get-inputs-from-excel-workbook-and-save-as-list-i">Get inputs from excel workbook and save as list <code>i</code></a></li>
  <li><a href="#add-some-extra-inputs-to-the-list-i" id="toc-add-some-extra-inputs-to-the-list-i" class="nav-link" data-scroll-target="#add-some-extra-inputs-to-the-list-i">Add some extra inputs to the list <code>i</code></a></li>
  <li><a href="#use-i-to-make-new-list-p-some-elements-same-some-used-in-calculations-to-make-new-elements" id="toc-use-i-to-make-new-list-p-some-elements-same-some-used-in-calculations-to-make-new-elements" class="nav-link" data-scroll-target="#use-i-to-make-new-list-p-some-elements-same-some-used-in-calculations-to-make-new-elements">Use <code>i</code> to make new list <code>p</code> (some elements same, some used in calculations to make new elements)</a></li>
  <li><a href="#add-some-more-inputs-to-p" id="toc-add-some-more-inputs-to-p" class="nav-link" data-scroll-target="#add-some-more-inputs-to-p">Add some more inputs to <code>p</code></a></li>
  </ul></li>
  <li><a href="#sequences" id="toc-sequences" class="nav-link" data-scroll-target="#sequences">Sequences</a>
  <ul class="collapse">
  <li><a href="#find-all-the-possible-combinations-and-orders-of-treatment-and-add-to-i" id="toc-find-all-the-possible-combinations-and-orders-of-treatment-and-add-to-i" class="nav-link" data-scroll-target="#find-all-the-possible-combinations-and-orders-of-treatment-and-add-to-i">Find all the possible combinations and orders of treatment and add to <code>i</code></a></li>
  <li><a href="#filter-to-valid-combinationssequences" id="toc-filter-to-valid-combinationssequences" class="nav-link" data-scroll-target="#filter-to-valid-combinationssequences">Filter to valid combinations/sequences</a></li>
  </ul></li>
  <li><a href="#import-ipd-and-look-ups" id="toc-import-ipd-and-look-ups" class="nav-link" data-scroll-target="#import-ipd-and-look-ups">Import IPD and look-ups</a>
  <ul class="collapse">
  <li><a href="#import-individual-patient-level-data-ipd-pseudosynthetic-trial-data" id="toc-import-individual-patient-level-data-ipd-pseudosynthetic-trial-data" class="nav-link" data-scroll-target="#import-individual-patient-level-data-ipd-pseudosynthetic-trial-data">Import individual patient-level data (IPD) (pseudo/synthetic trial data)</a></li>
  <li><a href="#get-look-ups-for-each-column" id="toc-get-look-ups-for-each-column" class="nav-link" data-scroll-target="#get-look-ups-for-each-column">Get look-ups for each column</a></li>
  </ul></li>
  <li><a href="#pre-processing-for-survival-analysis" id="toc-pre-processing-for-survival-analysis" class="nav-link" data-scroll-target="#pre-processing-for-survival-analysis">Pre-processing for survival analysis</a></li>
  <li><a href="#partitioned-survival-analysis-partsa" id="toc-partitioned-survival-analysis-partsa" class="nav-link" data-scroll-target="#partitioned-survival-analysis-partsa">Partitioned survival analysis (PartSA)</a>
  <ul class="collapse">
  <li><a href="#run-analysis" id="toc-run-analysis" class="nav-link" data-scroll-target="#run-analysis">Run analysis</a></li>
  <li><a href="#load-pre-run-survival-analysis" id="toc-load-pre-run-survival-analysis" class="nav-link" data-scroll-target="#load-pre-run-survival-analysis">Load pre-run survival analysis</a></li>
  <li><a href="#make-survival-analysis-report" id="toc-make-survival-analysis-report" class="nav-link" data-scroll-target="#make-survival-analysis-report">Make survival analysis report</a></li>
  </ul></li>
  <li><a href="#load-results-from-network-meta-analysis" id="toc-load-results-from-network-meta-analysis" class="nav-link" data-scroll-target="#load-results-from-network-meta-analysis">Load results from network meta analysis</a></li>
  <li><a href="#relative-efficacy-network" id="toc-relative-efficacy-network" class="nav-link" data-scroll-target="#relative-efficacy-network">Relative efficacy network</a></li>
  <li><a href="#survival-times" id="toc-survival-times" class="nav-link" data-scroll-target="#survival-times">Survival times</a></li>
  <li><a href="#processing-data" id="toc-processing-data" class="nav-link" data-scroll-target="#processing-data">Processing data</a></li>
  <li><a href="#economic-modelling" id="toc-economic-modelling" class="nav-link" data-scroll-target="#economic-modelling">Economic modelling</a>
  <ul class="collapse">
  <li><a href="#run-the-model" id="toc-run-the-model" class="nav-link" data-scroll-target="#run-the-model">Run the model</a></li>
  <li><a href="#compile-model-results" id="toc-compile-model-results" class="nav-link" data-scroll-target="#compile-model-results">Compile model results</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Model code walkthrough</h1>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author"><a href="https://github.com/amyheather">Amy Heather</a> <a href="https://orcid.org/0000-0002-6596-3479" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            University of Exeter
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
  
    
  </div>
  


</header>


<section id="purpose-of-this-notebook" class="level2">
<h2 class="anchored" data-anchor-id="purpose-of-this-notebook">Purpose of this notebook</h2>
<p>This is a (potentially temporary) notebook that I am keeping as I work through the model (copied from <code>Model_Structure.R</code>), writing down notes to explain each part to myself, to ensure I understand it.</p>
<p>To simplify this, I have removed the original comments, and so this just includes my comments that I needed to understand it. The benefit of this is that, once I have understood how it all works, I can use my comments below to inform any changes to the comments in <code>Model_Structure.R</code>, the function docstrings, or elsewhere. Once I have completed this notebook, I can also create the model overview pages.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Whenever I have made changes to the code in <code>Model_Structure.R</code>, these are indicated with these boxes. This is excluding the removal of comments, which has been done throughout.</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<p>Whenever I have add code or detailed explanation, to help explain and demonstrate what the model is doing, these are contained within these boxes.</p>
</div>
</div>
</div>
</section>
<section id="set-up" class="level2">
<h2 class="anchored" data-anchor-id="set-up">Set up</h2>
<section id="import-libraries" class="level3">
<h3 class="anchored" data-anchor-id="import-libraries">Import libraries</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(shiny, <span class="at">quiet =</span> <span class="cn">TRUE</span>)   </span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gtools, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(openxlsx, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(flexsurv, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(heemod, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(logOfGamma, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survminer, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(officer, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(officedown, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Hmisc, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(future.apply, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(crosstable, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(flextable, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(BCEA, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(collapse, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Matrix, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(progressr, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(microbenchmark, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="define-some-project-settings" class="level3">
<h3 class="anchored" data-anchor-id="define-some-project-settings">Define some project settings</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>keep_free_cores <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">any</span>(<span class="fu">is.na</span>(keep_free_cores), keep_free_cores<span class="sc">&lt;</span><span class="dv">0</span>)) {</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plan</span>(sequential)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plan</span>(<span class="fu">multisession</span>(<span class="at">workers =</span> <span class="fu">max</span>(<span class="fu">availableCores</span>()<span class="sc">-</span>keep_free_cores,<span class="dv">1</span>)))</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Recorded time to get to <strong>complete 3 active treatment lines for population 1</strong>, then repeated with other cores, to understand what is faster / slower:</p>
<ul>
<li>28 cores: &gt; 53m (still on 3)</li>
<li>12 cores: 35m</li>
<li>8 cores: &lt; 19m</li>
<li>4 cores: 7m</li>
<li>Sequential (i.e.&nbsp;<code>NA</code>): 3m</li>
</ul>
<p>To run full script <strong>sequentially</strong> on that <strong>remote machine</strong>, it took <strong>19 minutes</strong>.</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Other generic settings for the progress bar and units for table widths</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">handlers</span>(<span class="st">"progress"</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">crosstable_units=</span><span class="st">"cm"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><code>handlers("progress")</code>: <code>progressr</code> function, settings for how progress is reported</p>
<p><code>options(crosstable_units="cm")</code>: <code>crosstable</code> package generates descriptive statistics with function <code>crosstable()</code>, and this is the settings for it (although can’t spot us of <code>crosstable()</code> anywhere)</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>qc_mode <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><code>qc_mode</code> is just used in <code>survival_functions.R</code> and by <code>f_NMA_AddAssumptionsToNetwork()</code> (and perhaps others if it calls them) and it is the input for <code>verbose</code> (i.e.&nbsp;if true, there will be extra outputs to console)</p>
</div>
</div>
</div>
</section>
<section id="get-functions" class="level3">
<h3 class="anchored" data-anchor-id="get-functions">Get functions</h3>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>I’ve modified this to make path defined once, as needed to change it, and to define paths that occur later on in the script. Hence, you’ll spot the changes later in the code also for <code>excel_path</code> and <code>empty_results_path</code>.</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set path to folders</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>path_data <span class="ot">=</span> <span class="st">"../1_Data"</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>path_functions <span class="ot">=</span> <span class="st">"../3_Functions"</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>path_output <span class="ot">=</span> <span class="st">"../4_Output"</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Set paths to files loaded in this script</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>excel_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(path_data, <span class="st">"ID6184_RCC_model inputs FAD version [UK RWE unredacted, ACIC redacted, cPAS redacted].xlsm"</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>excel_path2 <span class="ot">&lt;-</span> <span class="fu">file.path</span>(path_data, <span class="st">"IPD_R_input_noACIC.xlsx"</span>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>empty_results_path <span class="ot">=</span> <span class="fu">file.path</span>(path_functions, <span class="st">"reporting/empty results doc.docx"</span>)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>RDS_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(path_data, <span class="st">"survival_analysis_no_ipd_CompanyTTDTTPPPS_redacted.rds"</span>)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>RDS_path2 <span class="ot">&lt;-</span> <span class="fu">file.path</span>(path_data, <span class="st">"PH_NMA_CODA.rds"</span>)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>RDS_path3 <span class="ot">&lt;-</span> <span class="fu">file.path</span>(path_data, <span class="st">"FPNMA_means.rds"</span>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Source functions</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(path_functions, <span class="st">"excel/extract.R"</span>))</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(path_functions, <span class="st">"sequencing/sequences.R"</span>))</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(path_functions, <span class="st">"survival/Survival_functions.R"</span>))</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(path_functions, <span class="st">"survival/other_cause_mortality.R"</span>))</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(path_functions, <span class="st">"survival/treatment_effect_waning.R"</span>))</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(path_functions, <span class="st">"misc/other.R"</span>))</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(path_functions, <span class="st">"misc/shift_and_pad.R"</span>))</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(path_functions, <span class="st">"misc/cleaning.R"</span>))</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(path_functions, <span class="st">"misc/nesting.R"</span>))</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(path_functions, <span class="st">"misc/discounting.R"</span>))</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(path_functions, <span class="st">"misc/qdirichlet.R"</span>))</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(path_functions, <span class="st">"misc/plotting.R"</span>))</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(path_functions, <span class="st">"misc/structure.R"</span>))</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(path_functions, <span class="st">"misc/fpnma_fns.R"</span>))</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(path_functions, <span class="st">"utility/age_related.R"</span>))</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(path_functions, <span class="st">"costs_and_QALYs/utility_processing.R"</span>))</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(path_functions, <span class="st">"adverse_events/AE_steps.R"</span>))</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(path_functions, <span class="st">"costs_and_QALYs/cost_processing.R"</span>))</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(path_functions, <span class="st">"markov/markov.R"</span>))</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(path_functions, <span class="st">"patient_flow/overarching.R"</span>))</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(path_functions, <span class="st">"patient_flow/partitioned_survival.R"</span>))</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(path_functions, <span class="st">"patient_flow/markov.R"</span>))</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(path_functions, <span class="st">"patient_flow/drug_costs.R"</span>))</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(path_functions, <span class="st">"patient_flow/hcru_costs.R"</span>))</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(path_functions, <span class="st">"patient_flow/qalys.R"</span>))</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(path_functions, <span class="st">"patient_flow/ae.R"</span>))</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(path_functions, <span class="st">"results/incremental_analysis.R"</span>))</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(path_functions, <span class="st">"results/model_averaging.R"</span>))</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(path_functions, <span class="st">"results/partitioned_survival.R"</span>))</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(path_functions, <span class="st">"misc/severity_modifier.R"</span>))</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(path_functions, <span class="st">"results/results_tables.R"</span>))</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(path_functions, <span class="st">"psa/psa functions.R"</span>))</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(path_functions, <span class="st">"reporting/word_document_output.R"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Not sure of purpose as doesn’t appear to be used anywhere - might be legacy code.</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>User_types <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Submitting company"</span>, <span class="st">"NICE"</span>, <span class="st">"EAG"</span>, <span class="st">"Committee"</span>, <span class="st">"NHSE"</span>, <span class="st">"Clinical expert"</span>, <span class="st">"Patient expert"</span>, <span class="st">"Non-intervention stakeholder"</span>, <span class="st">"Public"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="define-model-parameters" class="level2">
<h2 class="anchored" data-anchor-id="define-model-parameters">Define model parameters</h2>
<section id="get-inputs-from-excel-workbook-and-save-as-list-i" class="level3">
<h3 class="anchored" data-anchor-id="get-inputs-from-excel-workbook-and-save-as-list-i">Get inputs from excel workbook and save as list <code>i</code></h3>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-8-contents" aria-controls="callout-8" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-8" class="callout-8-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Hidden output as it is quite verbose.</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(excel_path)) {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  i <span class="ot">&lt;-</span> <span class="fu">f_excel_extract</span>(excel_path, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  i <span class="ot">&lt;-</span> <span class="fu">f_excel_extract</span>(rstudioapi<span class="sc">::</span><span class="fu">selectFile</span>(</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Select the Excel inputs file (ID6184_RCC_model inputs....xlsm)"</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"ID6184_RCC_model inputs....xlsm"</span>,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">path =</span> <span class="st">"../1_Data/"</span>,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">filter =</span> <span class="st">"Excel Files (*.xlsm)"</span>,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">existing =</span> <span class="cn">TRUE</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  ), <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-9-contents" aria-controls="callout-9" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-9" class="callout-9-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Import the file at <code>excel_path</code> using <code>f_excel_extract()</code>. If the file doesn’t exist, assuming the user is in RStudio, a dialog box will appear with the system files, and the user should then select a file from their directory. The dialog will open in <code>1_Data/</code>, show only <code>.xlsm</code> files, and the accept/ok button has the text <code>ID6184_RCC_model inputs....xlsm</code>.</p>
<p>The function <code>f_excel_extract</code> is below (note: <code>sheets</code> not used).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>f_excel_extract <span class="ot">&lt;-</span> <span class="cf">function</span>(path_to_excel_file, <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  wb          <span class="ot">&lt;-</span> <span class="fu">loadWorkbook</span>(path_to_excel_file)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  sheets      <span class="ot">&lt;-</span> wb<span class="sc">$</span>sheet_names</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  named       <span class="ot">&lt;-</span> <span class="fu">getNamedRegions</span>(wb)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  nams        <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">as.list</span>(named))</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(nams) <span class="ot">&lt;-</span> nams</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Cycle through all the named ranges, making a decision on cleaning as we go</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> <span class="fu">lapply</span>(nams, <span class="cf">function</span>(named_range) {</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (verbose) <span class="fu">cat</span>(<span class="fu">paste0</span>(<span class="st">"Extracting named range "</span>, named_range, <span class="st">" from "</span>, path_to_excel_file, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>))</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    dat <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(wb,<span class="at">namedRegion =</span> named_range, <span class="at">check.names =</span> <span class="cn">TRUE</span>,<span class="at">colNames =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(dat) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>      <span class="co"># if it has 0 rows, then the input must be a 1 cell one, so we can safely assume</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>      <span class="co"># no row names</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>      dat <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(wb,<span class="at">namedRegion =</span> named_range,<span class="at">colNames =</span> <span class="cn">FALSE</span>,<span class="at">rowNames =</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">all</span>(<span class="fu">length</span>(dat) <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">names</span>(dat)[<span class="dv">1</span>] <span class="sc">==</span> <span class="st">"X1"</span>)) {</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>        dat <span class="ot">&lt;-</span> <span class="fu">unlist</span>(dat, <span class="at">use.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span>(<span class="fu">nrow</span>(dat) <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>        dat <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">read.xlsx</span>(wb,<span class="at">namedRegion =</span> named_range,<span class="at">colNames =</span> <span class="cn">FALSE</span>,<span class="at">rowNames =</span> <span class="cn">FALSE</span>), <span class="at">use.names =</span> F)</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>      } </span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(dat)</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span>(<span class="fu">ncol</span>(dat) <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>      <span class="co"># if there's 1 column, then it's actually just a vector:</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>      dat <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">read.xlsx</span>(wb,<span class="at">namedRegion =</span> named_range,<span class="at">colNames =</span> <span class="cn">FALSE</span>,<span class="at">rowNames =</span> <span class="cn">FALSE</span>), <span class="at">use.names =</span> F)</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>      <span class="co"># logically we can't identify whether a table has appropriate names or not</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>      <span class="co"># at this point. this will have to be left to the cleaning functions.</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(dat)</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Drop the workbook at the end (I think in {} this would happen anyway, but want to ensure!)</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(wb)</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(output)</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It loops through <code>named_range</code>, which is returned by <code>openxlsx::getNamedRegions()</code>. This is a function that finds all the named regions in an excel file.</p>
<p>Named regions consist of:</p>
<ul>
<li>A name for the region (e.g.&nbsp;<code>apply_waning_to</code>)</li>
<li>The region, which consists of the sheet, column/s and row/s (e.g.&nbsp;<code>=Lists!$Y$10:$Y$11</code>)</li>
</ul>
<p>In this workbook, the named regions are all stored in a sheet called <code>named ranges</code>.</p>
<p>When this function runs, it creates a list called <code>i</code> and each element of that list reflects a row from the <code>named ranges sheet</code>, except the first element, which is each of the named ranges.</p>
<p>Named ranges:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(i[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(i<span class="sc">$</span><span class="st">`</span><span class="at">_xlnm._FilterDatabase</span><span class="st">`</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
</div>
<p><strong>Example</strong> <code>apply_waning_to</code> was from <code>=Lists!$Y$10:$Y$11</code>. Looking in the <code>Lists</code> sheet, we can see that Y10 was <code>ref trt hazard</code> and Y11 was <code>ref trt abs surv</code>. This matches up with the returned object:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>i[[<span class="dv">2</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "ref trt hazard"   "ref trt abs surv"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>apply_waning_to</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "ref trt hazard"   "ref trt abs surv"</code></pre>
</div>
</div>
<p><strong>Example 2:</strong> <code>dd_age_sex_source</code> is from <code>='Model settings'!$G$63</code>. Looking in the <code>Model settings</code> sheet, we can see that G63 is the answer to “Age/sex based on mean or PLD?”, with base case/default being <code>PLD</code>. We can likewise see this from its value in the list:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>i[[<span class="dv">11</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "PLD"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>dd_age_sex_source</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "PLD"</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>i <span class="ot">&lt;-</span> <span class="fu">c</span>(i,<span class="fu">f_excel_cleanParams</span>(i<span class="sc">$</span>R_table_param))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-10-contents" aria-controls="callout-10" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-10" class="callout-10-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>One of the items in the list <code>i</code> is <code>R_table_param</code>. The source of this in the excel workbook was <code>='All parameters'!$C$5:$Q$2912</code> - so basically, it’s just taking the full table from the sheet <code>All parameters</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(i<span class="sc">$</span>R_table_param)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
</div>
<p>The function <code>f_excel_cleanParams()</code> takes this table and turns each row into a list, which you can access using <code>Parameter.name</code>. It adds an extra element <code>Mean</code>, which is just the value from <code>Mean.current.value</code> converted to numeric.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>show_list <span class="ot">&lt;-</span> <span class="fu">f_excel_cleanParams</span>(i<span class="sc">$</span>R_table_param)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>show_list<span class="sc">$</span>cabo_nivo_include</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$Parameter.description
[1] "Include cabo nivo? (1=yes, 0=no)"

$Parameter.name
[1] "cabo_nivo_include"

$Mean.current.value
[1] "1"

$Mean
[1] 1</code></pre>
</div>
</div>
<p>When it did this, it then concatenated that list with the list <code>i</code>, meaning that each of those elements can now be accessed in the same way from <code>i</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>cabo_nivo_include</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$Parameter.description
[1] "Include cabo nivo? (1=yes, 0=no)"

$Parameter.name
[1] "cabo_nivo_include"

$Mean.current.value
[1] "1"

$Mean
[1] 1</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="add-some-extra-inputs-to-the-list-i" class="level3">
<h3 class="anchored" data-anchor-id="add-some-extra-inputs-to-the-list-i">Add some extra inputs to the list <code>i</code></h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>decision_problem <span class="ot">&lt;-</span> <span class="st">"cabo+nivo"</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>id     <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">ipd =</span> <span class="fu">list</span>())</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>lookup <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">ipd =</span> <span class="fu">list</span>())</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>distnames <span class="ot">&lt;-</span> </span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">gengamma      =</span> <span class="st">"gengamma"</span>,</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">exp           =</span> <span class="st">"exp"</span>,</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">weibull       =</span> <span class="st">"weibull"</span>,</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">lnorm         =</span> <span class="st">"lnorm"</span>,</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">gamma         =</span> <span class="st">"gamma"</span>,</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">gompertz      =</span> <span class="st">"gompertz"</span>,</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">llogis        =</span> <span class="st">"llogis"</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="use-i-to-make-new-list-p-some-elements-same-some-used-in-calculations-to-make-new-elements" class="level3">
<h3 class="anchored" data-anchor-id="use-i-to-make-new-list-p-some-elements-same-some-used-in-calculations-to-make-new-elements">Use <code>i</code> to make new list <code>p</code> (some elements same, some used in calculations to make new elements)</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">f_misc_param_generate_p</span>(i)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-11-contents" aria-controls="callout-11" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-11" class="callout-11-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The function <code>structure::f_misc_param_generate_p()</code> simply takes some of the elements from <code>i</code> and creates a new list <code>p</code>.</p>
<p>For example, these are both the same:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>basic<span class="sc">$</span>th_y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 40</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>ui_time_horizon</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 40</code></pre>
</div>
</div>
<p>See the full outline of what elements it takes by looking at the function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Function which creates an empty version of the parameters list p and populates</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' it using the inputs from i</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param i raw extracted inputs from Excel</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>f_misc_param_generate_p <span class="ot">&lt;-</span> <span class="cf">function</span>(i) {</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">basic =</span> <span class="fu">list</span>(</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">th   =</span> <span class="fu">ceiling</span>(i<span class="sc">$</span>ui_time_horizon <span class="sc">*</span> <span class="fl">365.25</span> <span class="sc">/</span> <span class="dv">7</span>), </span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">th_y =</span> i<span class="sc">$</span>ui_time_horizon, </span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">cl_d =</span> i<span class="sc">$</span>i_cycle_length_weeks<span class="sc">*</span><span class="dv">7</span>, </span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">cl_w =</span> i<span class="sc">$</span>i_cycle_length_weeks, </span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">cl_y =</span> i<span class="sc">$</span>i_cycle_length_weeks<span class="sc">*</span><span class="dv">7</span><span class="sc">/</span><span class="fl">365.25</span>, </span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">discQ =</span> i<span class="sc">$</span>ui_disc_qaly,</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">discC =</span> i<span class="sc">$</span>ui_disc_cost,</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">structure =</span> <span class="fu">str_trim</span>(i<span class="sc">$</span>dd_model_struct)</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">demo =</span> <span class="fu">list</span>(</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">table =</span> <span class="fu">data.table</span>(i<span class="sc">$</span>R_table_ptchar)</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>    ), <span class="co"># patient demographic data</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">seq   =</span> <span class="fu">list</span>(), <span class="co"># treatment sequences. same for both model structures.</span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">surv  =</span> <span class="fu">list</span>(), <span class="co"># Survival extrapolations (if needed for iteration, i.e. in part surv model). same for both model structures</span></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">releff =</span> <span class="fu">list</span>(), <span class="co"># Relative efficacy network, for use populating the disease model. same for both model structures</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">costs  =</span> <span class="fu">list</span>(</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">mk =</span> <span class="fu">list</span>(),</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">ps =</span> <span class="fu">list</span>(),</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">settings =</span> <span class="fu">list</span>(</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>        <span class="at">subsTx =</span> <span class="fu">data.table</span>(i<span class="sc">$</span>R_table_sub_txts_prop_n_costs)</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>    ), <span class="co"># All drug inputs after they've been processed and tidied up</span></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">util  =</span> <span class="fu">list</span>(</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">mk =</span> <span class="fu">list</span>(),</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">ps =</span> <span class="fu">list</span>()</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>    ), <span class="co"># All inputs to apply to the disease model</span></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">ae    =</span> <span class="fu">list</span>(</span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">mk =</span> <span class="fu">list</span>(),</span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>      <span class="at">ps =</span> <span class="fu">list</span>()</span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>    ), <span class="co"># Inputs to generate AE matrices AC and AQ</span></span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">misc  =</span> <span class="fu">list</span>(</span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a>      <span class="at">mk =</span> <span class="fu">list</span>(),</span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a>      <span class="at">ps =</span> <span class="fu">list</span>(),</span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot =</span> <span class="fu">list</span>(</span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a>        <span class="at">xlim_survplots_yr =</span> <span class="dv">20</span></span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a>  p<span class="sc">$</span>basic<span class="sc">$</span>n_cyc <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(p<span class="sc">$</span>basic<span class="sc">$</span>th) <span class="co"># rounding up to a whole number</span></span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a>  p<span class="sc">$</span>basic<span class="sc">$</span>t_cyc <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span><span class="sc">:</span>p<span class="sc">$</span>basic<span class="sc">$</span>n_cyc)</span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a>  p<span class="sc">$</span>basic<span class="sc">$</span>t_yr  <span class="ot">&lt;-</span> p<span class="sc">$</span>basic<span class="sc">$</span>t_cyc<span class="sc">*</span><span class="dv">7</span><span class="sc">/</span><span class="fl">365.25</span></span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># discount factors - base-case edition. These will get replaced for scenarios affecting</span></span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># discount rates or the time horizon</span></span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a>  p<span class="sc">$</span>basic<span class="sc">$</span>discFacQ <span class="ot">&lt;-</span> <span class="fu">f_discFac</span>(p<span class="sc">$</span>basic<span class="sc">$</span>discQ,p<span class="sc">$</span>basic<span class="sc">$</span>t_yr)</span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a>  p<span class="sc">$</span>basic<span class="sc">$</span>discFacC <span class="ot">&lt;-</span> <span class="fu">f_discFac</span>(p<span class="sc">$</span>basic<span class="sc">$</span>discC,p<span class="sc">$</span>basic<span class="sc">$</span>t_yr)</span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(p)</span>
<span id="cb31-59"><a href="#cb31-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-60"><a href="#cb31-60" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="add-some-more-inputs-to-p" class="level3">
<h3 class="anchored" data-anchor-id="add-some-more-inputs-to-p">Add some more inputs to <code>p</code></h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>basic<span class="sc">$</span>R_maxlines <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>basic<span class="sc">$</span>decision_problem <span class="ot">&lt;-</span> i<span class="sc">$</span>decision_problem</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-12-contents" aria-controls="callout-12" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-12" class="callout-12-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>I’m pretty sure that max lines is referring to the maximum number of treatment lines. The most it can be is 4. But I don’t know if perhaps you can change this to 2 to reduce the number in model? Or if this is a standard unchanging parameter as the model is only designed to go up to 4?</p>
</div>
</div>
</div>
</section>
</section>
<section id="sequences" class="level2">
<h2 class="anchored" data-anchor-id="sequences">Sequences</h2>
<section id="find-all-the-possible-combinations-and-orders-of-treatment-and-add-to-i" class="level3">
<h3 class="anchored" data-anchor-id="find-all-the-possible-combinations-and-orders-of-treatment-and-add-to-i">Find all the possible combinations and orders of treatment and add to <code>i</code></h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>sequences <span class="ot">&lt;-</span> <span class="fu">f_generate_sequences</span>(</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">comparators =</span> i<span class="sc">$</span>List_comparators, </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">maxlines    =</span> p<span class="sc">$</span>basic<span class="sc">$</span>R_maxlines</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-13-contents" aria-controls="callout-13" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-13" class="callout-13-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>This adds a new element to <code>i</code> called <code>sequences</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(i<span class="sc">$</span>sequences)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
</div>
<p>It’s created using <code>sequences::f_generate_sequences()</code>. The inputs to this were:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>List_comparators</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "nivolumab_monotherapy"         "cabozantinib_plus_nivolumab"  
 [3] "nivolumab_plus_ipilimumab"     "lenvatinib_plus_pembrolizumab"
 [5] "avelumab_plus_axitinib"        "pazopanib"                    
 [7] "tivozanib"                     "sunitinib"                    
 [9] "cabozantinib"                  "lenvatinib_plus_everolimus"   
[11] "everolimus"                    "axitinib"                     
[13] "sorafenib"                     "placebo_BSC"                  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>basic<span class="sc">$</span>R_maxlines</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4</code></pre>
</div>
</div>
<p>The output of the function is a table where each column is the line of therapy. The final column is always best supportive care (BSC). The first four columns reflect every possible order and combination of treatments (e.g.&nbsp;ABCD, ABCE, ABCF… and so on). The total possiblities are:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(i<span class="sc">$</span>sequences)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 26404     5</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="filter-to-valid-combinationssequences" class="level3">
<h3 class="anchored" data-anchor-id="filter-to-valid-combinationssequences">Filter to valid combinations/sequences</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>sequences <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(i<span class="sc">$</span>sequences)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>populations <span class="ot">&lt;-</span> i<span class="sc">$</span>i_nr_populations</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>seqs <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (population <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>populations) {</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Applying sequence restrictions to population"</span>, population,<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>  s <span class="ot">&lt;-</span> <span class="fu">f_path_tx_restrict</span>(</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">sequences                =</span> i<span class="sc">$</span>sequences,</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">allowed                  =</span> <span class="fu">f_get_allowed_lists</span>(i, population), <span class="co">#overall list of allowed drugs in this popn</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">L1                       =</span> <span class="fu">f_get_L1_lists</span>(i, population), <span class="co"># 1L drugs allowed in this popn</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">L2                       =</span> <span class="fu">f_get_L2_lists</span>(i, population), <span class="co"># 2L drugs allowed in this popn</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">L3                       =</span> <span class="fu">f_get_L3_lists</span>(i, population), <span class="co"># 3L drugs allowed in this popn</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">L4                       =</span> <span class="fu">f_get_L4_lists</span>(i, population), <span class="co"># 4L drugs allowed in this popn</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">only_after               =</span> <span class="fu">f_get_only_after_lists</span>(i, population), <span class="co">#list of restrictions where tx can be only after the listed txs</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">not_immediate_after      =</span> <span class="fu">f_get_not_immediate_after_lists</span>(i, population), <span class="co">#list of restrictions where tx can be only immediately before the listed txs</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">one_in_list              =</span> <span class="fu">f_get_one_in_list_lists</span>(i, population), <span class="co">#list of restrictions where only one of the tx in each list is allowed </span></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">only_after_one           =</span> <span class="fu">f_get_only_after_one_lists</span>(i, population), <span class="co">#list of restrictions where only one of the listed treatments is allowed prior to current therapy </span></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">L2_only_after            =</span> <span class="fu">f_get_2L_only_after_lists</span>(i, population), <span class="co">#list of 2L+ restrictions: if drug is used 2L, 3L or 4L, can only be after drug x</span></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">L2_only_immediate_after  =</span> <span class="fu">f_get_2L_only_immediate_after_lists</span>(i, population), <span class="co">#list of 2L+ restrictions: if drug is used 2L, 3L or 4L, can only be immediately after drug x</span></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">L2_only_one              =</span> <span class="fu">f_get_2L_only_one_lists</span>(i, population) <span class="co">#list of 2L+ drugs where only one of them allowed in a given sequence</span></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>  s <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="fu">rep</span>(<span class="fu">paste0</span>(<span class="st">"pop"</span>, population),<span class="fu">nrow</span>(s)), s)</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(s) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">'V'</span>, <span class="fu">seq_len</span>(<span class="fu">ncol</span>(s))) <span class="co"># rbind no longer likes un-named columns so added this</span></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>  seqs <span class="ot">&lt;-</span> <span class="fu">rbind</span>(seqs, s)</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Applying sequence restrictions to population 1 
Dropping drugs not allowed for this population.
applying rule: avelumab_plus_axitinib axitinib cabozantinib everolimus lenvatinib_plus_everolimus cabozantinib_plus_nivolumab nivolumab_monotherapy pazopanib sunitinib tivozanib are only allowed treatments.
Permutations before applying rule: 26404 
Permutations after applying rule : 5860 
applying rule: drug line restrictions.
Permutations before applying rule: 5860 
Permutations after applying rule : 628 
[1] "axitinib"
applying rule. axitinib is only allowed after avelumab_plus_axitinib cabozantinib lenvatinib_plus_everolimus cabozantinib_plus_nivolumab pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 628 
Permutations after applying rule : 628 
[1] "everolimus"
applying rule. everolimus is only allowed after avelumab_plus_axitinib axitinib cabozantinib lenvatinib_plus_everolimus cabozantinib_plus_nivolumab pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 628 
Permutations after applying rule : 628 
[1] "lenvatinib_plus_everolimus"
applying rule. lenvatinib_plus_everolimus is not allowed immediately after nivolumab_plus_ipilimumab 
Permutations before applying rule: 628 
Permutations after applying rule : 628 
[1] "axitinib"
applying rule axitinib : avelumab_plus_axitinib axitinib cannot be in one permutation
Permutations before applying rule: 628 
Permutations after applying rule : 559 
[1] "cabozantinib"
applying rule cabozantinib : cabozantinib cabozantinib_plus_nivolumab cannot be in one permutation
Permutations before applying rule: 559 
Permutations after applying rule : 520 
[1] "everolimus"
applying rule everolimus : lenvatinib_plus_everolimus everolimus cannot be in one permutation
Permutations before applying rule: 520 
Permutations after applying rule : 452 
[1] "io"
applying rule io : avelumab_plus_axitinib nivolumab_plus_ipilimumab cabozantinib_plus_nivolumab nivolumab_monotherapy lenvatinib_plus_pembrolizumab cannot be in one permutation
Permutations before applying rule: 452 
Permutations after applying rule : 400 
[1] "nivolumab"
applying rule nivolumab : nivolumab_plus_ipilimumab cabozantinib_plus_nivolumab nivolumab_monotherapy cannot be in one permutation
Permutations before applying rule: 400 
Permutations after applying rule : 400 
[1] "TKIs"
applying rule TKIs : sunitinib pazopanib tivozanib cannot be in one permutation
Permutations before applying rule: 400 
Permutations after applying rule : 202 
[1] "lenvatinib_plus_everolimus"
applying rule: lenvatinib_plus_everolimus can only be after ONE of avelumab_plus_axitinib axitinib cabozantinib cabozantinib_plus_nivolumab pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 202 
Permutations after applying rule : 182 
[1] "cabozantinib"
applying rule: cabozantinib as 2L+ only allowed after avelumab_plus_axitinib axitinib lenvatinib_plus_everolimus cabozantinib_plus_nivolumab pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 182 
Permutations after applying rule : 182 
[1] "pazopanib"
applying rule: pazopanib as 2L+ only allowed immediately after avelumab_plus_axitinib lenvatinib_plus_pembrolizumab cabozantinib_plus_nivolumab nivolumab_plus_ipilimumab 
Permutations before applying rule: 182 
Permutations after applying rule : 172 
[1] "sunitinib"
applying rule: sunitinib as 2L+ only allowed immediately after avelumab_plus_axitinib lenvatinib_plus_pembrolizumab cabozantinib_plus_nivolumab nivolumab_plus_ipilimumab 
Permutations before applying rule: 172 
Permutations after applying rule : 162 
[1] "tivozanib"
applying rule: tivozanib as 2L+ only allowed immediately after avelumab_plus_axitinib lenvatinib_plus_pembrolizumab cabozantinib_plus_nivolumab nivolumab_plus_ipilimumab 
Permutations before applying rule: 162 
Permutations after applying rule : 152 
Applying sequence restrictions to population 2 
Dropping drugs not allowed for this population.
applying rule: avelumab_plus_axitinib axitinib cabozantinib everolimus nivolumab_plus_ipilimumab lenvatinib_plus_everolimus cabozantinib_plus_nivolumab nivolumab_monotherapy pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib are only allowed treatments.
Permutations before applying rule: 26404 
Permutations after applying rule : 13344 
applying rule: drug line restrictions.
Permutations before applying rule: 13344 
Permutations after applying rule : 1036 
[1] "axitinib"
applying rule. axitinib is only allowed after avelumab_plus_axitinib cabozantinib lenvatinib_plus_everolimus cabozantinib_plus_nivolumab pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 1036 
Permutations after applying rule : 1017 
[1] "everolimus"
applying rule. everolimus is only allowed after avelumab_plus_axitinib axitinib cabozantinib lenvatinib_plus_everolimus cabozantinib_plus_nivolumab pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 1017 
Permutations after applying rule : 1004 
[1] "lenvatinib_plus_everolimus"
applying rule. lenvatinib_plus_everolimus is not allowed immediately after nivolumab_plus_ipilimumab 
Permutations before applying rule: 1004 
Permutations after applying rule : 984 
[1] "axitinib"
applying rule axitinib : avelumab_plus_axitinib axitinib cannot be in one permutation
Permutations before applying rule: 984 
Permutations after applying rule : 915 
[1] "cabozantinib"
applying rule cabozantinib : cabozantinib cabozantinib_plus_nivolumab cannot be in one permutation
Permutations before applying rule: 915 
Permutations after applying rule : 876 
[1] "everolimus"
applying rule everolimus : lenvatinib_plus_everolimus everolimus cannot be in one permutation
Permutations before applying rule: 876 
Permutations after applying rule : 773 
[1] "io"
applying rule io : avelumab_plus_axitinib nivolumab_plus_ipilimumab cabozantinib_plus_nivolumab nivolumab_monotherapy lenvatinib_plus_pembrolizumab cannot be in one permutation
Permutations before applying rule: 773 
Permutations after applying rule : 657 
[1] "lenvatinib_plus_everolimus"
applying rule lenvatinib_plus_everolimus : lenvatinib_plus_everolimus lenvatinib_plus_pembrolizumab cannot be in one permutation
Permutations before applying rule: 657 
Permutations after applying rule : 638 
[1] "nivolumab"
applying rule nivolumab : nivolumab_plus_ipilimumab cabozantinib_plus_nivolumab nivolumab_monotherapy cannot be in one permutation
Permutations before applying rule: 638 
Permutations after applying rule : 638 
[1] "TKIs"
applying rule TKIs : sunitinib pazopanib tivozanib cannot be in one permutation
Permutations before applying rule: 638 
Permutations after applying rule : 386 
[1] "lenvatinib_plus_everolimus"
applying rule: lenvatinib_plus_everolimus can only be after ONE of avelumab_plus_axitinib axitinib cabozantinib cabozantinib_plus_nivolumab pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 386 
Permutations after applying rule : 359 
[1] "cabozantinib"
applying rule: cabozantinib as 2L+ only allowed after avelumab_plus_axitinib axitinib nivolumab_plus_ipilimumab lenvatinib_plus_everolimus cabozantinib_plus_nivolumab pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 359 
Permutations after applying rule : 359 
[1] "pazopanib"
applying rule: pazopanib as 2L+ only allowed immediately after avelumab_plus_axitinib lenvatinib_plus_pembrolizumab cabozantinib_plus_nivolumab nivolumab_plus_ipilimumab 
Permutations before applying rule: 359 
Permutations after applying rule : 339 
[1] "sunitinib"
applying rule: sunitinib as 2L+ only allowed immediately after avelumab_plus_axitinib lenvatinib_plus_pembrolizumab cabozantinib_plus_nivolumab nivolumab_plus_ipilimumab 
Permutations before applying rule: 339 
Permutations after applying rule : 319 
[1] "tivozanib"
applying rule: tivozanib as 2L+ only allowed immediately after avelumab_plus_axitinib lenvatinib_plus_pembrolizumab cabozantinib_plus_nivolumab nivolumab_plus_ipilimumab 
Permutations before applying rule: 319 
Permutations after applying rule : 299 
Applying sequence restrictions to population 3 
Dropping drugs not allowed for this population.
applying rule: axitinib cabozantinib everolimus lenvatinib_plus_everolimus nivolumab_monotherapy pazopanib sunitinib tivozanib are only allowed treatments.
Permutations before applying rule: 26404 
Permutations after applying rule : 2080 
applying rule: drug line restrictions.
Permutations before applying rule: 2080 
Permutations after applying rule : 330 
[1] "axitinib"
applying rule. axitinib is only allowed after avelumab_plus_axitinib cabozantinib lenvatinib_plus_everolimus cabozantinib_plus_nivolumab pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 330 
Permutations after applying rule : 330 
[1] "everolimus"
applying rule. everolimus is only allowed after avelumab_plus_axitinib axitinib cabozantinib lenvatinib_plus_everolimus cabozantinib_plus_nivolumab pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 330 
Permutations after applying rule : 330 
[1] "lenvatinib_plus_everolimus"
applying rule. lenvatinib_plus_everolimus is not allowed immediately after nivolumab_plus_ipilimumab 
Permutations before applying rule: 330 
Permutations after applying rule : 330 
[1] "axitinib"
applying rule axitinib : avelumab_plus_axitinib axitinib cannot be in one permutation
Permutations before applying rule: 330 
Permutations after applying rule : 330 
[1] "everolimus"
applying rule everolimus : lenvatinib_plus_everolimus everolimus cannot be in one permutation
Permutations before applying rule: 330 
Permutations after applying rule : 288 
[1] "lenvatinib_plus_everolimus"
applying rule lenvatinib_plus_everolimus : lenvatinib_plus_everolimus lenvatinib_plus_pembrolizumab cannot be in one permutation
Permutations before applying rule: 288 
Permutations after applying rule : 288 
[1] "TKIs"
applying rule TKIs : sunitinib pazopanib tivozanib cannot be in one permutation
Permutations before applying rule: 288 
Permutations after applying rule : 120 
[1] "lenvatinib_plus_everolimus"
applying rule: lenvatinib_plus_everolimus can only be after ONE of axitinib cabozantinib pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 120 
Permutations after applying rule : 111 
[1] "cabozantinib"
applying rule: cabozantinib as 2L+ only allowed after avelumab_plus_axitinib axitinib lenvatinib_plus_everolimus cabozantinib_plus_nivolumab pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 111 
Permutations after applying rule : 111 
[1] "pazopanib"
applying rule: pazopanib as 2L+ only allowed immediately after avelumab_plus_axitinib lenvatinib_plus_pembrolizumab cabozantinib_plus_nivolumab nivolumab_plus_ipilimumab 
Permutations before applying rule: 111 
Permutations after applying rule : 111 
[1] "sunitinib"
applying rule: sunitinib as 2L+ only allowed immediately after avelumab_plus_axitinib lenvatinib_plus_pembrolizumab cabozantinib_plus_nivolumab nivolumab_plus_ipilimumab 
Permutations before applying rule: 111 
Permutations after applying rule : 111 
[1] "tivozanib"
applying rule: tivozanib as 2L+ only allowed immediately after avelumab_plus_axitinib lenvatinib_plus_pembrolizumab cabozantinib_plus_nivolumab nivolumab_plus_ipilimumab 
Permutations before applying rule: 111 
Permutations after applying rule : 111 
Applying sequence restrictions to population 4 
Dropping drugs not allowed for this population.
applying rule: axitinib cabozantinib everolimus lenvatinib_plus_everolimus nivolumab_monotherapy pazopanib sunitinib tivozanib are only allowed treatments.
Permutations before applying rule: 26404 
Permutations after applying rule : 2080 
applying rule: drug line restrictions.
Permutations before applying rule: 2080 
Permutations after applying rule : 440 
[1] "axitinib"
applying rule. axitinib is only allowed after avelumab_plus_axitinib cabozantinib lenvatinib_plus_everolimus cabozantinib_plus_nivolumab pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 440 
Permutations after applying rule : 440 
[1] "everolimus"
applying rule. everolimus is only allowed after avelumab_plus_axitinib axitinib cabozantinib lenvatinib_plus_everolimus cabozantinib_plus_nivolumab pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 440 
Permutations after applying rule : 440 
[1] "lenvatinib_plus_everolimus"
applying rule. lenvatinib_plus_everolimus is not allowed immediately after nivolumab_plus_ipilimumab 
Permutations before applying rule: 440 
Permutations after applying rule : 440 
[1] "axitinib"
applying rule axitinib : avelumab_plus_axitinib axitinib cannot be in one permutation
Permutations before applying rule: 440 
Permutations after applying rule : 440 
[1] "everolimus"
applying rule everolimus : lenvatinib_plus_everolimus everolimus cannot be in one permutation
Permutations before applying rule: 440 
Permutations after applying rule : 384 
[1] "lenvatinib_plus_everolimus"
applying rule lenvatinib_plus_everolimus : lenvatinib_plus_everolimus lenvatinib_plus_pembrolizumab cannot be in one permutation
Permutations before applying rule: 384 
Permutations after applying rule : 384 
[1] "TKIs"
applying rule TKIs : sunitinib pazopanib tivozanib cannot be in one permutation
Permutations before applying rule: 384 
Permutations after applying rule : 198 
[1] "lenvatinib_plus_everolimus"
applying rule: lenvatinib_plus_everolimus can only be after ONE of axitinib cabozantinib pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 198 
Permutations after applying rule : 182 
[1] "cabozantinib"
applying rule: cabozantinib as 2L+ only allowed after avelumab_plus_axitinib axitinib lenvatinib_plus_everolimus cabozantinib_plus_nivolumab pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 182 
Permutations after applying rule : 182 
[1] "pazopanib"
applying rule: pazopanib as 2L+ only allowed immediately after avelumab_plus_axitinib lenvatinib_plus_pembrolizumab cabozantinib_plus_nivolumab nivolumab_plus_ipilimumab 
Permutations before applying rule: 182 
Permutations after applying rule : 182 
[1] "sunitinib"
applying rule: sunitinib as 2L+ only allowed immediately after avelumab_plus_axitinib lenvatinib_plus_pembrolizumab cabozantinib_plus_nivolumab nivolumab_plus_ipilimumab 
Permutations before applying rule: 182 
Permutations after applying rule : 182 
[1] "tivozanib"
applying rule: tivozanib as 2L+ only allowed immediately after avelumab_plus_axitinib lenvatinib_plus_pembrolizumab cabozantinib_plus_nivolumab nivolumab_plus_ipilimumab 
Permutations before applying rule: 182 
Permutations after applying rule : 182 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(seqs) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-14-contents" aria-controls="callout-14" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Introduction to <code>f_path_tx_restrict</code>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-14" class="callout-14-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><code>f_path_tx_restrict</code> is defined in two .R files: <code>rccFunctions.R</code> and <code>sequences.R</code>. In this script, we did not use <code>rccFunctions.R</code>, and just sourced <code>sequences.R</code>.</p>
<p>This has substantially reduced the number of rows with possible sequence combinations in <code>i$sequences</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(i<span class="sc">$</span>sequences)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 26404     5</code></pre>
</div>
</div>
<p>It utilises several other functions from <code>sequences.R</code>, each taking the input of <code>i</code> and <code>population</code>, where population is an element from:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>i_nr_populations</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4</code></pre>
</div>
</div>
<p>We can see from the excel spreadsheet that this is the value for total populations from <code>Lists</code>, and that above it it mentions the popoulations:</p>
<ul>
<li>pop1 &gt;12m since IO, favourable risk</li>
<li>pop2 &gt;12m since IO, intermed/poor risk</li>
<li>pop3 &lt;12m since IO, favourable risk</li>
<li>pop4 &lt;12m since IO, intermed/poor risk</li>
</ul>
<p>IO refers to immuno-ocology. also known as immunotherapy.</p>
<p>The risks are as defined in the International Metastatic Renal Cell Carcinoma Database Consortium (IMDC) criteria. RCC can be defined as either:</p>
<ul>
<li><strong>Favourable-risk</strong> disease/cancer/RCC</li>
<li><strong>Intermediate- and poor-risk</strong> disease/cancer/RCC</li>
</ul>
<p>This then guides treatment decisions:</p>
<ul>
<li>Treatments for all risk groups (i.e.&nbsp;favourable, intermediate or poor) include “sunitinib, pazopanib, tivozanib or avelumab plus axitinib”</li>
<li>Additional treatments for intermediate- or poor-risk cancer are “nivolumab plus ipilimumab, lenvatinib plus pembrolizumab, or cabozantinib” <span class="citation" data-cites="national_institute_for_health_and_care_excellence_nice_cabozantinib_2024">[<a href="#ref-national_institute_for_health_and_care_excellence_nice_cabozantinib_2024" role="doc-biblioref">1</a>]</span></li>
</ul>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-15-contents" aria-controls="callout-15" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Explanation of <code>f_get_allowed_lists()</code>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-15" class="callout-15-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The first function used within <code>f_path_tx_restrict()</code> is <code>f_get_allowed_lists()</code> to get the value for <code>allowed</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>f_get_allowed_lists <span class="ot">&lt;-</span> <span class="cf">function</span>(i, population) {</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> i[<span class="fu">grep</span>(<span class="st">"allowed"</span>, <span class="fu">names</span>(i))]</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> output[<span class="fu">grep</span>(<span class="fu">paste0</span>(<span class="st">"pop"</span>, population), <span class="fu">names</span>(output))]</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  output <span class="ot">&lt;-</span> output[<span class="sc">!</span>(<span class="fu">grepl</span>(<span class="st">"only_one_allowed"</span>, <span class="fu">names</span>(output)))]</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(output) <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="fu">paste0</span>(<span class="st">"List_"</span>,<span class="st">"pop"</span>,population,<span class="st">"_"</span>), <span class="st">""</span>, <span class="fu">names</span>(output))</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">f_check_drugnames</span>(i, output)</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(output)</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The first thing this function does is find all the “allowed” lists from <code>i</code>. As you can see, there are several lists defined for each population.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>output <span class="ot">&lt;-</span> i[<span class="fu">grep</span>(<span class="st">"allowed"</span>, <span class="fu">names</span>(i))]</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(output)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "List_pop1_allowed"                                    
 [2] "List_pop1_axitinib_only_one_allowed"                  
 [3] "List_pop1_cabozantinib_only_one_allowed"              
 [4] "List_pop1_everolimus_only_one_allowed"                
 [5] "List_pop1_io_only_one_allowed"                        
 [6] "List_pop1_lenvatinib_plus_everolimus_allowed"         
 [7] "List_pop1_nivolumab_only_one_allowed"                 
 [8] "List_pop1_TKIs_only_one_allowed"                      
 [9] "List_pop2_allowed"                                    
[10] "List_pop2_axitinib_only_one_allowed"                  
[11] "List_pop2_cabozantinib_only_one_allowed"              
[12] "List_pop2_everolimus_only_one_allowed"                
[13] "List_pop2_io_only_one_allowed"                        
[14] "List_pop2_lenvatinib_plus_everolimus_only_one_allowed"
[15] "List_pop2_nivolumab_only_one_allowed"                 
[16] "List_pop2_TKIs_only_one_allowed"                      
[17] "List_pop3_allowed"                                    
[18] "List_pop3_axitinib_only_one_allowed"                  
[19] "List_pop3_everolimus_only_one_allowed"                
[20] "List_pop3_lenvatinib_plus_everolimus_only_one_allowed"
[21] "List_pop3_TKIs_only_one_allowed"                      
[22] "List_pop4_allowed"                                    
[23] "List_pop4_axitinib_only_one_allowed"                  
[24] "List_pop4_everolimus_only_one_allowed"                
[25] "List_pop4_lenvatinib_plus_everolimus_only_one_allowed"
[26] "List_pop4_TKIs_only_one_allowed"                      </code></pre>
</div>
</div>
<p>It then filters to one of the populations (<code>pop1</code>, <code>pop2</code>, <code>pop3</code> or <code>pop4</code>). For example, for <code>pop1</code>…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>population <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>output <span class="ot">&lt;-</span> output[<span class="fu">grep</span>(<span class="fu">paste0</span>(<span class="st">"pop"</span>, population), <span class="fu">names</span>(output))]</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>output</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$List_pop1_allowed
 [1] "avelumab_plus_axitinib"      "axitinib"                   
 [3] "cabozantinib"                "everolimus"                 
 [5] "lenvatinib_plus_everolimus"  "cabozantinib_plus_nivolumab"
 [7] "nivolumab_monotherapy"       "pazopanib"                  
 [9] "sunitinib"                   "tivozanib"                  

$List_pop1_axitinib_only_one_allowed
[1] "avelumab_plus_axitinib" "axitinib"              

$List_pop1_cabozantinib_only_one_allowed
[1] "cabozantinib"                "cabozantinib_plus_nivolumab"

$List_pop1_everolimus_only_one_allowed
[1] "lenvatinib_plus_everolimus" "everolimus"                

$List_pop1_io_only_one_allowed
[1] "avelumab_plus_axitinib"        "nivolumab_plus_ipilimumab"    
[3] "cabozantinib_plus_nivolumab"   "nivolumab_monotherapy"        
[5] "lenvatinib_plus_pembrolizumab"

$List_pop1_lenvatinib_plus_everolimus_allowed
[1] "lenvatinib_plus_everolimus"    "lenvatinib_plus_pembrolizumab"

$List_pop1_nivolumab_only_one_allowed
[1] "nivolumab_plus_ipilimumab"   "cabozantinib_plus_nivolumab"
[3] "nivolumab_monotherapy"      

$List_pop1_TKIs_only_one_allowed
[1] "sunitinib" "pazopanib" "tivozanib"</code></pre>
</div>
</div>
<p>It removes the lists that said <code>only_one_allowed</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>output <span class="ot">&lt;-</span> output[<span class="sc">!</span>(<span class="fu">grepl</span>(<span class="st">"only_one_allowed"</span>, <span class="fu">names</span>(output)))]</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>output</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$List_pop1_allowed
 [1] "avelumab_plus_axitinib"      "axitinib"                   
 [3] "cabozantinib"                "everolimus"                 
 [5] "lenvatinib_plus_everolimus"  "cabozantinib_plus_nivolumab"
 [7] "nivolumab_monotherapy"       "pazopanib"                  
 [9] "sunitinib"                   "tivozanib"                  

$List_pop1_lenvatinib_plus_everolimus_allowed
[1] "lenvatinib_plus_everolimus"    "lenvatinib_plus_pembrolizumab"</code></pre>
</div>
</div>
<p>Finally, it renames the lists to remove the words <code>List</code> and <code>pop1</code>(2/3/4).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(output) <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="fu">paste0</span>(<span class="st">"List_"</span>,<span class="st">"pop"</span>,population,<span class="st">"_"</span>), <span class="st">""</span>, <span class="fu">names</span>(output))</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>output</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$allowed
 [1] "avelumab_plus_axitinib"      "axitinib"                   
 [3] "cabozantinib"                "everolimus"                 
 [5] "lenvatinib_plus_everolimus"  "cabozantinib_plus_nivolumab"
 [7] "nivolumab_monotherapy"       "pazopanib"                  
 [9] "sunitinib"                   "tivozanib"                  

$lenvatinib_plus_everolimus_allowed
[1] "lenvatinib_plus_everolimus"    "lenvatinib_plus_pembrolizumab"</code></pre>
</div>
</div>
<p>This checks that each of the names in the list match the names in <code>i$List_comparators</code>, and will stop the code and return an error message if any do not.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>List_comparators</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "nivolumab_monotherapy"         "cabozantinib_plus_nivolumab"  
 [3] "nivolumab_plus_ipilimumab"     "lenvatinib_plus_pembrolizumab"
 [5] "avelumab_plus_axitinib"        "pazopanib"                    
 [7] "tivozanib"                     "sunitinib"                    
 [9] "cabozantinib"                  "lenvatinib_plus_everolimus"   
[11] "everolimus"                    "axitinib"                     
[13] "sorafenib"                     "placebo_BSC"                  </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">f_check_drugnames</span>(i, output)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-16-contents" aria-controls="callout-16" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Returning to <code>f_path_tx_restrict</code>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-16" class="callout-16-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The result from the function above is input into <code>f_path_tx_restrict</code> as <code>allowed</code>, and used in a single line, to remove drugs not allowed for that population:</p>
<pre><code>s &lt;- f_path_allowed(s, allowed[[1]])</code></pre>
<p>As a reminder, <code>s</code> and <code>allowed[[1]]</code> are:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Input to f_path_tx_restrict(), as allowed = f_get_allowed_lists(i, population)</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>allowed <span class="ot">&lt;-</span> output</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>allowed[[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "avelumab_plus_axitinib"      "axitinib"                   
 [3] "cabozantinib"                "everolimus"                 
 [5] "lenvatinib_plus_everolimus"  "cabozantinib_plus_nivolumab"
 [7] "nivolumab_monotherapy"       "pazopanib"                  
 [9] "sunitinib"                   "tivozanib"                  </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Input to f_path_tx_restrict()</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>sequences <span class="ot">&lt;-</span> i<span class="sc">$</span>sequences</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> sequences</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(s)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
</div>
<p>We apply the function <code>f_path_allowed()</code>…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>f_path_allowed <span class="ot">&lt;-</span> <span class="cf">function</span>(perms, rule) {</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">#objective of function is to identify perms that violate rule and exclude</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"applying rule:"</span>, rule, <span class="st">"are only allowed treatments.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Permutations before applying rule:"</span>, <span class="fu">nrow</span>(perms), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>  rule <span class="ot">&lt;-</span> <span class="fu">c</span>(rule, <span class="st">"BSC"</span>, <span class="st">""</span>)</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(perms)) {</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>    perms <span class="ot">&lt;-</span> perms[perms[,n] <span class="sc">%in%</span> rule,]</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Permutations after applying rule :"</span>, <span class="fu">nrow</span>(perms),<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(perms)</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So in this case…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>perms <span class="ot">&lt;-</span> s</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>rule <span class="ot">&lt;-</span> allowed[[<span class="dv">1</span>]]</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"applying rule:"</span>, rule, <span class="st">"are only allowed treatments.</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>applying rule: avelumab_plus_axitinib axitinib cabozantinib everolimus lenvatinib_plus_everolimus cabozantinib_plus_nivolumab nivolumab_monotherapy pazopanib sunitinib tivozanib are only allowed treatments.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Permutations before applying rule:"</span>, <span class="fu">nrow</span>(perms), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Permutations before applying rule: 26404 </code></pre>
</div>
</div>
<p>It adds BSC (best supportive care) and an empty element to the list of allowed treatments</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>rule <span class="ot">&lt;-</span> <span class="fu">c</span>(rule, <span class="st">"BSC"</span>, <span class="st">""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It then loops through each of the lines of treatment (columns of <code>perms</code> - V1, V2, V3, V4, V5, V6), and only keeps the rows if the treatment in that column in that row is in the list of allowed treatments.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(perms)) {</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  perms <span class="ot">&lt;-</span> perms[perms[,n] <span class="sc">%in%</span> rule,]</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Permutations after applying rule :"</span>, <span class="fu">nrow</span>(perms),<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Permutations after applying rule : 5860 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">f_path_allowed</span>(s, allowed[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>applying rule: avelumab_plus_axitinib axitinib cabozantinib everolimus lenvatinib_plus_everolimus cabozantinib_plus_nivolumab nivolumab_monotherapy pazopanib sunitinib tivozanib are only allowed treatments.
Permutations before applying rule: 26404 
Permutations after applying rule : 5860 </code></pre>
</div>
<div class="cell-output-display">

</div>
</div>
<p>So, as a whole:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (population <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>i<span class="sc">$</span>i_nr_populations) {</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>  sequences <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(i<span class="sc">$</span>sequences)</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>  allowed <span class="ot">&lt;-</span> <span class="fu">f_get_allowed_lists</span>(i, population)</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">"Dropping drugs not allowed for pop"</span>, population))</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>  sequences</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>  s <span class="ot">&lt;-</span> <span class="fu">f_path_allowed</span>(sequences, allowed[[<span class="dv">1</span>]])</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>  s</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Dropping drugs not allowed for pop1"
applying rule: avelumab_plus_axitinib axitinib cabozantinib everolimus lenvatinib_plus_everolimus cabozantinib_plus_nivolumab nivolumab_monotherapy pazopanib sunitinib tivozanib are only allowed treatments.
Permutations before applying rule: 26404 
Permutations after applying rule : 5860 
[1] "Dropping drugs not allowed for pop2"
applying rule: avelumab_plus_axitinib axitinib cabozantinib everolimus nivolumab_plus_ipilimumab lenvatinib_plus_everolimus cabozantinib_plus_nivolumab nivolumab_monotherapy pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib are only allowed treatments.
Permutations before applying rule: 26404 
Permutations after applying rule : 13344 
[1] "Dropping drugs not allowed for pop3"
applying rule: axitinib cabozantinib everolimus lenvatinib_plus_everolimus nivolumab_monotherapy pazopanib sunitinib tivozanib are only allowed treatments.
Permutations before applying rule: 26404 
Permutations after applying rule : 2080 
[1] "Dropping drugs not allowed for pop4"
applying rule: axitinib cabozantinib everolimus lenvatinib_plus_everolimus nivolumab_monotherapy pazopanib sunitinib tivozanib are only allowed treatments.
Permutations before applying rule: 26404 
Permutations after applying rule : 2080 </code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-17-contents" aria-controls="callout-17" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Explaining the other functions in <code>f_path_tx_restrict()</code>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-17" class="callout-17-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>As a reminder, these were:</p>
<pre><code>s &lt;- f_path_tx_restrict(
  sequences                = i$sequences,
  allowed                  = f_get_allowed_lists(i, population), #overall list of allowed drugs in this popn
  L1                       = f_get_L1_lists(i, population), # 1L drugs allowed in this popn
  L2                       = f_get_L2_lists(i, population), # 2L drugs allowed in this popn
  L3                       = f_get_L3_lists(i, population), # 3L drugs allowed in this popn
  L4                       = f_get_L4_lists(i, population), # 4L drugs allowed in this popn
  only_after               = f_get_only_after_lists(i, population), #list of restrictions where tx can be only after the listed txs
  not_immediate_after      = f_get_not_immediate_after_lists(i, population), #list of restrictions where tx can be only immediately before the listed txs
  one_in_list              = f_get_one_in_list_lists(i, population), #list of restrictions where only one of the tx in each list is allowed 
  only_after_one           = f_get_only_after_one_lists(i, population), #list of restrictions where only one of the listed treatments is allowed prior to current therapy 
  L2_only_after            = f_get_2L_only_after_lists(i, population), #list of 2L+ restrictions: if drug is used 2L, 3L or 4L, can only be after drug x
  L2_only_immediate_after  = f_get_2L_only_immediate_after_lists(i, population), #list of 2L+ restrictions: if drug is used 2L, 3L or 4L, can only be immediately after drug x
  L2_only_one              = f_get_2L_only_one_lists(i, population) #list of 2L+ drugs where only one of them allowed in a given sequence
)</code></pre>
<p>We have functions that find the overall list of allowed drugs for the population, and then the drugs allowed for each line of treatment.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Overall list of allowed drugs"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Overall list of allowed drugs"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">f_get_allowed_lists</span>(i, i<span class="sc">$</span>i_nr_populations[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$allowed
[1] "axitinib"                   "cabozantinib"              
[3] "everolimus"                 "lenvatinib_plus_everolimus"
[5] "nivolumab_monotherapy"      "pazopanib"                 
[7] "sunitinib"                  "tivozanib"                 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"L1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "L1"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">f_get_L1_lists</span>(i, i<span class="sc">$</span>i_nr_populations[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "cabozantinib" "pazopanib"    "sunitinib"    "tivozanib"   </code></pre>
</div>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"L2"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "L2"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="fu">f_get_L2_lists</span>(i, i<span class="sc">$</span>i_nr_populations[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "axitinib"                   "cabozantinib"              
[3] "everolimus"                 "lenvatinib_plus_everolimus"
[5] "nivolumab_monotherapy"      "pazopanib"                 
[7] "sunitinib"                  "tivozanib"                 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"L3"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "L3"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="fu">f_get_L3_lists</span>(i, i<span class="sc">$</span>i_nr_populations[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "axitinib"                   "cabozantinib"              
[3] "everolimus"                 "lenvatinib_plus_everolimus"
[5] "nivolumab_monotherapy"      "pazopanib"                 
[7] "sunitinib"                  "tivozanib"                 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"L4"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "L4"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="fu">f_get_L4_lists</span>(i, i<span class="sc">$</span>i_nr_populations[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "axitinib"   "everolimus"</code></pre>
</div>
</div>
<p>We then have treatments that can only come after or before certain treatments. As illustrated in Figure 1 in the pathway model report, you can see examples like how:</p>
<ul>
<li>Axitinib - can only administer after tyrosine kinase inhibitor (TKI) (e.g.&nbsp;sunitinib) or cytokine</li>
<li>Everolimus - can only administrater after vascular endothelial growth factor (VEGF)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"list of restrictions where tx can be only after the listed txs"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "list of restrictions where tx can be only after the listed txs"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">f_get_only_after_lists</span>(i, i<span class="sc">$</span>i_nr_populations[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$axitinib
[1] "avelumab_plus_axitinib"        "cabozantinib"                 
[3] "lenvatinib_plus_everolimus"    "cabozantinib_plus_nivolumab"  
[5] "pazopanib"                     "lenvatinib_plus_pembrolizumab"
[7] "sunitinib"                     "tivozanib"                    

$everolimus
[1] "avelumab_plus_axitinib"        "axitinib"                     
[3] "cabozantinib"                  "lenvatinib_plus_everolimus"   
[5] "cabozantinib_plus_nivolumab"   "pazopanib"                    
[7] "lenvatinib_plus_pembrolizumab" "sunitinib"                    
[9] "tivozanib"                    </code></pre>
</div>
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"list of restrictions where tx can be only immediately before the listed txs"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "list of restrictions where tx can be only immediately before the listed txs"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">f_get_not_immediate_after_lists</span>(i, i<span class="sc">$</span>i_nr_populations[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$lenvatinib_plus_everolimus
[1] "nivolumab_plus_ipilimumab"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"list of restrictions where only one of the tx in each list is allowed "</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "list of restrictions where only one of the tx in each list is allowed "</code></pre>
</div>
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="fu">f_get_one_in_list_lists</span>(i, i<span class="sc">$</span>i_nr_populations[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$axitinib
[1] "avelumab_plus_axitinib" "axitinib"              

$everolimus
[1] "lenvatinib_plus_everolimus" "everolimus"                

$lenvatinib_plus_everolimus
[1] "lenvatinib_plus_everolimus"    "lenvatinib_plus_pembrolizumab"

$TKIs
[1] "sunitinib" "pazopanib" "tivozanib"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"list of restrictions where only one of the listed treatments is allowed prior to current therapy "</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "list of restrictions where only one of the listed treatments is allowed prior to current therapy "</code></pre>
</div>
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="fu">f_get_only_after_one_lists</span>(i, i<span class="sc">$</span>i_nr_populations[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$lenvatinib_plus_everolimus
[1] "axitinib"                      "cabozantinib"                 
[3] "pazopanib"                     "lenvatinib_plus_pembrolizumab"
[5] "sunitinib"                     "tivozanib"                    </code></pre>
</div>
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"list of 2L+ restrictions: if drug is used 2L, 3L or 4L, can only be after drug x"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "list of 2L+ restrictions: if drug is used 2L, 3L or 4L, can only be after drug x"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="fu">f_get_2L_only_after_lists</span>(i, i<span class="sc">$</span>i_nr_populations[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$cabozantinib
[1] "avelumab_plus_axitinib"        "axitinib"                     
[3] "lenvatinib_plus_everolimus"    "cabozantinib_plus_nivolumab"  
[5] "pazopanib"                     "lenvatinib_plus_pembrolizumab"
[7] "sunitinib"                     "tivozanib"                    </code></pre>
</div>
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"list of 2L+ restrictions: if drug is used 2L, 3L or 4L, can only be immediately after drug x"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "list of 2L+ restrictions: if drug is used 2L, 3L or 4L, can only be immediately after drug x"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="fu">f_get_2L_only_immediate_after_lists</span>(i, i<span class="sc">$</span>i_nr_populations[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$pazopanib
[1] "avelumab_plus_axitinib"        "lenvatinib_plus_pembrolizumab"
[3] "cabozantinib_plus_nivolumab"   "nivolumab_plus_ipilimumab"    

$sunitinib
[1] "avelumab_plus_axitinib"        "lenvatinib_plus_pembrolizumab"
[3] "cabozantinib_plus_nivolumab"   "nivolumab_plus_ipilimumab"    

$tivozanib
[1] "avelumab_plus_axitinib"        "lenvatinib_plus_pembrolizumab"
[3] "cabozantinib_plus_nivolumab"   "nivolumab_plus_ipilimumab"    </code></pre>
</div>
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"list of 2L+ drugs where only one of them allowed in a given sequence"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "list of 2L+ drugs where only one of them allowed in a given sequence"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="fu">f_get_2L_only_one_lists</span>(i, i<span class="sc">$</span>i_nr_populations[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>named list()</code></pre>
</div>
</div>
<p>Within <code>f_path_tx_restrict()</code>, various functions are then applied to implement the logic of these lists. For example:</p>
<ul>
<li><code>f_path_drug_lines()</code> is used to remove drugs from a line unless it is listed in <code>L1</code>, <code>L2</code>, <code>L3</code>, or <code>L4</code>.</li>
<li>For <code>only_after</code>, <code>f_path_notAllowedImmediateAfter()</code> is used to remove permutations that have treatment before drugs in rule</li>
</ul>
<p>And so on. Overall, we then get:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>population <span class="ot">&lt;-</span> i<span class="sc">$</span>i_nr_populations[<span class="dv">1</span>]</span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">f_path_tx_restrict</span>(</span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">sequences                =</span> i<span class="sc">$</span>sequences,</span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">allowed                  =</span> <span class="fu">f_get_allowed_lists</span>(i, population), <span class="co">#overall list of allowed drugs in this popn</span></span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">L1                       =</span> <span class="fu">f_get_L1_lists</span>(i, population), <span class="co"># 1L drugs allowed in this popn</span></span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">L2                       =</span> <span class="fu">f_get_L2_lists</span>(i, population), <span class="co"># 2L drugs allowed in this popn</span></span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">L3                       =</span> <span class="fu">f_get_L3_lists</span>(i, population), <span class="co"># 3L drugs allowed in this popn</span></span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">L4                       =</span> <span class="fu">f_get_L4_lists</span>(i, population), <span class="co"># 4L drugs allowed in this popn</span></span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">only_after               =</span> <span class="fu">f_get_only_after_lists</span>(i, population), <span class="co">#list of restrictions where tx can be only after the listed txs</span></span>
<span id="cb125-11"><a href="#cb125-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">not_immediate_after      =</span> <span class="fu">f_get_not_immediate_after_lists</span>(i, population), <span class="co">#list of restrictions where tx can be only immediately before the listed txs</span></span>
<span id="cb125-12"><a href="#cb125-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">one_in_list              =</span> <span class="fu">f_get_one_in_list_lists</span>(i, population), <span class="co">#list of restrictions where only one of the tx in each list is allowed </span></span>
<span id="cb125-13"><a href="#cb125-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">only_after_one           =</span> <span class="fu">f_get_only_after_one_lists</span>(i, population), <span class="co">#list of restrictions where only one of the listed treatments is allowed prior to current therapy </span></span>
<span id="cb125-14"><a href="#cb125-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">L2_only_after            =</span> <span class="fu">f_get_2L_only_after_lists</span>(i, population), <span class="co">#list of 2L+ restrictions: if drug is used 2L, 3L or 4L, can only be after drug x</span></span>
<span id="cb125-15"><a href="#cb125-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">L2_only_immediate_after  =</span> <span class="fu">f_get_2L_only_immediate_after_lists</span>(i, population), <span class="co">#list of 2L+ restrictions: if drug is used 2L, 3L or 4L, can only be immediately after drug x</span></span>
<span id="cb125-16"><a href="#cb125-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">L2_only_one              =</span> <span class="fu">f_get_2L_only_one_lists</span>(i, population) <span class="co">#list of 2L+ drugs where only one of them allowed in a given sequence</span></span>
<span id="cb125-17"><a href="#cb125-17" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dropping drugs not allowed for this population.
applying rule: axitinib cabozantinib everolimus lenvatinib_plus_everolimus nivolumab_monotherapy pazopanib sunitinib tivozanib are only allowed treatments.
Permutations before applying rule: 26404 
Permutations after applying rule : 2080 
applying rule: drug line restrictions.
Permutations before applying rule: 2080 
Permutations after applying rule : 440 
[1] "axitinib"
applying rule. axitinib is only allowed after avelumab_plus_axitinib cabozantinib lenvatinib_plus_everolimus cabozantinib_plus_nivolumab pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 440 
Permutations after applying rule : 440 
[1] "everolimus"
applying rule. everolimus is only allowed after avelumab_plus_axitinib axitinib cabozantinib lenvatinib_plus_everolimus cabozantinib_plus_nivolumab pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 440 
Permutations after applying rule : 440 
[1] "lenvatinib_plus_everolimus"
applying rule. lenvatinib_plus_everolimus is not allowed immediately after nivolumab_plus_ipilimumab 
Permutations before applying rule: 440 
Permutations after applying rule : 440 
[1] "axitinib"
applying rule axitinib : avelumab_plus_axitinib axitinib cannot be in one permutation
Permutations before applying rule: 440 
Permutations after applying rule : 440 
[1] "everolimus"
applying rule everolimus : lenvatinib_plus_everolimus everolimus cannot be in one permutation
Permutations before applying rule: 440 
Permutations after applying rule : 384 
[1] "lenvatinib_plus_everolimus"
applying rule lenvatinib_plus_everolimus : lenvatinib_plus_everolimus lenvatinib_plus_pembrolizumab cannot be in one permutation
Permutations before applying rule: 384 
Permutations after applying rule : 384 
[1] "TKIs"
applying rule TKIs : sunitinib pazopanib tivozanib cannot be in one permutation
Permutations before applying rule: 384 
Permutations after applying rule : 198 
[1] "lenvatinib_plus_everolimus"
applying rule: lenvatinib_plus_everolimus can only be after ONE of axitinib cabozantinib pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 198 
Permutations after applying rule : 182 
[1] "cabozantinib"
applying rule: cabozantinib as 2L+ only allowed after avelumab_plus_axitinib axitinib lenvatinib_plus_everolimus cabozantinib_plus_nivolumab pazopanib lenvatinib_plus_pembrolizumab sunitinib tivozanib 
Permutations before applying rule: 182 
Permutations after applying rule : 182 
[1] "pazopanib"
applying rule: pazopanib as 2L+ only allowed immediately after avelumab_plus_axitinib lenvatinib_plus_pembrolizumab cabozantinib_plus_nivolumab nivolumab_plus_ipilimumab 
Permutations before applying rule: 182 
Permutations after applying rule : 182 
[1] "sunitinib"
applying rule: sunitinib as 2L+ only allowed immediately after avelumab_plus_axitinib lenvatinib_plus_pembrolizumab cabozantinib_plus_nivolumab nivolumab_plus_ipilimumab 
Permutations before applying rule: 182 
Permutations after applying rule : 182 
[1] "tivozanib"
applying rule: tivozanib as 2L+ only allowed immediately after avelumab_plus_axitinib lenvatinib_plus_pembrolizumab cabozantinib_plus_nivolumab nivolumab_plus_ipilimumab 
Permutations before applying rule: 182 
Permutations after applying rule : 182 </code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>sequences <span class="ot">&lt;-</span> seqs</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(s, seqs, populations)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="import-ipd-and-look-ups" class="level2">
<h2 class="anchored" data-anchor-id="import-ipd-and-look-ups">Import IPD and look-ups</h2>
<section id="import-individual-patient-level-data-ipd-pseudosynthetic-trial-data" class="level3">
<h3 class="anchored" data-anchor-id="import-individual-patient-level-data-ipd-pseudosynthetic-trial-data">Import individual patient-level data (IPD) (pseudo/synthetic trial data)</h3>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-18-contents" aria-controls="callout-18" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-18" class="callout-18-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Set excel path at start of script instead of here and changed default path</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(excel_path2)) {</span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>  wb <span class="ot">&lt;-</span> <span class="fu">f_excel_extract</span>(excel_path2, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>  i<span class="sc">$</span>surv<span class="sc">$</span>pld <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(wb<span class="sc">$</span><span class="st">`</span><span class="at">_xlnm._FilterDatabase</span><span class="st">`</span>)</span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(wb)</span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a>  wb <span class="ot">&lt;-</span> <span class="fu">f_excel_extract</span>(rstudioapi<span class="sc">::</span><span class="fu">selectFile</span>(</span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Select the IPD file (IPD_R_input_noACIC.xlsx)"</span>,</span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"IPD_R_input_noACIC.xlsx"</span>,</span>
<span id="cb128-11"><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">path =</span> <span class="st">"../1_Data/"</span>,</span>
<span id="cb128-12"><a href="#cb128-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">filter =</span> <span class="st">"Excel Files (*.xlsx)"</span>,</span>
<span id="cb128-13"><a href="#cb128-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">existing =</span> <span class="cn">TRUE</span></span>
<span id="cb128-14"><a href="#cb128-14" aria-hidden="true" tabindex="-1"></a>  ), <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb128-15"><a href="#cb128-15" aria-hidden="true" tabindex="-1"></a>  i<span class="sc">$</span>surv<span class="sc">$</span>pld <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(wb<span class="sc">$</span><span class="st">`</span><span class="at">_xlnm._FilterDatabase</span><span class="st">`</span>)</span>
<span id="cb128-16"><a href="#cb128-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb128-17"><a href="#cb128-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Extracting named range _xlnm._FilterDatabase from ../1_Data/IPD_R_input_noACIC.xlsx</code></pre>
</div>
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>pld <span class="ot">&lt;-</span> i<span class="sc">$</span>surv<span class="sc">$</span>pld[,<span class="fu">list</span>(population,line,molecule,trial,endpoint,timew,event_censor)]</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>pld[timew <span class="sc">==</span><span class="dv">0</span>,<span class="st">"timew"</span>] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">7</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-19-contents" aria-controls="callout-19" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-19" class="callout-19-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The file we are importing contains pseudo-individual patient data (IPD) for all the clinical trials (i.e.&nbsp;simulated data to replace clinical trial data considered confidential).</p>
<p>This uses <code>f_excel_extract()</code> like before, this time from <code>IPD_R_input_noACIC.xlsx</code>. It produces <code>wb</code> which is a list with one item: <code>wb$_xlnm._FilterDatabase</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>wb <span class="ot">&lt;-</span> <span class="fu">f_excel_extract</span>(excel_path2, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Extracting named range _xlnm._FilterDatabase from ../1_Data/IPD_R_input_noACIC.xlsx</code></pre>
</div>
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(wb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
</div>
<p>That is simply the table from the <code>IPD</code> sheet of that dataframe.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(wb<span class="sc">$</span><span class="st">`</span><span class="at">_xlnm._FilterDatabase</span><span class="st">`</span>)</span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 21741     9</code></pre>
</div>
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
</div>
<p>The script then filter to only the columns: <code>list(population,line,molecule,trial,endpoint,timew,event_censor)</code>.</p>
<p>Then it finds the rows where the column <code>timew</code>==0, and replaces their values with 1/7. In <code>Model_Structure.R</code>, they explain that this is because we don’t allow zero survival times, so has to be at least 1 day (and since TuotA is in weeks, this is 1/7… not sure what TuotA is).</p>
<p>Looking at what this dataframe contains…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(df<span class="sc">$</span>population)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0 1 2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(df<span class="sc">$</span>line)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1 2 3 4</code></pre>
</div>
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(df<span class="sc">$</span>molecule)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1]   1   7   0  10   2   4   5   6   8   9  11 666 999</code></pre>
</div>
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(df<span class="sc">$</span>trial)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0 1 2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(df<span class="sc">$</span>endpoint)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0 1 2 3 4</code></pre>
</div>
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="fu">describe</span>(df<span class="sc">$</span>timew)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>df$timew 
       n  missing distinct     Info     Mean      Gmd      .05      .10 
   21741        0     2966        1    254.5    287.7     8.80    17.43 
     .25      .50      .75      .90      .95 
   53.00   148.00   339.00   686.00   909.00 

lowest : 0        0.130446 0.142857 0.142857 0.285714
highest: 1605     1610     1622     1645     1659    </code></pre>
</div>
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(df<span class="sc">$</span>event_censor)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1 0</code></pre>
</div>
</div>
<p><code>molecule</code>: combination therapies are under same number</p>
<p><code>trial</code>: trial id <em>within</em> population line and molecule to set them apart (so often just 1)</p>
<p><code>event_censor</code>: event coded as 1, censor as 0</p>
<p>Final result:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(i<span class="sc">$</span>surv<span class="sc">$</span>pld)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
</div>
</div>
</div>
</div>
</section>
<section id="get-look-ups-for-each-column" class="level3">
<h3 class="anchored" data-anchor-id="get-look-ups-for-each-column">Get look-ups for each column</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>id<span class="sc">$</span>ipd <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">pop      =</span> i<span class="sc">$</span>r_pld_lookup_pop<span class="sc">$</span>Number[<span class="sc">!</span><span class="fu">is.na</span>(i<span class="sc">$</span>r_pld_lookup_pop<span class="sc">$</span>Number)],</span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">line     =</span> i<span class="sc">$</span>r_pld_lookup_line<span class="sc">$</span>Number[<span class="sc">!</span><span class="fu">is.na</span>(i<span class="sc">$</span>r_pld_lookup_line<span class="sc">$</span>Number)],</span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">mol      =</span> i<span class="sc">$</span>r_pld_lookup_mol<span class="sc">$</span>Number[<span class="sc">!</span><span class="fu">is.na</span>(i<span class="sc">$</span>r_pld_lookup_mol<span class="sc">$</span>Number)],</span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">trial    =</span> i<span class="sc">$</span>r_pld_lookup_trial<span class="sc">$</span>Number[<span class="sc">!</span><span class="fu">is.na</span>(i<span class="sc">$</span>r_pld_lookup_trial<span class="sc">$</span>Number)],</span>
<span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">endpoint =</span> i<span class="sc">$</span>r_pld_lookup_endpoint<span class="sc">$</span>Number[<span class="sc">!</span><span class="fu">is.na</span>(i<span class="sc">$</span>r_pld_lookup_endpoint<span class="sc">$</span>Number)]</span>
<span id="cb153-7"><a href="#cb153-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-20-contents" aria-controls="callout-20" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-20" class="callout-20-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Gets the unique values from each column (excluding NaN)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>id<span class="sc">$</span>ipd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$pop
[1] 0 1 2

$line
[1] 1 2 3 4 5

$mol
 [1]   0   1   2   3   4   5   6   7   8   9  10  11  12 999

$trial
[1] 0 1 2

$endpoint
[1] 0 1 2 3 4</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(i<span class="sc">$</span>id<span class="sc">$</span>ipd<span class="sc">$</span>pop)      <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"pop_"</span>     , i<span class="sc">$</span>id<span class="sc">$</span>ipd<span class="sc">$</span>pop)</span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(i<span class="sc">$</span>id<span class="sc">$</span>ipd<span class="sc">$</span>line)     <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"line_"</span>    , i<span class="sc">$</span>id<span class="sc">$</span>ipd<span class="sc">$</span>line)</span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(i<span class="sc">$</span>id<span class="sc">$</span>ipd<span class="sc">$</span>mol)      <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"mol_"</span>     , i<span class="sc">$</span>id<span class="sc">$</span>ipd<span class="sc">$</span>mol)</span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(i<span class="sc">$</span>id<span class="sc">$</span>ipd<span class="sc">$</span>trial)    <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"trial_"</span>   , i<span class="sc">$</span>id<span class="sc">$</span>ipd<span class="sc">$</span>trial)</span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(i<span class="sc">$</span>id<span class="sc">$</span>ipd<span class="sc">$</span>endpoint) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"endpoint_"</span>, i<span class="sc">$</span>id<span class="sc">$</span>ipd<span class="sc">$</span>endpoint)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-21-contents" aria-controls="callout-21" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-21" class="callout-21-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Adds names for each which combine the column name with the value</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>id<span class="sc">$</span>ipd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$pop
pop_0 pop_1 pop_2 
    0     1     2 

$line
line_1 line_2 line_3 line_4 line_5 
     1      2      3      4      5 

$mol
  mol_0   mol_1   mol_2   mol_3   mol_4   mol_5   mol_6   mol_7   mol_8   mol_9 
      0       1       2       3       4       5       6       7       8       9 
 mol_10  mol_11  mol_12 mol_999 
     10      11      12     999 

$trial
trial_0 trial_1 trial_2 
      0       1       2 

$endpoint
endpoint_0 endpoint_1 endpoint_2 endpoint_3 endpoint_4 
         0          1          2          3          4 </code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>lookup<span class="sc">$</span>ipd <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">pop      =</span> <span class="fu">data.table</span>(i<span class="sc">$</span>r_pld_lookup_pop)[Description <span class="sc">!=</span> <span class="dv">0</span>],</span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">line     =</span> <span class="fu">data.table</span>(i<span class="sc">$</span>r_pld_lookup_line)[Description <span class="sc">!=</span> <span class="dv">0</span>],</span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">mol      =</span> <span class="fu">data.table</span>(i<span class="sc">$</span>r_pld_lookup_mol)[Description <span class="sc">!=</span> <span class="dv">0</span>],</span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">trial    =</span> <span class="fu">data.table</span>(i<span class="sc">$</span>r_pld_lookup_trial)[Description <span class="sc">!=</span> <span class="dv">0</span>],</span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">endpoint =</span> <span class="fu">data.table</span>(i<span class="sc">$</span>r_pld_lookup_endpoint)[Description <span class="sc">!=</span> <span class="dv">0</span>]</span>
<span id="cb159-7"><a href="#cb159-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-22-contents" aria-controls="callout-22" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-22" class="callout-22-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Makes a list containing dataframes with the look-ups for each of those columns (which were stored in <code>i</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>lookup<span class="sc">$</span>ipd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$pop
                Description                  RCC_input_desc Number
                     &lt;char&gt;                          &lt;char&gt;  &lt;num&gt;
1:                      All                 All risk groups      0
2: Poor / intermediate risk Poor or intermediate risk group      1
3:          Favourable risk           Favourable risk group      2

$line
            Description RCC_input_desc Number
                 &lt;char&gt;         &lt;char&gt;  &lt;num&gt;
1: Previously untreated             1L      1
2:             2nd line             2L      2
3:             3rd line             3L      3
4:             4th line             4L      4
5:                  BSC             5L      5

$mol
                      Description                RCC_input_desc Number
                           &lt;char&gt;                        &lt;char&gt;  &lt;num&gt;
 1:         Nivolumab monotherapy         nivolumab_monotherapy      0
 2:   Cabozantinib plus nivolumab   cabozantinib_plus_nivolumab      1
 3:     Nivolumab plus ipilimumab     nivolumab_plus_ipilimumab      2
 4: Lenvatinib plus pembrolizumab lenvatinib_plus_pembrolizumab      3
 5:        Avelumab plus axitinib        avelumab_plus_axitinib      4
 6:                     Pazopanib                     pazopanib      5
 7:                     Tivozanib                     tivozanib      6
 8:                     Sunitinib                     sunitinib      7
 9:                  Cabozantinib                  cabozantinib      8
10:    Lenvatinib plus everolimus    lenvatinib_plus_everolimus      9
11:                    Everolimus                    everolimus     10
12:                      Axitinib                      axitinib     11
13:                     Sorafenib                     sorafenib     12
14:                 Placebo / BSC                   placebo_BSC    999

$trial
           Description RCC_input_desc Number
                &lt;char&gt;         &lt;char&gt;  &lt;num&gt;
1:       CheckMate 9ER  CheckMate_9ER      0
2:       CheckMate 025  CheckMate_025      1
3: Real world evidence            RWE      2

$endpoint
   Description                    RCC_input_desc Number
        &lt;char&gt;                            &lt;char&gt;  &lt;num&gt;
1:          OS                  Overall survival      0
2:         PFS         Progression free survival      1
3:         TTD Time to treatment discontinuation      2
4:         TTP               Time to progression      3
5:         PPS         Post progression survival      4</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>line<span class="sc">$</span>seq_col <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"V"</span>,<span class="dv">2</span><span class="sc">:</span>(<span class="fu">nrow</span>(i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>line)<span class="sc">+</span><span class="dv">1</span>))</span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>line<span class="sc">$</span>R_id    <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"line_"</span>,<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>line))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-23-contents" aria-controls="callout-23" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-23" class="callout-23-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Create a list of V2, V3, V4…</p>
<p>And line_1, line_2, line_3…</p>
<p>For length of the <code>line</code> (i.e.&nbsp;5 long: 1st, 2nd, 3rd or 4th line of treatment, or best supportive care (BSC)),</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>line<span class="sc">$</span>seq_col</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "V2" "V3" "V4" "V5" "V6"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>line<span class="sc">$</span>R_id</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "line_1" "line_2" "line_3" "line_4" "line_5"</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>lookup<span class="sc">$</span>dist <span class="ot">&lt;-</span> i<span class="sc">$</span>r_pld_lookup_dist</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-24-contents" aria-controls="callout-24" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-24" class="callout-24-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Save the look up for distributions under <code>i$lookup$dist</code> (just making another entry in <code>i</code> but under a different name)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>lookup<span class="sc">$</span>dist</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>lookup<span class="sc">$</span>trt <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>mol<span class="sc">$</span>Number</span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(i<span class="sc">$</span>lookup<span class="sc">$</span>trt) <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>mol<span class="sc">$</span>RCC_input_desc</span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(i<span class="sc">$</span>lookup<span class="sc">$</span>trt)[<span class="fu">length</span>(i<span class="sc">$</span>lookup<span class="sc">$</span>trt)] <span class="ot">&lt;-</span> <span class="st">"BSC"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-25-contents" aria-controls="callout-25" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-25" class="callout-25-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Create a treatment lookup but getting the numbers for each molecule, and their equivalent name from <code>RCC_input_desc</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>lookup<span class="sc">$</span>trt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        nivolumab_monotherapy   cabozantinib_plus_nivolumab 
                            0                             1 
    nivolumab_plus_ipilimumab lenvatinib_plus_pembrolizumab 
                            2                             3 
       avelumab_plus_axitinib                     pazopanib 
                            4                             5 
                    tivozanib                     sunitinib 
                            6                             7 
                 cabozantinib    lenvatinib_plus_everolimus 
                            8                             9 
                   everolimus                      axitinib 
                           10                            11 
                    sorafenib                           BSC 
                           12                           999 </code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="pre-processing-for-survival-analysis" class="level2">
<h2 class="anchored" data-anchor-id="pre-processing-for-survival-analysis">Pre-processing for survival analysis</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>basic<span class="sc">$</span>lookup <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup</span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>basic<span class="sc">$</span>id <span class="ot">&lt;-</span> i<span class="sc">$</span>id</span>
<span id="cb172-3"><a href="#cb172-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-4"><a href="#cb172-4" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>seq_clean <span class="ot">&lt;-</span> <span class="fu">data.table</span>(i<span class="sc">$</span>sequences)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-26-contents" aria-controls="callout-26" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-26" class="callout-26-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Add look-ups and ids from <code>i</code> to <code>p</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb173"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>basic<span class="sc">$</span>lookup</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$ipd
$ipd$pop
                Description                  RCC_input_desc Number
                     &lt;char&gt;                          &lt;char&gt;  &lt;num&gt;
1:                      All                 All risk groups      0
2: Poor / intermediate risk Poor or intermediate risk group      1
3:          Favourable risk           Favourable risk group      2

$ipd$line
            Description RCC_input_desc Number seq_col   R_id
                 &lt;char&gt;         &lt;char&gt;  &lt;num&gt;  &lt;char&gt; &lt;char&gt;
1: Previously untreated             1L      1      V2 line_1
2:             2nd line             2L      2      V3 line_2
3:             3rd line             3L      3      V4 line_3
4:             4th line             4L      4      V5 line_4
5:                  BSC             5L      5      V6 line_5

$ipd$mol
                      Description                RCC_input_desc Number
                           &lt;char&gt;                        &lt;char&gt;  &lt;num&gt;
 1:         Nivolumab monotherapy         nivolumab_monotherapy      0
 2:   Cabozantinib plus nivolumab   cabozantinib_plus_nivolumab      1
 3:     Nivolumab plus ipilimumab     nivolumab_plus_ipilimumab      2
 4: Lenvatinib plus pembrolizumab lenvatinib_plus_pembrolizumab      3
 5:        Avelumab plus axitinib        avelumab_plus_axitinib      4
 6:                     Pazopanib                     pazopanib      5
 7:                     Tivozanib                     tivozanib      6
 8:                     Sunitinib                     sunitinib      7
 9:                  Cabozantinib                  cabozantinib      8
10:    Lenvatinib plus everolimus    lenvatinib_plus_everolimus      9
11:                    Everolimus                    everolimus     10
12:                      Axitinib                      axitinib     11
13:                     Sorafenib                     sorafenib     12
14:                 Placebo / BSC                   placebo_BSC    999

$ipd$trial
           Description RCC_input_desc Number
                &lt;char&gt;         &lt;char&gt;  &lt;num&gt;
1:       CheckMate 9ER  CheckMate_9ER      0
2:       CheckMate 025  CheckMate_025      1
3: Real world evidence            RWE      2

$ipd$endpoint
   Description                    RCC_input_desc Number
        &lt;char&gt;                            &lt;char&gt;  &lt;num&gt;
1:          OS                  Overall survival      0
2:         PFS         Progression free survival      1
3:         TTD Time to treatment discontinuation      2
4:         TTP               Time to progression      3
5:         PPS         Post progression survival      4


$dist
        Description RCC_input_desc Number
1 Generalised gamma       gengamma      0
2       Exponential            exp      1
3           Weibull        weibull      2
4        Log-normal          lnorm      3
5             Gamma          gamma      4
6          Gompertz       gompertz      5
7      Log-logistic         llogis      6

$trt
        nivolumab_monotherapy   cabozantinib_plus_nivolumab 
                            0                             1 
    nivolumab_plus_ipilimumab lenvatinib_plus_pembrolizumab 
                            2                             3 
       avelumab_plus_axitinib                     pazopanib 
                            4                             5 
                    tivozanib                     sunitinib 
                            6                             7 
                 cabozantinib    lenvatinib_plus_everolimus 
                            8                             9 
                   everolimus                      axitinib 
                           10                            11 
                    sorafenib                           BSC 
                           12                           999 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb175"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>basic<span class="sc">$</span>id</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$ipd
$ipd$pop
pop_0 pop_1 pop_2 
    0     1     2 

$ipd$line
line_1 line_2 line_3 line_4 line_5 
     1      2      3      4      5 

$ipd$mol
  mol_0   mol_1   mol_2   mol_3   mol_4   mol_5   mol_6   mol_7   mol_8   mol_9 
      0       1       2       3       4       5       6       7       8       9 
 mol_10  mol_11  mol_12 mol_999 
     10      11      12     999 

$ipd$trial
trial_0 trial_1 trial_2 
      0       1       2 

$ipd$endpoint
endpoint_0 endpoint_1 endpoint_2 endpoint_3 endpoint_4 
         0          1          2          3          4 </code></pre>
</div>
</div>
<p>Convert sequences to a data table</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb177"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(i<span class="sc">$</span>seq_clean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>seq_clean<span class="sc">$</span>V1 <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"pop_"</span>,<span class="fu">as.numeric</span>(<span class="fu">substr</span>(i<span class="sc">$</span>seq_clean<span class="sc">$</span>V1,<span class="dv">4</span>,<span class="dv">4</span>)) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>seq_pops <span class="ot">&lt;-</span> <span class="fu">unique</span>(i<span class="sc">$</span>seq_clean<span class="sc">$</span>V1)</span>
<span id="cb178-3"><a href="#cb178-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(i<span class="sc">$</span>seq_pops) <span class="ot">&lt;-</span> i<span class="sc">$</span>seq_pops</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-27-contents" aria-controls="callout-27" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-27" class="callout-27-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Changes <code>i$seq_clean$V1</code> from having pop_1 to pop_4, to having pop_0 to pop_3.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb179"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>seq_pops</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  pop_0   pop_1   pop_2   pop_3 
"pop_0" "pop_1" "pop_2" "pop_3" </code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb181"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>seq_clean <span class="ot">&lt;-</span> <span class="fu">lapply</span>(i<span class="sc">$</span>seq_pops, <span class="cf">function</span>(popu) {</span>
<span id="cb181-2"><a href="#cb181-2" aria-hidden="true" tabindex="-1"></a>  tmp <span class="ot">&lt;-</span> i<span class="sc">$</span>seq_clean[V1 <span class="sc">==</span> popu,<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb181-3"><a href="#cb181-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(tmp) <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>line<span class="sc">$</span>R_id[<span class="dv">1</span><span class="sc">:</span>(p<span class="sc">$</span>basic<span class="sc">$</span>R_maxlines <span class="sc">+</span> <span class="dv">1</span>)]</span>
<span id="cb181-4"><a href="#cb181-4" aria-hidden="true" tabindex="-1"></a>  tmp</span>
<span id="cb181-5"><a href="#cb181-5" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-28-contents" aria-controls="callout-28" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-28" class="callout-28-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Loops through each of the populations, and then gets the treatment sequences for that population, and saves them under new column names (line_1 to line_5), using the lookup, and saving them as seperate dataframes for each population.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>line</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb183"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(i<span class="sc">$</span>seq_clean<span class="sc">$</span>pop_0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>seq_n <span class="ot">&lt;-</span> <span class="fu">lapply</span>(i<span class="sc">$</span>seq_clean, <span class="cf">function</span>(popu) {</span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.table</span>(<span class="fu">lapply</span>(popu, <span class="cf">function</span>(co) i<span class="sc">$</span>lookup<span class="sc">$</span>trt[co]))</span>
<span id="cb184-3"><a href="#cb184-3" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-29-contents" aria-controls="callout-29" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-29" class="callout-29-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Create new item <code>i$seq_n</code>. It looks through the four sequence tables in <code>i$seq_clean</code>. It then loops through each column in each of those dataframes (i.e.&nbsp;line 1, line 2, line 3…) and uses <code>i$lookup$trt</code> to convert from the name of the treatment to the numeric identifier for that treatment.</p>
<p>Look up table:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb185"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>lookup<span class="sc">$</span>trt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        nivolumab_monotherapy   cabozantinib_plus_nivolumab 
                            0                             1 
    nivolumab_plus_ipilimumab lenvatinib_plus_pembrolizumab 
                            2                             3 
       avelumab_plus_axitinib                     pazopanib 
                            4                             5 
                    tivozanib                     sunitinib 
                            6                             7 
                 cabozantinib    lenvatinib_plus_everolimus 
                            8                             9 
                   everolimus                      axitinib 
                           10                            11 
                    sorafenib                           BSC 
                           12                           999 </code></pre>
</div>
</div>
<p>Output example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb187"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(i<span class="sc">$</span>seq_n<span class="sc">$</span>pop_0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>seq_ref <span class="ot">&lt;-</span> <span class="fu">lapply</span>(i<span class="sc">$</span>seq_clean, <span class="cf">function</span>(popu) {</span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a>  tmp <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">lapply</span>(popu, <span class="cf">function</span>(co) {</span>
<span id="cb188-3"><a href="#cb188-3" aria-hidden="true" tabindex="-1"></a>    vals <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"mol_"</span>,i<span class="sc">$</span>lookup<span class="sc">$</span>trt[co])</span>
<span id="cb188-4"><a href="#cb188-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(vals <span class="sc">==</span> <span class="st">"mol_NA"</span>,<span class="cn">NA</span>,vals)</span>
<span id="cb188-5"><a href="#cb188-5" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb188-6"><a href="#cb188-6" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-30-contents" aria-controls="callout-30" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-30" class="callout-30-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Creates <code>i$seq_ref</code>. This just takes the table with the drug in each line of treatment, but instead of just converting it to the number representing each treatment, it adds the mol_ suffix, e.g.&nbsp;mol_4, mol_5</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb189"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(i<span class="sc">$</span>seq_ref<span class="sc">$</span>pop_0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>seq<span class="sc">$</span>n   <span class="ot">&lt;-</span> i<span class="sc">$</span>seq_n</span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>seq<span class="sc">$</span>ref <span class="ot">&lt;-</span> i<span class="sc">$</span>seq_ref</span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>seq<span class="sc">$</span>qc <span class="ot">&lt;-</span> i<span class="sc">$</span>seq_clean</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb191"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>population <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>pop<span class="sc">$</span>Number</span>
<span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>population) <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>pop<span class="sc">$</span>Description</span>
<span id="cb191-5"><a href="#cb191-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-6"><a href="#cb191-6" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>line <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>line<span class="sc">$</span>Number</span>
<span id="cb191-7"><a href="#cb191-7" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>line) <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>line<span class="sc">$</span>Description</span>
<span id="cb191-8"><a href="#cb191-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-9"><a href="#cb191-9" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>molecule <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>mol<span class="sc">$</span>Number</span>
<span id="cb191-10"><a href="#cb191-10" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>molecule) <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>mol<span class="sc">$</span>Description</span>
<span id="cb191-11"><a href="#cb191-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-12"><a href="#cb191-12" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>trial <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>trial<span class="sc">$</span>Number</span>
<span id="cb191-13"><a href="#cb191-13" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>trial) <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>trial<span class="sc">$</span>Description</span>
<span id="cb191-14"><a href="#cb191-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-15"><a href="#cb191-15" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>endpoint <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>endpoint<span class="sc">$</span>Number</span>
<span id="cb191-16"><a href="#cb191-16" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>endpoint) <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>endpoint<span class="sc">$</span>Description</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-31-contents" aria-controls="callout-31" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-31" class="callout-31-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Makes a named list from each of the look ups.</p>
<p>For example it uses these…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>pop<span class="sc">$</span>Number</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0 1 2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb194"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>pop<span class="sc">$</span>Description</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "All"                      "Poor / intermediate risk"
[3] "Favourable risk"         </code></pre>
</div>
</div>
<p>…to make this…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb196"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>population</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                     All Poor / intermediate risk          Favourable risk 
                       0                        1                        2 </code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb198"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>dat <span class="ot">&lt;-</span> i<span class="sc">$</span>surv<span class="sc">$</span>pld</span>
<span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>dat<span class="sc">$</span>population <span class="ot">&lt;-</span> <span class="fu">names</span>(i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>population)[<span class="fu">match</span>(i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>dat<span class="sc">$</span>population,i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>population)]</span>
<span id="cb198-3"><a href="#cb198-3" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>dat<span class="sc">$</span>line       <span class="ot">&lt;-</span> <span class="fu">names</span>(i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>line)[<span class="fu">match</span>(i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>dat<span class="sc">$</span>line,i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>line)]</span>
<span id="cb198-4"><a href="#cb198-4" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>dat<span class="sc">$</span>molecule   <span class="ot">&lt;-</span> <span class="fu">names</span>(i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>molecule)[<span class="fu">match</span>(i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>dat<span class="sc">$</span>molecule,i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>molecule)]</span>
<span id="cb198-5"><a href="#cb198-5" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>dat<span class="sc">$</span>trial      <span class="ot">&lt;-</span> <span class="fu">names</span>(i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>trial)[<span class="fu">match</span>(i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>dat<span class="sc">$</span>trial,i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>trial)]</span>
<span id="cb198-6"><a href="#cb198-6" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>dat<span class="sc">$</span>endpoint   <span class="ot">&lt;-</span> <span class="fu">names</span>(i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>endpoint)[<span class="fu">match</span>(i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>dat<span class="sc">$</span>endpoint,i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>endpoint)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-32-contents" aria-controls="callout-32" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-32" class="callout-32-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Converts from <code>i$surv$pld</code> (which is all numeric values)…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb199"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(i<span class="sc">$</span>surv<span class="sc">$</span>pld)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
</div>
<p>…to a version with all the labels from the lookups…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb200"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(i<span class="sc">$</span>surv<span class="sc">$</span>lab_pld<span class="sc">$</span>dat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb201"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>n_by_plmte <span class="ot">&lt;-</span> i<span class="sc">$</span>surv<span class="sc">$</span>pld[, .N, by <span class="ot">=</span> <span class="fu">list</span>(population, line,molecule,trial,endpoint)] <span class="sc">%&gt;%</span></span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(population,line, molecule,trial,endpoint)</span>
<span id="cb201-3"><a href="#cb201-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-4"><a href="#cb201-4" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>n_by_plmte<span class="sc">$</span>population <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>pop[<span class="fu">match</span>(i<span class="sc">$</span>surv<span class="sc">$</span>n_by_plmte<span class="sc">$</span>population       ,i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>pop<span class="sc">$</span>Number),Description]</span>
<span id="cb201-5"><a href="#cb201-5" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>n_by_plmte<span class="sc">$</span>line       <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>line[<span class="fu">match</span>(i<span class="sc">$</span>surv<span class="sc">$</span>n_by_plmte<span class="sc">$</span>line       ,i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>line<span class="sc">$</span>Number),Description]</span>
<span id="cb201-6"><a href="#cb201-6" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>n_by_plmte<span class="sc">$</span>molecule   <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>mol[<span class="fu">match</span>(i<span class="sc">$</span>surv<span class="sc">$</span>n_by_plmte<span class="sc">$</span>molecule       ,i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>mol<span class="sc">$</span>Number),Description]</span>
<span id="cb201-7"><a href="#cb201-7" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>n_by_plmte<span class="sc">$</span>molecule[<span class="fu">which</span>(<span class="fu">is.na</span>(i<span class="sc">$</span>surv<span class="sc">$</span>n_by_plmte<span class="sc">$</span>molecule))]   <span class="ot">&lt;-</span> <span class="st">"Non-UK treatments (pooled)"</span></span>
<span id="cb201-8"><a href="#cb201-8" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>n_by_plmte<span class="sc">$</span>trial      <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>trial[<span class="fu">match</span>(i<span class="sc">$</span>surv<span class="sc">$</span>n_by_plmte<span class="sc">$</span>trial       ,i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>trial<span class="sc">$</span>Number),Description]</span>
<span id="cb201-9"><a href="#cb201-9" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>n_by_plmte<span class="sc">$</span>endpoint   <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>endpoint[<span class="fu">match</span>(i<span class="sc">$</span>surv<span class="sc">$</span>n_by_plmte<span class="sc">$</span>endpoint       ,i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>endpoint<span class="sc">$</span>Number),Description]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-33-contents" aria-controls="callout-33" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-33" class="callout-33-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Counts for each combination of pop + line + molecule + trial + endpoint (together, uses abbreviation plmte).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb202"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(i<span class="sc">$</span>surv<span class="sc">$</span>pld[, .N, <span class="at">by =</span> <span class="fu">list</span>(population, line,molecule,trial,endpoint)] <span class="sc">%&gt;%</span></span>
<span id="cb202-2"><a href="#cb202-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(population,line, molecule,trial,endpoint))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
</div>
<p>Then replaces the numeric values with labels</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb203"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(i<span class="sc">$</span>surv<span class="sc">$</span>n_by_plmte)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
</div>
</div>
</div>
</div>
</section>
<section id="partitioned-survival-analysis-partsa" class="level2">
<h2 class="anchored" data-anchor-id="partitioned-survival-analysis-partsa">Partitioned survival analysis (PartSA)</h2>
<section id="run-analysis" class="level3">
<h3 class="anchored" data-anchor-id="run-analysis">Run analysis</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb204"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (i<span class="sc">$</span>dd_run_surv_reg <span class="sc">==</span> <span class="st">"Yes"</span>) {</span>
<span id="cb204-2"><a href="#cb204-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb204-3"><a href="#cb204-3" aria-hidden="true" tabindex="-1"></a>  i<span class="sc">$</span>surv<span class="sc">$</span>reg <span class="ot">&lt;-</span> <span class="fu">f_surv_runAllTSD14</span>(</span>
<span id="cb204-4"><a href="#cb204-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">r_pld             =</span> i<span class="sc">$</span>surv<span class="sc">$</span>pld,</span>
<span id="cb204-5"><a href="#cb204-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">id                =</span> i<span class="sc">$</span>id<span class="sc">$</span>ipd,</span>
<span id="cb204-6"><a href="#cb204-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">lookups           =</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd,</span>
<span id="cb204-7"><a href="#cb204-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">draw_plots        =</span> <span class="cn">FALSE</span>,</span>
<span id="cb204-8"><a href="#cb204-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">distnames         =</span> i<span class="sc">$</span>distnames,</span>
<span id="cb204-9"><a href="#cb204-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">cl_y              =</span> p<span class="sc">$</span>basic<span class="sc">$</span>cl_y,</span>
<span id="cb204-10"><a href="#cb204-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">t_cyc             =</span> p<span class="sc">$</span>basic<span class="sc">$</span>t_cyc,</span>
<span id="cb204-11"><a href="#cb204-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlim_survplots_yr =</span> p<span class="sc">$</span>misc<span class="sc">$</span>plot<span class="sc">$</span>xlim_survplots_yr,</span>
<span id="cb204-12"><a href="#cb204-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">t_yr              =</span> p<span class="sc">$</span>basic<span class="sc">$</span>t_yr,</span>
<span id="cb204-13"><a href="#cb204-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose           =</span> qc_mode,</span>
<span id="cb204-14"><a href="#cb204-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_obs           =</span> <span class="dv">28</span></span>
<span id="cb204-15"><a href="#cb204-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb204-16"><a href="#cb204-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-17"><a href="#cb204-17" aria-hidden="true" tabindex="-1"></a>  i<span class="sc">$</span>surv<span class="sc">$</span>reg<span class="sc">$</span>pop_0<span class="sc">$</span>line_4<span class="sc">$</span>mol_999<span class="sc">$</span>trial_2<span class="sc">$</span>endpoint_4 <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">1</span>,<span class="cf">function</span>(x) {</span>
<span id="cb204-18"><a href="#cb204-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-19"><a href="#cb204-19" aria-hidden="true" tabindex="-1"></a>    ipd <span class="ot">&lt;-</span> i<span class="sc">$</span>surv<span class="sc">$</span>pld[line<span class="sc">==</span><span class="dv">4</span> <span class="sc">&amp;</span> endpoint<span class="sc">==</span><span class="dv">4</span>,<span class="fu">list</span>(timew,event_censor)]</span>
<span id="cb204-20"><a href="#cb204-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb204-21"><a href="#cb204-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(ipd) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"t"</span>,<span class="st">"e"</span>)</span>
<span id="cb204-22"><a href="#cb204-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb204-23"><a href="#cb204-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">paste0</span>(</span>
<span id="cb204-24"><a href="#cb204-24" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Survival analysis - population: "</span>, i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>pop[Number      <span class="sc">==</span> <span class="dv">0</span>, Description],</span>
<span id="cb204-25"><a href="#cb204-25" aria-hidden="true" tabindex="-1"></a>      <span class="st">"</span><span class="sc">\t</span><span class="st"> line: "</span>                       , i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>line[Number     <span class="sc">==</span> <span class="dv">4</span>, Description],</span>
<span id="cb204-26"><a href="#cb204-26" aria-hidden="true" tabindex="-1"></a>      <span class="st">"</span><span class="sc">\t</span><span class="st"> molecule: "</span>                   , i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>mol[Number     <span class="sc">==</span> <span class="dv">999</span>, Description],</span>
<span id="cb204-27"><a href="#cb204-27" aria-hidden="true" tabindex="-1"></a>      <span class="st">"</span><span class="sc">\t</span><span class="st"> trial: "</span>                      , i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>trial[Number     <span class="sc">==</span> <span class="dv">2</span>, Description],</span>
<span id="cb204-28"><a href="#cb204-28" aria-hidden="true" tabindex="-1"></a>      <span class="st">"</span><span class="sc">\t</span><span class="st"> endpoint: "</span>                   , i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>endpoint[Number <span class="sc">==</span> <span class="dv">4</span>, Description], <span class="st">"</span><span class="sc">\n</span><span class="st">"</span></span>
<span id="cb204-29"><a href="#cb204-29" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb204-30"><a href="#cb204-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb204-31"><a href="#cb204-31" aria-hidden="true" tabindex="-1"></a>    fs_fits <span class="ot">&lt;-</span> <span class="fu">lapply</span>(i<span class="sc">$</span>distnames, <span class="cf">function</span>(dist) {  <span class="co"># applying all parametric survival curves in the list of distNames</span></span>
<span id="cb204-32"><a href="#cb204-32" aria-hidden="true" tabindex="-1"></a>      fs_fit <span class="ot">&lt;-</span> <span class="fu">flexsurvreg</span>(</span>
<span id="cb204-33"><a href="#cb204-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">formula =</span> <span class="fu">Surv</span>(t, e) <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb204-34"><a href="#cb204-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> ipd,</span>
<span id="cb204-35"><a href="#cb204-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">dist =</span> dist</span>
<span id="cb204-36"><a href="#cb204-36" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb204-37"><a href="#cb204-37" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb204-38"><a href="#cb204-38" aria-hidden="true" tabindex="-1"></a>        <span class="at">coefs =</span> <span class="fu">coefficients</span>(fs_fit),                                         <span class="co"># coefficients for the fitted model</span></span>
<span id="cb204-39"><a href="#cb204-39" aria-hidden="true" tabindex="-1"></a>        <span class="at">vcov  =</span> <span class="fu">vcov</span>(fs_fit),                                                 <span class="co"># variance covariance matrix for the fitted model</span></span>
<span id="cb204-40"><a href="#cb204-40" aria-hidden="true" tabindex="-1"></a>        <span class="at">fit   =</span> <span class="fu">c</span>(<span class="at">AIC=</span> <span class="fu">AIC</span>(fs_fit), <span class="at">BIC=</span><span class="fu">BIC</span>(fs_fit), <span class="at">logLik =</span> <span class="fu">logLik</span>(fs_fit)) <span class="co"># goodness of fit statistics for the fitted model</span></span>
<span id="cb204-41"><a href="#cb204-41" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb204-42"><a href="#cb204-42" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb204-43"><a href="#cb204-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb204-44"><a href="#cb204-44" aria-hidden="true" tabindex="-1"></a>    gof <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(i<span class="sc">$</span>distnames, <span class="cf">function</span>(dist) fs_fits[[dist]]<span class="sc">$</span>fit))</span>
<span id="cb204-45"><a href="#cb204-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb204-46"><a href="#cb204-46" aria-hidden="true" tabindex="-1"></a>    st <span class="ot">&lt;-</span> <span class="fu">matrix</span>(</span>
<span id="cb204-47"><a href="#cb204-47" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unlist</span>(<span class="fu">lapply</span>(i<span class="sc">$</span>distnames, <span class="cf">function</span>(dist) {</span>
<span id="cb204-48"><a href="#cb204-48" aria-hidden="true" tabindex="-1"></a>        <span class="fu">f_extrapolate</span>(p<span class="sc">$</span>basic<span class="sc">$</span>t_cyc, fs_fits[[dist]]<span class="sc">$</span>coefs, dist)</span>
<span id="cb204-49"><a href="#cb204-49" aria-hidden="true" tabindex="-1"></a>      })),</span>
<span id="cb204-50"><a href="#cb204-50" aria-hidden="true" tabindex="-1"></a>      <span class="at">ncol =</span> <span class="fu">length</span>(i<span class="sc">$</span>distnames),</span>
<span id="cb204-51"><a href="#cb204-51" aria-hidden="true" tabindex="-1"></a>      <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="cn">NULL</span>, i<span class="sc">$</span>distnames),</span>
<span id="cb204-52"><a href="#cb204-52" aria-hidden="true" tabindex="-1"></a>      <span class="at">byrow =</span> <span class="cn">FALSE</span></span>
<span id="cb204-53"><a href="#cb204-53" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb204-54"><a href="#cb204-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-55"><a href="#cb204-55" aria-hidden="true" tabindex="-1"></a>    plot <span class="ot">&lt;-</span> {</span>
<span id="cb204-56"><a href="#cb204-56" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb204-57"><a href="#cb204-57" aria-hidden="true" tabindex="-1"></a>      sm_ipd <span class="ot">&lt;-</span> <span class="fu">f_ce_km_MakeDatSurvFriendly</span>(</span>
<span id="cb204-58"><a href="#cb204-58" aria-hidden="true" tabindex="-1"></a>        <span class="at">Data_required =</span> ipd,</span>
<span id="cb204-59"><a href="#cb204-59" aria-hidden="true" tabindex="-1"></a>        <span class="at">time_column   =</span> <span class="st">"t"</span>,                 <span class="co"># note that this is taking IPD in weeks</span></span>
<span id="cb204-60"><a href="#cb204-60" aria-hidden="true" tabindex="-1"></a>        <span class="at">event_column  =</span> <span class="st">"e"</span>,</span>
<span id="cb204-61"><a href="#cb204-61" aria-hidden="true" tabindex="-1"></a>        <span class="at">t_multiplier  =</span> p<span class="sc">$</span>basic<span class="sc">$</span>cl_y             <span class="co"># data in weeks, cycle length in plot years</span></span>
<span id="cb204-62"><a href="#cb204-62" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb204-63"><a href="#cb204-63" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb204-64"><a href="#cb204-64" aria-hidden="true" tabindex="-1"></a>      form          <span class="ot">&lt;-</span> <span class="fu">Surv</span>(t, ec) <span class="sc">~</span> <span class="dv">1</span></span>
<span id="cb204-65"><a href="#cb204-65" aria-hidden="true" tabindex="-1"></a>      sm_surv_est   <span class="ot">&lt;-</span> <span class="fu">surv_fit</span>(<span class="at">formula =</span> form, <span class="at">data =</span> sm_ipd)</span>
<span id="cb204-66"><a href="#cb204-66" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb204-67"><a href="#cb204-67" aria-hidden="true" tabindex="-1"></a>      survival_plot <span class="ot">&lt;-</span> <span class="fu">suppressMessages</span>(<span class="fu">f_extrap_plot</span>(</span>
<span id="cb204-68"><a href="#cb204-68" aria-hidden="true" tabindex="-1"></a>        <span class="at">SurvEstimate   =</span> sm_surv_est,</span>
<span id="cb204-69"><a href="#cb204-69" aria-hidden="true" tabindex="-1"></a>        <span class="at">Data_required  =</span> sm_ipd,</span>
<span id="cb204-70"><a href="#cb204-70" aria-hidden="true" tabindex="-1"></a>        <span class="at">curvefits_data =</span> st,</span>
<span id="cb204-71"><a href="#cb204-71" aria-hidden="true" tabindex="-1"></a>        <span class="at">time_vector    =</span> p<span class="sc">$</span>basic<span class="sc">$</span>t_yr,</span>
<span id="cb204-72"><a href="#cb204-72" aria-hidden="true" tabindex="-1"></a>        <span class="at">xlim           =</span> p<span class="sc">$</span>misc<span class="sc">$</span>plot<span class="sc">$</span>xlim_survplots_yr,   <span class="do">#### this will need replacing dependent on how many years we decide to show per time horizon</span></span>
<span id="cb204-73"><a href="#cb204-73" aria-hidden="true" tabindex="-1"></a>        <span class="at">break_by       =</span> <span class="fu">round</span>(<span class="dv">20</span><span class="sc">/</span><span class="dv">8</span>,<span class="dv">0</span>) <span class="do">#### this will need replacing dependent on how many years we decide to show per time horizon</span></span>
<span id="cb204-74"><a href="#cb204-74" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb204-75"><a href="#cb204-75" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(</span>
<span id="cb204-76"><a href="#cb204-76" aria-hidden="true" tabindex="-1"></a>        <span class="at">ipd     =</span> sm_ipd,</span>
<span id="cb204-77"><a href="#cb204-77" aria-hidden="true" tabindex="-1"></a>        <span class="at">formula =</span> form,</span>
<span id="cb204-78"><a href="#cb204-78" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot    =</span> survival_plot</span>
<span id="cb204-79"><a href="#cb204-79" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb204-80"><a href="#cb204-80" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb204-81"><a href="#cb204-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-82"><a href="#cb204-82" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb204-83"><a href="#cb204-83" aria-hidden="true" tabindex="-1"></a>      <span class="at">pop      =</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>pop[     Number <span class="sc">==</span> <span class="dv">0</span>,Description],</span>
<span id="cb204-84"><a href="#cb204-84" aria-hidden="true" tabindex="-1"></a>      <span class="at">line     =</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>line[    Number <span class="sc">==</span> <span class="dv">4</span>,Description],</span>
<span id="cb204-85"><a href="#cb204-85" aria-hidden="true" tabindex="-1"></a>      <span class="at">mol      =</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>mol[     Number <span class="sc">==</span> <span class="dv">999</span>,Description],</span>
<span id="cb204-86"><a href="#cb204-86" aria-hidden="true" tabindex="-1"></a>      <span class="at">tr       =</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>trial[     Number <span class="sc">==</span> <span class="dv">2</span>,Description],</span>
<span id="cb204-87"><a href="#cb204-87" aria-hidden="true" tabindex="-1"></a>      <span class="at">endpoint =</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>endpoint[Number <span class="sc">==</span> <span class="dv">4</span>,Description],</span>
<span id="cb204-88"><a href="#cb204-88" aria-hidden="true" tabindex="-1"></a>      <span class="at">ipd      =</span> ipd,</span>
<span id="cb204-89"><a href="#cb204-89" aria-hidden="true" tabindex="-1"></a>      <span class="at">fs_fits  =</span> fs_fits,</span>
<span id="cb204-90"><a href="#cb204-90" aria-hidden="true" tabindex="-1"></a>      <span class="at">gof      =</span> gof,</span>
<span id="cb204-91"><a href="#cb204-91" aria-hidden="true" tabindex="-1"></a>      <span class="at">st       =</span> st,</span>
<span id="cb204-92"><a href="#cb204-92" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot     =</span> plot</span>
<span id="cb204-93"><a href="#cb204-93" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb204-94"><a href="#cb204-94" aria-hidden="true" tabindex="-1"></a>  })[[<span class="dv">1</span>]]</span>
<span id="cb204-95"><a href="#cb204-95" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb204-96"><a href="#cb204-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(i<span class="sc">$</span>surv<span class="sc">$</span>reg, <span class="at">file =</span> <span class="st">"./1_Data/Survival_analysis.rds"</span>)</span>
<span id="cb204-97"><a href="#cb204-97" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb204-98"><a href="#cb204-98" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-34-contents" aria-controls="callout-34" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-34" class="callout-34-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>This was not run as is set to “No” in the excel spreadsheet</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb205"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>dd_run_surv_reg</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "No"</code></pre>
</div>
</div>
<p>However, if run, this function would:</p>
<p><strong>1. Run survival analysis</strong>. Using <code>f_surv_runAllTSD14()</code> from <code>survival/</code> (see dropdown below). “TSD14” refers to technical support document 14 which is a methods guide from NICE for performing survival analysis, <a href="https://www.sheffield.ac.uk/nice-dsu/tsds/survival-analysis">available here</a>. The function;</p>
<ul>
<li>Runs through all possible populations, lines, molecules, trials and endpoints in <code>id</code> (<code>i$id$ipd</code>, the lookup of unique values for each of those items)</li>
<li>If there is data available in <code>r_pld</code> (<code>i$surv$pld</code>, the patient level data), then it performs survival analysis using the function <code>flexsurv::flexsurvreg()</code>. This data will need to meet the threshold you set for the number of observations (default <code>28</code>).</li>
<li>It repeats this for each with each of the distributions in <code>distnames</code></li>
<li>It saves the coefficients, variance covariance matrix, and goodness of fit statistics, and saves these as <code>fs_fits</code> (and also <code>gof</code>)</li>
<li>The survival curves are then extrapolated using the fitted models over the specified time cycle (<code>t_cyc</code> (<code>p$basic$t_cyc</code>)) using the function <code>f_extrapolate()</code>. These are saved in the matrix <code>st</code> (survival at time t, or st for short)</li>
<li>If creating plots, this is done using the function <code>f_extrap_plot()</code></li>
<li>Finally, the function returns the results for each combination</li>
</ul>
<p><strong>2. Seperately, manually run survival analysis for best supportive care (BSC)</strong>. This is done seperately as there is very little information available on BSC overall survival (OS). Hence, the best source of data is to use the pooled post-progression survival (PPS) data from 4L (fourth line) patients (since they are unlikely to receive something after that treatment). It has similar steps to <code>f_surv_runAllTSD14()</code>.</p>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-35-contents" aria-controls="callout-35" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<code>f_surv_runAllTSD14()</code>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-35" class="callout-35-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb207"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a>f_surv_runAllTSD14 <span class="ot">&lt;-</span></span>
<span id="cb207-2"><a href="#cb207-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(r_pld,</span>
<span id="cb207-3"><a href="#cb207-3" aria-hidden="true" tabindex="-1"></a>           id,</span>
<span id="cb207-4"><a href="#cb207-4" aria-hidden="true" tabindex="-1"></a>           lookups,</span>
<span id="cb207-5"><a href="#cb207-5" aria-hidden="true" tabindex="-1"></a>           distnames,</span>
<span id="cb207-6"><a href="#cb207-6" aria-hidden="true" tabindex="-1"></a>           t_cyc,</span>
<span id="cb207-7"><a href="#cb207-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">cl_y              =</span> <span class="cn">NULL</span>,</span>
<span id="cb207-8"><a href="#cb207-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">xlim_survplots_yr =</span> <span class="cn">NULL</span>,</span>
<span id="cb207-9"><a href="#cb207-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">t_yr              =</span> <span class="cn">NULL</span>,</span>
<span id="cb207-10"><a href="#cb207-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">draw_plots        =</span> <span class="cn">FALSE</span>,</span>
<span id="cb207-11"><a href="#cb207-11" aria-hidden="true" tabindex="-1"></a>           <span class="at">verbose           =</span> <span class="cn">FALSE</span>,</span>
<span id="cb207-12"><a href="#cb207-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">min_obs           =</span> <span class="dv">30</span>) {</span>
<span id="cb207-13"><a href="#cb207-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb207-14"><a href="#cb207-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (draw_plots) {</span>
<span id="cb207-15"><a href="#cb207-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">is.null</span>(cl_y)) <span class="fu">stop</span>(<span class="st">"If draw_plots is TRUE, then cl_y (cycle length in years) must be provided"</span>)</span>
<span id="cb207-16"><a href="#cb207-16" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">is.null</span>(xlim_survplots_yr)) <span class="fu">stop</span>(<span class="st">"If draw_plots is TRUE, then xlim_survplots_yr (x axis limit for plot in years) must be provided"</span>)</span>
<span id="cb207-17"><a href="#cb207-17" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">is.null</span>(t_yr)) <span class="fu">stop</span>(<span class="st">"If draw_plots is TRUE, then t_yr (vector of time in years to TH) must be provided"</span>)</span>
<span id="cb207-18"><a href="#cb207-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb207-19"><a href="#cb207-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb207-20"><a href="#cb207-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb207-21"><a href="#cb207-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(id<span class="sc">$</span>pop, <span class="cf">function</span>(trial_population) {</span>
<span id="cb207-22"><a href="#cb207-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapply</span>(id<span class="sc">$</span>line, <span class="cf">function</span>(l) {</span>
<span id="cb207-23"><a href="#cb207-23" aria-hidden="true" tabindex="-1"></a>      <span class="fu">lapply</span>(id<span class="sc">$</span>mol, <span class="cf">function</span>(m) {</span>
<span id="cb207-24"><a href="#cb207-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lapply</span>(id<span class="sc">$</span>trial, <span class="cf">function</span>(tr) {</span>
<span id="cb207-25"><a href="#cb207-25" aria-hidden="true" tabindex="-1"></a>          <span class="fu">lapply</span>(id<span class="sc">$</span>endpoint, <span class="cf">function</span>(en) {</span>
<span id="cb207-26"><a href="#cb207-26" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb207-27"><a href="#cb207-27" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb207-28"><a href="#cb207-28" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Filter down to the parameters avove associated with this combination:</span></span>
<span id="cb207-29"><a href="#cb207-29" aria-hidden="true" tabindex="-1"></a>            ipd <span class="ot">&lt;-</span> r_pld[population <span class="sc">==</span> trial_population <span class="sc">&amp;</span> line<span class="sc">==</span>l <span class="sc">&amp;</span> molecule<span class="sc">==</span>m <span class="sc">&amp;</span> trial<span class="sc">==</span>tr <span class="sc">&amp;</span> endpoint<span class="sc">==</span>en,<span class="fu">list</span>(timew,event_censor)]</span>
<span id="cb207-30"><a href="#cb207-30" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb207-31"><a href="#cb207-31" aria-hidden="true" tabindex="-1"></a>            <span class="fu">names</span>(ipd) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"t"</span>,<span class="st">"e"</span>)</span>
<span id="cb207-32"><a href="#cb207-32" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb207-33"><a href="#cb207-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(<span class="fu">all</span>(verbose, <span class="fu">nrow</span>(ipd) <span class="sc">&gt;</span> <span class="dv">0</span>)) {</span>
<span id="cb207-34"><a href="#cb207-34" aria-hidden="true" tabindex="-1"></a>              <span class="fu">cat</span>(<span class="fu">paste0</span>(</span>
<span id="cb207-35"><a href="#cb207-35" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Survival analysis - population: "</span>, lookups<span class="sc">$</span>pop[Number      <span class="sc">==</span> trial_population, Description],</span>
<span id="cb207-36"><a href="#cb207-36" aria-hidden="true" tabindex="-1"></a>                <span class="st">"</span><span class="sc">\t</span><span class="st"> line: "</span>                       , lookups<span class="sc">$</span>line[Number     <span class="sc">==</span> l               , Description],</span>
<span id="cb207-37"><a href="#cb207-37" aria-hidden="true" tabindex="-1"></a>                <span class="st">"</span><span class="sc">\t</span><span class="st"> molecule: "</span>                   , lookups<span class="sc">$</span>mol[Number      <span class="sc">==</span> m               , Description],</span>
<span id="cb207-38"><a href="#cb207-38" aria-hidden="true" tabindex="-1"></a>                <span class="st">"</span><span class="sc">\t</span><span class="st"> trial: "</span>                      , tr,</span>
<span id="cb207-39"><a href="#cb207-39" aria-hidden="true" tabindex="-1"></a>                <span class="st">"</span><span class="sc">\t</span><span class="st"> endpoint: "</span>                   , lookups<span class="sc">$</span>endpoint[Number <span class="sc">==</span> en              , Description], <span class="st">"</span><span class="sc">\n</span><span class="st">"</span></span>
<span id="cb207-40"><a href="#cb207-40" aria-hidden="true" tabindex="-1"></a>              ))</span>
<span id="cb207-41"><a href="#cb207-41" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb207-42"><a href="#cb207-42" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb207-43"><a href="#cb207-43" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb207-44"><a href="#cb207-44" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If that dataset is empty (i.e., has no rows), then there's no data for it. return</span></span>
<span id="cb207-45"><a href="#cb207-45" aria-hidden="true" tabindex="-1"></a>            <span class="co"># nothing</span></span>
<span id="cb207-46"><a href="#cb207-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (<span class="fu">nrow</span>(ipd) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb207-47"><a href="#cb207-47" aria-hidden="true" tabindex="-1"></a>              <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb207-48"><a href="#cb207-48" aria-hidden="true" tabindex="-1"></a>                <span class="at">pop      =</span> lookups<span class="sc">$</span>pop[     Number <span class="sc">==</span> trial_population,Description],</span>
<span id="cb207-49"><a href="#cb207-49" aria-hidden="true" tabindex="-1"></a>                <span class="at">line     =</span> lookups<span class="sc">$</span>line[    Number <span class="sc">==</span> l,Description],</span>
<span id="cb207-50"><a href="#cb207-50" aria-hidden="true" tabindex="-1"></a>                <span class="at">mol      =</span> lookups<span class="sc">$</span>mol[     Number <span class="sc">==</span> m,Description],</span>
<span id="cb207-51"><a href="#cb207-51" aria-hidden="true" tabindex="-1"></a>                <span class="at">tr       =</span> lookups<span class="sc">$</span>trial[     Number <span class="sc">==</span> tr,Description],</span>
<span id="cb207-52"><a href="#cb207-52" aria-hidden="true" tabindex="-1"></a>                <span class="at">endpoint =</span> lookups<span class="sc">$</span>endpoint[Number <span class="sc">==</span> en,Description],</span>
<span id="cb207-53"><a href="#cb207-53" aria-hidden="true" tabindex="-1"></a>                <span class="at">ipd      =</span> <span class="cn">NULL</span>,</span>
<span id="cb207-54"><a href="#cb207-54" aria-hidden="true" tabindex="-1"></a>                <span class="at">fs_fits  =</span> <span class="cn">NULL</span>,</span>
<span id="cb207-55"><a href="#cb207-55" aria-hidden="true" tabindex="-1"></a>                <span class="at">gof      =</span> <span class="cn">NULL</span>,</span>
<span id="cb207-56"><a href="#cb207-56" aria-hidden="true" tabindex="-1"></a>                <span class="at">st       =</span> <span class="cn">NULL</span>,</span>
<span id="cb207-57"><a href="#cb207-57" aria-hidden="true" tabindex="-1"></a>                <span class="at">plot     =</span> <span class="cn">NULL</span></span>
<span id="cb207-58"><a href="#cb207-58" aria-hidden="true" tabindex="-1"></a>              ))</span>
<span id="cb207-59"><a href="#cb207-59" aria-hidden="true" tabindex="-1"></a>            } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">nrow</span>(ipd) <span class="sc">&lt;</span> min_obs) {</span>
<span id="cb207-60"><a href="#cb207-60" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb207-61"><a href="#cb207-61" aria-hidden="true" tabindex="-1"></a>              <span class="fu">warning</span>(<span class="fu">paste0</span>(</span>
<span id="cb207-62"><a href="#cb207-62" aria-hidden="true" tabindex="-1"></a>                lookups<span class="sc">$</span>pop[Number      <span class="sc">==</span> trial_population, Description],</span>
<span id="cb207-63"><a href="#cb207-63" aria-hidden="true" tabindex="-1"></a>                <span class="st">" population "</span>     , lookups<span class="sc">$</span>line[Number     <span class="sc">==</span> l               , Description],</span>
<span id="cb207-64"><a href="#cb207-64" aria-hidden="true" tabindex="-1"></a>                <span class="st">" "</span> , lookups<span class="sc">$</span>mol[Number      <span class="sc">==</span> m               , Description],</span>
<span id="cb207-65"><a href="#cb207-65" aria-hidden="true" tabindex="-1"></a>                <span class="st">" "</span> , lookups<span class="sc">$</span>endpoint[Number <span class="sc">==</span> en              , Description],</span>
<span id="cb207-66"><a href="#cb207-66" aria-hidden="true" tabindex="-1"></a>                <span class="st">" from "</span>    , lookups<span class="sc">$</span>trial[Number <span class="sc">==</span> tr              , Description],</span>
<span id="cb207-67"><a href="#cb207-67" aria-hidden="true" tabindex="-1"></a>                <span class="st">" has "</span>,<span class="fu">nrow</span>(ipd), <span class="st">"(&lt;"</span>, min_obs, <span class="st">") observations (i.e. &lt; the minimum set by you!). Skipping this PLMTE."</span></span>
<span id="cb207-68"><a href="#cb207-68" aria-hidden="true" tabindex="-1"></a>              ),<span class="at">immediate. =</span> <span class="cn">TRUE</span>)</span>
<span id="cb207-69"><a href="#cb207-69" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb207-70"><a href="#cb207-70" aria-hidden="true" tabindex="-1"></a>              <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb207-71"><a href="#cb207-71" aria-hidden="true" tabindex="-1"></a>                <span class="at">pop      =</span> lookups<span class="sc">$</span>pop[     Number <span class="sc">==</span> trial_population,Description],</span>
<span id="cb207-72"><a href="#cb207-72" aria-hidden="true" tabindex="-1"></a>                <span class="at">line     =</span> lookups<span class="sc">$</span>line[    Number <span class="sc">==</span> l,Description],</span>
<span id="cb207-73"><a href="#cb207-73" aria-hidden="true" tabindex="-1"></a>                <span class="at">mol      =</span> lookups<span class="sc">$</span>mol[     Number <span class="sc">==</span> m,Description],</span>
<span id="cb207-74"><a href="#cb207-74" aria-hidden="true" tabindex="-1"></a>                <span class="at">tr       =</span> lookups<span class="sc">$</span>trial[     Number <span class="sc">==</span> tr,Description],</span>
<span id="cb207-75"><a href="#cb207-75" aria-hidden="true" tabindex="-1"></a>                <span class="at">endpoint =</span> lookups<span class="sc">$</span>endpoint[Number <span class="sc">==</span> en,Description],</span>
<span id="cb207-76"><a href="#cb207-76" aria-hidden="true" tabindex="-1"></a>                <span class="at">ipd      =</span> <span class="cn">NULL</span>,</span>
<span id="cb207-77"><a href="#cb207-77" aria-hidden="true" tabindex="-1"></a>                <span class="at">fs_fits  =</span> <span class="cn">NULL</span>,</span>
<span id="cb207-78"><a href="#cb207-78" aria-hidden="true" tabindex="-1"></a>                <span class="at">gof      =</span> <span class="cn">NULL</span>,</span>
<span id="cb207-79"><a href="#cb207-79" aria-hidden="true" tabindex="-1"></a>                <span class="at">st       =</span> <span class="cn">NULL</span>,</span>
<span id="cb207-80"><a href="#cb207-80" aria-hidden="true" tabindex="-1"></a>                <span class="at">plot     =</span> <span class="cn">NULL</span></span>
<span id="cb207-81"><a href="#cb207-81" aria-hidden="true" tabindex="-1"></a>              ))</span>
<span id="cb207-82"><a href="#cb207-82" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb207-83"><a href="#cb207-83" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb207-84"><a href="#cb207-84" aria-hidden="true" tabindex="-1"></a>            } <span class="cf">else</span> {</span>
<span id="cb207-85"><a href="#cb207-85" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb207-86"><a href="#cb207-86" aria-hidden="true" tabindex="-1"></a>              <span class="co"># If there IS data, continue on to use that data to produce full survival analysis results.</span></span>
<span id="cb207-87"><a href="#cb207-87" aria-hidden="true" tabindex="-1"></a>              <span class="co"># </span></span>
<span id="cb207-88"><a href="#cb207-88" aria-hidden="true" tabindex="-1"></a>              <span class="co"># Remember that the IPD is sensitive so should not ever be saved to disk. Being stored in i</span></span>
<span id="cb207-89"><a href="#cb207-89" aria-hidden="true" tabindex="-1"></a>              <span class="co"># and never saved is the way to do this.</span></span>
<span id="cb207-90"><a href="#cb207-90" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb207-91"><a href="#cb207-91" aria-hidden="true" tabindex="-1"></a>              <span class="co"># Even within the multiple nesting by population, line, molecule, trial and endpoint,</span></span>
<span id="cb207-92"><a href="#cb207-92" aria-hidden="true" tabindex="-1"></a>              <span class="co"># we need ANOTHER (6th) layer - the parametric model:</span></span>
<span id="cb207-93"><a href="#cb207-93" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb207-94"><a href="#cb207-94" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb207-95"><a href="#cb207-95" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb207-96"><a href="#cb207-96" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb207-97"><a href="#cb207-97" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb207-98"><a href="#cb207-98" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb207-99"><a href="#cb207-99" aria-hidden="true" tabindex="-1"></a>              fs_fits <span class="ot">&lt;-</span> <span class="fu">lapply</span>(distnames, <span class="cf">function</span>(dist) {  <span class="co"># applying all parametric survival curves in the list of distNames</span></span>
<span id="cb207-100"><a href="#cb207-100" aria-hidden="true" tabindex="-1"></a>                fs_fit <span class="ot">&lt;-</span> <span class="fu">flexsurvreg</span>(</span>
<span id="cb207-101"><a href="#cb207-101" aria-hidden="true" tabindex="-1"></a>                  <span class="at">formula =</span> <span class="fu">Surv</span>(t, e) <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb207-102"><a href="#cb207-102" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> ipd,</span>
<span id="cb207-103"><a href="#cb207-103" aria-hidden="true" tabindex="-1"></a>                  <span class="at">dist =</span> dist</span>
<span id="cb207-104"><a href="#cb207-104" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb207-105"><a href="#cb207-105" aria-hidden="true" tabindex="-1"></a>                <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb207-106"><a href="#cb207-106" aria-hidden="true" tabindex="-1"></a>                  <span class="at">coefs =</span> <span class="fu">coefficients</span>(fs_fit),                                         <span class="co"># coefficients for the fitted model</span></span>
<span id="cb207-107"><a href="#cb207-107" aria-hidden="true" tabindex="-1"></a>                  <span class="at">vcov  =</span> <span class="fu">vcov</span>(fs_fit),                                                 <span class="co"># variance covariance matrix for the fitted model</span></span>
<span id="cb207-108"><a href="#cb207-108" aria-hidden="true" tabindex="-1"></a>                  <span class="at">fit   =</span> <span class="fu">c</span>(<span class="at">AIC=</span> <span class="fu">AIC</span>(fs_fit), <span class="at">BIC=</span><span class="fu">BIC</span>(fs_fit), <span class="at">logLik =</span> <span class="fu">logLik</span>(fs_fit)) <span class="co"># goodness of fit statistics for the fitted model</span></span>
<span id="cb207-109"><a href="#cb207-109" aria-hidden="true" tabindex="-1"></a>                ))</span>
<span id="cb207-110"><a href="#cb207-110" aria-hidden="true" tabindex="-1"></a>              })</span>
<span id="cb207-111"><a href="#cb207-111" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb207-112"><a href="#cb207-112" aria-hidden="true" tabindex="-1"></a>              gof <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(distnames, <span class="cf">function</span>(dist) fs_fits[[dist]]<span class="sc">$</span>fit))</span>
<span id="cb207-113"><a href="#cb207-113" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb207-114"><a href="#cb207-114" aria-hidden="true" tabindex="-1"></a>             </span>
<span id="cb207-115"><a href="#cb207-115" aria-hidden="true" tabindex="-1"></a>              st <span class="ot">&lt;-</span> <span class="fu">matrix</span>(</span>
<span id="cb207-116"><a href="#cb207-116" aria-hidden="true" tabindex="-1"></a>                <span class="fu">unlist</span>(<span class="fu">lapply</span>(distnames, <span class="cf">function</span>(dist) {</span>
<span id="cb207-117"><a href="#cb207-117" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">f_extrapolate</span>(t_cyc, fs_fits[[dist]]<span class="sc">$</span>coefs, dist)</span>
<span id="cb207-118"><a href="#cb207-118" aria-hidden="true" tabindex="-1"></a>                })),</span>
<span id="cb207-119"><a href="#cb207-119" aria-hidden="true" tabindex="-1"></a>                <span class="at">ncol =</span> <span class="fu">length</span>(distnames),</span>
<span id="cb207-120"><a href="#cb207-120" aria-hidden="true" tabindex="-1"></a>                <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="cn">NULL</span>, distnames),</span>
<span id="cb207-121"><a href="#cb207-121" aria-hidden="true" tabindex="-1"></a>                <span class="at">byrow =</span> <span class="cn">FALSE</span></span>
<span id="cb207-122"><a href="#cb207-122" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb207-123"><a href="#cb207-123" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb207-124"><a href="#cb207-124" aria-hidden="true" tabindex="-1"></a>              <span class="cf">if</span> (draw_plots) {</span>
<span id="cb207-125"><a href="#cb207-125" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb207-126"><a href="#cb207-126" aria-hidden="true" tabindex="-1"></a>                plot <span class="ot">&lt;-</span> {</span>
<span id="cb207-127"><a href="#cb207-127" aria-hidden="true" tabindex="-1"></a>                  <span class="co"># First the IPD is produced in a format that survminer will accept. Data must all be </span></span>
<span id="cb207-128"><a href="#cb207-128" aria-hidden="true" tabindex="-1"></a>                  <span class="co"># the same format with the same column names. </span></span>
<span id="cb207-129"><a href="#cb207-129" aria-hidden="true" tabindex="-1"></a>                  <span class="co"># this assumes no covariate adjustment.</span></span>
<span id="cb207-130"><a href="#cb207-130" aria-hidden="true" tabindex="-1"></a>                  </span>
<span id="cb207-131"><a href="#cb207-131" aria-hidden="true" tabindex="-1"></a>                  sm_ipd <span class="ot">&lt;-</span> <span class="fu">f_ce_km_MakeDatSurvFriendly</span>(</span>
<span id="cb207-132"><a href="#cb207-132" aria-hidden="true" tabindex="-1"></a>                    <span class="at">Data_required =</span> ipd,</span>
<span id="cb207-133"><a href="#cb207-133" aria-hidden="true" tabindex="-1"></a>                    <span class="at">time_column   =</span> <span class="st">"t"</span>,                 <span class="co"># note that this is taking IPD in weeks </span></span>
<span id="cb207-134"><a href="#cb207-134" aria-hidden="true" tabindex="-1"></a>                    <span class="at">event_column  =</span> <span class="st">"e"</span>,</span>
<span id="cb207-135"><a href="#cb207-135" aria-hidden="true" tabindex="-1"></a>                    <span class="at">t_multiplier  =</span> cl_y             <span class="co"># data in weeks, cycle length in plot years</span></span>
<span id="cb207-136"><a href="#cb207-136" aria-hidden="true" tabindex="-1"></a>                  )</span>
<span id="cb207-137"><a href="#cb207-137" aria-hidden="true" tabindex="-1"></a>                  </span>
<span id="cb207-138"><a href="#cb207-138" aria-hidden="true" tabindex="-1"></a>                  <span class="co"># get the survival analysis in the form we need for survminer</span></span>
<span id="cb207-139"><a href="#cb207-139" aria-hidden="true" tabindex="-1"></a>                  <span class="co"># and make the extrapolations we need for survminer</span></span>
<span id="cb207-140"><a href="#cb207-140" aria-hidden="true" tabindex="-1"></a>                  </span>
<span id="cb207-141"><a href="#cb207-141" aria-hidden="true" tabindex="-1"></a>                  form          <span class="ot">&lt;-</span> <span class="fu">Surv</span>(t, ec) <span class="sc">~</span> <span class="dv">1</span></span>
<span id="cb207-142"><a href="#cb207-142" aria-hidden="true" tabindex="-1"></a>                  sm_surv_est   <span class="ot">&lt;-</span> <span class="fu">surv_fit</span>(<span class="at">formula =</span> form, <span class="at">data =</span> sm_ipd)</span>
<span id="cb207-143"><a href="#cb207-143" aria-hidden="true" tabindex="-1"></a>                  </span>
<span id="cb207-144"><a href="#cb207-144" aria-hidden="true" tabindex="-1"></a>                  <span class="co"># make the plot with the input data:</span></span>
<span id="cb207-145"><a href="#cb207-145" aria-hidden="true" tabindex="-1"></a>                  survival_plot <span class="ot">&lt;-</span> <span class="fu">suppressMessages</span>(<span class="fu">f_extrap_plot</span>(</span>
<span id="cb207-146"><a href="#cb207-146" aria-hidden="true" tabindex="-1"></a>                    <span class="at">SurvEstimate   =</span> sm_surv_est,</span>
<span id="cb207-147"><a href="#cb207-147" aria-hidden="true" tabindex="-1"></a>                    <span class="at">Data_required  =</span> sm_ipd,</span>
<span id="cb207-148"><a href="#cb207-148" aria-hidden="true" tabindex="-1"></a>                    <span class="at">curvefits_data =</span> st,</span>
<span id="cb207-149"><a href="#cb207-149" aria-hidden="true" tabindex="-1"></a>                    <span class="at">time_vector    =</span> t_yr,</span>
<span id="cb207-150"><a href="#cb207-150" aria-hidden="true" tabindex="-1"></a>                    <span class="at">xlim           =</span> xlim_survplots_yr,   </span>
<span id="cb207-151"><a href="#cb207-151" aria-hidden="true" tabindex="-1"></a>                    <span class="at">break_by       =</span> <span class="fu">round</span>(xlim_survplots_yr<span class="sc">/</span><span class="dv">8</span>,<span class="dv">0</span>) </span>
<span id="cb207-152"><a href="#cb207-152" aria-hidden="true" tabindex="-1"></a>                  ))</span>
<span id="cb207-153"><a href="#cb207-153" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">list</span>(</span>
<span id="cb207-154"><a href="#cb207-154" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ipd     =</span> sm_ipd,</span>
<span id="cb207-155"><a href="#cb207-155" aria-hidden="true" tabindex="-1"></a>                    <span class="at">formula =</span> form,</span>
<span id="cb207-156"><a href="#cb207-156" aria-hidden="true" tabindex="-1"></a>                    <span class="at">plot    =</span> survival_plot</span>
<span id="cb207-157"><a href="#cb207-157" aria-hidden="true" tabindex="-1"></a>                  )</span>
<span id="cb207-158"><a href="#cb207-158" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb207-159"><a href="#cb207-159" aria-hidden="true" tabindex="-1"></a>              } <span class="cf">else</span> {</span>
<span id="cb207-160"><a href="#cb207-160" aria-hidden="true" tabindex="-1"></a>                plot <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb207-161"><a href="#cb207-161" aria-hidden="true" tabindex="-1"></a>              }</span>
<span id="cb207-162"><a href="#cb207-162" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb207-163"><a href="#cb207-163" aria-hidden="true" tabindex="-1"></a>              <span class="co"># Now that we've done everything for this dataset, return a list of the stuff</span></span>
<span id="cb207-164"><a href="#cb207-164" aria-hidden="true" tabindex="-1"></a>              <span class="co"># we need for it:</span></span>
<span id="cb207-165"><a href="#cb207-165" aria-hidden="true" tabindex="-1"></a>              <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb207-166"><a href="#cb207-166" aria-hidden="true" tabindex="-1"></a>                <span class="at">pop      =</span> lookups<span class="sc">$</span>pop[     Number <span class="sc">==</span> trial_population,Description],</span>
<span id="cb207-167"><a href="#cb207-167" aria-hidden="true" tabindex="-1"></a>                <span class="at">line     =</span> lookups<span class="sc">$</span>line[    Number <span class="sc">==</span> l,Description],</span>
<span id="cb207-168"><a href="#cb207-168" aria-hidden="true" tabindex="-1"></a>                <span class="at">mol      =</span> lookups<span class="sc">$</span>mol[     Number <span class="sc">==</span> m,Description],</span>
<span id="cb207-169"><a href="#cb207-169" aria-hidden="true" tabindex="-1"></a>                <span class="at">tr       =</span> lookups<span class="sc">$</span>trial[     Number <span class="sc">==</span> tr,Description],</span>
<span id="cb207-170"><a href="#cb207-170" aria-hidden="true" tabindex="-1"></a>                <span class="at">endpoint =</span> lookups<span class="sc">$</span>endpoint[Number <span class="sc">==</span> en,Description],</span>
<span id="cb207-171"><a href="#cb207-171" aria-hidden="true" tabindex="-1"></a>                <span class="at">ipd      =</span> ipd,</span>
<span id="cb207-172"><a href="#cb207-172" aria-hidden="true" tabindex="-1"></a>                <span class="at">fs_fits  =</span> fs_fits,</span>
<span id="cb207-173"><a href="#cb207-173" aria-hidden="true" tabindex="-1"></a>                <span class="at">gof      =</span> gof,</span>
<span id="cb207-174"><a href="#cb207-174" aria-hidden="true" tabindex="-1"></a>                <span class="at">st       =</span> st,</span>
<span id="cb207-175"><a href="#cb207-175" aria-hidden="true" tabindex="-1"></a>                <span class="at">plot     =</span> plot</span>
<span id="cb207-176"><a href="#cb207-176" aria-hidden="true" tabindex="-1"></a>              ))</span>
<span id="cb207-177"><a href="#cb207-177" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb207-178"><a href="#cb207-178" aria-hidden="true" tabindex="-1"></a>          })</span>
<span id="cb207-179"><a href="#cb207-179" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb207-180"><a href="#cb207-180" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb207-181"><a href="#cb207-181" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb207-182"><a href="#cb207-182" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb207-183"><a href="#cb207-183" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="load-pre-run-survival-analysis" class="level3">
<h3 class="anchored" data-anchor-id="load-pre-run-survival-analysis">Load pre-run survival analysis</h3>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-36-contents" aria-controls="callout-36" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-36" class="callout-36-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Set file path at start and changed default path here</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb208"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(RDS_path)) {</span>
<span id="cb208-2"><a href="#cb208-2" aria-hidden="true" tabindex="-1"></a>  i<span class="sc">$</span>surv<span class="sc">$</span>reg <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(RDS_path)</span>
<span id="cb208-3"><a href="#cb208-3" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb208-4"><a href="#cb208-4" aria-hidden="true" tabindex="-1"></a>  i<span class="sc">$</span>surv<span class="sc">$</span>reg <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(rstudioapi<span class="sc">::</span><span class="fu">selectFile</span>(</span>
<span id="cb208-5"><a href="#cb208-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Please select 'Survival_analysis_noTTDorTTPorPPS[NoACIC].rds'"</span>,</span>
<span id="cb208-6"><a href="#cb208-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Survival_analysis_noTTDorTTPorPPS[NoACIC].rds"</span>,</span>
<span id="cb208-7"><a href="#cb208-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">path =</span> <span class="st">"../1_Data/"</span>,</span>
<span id="cb208-8"><a href="#cb208-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">filter =</span> <span class="st">"R Files (*.rds)"</span>,</span>
<span id="cb208-9"><a href="#cb208-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">existing =</span> <span class="cn">TRUE</span></span>
<span id="cb208-10"><a href="#cb208-10" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb208-11"><a href="#cb208-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-37-contents" aria-controls="callout-37" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-37" class="callout-37-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Looking at some examples…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb209"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>reg<span class="sc">$</span>pop_0<span class="sc">$</span>line_1<span class="sc">$</span>mol_0<span class="sc">$</span>trial_0<span class="sc">$</span>endpoint_0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$pop
[1] "All"

$line
[1] "Previously untreated"

$mol
[1] "Nivolumab monotherapy"

$tr
[1] "CheckMate 9ER"

$endpoint
[1] "OS"

$fs_fits
NULL

$gof
NULL

$st
NULL

$plot
NULL</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb211"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>reg<span class="sc">$</span>pop_2<span class="sc">$</span>line_1<span class="sc">$</span>mol_4<span class="sc">$</span>trial_2<span class="sc">$</span>endpoint_1<span class="sc">$</span>pop</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Favourable risk"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb213"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>reg<span class="sc">$</span>pop_2<span class="sc">$</span>line_1<span class="sc">$</span>mol_4<span class="sc">$</span>trial_2<span class="sc">$</span>endpoint_1<span class="sc">$</span>line</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Previously untreated"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb215"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb215-1"><a href="#cb215-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>reg<span class="sc">$</span>pop_2<span class="sc">$</span>line_1<span class="sc">$</span>mol_4<span class="sc">$</span>trial_2<span class="sc">$</span>endpoint_1<span class="sc">$</span>mol</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Avelumab plus axitinib"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb217"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>reg<span class="sc">$</span>pop_2<span class="sc">$</span>line_1<span class="sc">$</span>mol_4<span class="sc">$</span>trial_2<span class="sc">$</span>endpoint_1<span class="sc">$</span>tr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Real world evidence"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb219"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb219-1"><a href="#cb219-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>reg<span class="sc">$</span>pop_2<span class="sc">$</span>line_1<span class="sc">$</span>mol_4<span class="sc">$</span>trial_2<span class="sc">$</span>endpoint_1<span class="sc">$</span>endpoint</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "PFS"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb221"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb221-1"><a href="#cb221-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>reg<span class="sc">$</span>pop_2<span class="sc">$</span>line_1<span class="sc">$</span>mol_4<span class="sc">$</span>trial_2<span class="sc">$</span>endpoint_1<span class="sc">$</span>fs_fits</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$gengamma
$gengamma$coefs
        mu      sigma          Q 
4.82247273 0.09056327 0.53625899 

$gengamma$vcov
               mu       sigma           Q
mu     0.06429237 -0.01613530  0.07438497
sigma -0.01613530  0.09666317 -0.14803155
Q      0.07438497 -0.14803155  0.31491365

$gengamma$fit
      AIC       BIC    logLik 
 317.6759  324.1053 -155.8380 


$exp
$exp$coefs
[1] -5.016078

$exp$vcov
           rate
rate 0.03846153

$exp$fit
      AIC       BIC    logLik 
 314.8361  316.9792 -156.4180 


$weibull
$weibull$coefs
    shape     scale 
0.1368876 4.9253396 

$weibull$vcov
            shape       scale
shape  0.02973812 -0.01789284
scale -0.01789284  0.04001588

$weibull$fit
      AIC       BIC    logLik 
 316.2418  320.5281 -156.1209 


$lnorm
$lnorm$coefs
 meanlog    sdlog 
4.684472 0.328264 

$lnorm$vcov
           meanlog      sdlog
meanlog 0.05800727 0.01964325
sdlog   0.01964325 0.02324137

$lnorm$fit
      AIC       BIC    logLik 
 316.5742  320.8604 -156.2871 


$gamma
$gamma$coefs
     shape       rate 
 0.2069477 -4.6877664 

$gamma$vcov
           shape       rate
shape 0.05266007 0.08092084
rate  0.08092084 0.15342291

$gamma$fit
      AIC       BIC    logLik 
 316.0581  320.3443 -156.0290 


$gompertz
$gompertz$coefs
        shape          rate 
 0.0007630215 -5.0471143856 

$gompertz$vcov
              shape         rate
shape  4.340977e-05 -0.001780984
rate  -1.780984e-03  0.111530453

$gompertz$fit
      AIC       BIC    logLik 
 316.8228  321.1090 -156.4114 


$llogis
$llogis$coefs
    shape     scale 
0.3055121 4.6022358 

$llogis$vcov
            shape       scale
shape  0.02883745 -0.01535555
scale -0.01535555  0.04180951

$llogis$fit
      AIC       BIC    logLik 
 315.2343  319.5206 -155.6172 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb223"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb223-1"><a href="#cb223-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>reg<span class="sc">$</span>pop_2<span class="sc">$</span>line_1<span class="sc">$</span>mol_4<span class="sc">$</span>trial_2<span class="sc">$</span>endpoint_1<span class="sc">$</span>gof</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              AIC      BIC    logLik
gengamma 317.6759 324.1053 -155.8380
exp      314.8361 316.9792 -156.4180
weibull  316.2418 320.5281 -156.1209
lnorm    316.5742 320.8604 -156.2871
gamma    316.0581 320.3443 -156.0290
gompertz 316.8228 321.1090 -156.4114
llogis   315.2343 319.5206 -155.6172</code></pre>
</div>
<div class="sourceCode cell-code" id="cb225"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb225-1"><a href="#cb225-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(i<span class="sc">$</span>surv<span class="sc">$</span>reg<span class="sc">$</span>pop_2<span class="sc">$</span>line_1<span class="sc">$</span>mol_4<span class="sc">$</span>trial_2<span class="sc">$</span>endpoint_1<span class="sc">$</span>st)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      gengamma       exp   weibull     lnorm     gamma  gompertz    llogis
[1,] 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000
[2,] 0.9985777 0.9933915 0.9964812 0.9996291 0.9972167 0.9935903 0.9980669
[3,] 0.9958140 0.9868266 0.9922259 0.9979763 0.9935048 0.9872169 0.9950622
[4,] 0.9922663 0.9803051 0.9876526 0.9950948 0.9893592 0.9808795 0.9914695
[5,] 0.9881616 0.9738267 0.9828687 0.9912317 0.9849185 0.9745780 0.9874457
[6,] 0.9836342 0.9673911 0.9779288 0.9866047 0.9802557 0.9683123 0.9830798</code></pre>
</div>
<div class="sourceCode cell-code" id="cb227"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb227-1"><a href="#cb227-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>reg<span class="sc">$</span>pop_2<span class="sc">$</span>line_1<span class="sc">$</span>mol_4<span class="sc">$</span>trial_2<span class="sc">$</span>endpoint_1<span class="sc">$</span>plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NULL</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb229"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb229-1"><a href="#cb229-1" aria-hidden="true" tabindex="-1"></a>TH <span class="ot">&lt;-</span> p<span class="sc">$</span>basic<span class="sc">$</span>th <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb229-2"><a href="#cb229-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb229-3"><a href="#cb229-3" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>reg <span class="ot">&lt;-</span><span class="fu">lapply</span>(i<span class="sc">$</span>surv<span class="sc">$</span>reg, <span class="cf">function</span>(popu) {</span>
<span id="cb229-4"><a href="#cb229-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(popu, <span class="cf">function</span>(li) {</span>
<span id="cb229-5"><a href="#cb229-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapply</span>(li, <span class="cf">function</span>(mol) {</span>
<span id="cb229-6"><a href="#cb229-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">lapply</span>(mol, <span class="cf">function</span>(tr) {</span>
<span id="cb229-7"><a href="#cb229-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lapply</span>(tr, <span class="cf">function</span>(endp) {</span>
<span id="cb229-8"><a href="#cb229-8" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (<span class="fu">is.null</span>(endp<span class="sc">$</span>st)) {</span>
<span id="cb229-9"><a href="#cb229-9" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(endp)</span>
<span id="cb229-10"><a href="#cb229-10" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> {</span>
<span id="cb229-11"><a href="#cb229-11" aria-hidden="true" tabindex="-1"></a>            endp<span class="sc">$</span>st <span class="ot">&lt;-</span> endp<span class="sc">$</span>st[<span class="dv">1</span><span class="sc">:</span>TH,]</span>
<span id="cb229-12"><a href="#cb229-12" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(endp)</span>
<span id="cb229-13"><a href="#cb229-13" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb229-14"><a href="#cb229-14" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb229-15"><a href="#cb229-15" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb229-16"><a href="#cb229-16" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb229-17"><a href="#cb229-17" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb229-18"><a href="#cb229-18" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-38-contents" aria-controls="callout-38" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-38" class="callout-38-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Limits the matrix with the extrapolated survival curves to the time horizon of the study</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb230"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb230-1"><a href="#cb230-1" aria-hidden="true" tabindex="-1"></a>TH</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2089</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="make-survival-analysis-report" class="level3">
<h3 class="anchored" data-anchor-id="make-survival-analysis-report">Make survival analysis report</h3>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-39-contents" aria-controls="callout-39" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-39" class="callout-39-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>I’ve changed path to doc below.</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb232"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb232-1"><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (i<span class="sc">$</span>dd_report_req_surv_reg<span class="sc">==</span><span class="st">"Yes"</span>) {</span>
<span id="cb232-2"><a href="#cb232-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb232-3"><a href="#cb232-3" aria-hidden="true" tabindex="-1"></a>  doc_surv <span class="ot">&lt;-</span> <span class="fu">f_surv_makeTSD14Report</span>(</span>
<span id="cb232-4"><a href="#cb232-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">fs_res =</span> i<span class="sc">$</span>surv<span class="sc">$</span>reg,</span>
<span id="cb232-5"><a href="#cb232-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">id     =</span> i<span class="sc">$</span>id<span class="sc">$</span>ipd,</span>
<span id="cb232-6"><a href="#cb232-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">lookup =</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd</span>
<span id="cb232-7"><a href="#cb232-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb232-8"><a href="#cb232-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(doc_surv, <span class="at">target =</span> <span class="st">"../4_Output/Survival_Analysis.docx"</span>)</span>
<span id="cb232-9"><a href="#cb232-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb232-10"><a href="#cb232-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(doc_surv)</span>
<span id="cb232-11"><a href="#cb232-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-40-contents" aria-controls="callout-40" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-40" class="callout-40-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>This only works if you have produced the plots. As our pre-run <code>.rds</code> results do not include these, we cannot make the plot. I’ve tried to run the survival analysis function, but couldn’t as hit an error:</p>
<pre><code>Error in optim(method = "BFGS", par = c(mu = 5.82584217367559, sigma = -0.208272130470619,  : 
  non-finite finite-difference value [1]</code></pre>
</div>
</div>
</div>
</section>
</section>
<section id="load-results-from-network-meta-analysis" class="level2">
<h2 class="anchored" data-anchor-id="load-results-from-network-meta-analysis">Load results from network meta analysis</h2>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-41-contents" aria-controls="callout-41" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-41" class="callout-41-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>File path above now, and path option below is changed.</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb234"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb234-1"><a href="#cb234-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(RDS_path2)) {</span>
<span id="cb234-2"><a href="#cb234-2" aria-hidden="true" tabindex="-1"></a>  i<span class="sc">$</span>PHNMA <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(RDS_path2)</span>
<span id="cb234-3"><a href="#cb234-3" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb234-4"><a href="#cb234-4" aria-hidden="true" tabindex="-1"></a>  i<span class="sc">$</span>PHNMA <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(rstudioapi<span class="sc">::</span><span class="fu">selectFile</span>(</span>
<span id="cb234-5"><a href="#cb234-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Please select 'PH_NMA_CODA.rds'"</span>,</span>
<span id="cb234-6"><a href="#cb234-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"PH_NMA_CODA.rds"</span>,</span>
<span id="cb234-7"><a href="#cb234-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">path =</span> <span class="st">"../1_Data/"</span>,</span>
<span id="cb234-8"><a href="#cb234-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">filter =</span> <span class="st">"R Files (*.rds)"</span>,</span>
<span id="cb234-9"><a href="#cb234-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">existing =</span> <span class="cn">TRUE</span></span>
<span id="cb234-10"><a href="#cb234-10" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb234-11"><a href="#cb234-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb234-12"><a href="#cb234-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-13"><a href="#cb234-13" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(i<span class="sc">$</span>PHNMA<span class="sc">$</span>data) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Run"</span>, <span class="st">"Population"</span>, <span class="st">"Line"</span>, <span class="st">"Molecule"</span>, <span class="st">"Endpoint"</span>, <span class="st">"Reference.treatment"</span>, <span class="st">"Reference.trial"</span>, <span class="st">"HR"</span>)</span>
<span id="cb234-14"><a href="#cb234-14" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>PHNMA<span class="sc">$</span>data<span class="sc">$</span>Reference.endpoint <span class="ot">&lt;-</span> i<span class="sc">$</span>PHNMA<span class="sc">$</span>data<span class="sc">$</span>Endpoint</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-42-contents" aria-controls="callout-42" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-42" class="callout-42-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>PH NMA CODA samples. My understanding is that these are “CODA” samples as they are from a Bayesian network meta analysis. “CODA” refers to “Convergence Diagnosis and Output Analysis”. When you run a Bayesian analysis, CODA samples are samples from the posterior distribution of your model parameters, as these samples are used to estimate the parameter distributions, check convergence and perform diagnostics.</p>
<p>Imports dataframe, sets colnames, and makes duplicate of <code>Endpoint</code> called <code>Reference.endpoint</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb235"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb235-1"><a href="#cb235-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(i<span class="sc">$</span>PHNMA<span class="sc">$</span>data))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     Run Population  Line Molecule Endpoint Reference.treatment Reference.trial
   &lt;int&gt;      &lt;int&gt; &lt;int&gt;    &lt;int&gt;    &lt;int&gt;               &lt;int&gt;           &lt;int&gt;
1:     1          0     1        4        0                   7               0
2:     1          0     1        1        0                   7               0
3:     1          0     1        8        0                   7               0
4:     1          0     1        2        0                   7               0
5:     1          0     1        5        0                   7               0
6:     1          0     1        3        0                   7               0
          HR Reference.endpoint
       &lt;num&gt;              &lt;int&gt;
1: 0.8958580                  0
2: 0.7821468                  0
3: 1.4324613                  0
4: 0.7571763                  0
5: 0.9492596                  0
6: 0.8561836                  0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb237"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb237-1"><a href="#cb237-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">dim</span>(i<span class="sc">$</span>PHNMA<span class="sc">$</span>data))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 680000      9</code></pre>
</div>
<div class="sourceCode cell-code" id="cb239"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb239-1"><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">unique</span>(i<span class="sc">$</span>PHNMA<span class="sc">$</span>data<span class="sc">$</span>Endpoint))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0 1</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb241"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb241-1"><a href="#cb241-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>PHNMA<span class="sc">$</span>assume3L      <span class="ot">&lt;-</span> i<span class="sc">$</span>PHNMA<span class="sc">$</span>data[Line<span class="sc">==</span><span class="dv">2</span>,]</span>
<span id="cb241-2"><a href="#cb241-2" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>PHNMA<span class="sc">$</span>assume3L<span class="sc">$</span>Line <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb241-3"><a href="#cb241-3" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>PHNMA<span class="sc">$</span>data         <span class="ot">&lt;-</span> <span class="fu">rbind</span>(i<span class="sc">$</span>PHNMA<span class="sc">$</span>data,i<span class="sc">$</span>PHNMA<span class="sc">$</span>assume3L)</span>
<span id="cb241-4"><a href="#cb241-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-5"><a href="#cb241-5" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>PHNMA<span class="sc">$</span>assumeTTD <span class="ot">&lt;-</span> i<span class="sc">$</span>PHNMA<span class="sc">$</span>data[Endpoint<span class="sc">==</span><span class="dv">1</span>,]</span>
<span id="cb241-6"><a href="#cb241-6" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>PHNMA<span class="sc">$</span>assumeTTD<span class="sc">$</span>Endpoint <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb241-7"><a href="#cb241-7" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>PHNMA<span class="sc">$</span>data <span class="ot">&lt;-</span> <span class="fu">rbind</span>(i<span class="sc">$</span>PHNMA<span class="sc">$</span>data,i<span class="sc">$</span>PHNMA<span class="sc">$</span>assumeTTD)</span>
<span id="cb241-8"><a href="#cb241-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-9"><a href="#cb241-9" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>PHNMA<span class="sc">$</span>assumeTTP <span class="ot">&lt;-</span> i<span class="sc">$</span>PHNMA<span class="sc">$</span>data[Endpoint<span class="sc">==</span><span class="dv">1</span>,]</span>
<span id="cb241-10"><a href="#cb241-10" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>PHNMA<span class="sc">$</span>assumeTTP<span class="sc">$</span>Endpoint <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb241-11"><a href="#cb241-11" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>PHNMA<span class="sc">$</span>data <span class="ot">&lt;-</span> <span class="fu">rbind</span>(i<span class="sc">$</span>PHNMA<span class="sc">$</span>data,i<span class="sc">$</span>PHNMA<span class="sc">$</span>assumeTTP)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-43-contents" aria-controls="callout-43" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-43" class="callout-43-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><code>Model_Structure.R</code> highlights 3L relative effectiveness is assumed to be the same as 2L.</p>
<p>In the code, we can see that it:</p>
<ul>
<li>Sets data for 3L (<code>assume3L</code>) to <code>i$PHNMA$data[Line==2,]</code></li>
<li>Sets time to discontinuation (TTD) for 2L to <code>i$PHNMA$data[Endpoint==1,]</code></li>
<li>Sets time to progression (TTP) for 3L to <code>i$PHNMA$data[Endpoint==1,]</code></li>
</ul>
<p>e.g.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb242"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb242-1"><a href="#cb242-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(i<span class="sc">$</span>PHNMA<span class="sc">$</span>assume3L)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
<div class="sourceCode cell-code" id="cb243"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb243-1"><a href="#cb243-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(i<span class="sc">$</span>PHNMA<span class="sc">$</span>data[Line<span class="sc">==</span><span class="dv">2</span>,])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb244"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb244-1"><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>PHNMA<span class="sc">$</span>means <span class="ot">&lt;-</span> i<span class="sc">$</span>PHNMA<span class="sc">$</span>data[,.(<span class="at">HR =</span> <span class="fu">mean</span>(HR)),by<span class="ot">=</span><span class="fu">list</span>(Population,Line,Molecule,Endpoint,Reference.treatment,Reference.trial)]</span>
<span id="cb244-2"><a href="#cb244-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-3"><a href="#cb244-3" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>releff<span class="sc">$</span>CODA<span class="sc">$</span>PH <span class="ot">&lt;-</span> i<span class="sc">$</span>PHNMA<span class="sc">$</span>means</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-44-contents" aria-controls="callout-44" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-44" class="callout-44-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Mean hazard ratio by each combination of population, line, molecule, endpoint, reference treatment and reference trial. <code>Model_Structure.R</code> says this is for the deterministic analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb245"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb245-1"><a href="#cb245-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(i<span class="sc">$</span>PHNMA<span class="sc">$</span>means)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb246"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(i<span class="sc">$</span>PHNMA<span class="sc">$</span>data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1980000       9</code></pre>
</div>
<div class="sourceCode cell-code" id="cb248"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb248-1"><a href="#cb248-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the number of hazard ratios per group, used when finding means</span></span>
<span id="cb248-2"><a href="#cb248-2" aria-hidden="true" tabindex="-1"></a><span class="co"># and we see that, for each one, it is 10000</span></span>
<span id="cb248-3"><a href="#cb248-3" aria-hidden="true" tabindex="-1"></a>phnma_group_n <span class="ot">&lt;-</span> i<span class="sc">$</span>PHNMA<span class="sc">$</span>data[, .(<span class="at">Number_of_Rows =</span> .N), by <span class="ot">=</span> <span class="fu">list</span>(Population, Line, Molecule, Endpoint, Reference.treatment, Reference.trial)]</span>
<span id="cb248-4"><a href="#cb248-4" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(phnma_group_n<span class="sc">$</span>Number_of_Rows)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 10000</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-45-contents" aria-controls="callout-45" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-45" class="callout-45-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>File path above now, and path option below is changed.</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb250"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb250-1"><a href="#cb250-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>FPNMA <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb250-2"><a href="#cb250-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-3"><a href="#cb250-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(RDS_path3)) {</span>
<span id="cb250-4"><a href="#cb250-4" aria-hidden="true" tabindex="-1"></a>  i<span class="sc">$</span>FPNMA<span class="sc">$</span>means  <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(RDS_path3)</span>
<span id="cb250-5"><a href="#cb250-5" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb250-6"><a href="#cb250-6" aria-hidden="true" tabindex="-1"></a>  i<span class="sc">$</span>FPNMA<span class="sc">$</span>means <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(rstudioapi<span class="sc">::</span><span class="fu">selectFile</span>(</span>
<span id="cb250-7"><a href="#cb250-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Load in FP NMA CODA (FPNMA_means.rds)"</span>,</span>
<span id="cb250-8"><a href="#cb250-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"FPNMA_means.rds"</span>,</span>
<span id="cb250-9"><a href="#cb250-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">path =</span> <span class="st">"../1_Data/"</span>,</span>
<span id="cb250-10"><a href="#cb250-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">filter =</span> <span class="st">"R Files (*.rds)"</span>,</span>
<span id="cb250-11"><a href="#cb250-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">existing =</span> <span class="cn">TRUE</span></span>
<span id="cb250-12"><a href="#cb250-12" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb250-13"><a href="#cb250-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb250-14"><a href="#cb250-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-15"><a href="#cb250-15" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(i<span class="sc">$</span>FPNMA<span class="sc">$</span>means)[<span class="fu">colnames</span>(i<span class="sc">$</span>FPNMA<span class="sc">$</span>means) <span class="sc">==</span> <span class="st">"intervention_code"</span>] <span class="ot">&lt;-</span> <span class="st">"Molecule"</span></span>
<span id="cb250-16"><a href="#cb250-16" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(i<span class="sc">$</span>FPNMA<span class="sc">$</span>means)[<span class="fu">colnames</span>(i<span class="sc">$</span>FPNMA<span class="sc">$</span>means) <span class="sc">==</span> <span class="st">"reference_treatment_code"</span>] <span class="ot">&lt;-</span> <span class="st">"Reference.treatment"</span></span>
<span id="cb250-17"><a href="#cb250-17" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(i<span class="sc">$</span>FPNMA<span class="sc">$</span>means)[<span class="fu">colnames</span>(i<span class="sc">$</span>FPNMA<span class="sc">$</span>means) <span class="sc">==</span> <span class="st">"ref_trial_code"</span>] <span class="ot">&lt;-</span> <span class="st">"Reference.trial"</span></span>
<span id="cb250-18"><a href="#cb250-18" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(i<span class="sc">$</span>FPNMA<span class="sc">$</span>means)[<span class="fu">colnames</span>(i<span class="sc">$</span>FPNMA<span class="sc">$</span>means) <span class="sc">==</span> <span class="st">"population"</span>] <span class="ot">&lt;-</span> <span class="st">"Population"</span></span>
<span id="cb250-19"><a href="#cb250-19" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(i<span class="sc">$</span>FPNMA<span class="sc">$</span>means)[<span class="fu">colnames</span>(i<span class="sc">$</span>FPNMA<span class="sc">$</span>means) <span class="sc">==</span> <span class="st">"line"</span>] <span class="ot">&lt;-</span> <span class="st">"Line"</span></span>
<span id="cb250-20"><a href="#cb250-20" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(i<span class="sc">$</span>FPNMA<span class="sc">$</span>means)[<span class="fu">colnames</span>(i<span class="sc">$</span>FPNMA<span class="sc">$</span>means) <span class="sc">==</span> <span class="st">"endpoint"</span>] <span class="ot">&lt;-</span> <span class="st">"Endpoint"</span></span>
<span id="cb250-21"><a href="#cb250-21" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(i<span class="sc">$</span>FPNMA<span class="sc">$</span>means)[<span class="fu">colnames</span>(i<span class="sc">$</span>FPNMA<span class="sc">$</span>means) <span class="sc">==</span> <span class="st">"V1"</span>] <span class="ot">&lt;-</span> <span class="st">"HR"</span></span>
<span id="cb250-22"><a href="#cb250-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-23"><a href="#cb250-23" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>FPNMA<span class="sc">$</span>means<span class="sc">$</span>time <span class="ot">&lt;-</span> <span class="fu">round</span>(i<span class="sc">$</span>FPNMA<span class="sc">$</span>means<span class="sc">$</span>time <span class="sc">*</span> <span class="dv">52</span> <span class="sc">/</span> <span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-46-contents" aria-controls="callout-46" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-46" class="callout-46-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Import fractional polynomial (FP) NMA data.</p>
<p>Rename columns and convert time to months (as multiplied by 52, which is the number of weeks in a year, and then divides by 12, which is the number of months). Hence, it seems the original unit was something per week.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb251"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb251-1"><a href="#cb251-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(i<span class="sc">$</span>FPNMA<span class="sc">$</span>means)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 66528     8</code></pre>
</div>
<div class="sourceCode cell-code" id="cb253"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb253-1"><a href="#cb253-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(i<span class="sc">$</span>FPNMA<span class="sc">$</span>means)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb254"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb254-1"><a href="#cb254-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>FPNMA<span class="sc">$</span>means <span class="ot">&lt;-</span> <span class="fu">f_rebase_for_cabo_as_ref_in_2L</span>(<span class="at">FPNMAdata =</span> i<span class="sc">$</span>FPNMA<span class="sc">$</span>means)</span>
<span id="cb254-2"><a href="#cb254-2" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>FPNMA<span class="sc">$</span>means <span class="ot">&lt;-</span> <span class="fu">f_3L_rel_effect_same_as_2L</span>(<span class="at">FPNMAdata =</span> i<span class="sc">$</span>FPNMA<span class="sc">$</span>means) </span>
<span id="cb254-3"><a href="#cb254-3" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>FPNMA<span class="sc">$</span>destinations <span class="ot">&lt;-</span> <span class="fu">f_gen_destinations</span>(<span class="at">fp_data =</span> i<span class="sc">$</span>FPNMA<span class="sc">$</span>means)</span>
<span id="cb254-4"><a href="#cb254-4" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>FPNMA<span class="sc">$</span>means <span class="ot">&lt;-</span> <span class="fu">f_add_reference_trial_2</span>(<span class="at">fp_data =</span> i<span class="sc">$</span>FPNMA<span class="sc">$</span>means)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-47-contents" aria-controls="callout-47" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-47" class="callout-47-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><code>misc</code>: <code>f_rebase_for_cabo_as_ref_in_2L</code>: Here, rebasing refers to changing the reference point - in this case, it changes the hazard ratios from molecule 10 in second line to molecule 8 (cabo), to allow the use of cabo as a reference treatment in second line. Joins to end of dataframe.</p>
<p><code>misc</code>: <code>f_3L_rel_effect_same_as_2L</code>: Assume that hazard ratios for 3L are same as 2L (like above). Joins to end of dataframe.</p>
<p><code>misc</code>: <code>f_gen_destinations</code>: Gets unique combinations of population + line + molecule + endpoint + reference treatment + reference trial. It then duplicates the dataframe and joins the two, except changing that second one so that reference.trial is set for 2 (real-world evidence) on all rows. The function docstrings explains that “this is an assumption of the specific adaptation for the RCC PATT model, which may not hold in other circumstances. Consequently, this function is specific to the RCC model and not the generic pathway”</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb255"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb255-1"><a href="#cb255-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(i<span class="sc">$</span>FPNMA<span class="sc">$</span>destinations)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 244   6</code></pre>
</div>
<div class="sourceCode cell-code" id="cb257"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb257-1"><a href="#cb257-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(i<span class="sc">$</span>FPNMA<span class="sc">$</span>destinations)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
</div>
<p><code>misc</code>: <code>f_add_reference_trial_2</code>: Makes a copy of <code>i$FPNMA$means</code> where reference trial is set to 2. Joins to end of dataframe.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb258"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb258-1"><a href="#cb258-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(i<span class="sc">$</span>FPNMA<span class="sc">$</span>means<span class="sc">$</span>Reference.trial)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0 1 2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb260"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb260-1"><a href="#cb260-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>trial</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb261"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb261-1"><a href="#cb261-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>releff<span class="sc">$</span>CODA<span class="sc">$</span>FP <span class="ot">&lt;-</span> i<span class="sc">$</span>FPNMA<span class="sc">$</span>means</span>
<span id="cb261-2"><a href="#cb261-2" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>releff<span class="sc">$</span>fp_dest <span class="ot">&lt;-</span> i<span class="sc">$</span>FPNMA<span class="sc">$</span>destinations[<span class="sc">!</span><span class="fu">is.na</span>(Molecule), ]</span>
<span id="cb261-3"><a href="#cb261-3" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>releff<span class="sc">$</span>CODA<span class="sc">$</span>FP <span class="ot">&lt;-</span> p<span class="sc">$</span>releff<span class="sc">$</span>CODA<span class="sc">$</span>FP[time <span class="sc">&lt;=</span> p<span class="sc">$</span>basic<span class="sc">$</span>th, ]</span>
<span id="cb261-4"><a href="#cb261-4" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>releff<span class="sc">$</span>fp_dest <span class="ot">&lt;-</span> i<span class="sc">$</span>FPNMA<span class="sc">$</span>destinations[<span class="sc">!</span><span class="fu">is.na</span>(Molecule), ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-48-contents" aria-controls="callout-48" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-48" class="callout-48-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Add parameters to <code>p</code>, remove molecules with NA, and limit time horizon to <code>p$basic$th</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb262"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb262-1"><a href="#cb262-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>basic<span class="sc">$</span>th</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2088</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="relative-efficacy-network" class="level2">
<h2 class="anchored" data-anchor-id="relative-efficacy-network">Relative efficacy network</h2>
<p>A relative efficacy network is required to compute the survival times for all the different PLMTEs we need to power the model with.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb264"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb264-1"><a href="#cb264-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>releff<span class="sc">$</span>network <span class="ot">&lt;-</span> <span class="fu">f_NMA_generateNetwork</span>(i<span class="sc">$</span>id<span class="sc">$</span>ipd,i<span class="sc">$</span>lookup<span class="sc">$</span>ipd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-49-contents" aria-controls="callout-49" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-49" class="callout-49-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Uses <code>survival</code> function <code>f_NMA_generateNetwork()</code> which uses the unique values for population line molecule trial endpoint (accepts labels as input too but these aren’t used by the function).</p>
<p>Creates a nested list where can then breakdown by population &gt; line &gt; molecule &gt; trial &gt; endpoint (PLMTE). There is then:</p>
<ul>
<li><code>$dest</code> - which holds the numbers for the PLMTE</li>
<li><code>$orig</code> - empty list of PLMTE plus dist and source</li>
<li><code>$hr</code> - set to 1</li>
<li><code>$fp</code> - empty list</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb265"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb265-1"><a href="#cb265-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>releff<span class="sc">$</span>network<span class="sc">$</span>pop_0<span class="sc">$</span>line_1<span class="sc">$</span>mol_0<span class="sc">$</span>trial_0<span class="sc">$</span>endpoint_0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$dest
$dest$pop
[1] "pop_0"

$dest$line
[1] "line_1"

$dest$mol
[1] "mol_0"

$dest$trial
[1] "trial_0"

$dest$endpoint
[1] "endpoint_0"


$orig
$orig$pop
NULL

$orig$line
NULL

$orig$mol
NULL

$orig$trial
NULL

$orig$endpoint
NULL

$orig$dist
NULL

$orig$source
NULL


$hr
[1] 1

$fp
list()</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb267"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb267-1"><a href="#cb267-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="st">"Trial"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(i<span class="sc">$</span>R_table_eff_data_settings)) {</span>
<span id="cb267-2"><a href="#cb267-2" aria-hidden="true" tabindex="-1"></a>  i<span class="sc">$</span>R_table_eff_data_settings<span class="sc">$</span>Trial <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>trial<span class="sc">$</span>Number[<span class="fu">match</span>(i<span class="sc">$</span>R_table_eff_data_settings<span class="sc">$</span>Trial.name.if.effectiveness.source.is.trial,i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>trial<span class="sc">$</span>Description)]</span>
<span id="cb267-3"><a href="#cb267-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-50-contents" aria-controls="callout-50" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-50" class="callout-50-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>If <code>Trial</code> is not in <code>i$R_table_eff_data_settings</code> (which it wasn’t in the default settings) then it gets trial names (<code>i$R_table_eff_data_settings$Trial.name.if.effectiveness.source.is.trial</code>)…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb268"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb268-1"><a href="#cb268-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(i<span class="sc">$</span>R_table_eff_data_settings<span class="sc">$</span>Trial.name.if.effectiveness.source.is.trial, <span class="dv">50</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "0"                   "0"                   "0"                  
 [4] "0"                   "0"                   "0"                  
 [7] "0"                   "Real world evidence" "0"                  
[10] "0"                   "0"                   "0"                  
[13] "0"                   "0"                   "0"                  
[16] "0"                   "0"                   "0"                  
[19] "0"                   "0"                   "0"                  
[22] "Real world evidence" "0"                   "0"                  
[25] "0"                   "0"                   "0"                  
[28] "0"                   "0"                   "0"                  
[31] "0"                   "0"                   "0"                  
[34] "0"                   "0"                   "Real world evidence"
[37] "0"                   "0"                   "0"                  
[40] "0"                   "0"                   "0"                  
[43] "0"                   "0"                   "0"                  
[46] "0"                   "0"                   "0"                  
[49] "0"                   "Real world evidence"</code></pre>
</div>
</div>
<p>…checks if they are in the lookup (<code>i$lookup$ipd$trial$Description</code>)…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb270"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb270-1"><a href="#cb270-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>trial<span class="sc">$</span>Description</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "CheckMate 9ER"       "CheckMate 025"       "Real world evidence"</code></pre>
</div>
</div>
<p>… and converts them to trial numbers using another lookup <code>i$lookup$ipd$trial$Number</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb272"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb272-1"><a href="#cb272-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>trial<span class="sc">$</span>Number</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0 1 2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb274"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb274-1"><a href="#cb274-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(i<span class="sc">$</span>R_table_eff_data_settings<span class="sc">$</span>Trial, <span class="dv">50</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] NA NA NA NA NA NA NA  2 NA NA NA NA NA NA NA NA NA NA NA NA NA  2 NA NA NA
[26] NA NA NA NA NA NA NA NA NA NA  2 NA NA NA NA NA NA NA NA NA NA NA NA NA  2</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb276"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb276-1"><a href="#cb276-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>releff<span class="sc">$</span>network <span class="ot">&lt;-</span> <span class="fu">f_NMA_linkPHNMA</span>(</span>
<span id="cb276-2"><a href="#cb276-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">network       =</span> p<span class="sc">$</span>releff<span class="sc">$</span>network,</span>
<span id="cb276-3"><a href="#cb276-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">hr_table      =</span> p<span class="sc">$</span>releff<span class="sc">$</span>CODA<span class="sc">$</span>PH</span>
<span id="cb276-4"><a href="#cb276-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-51-contents" aria-controls="callout-51" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-51" class="callout-51-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Takes the hazard ratios from <code>p$releff$CODA$PH</code> and inputs them into <code>p$releff$network</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb277"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb277-1"><a href="#cb277-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(p<span class="sc">$</span>releff<span class="sc">$</span>CODA<span class="sc">$</span>PH)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
</div>
<p>Looking at example from first row of table, you can see it has populated <code>hr</code> and <code>orig</code> using <code>p$releff$CODA$PH</code>. For example:</p>
<ul>
<li><code>Molecule</code> in PHNMA data becomes <code>dest$mol</code> in network (as in NMA, destination is treatment being evaluated against reference treatment)</li>
<li><code>Reference.treatment</code> in PHNMA data becomes <code>orig$mol</code> in network (as in NMA, origin is reference treatment)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb278"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb278-1"><a href="#cb278-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>releff<span class="sc">$</span>network<span class="sc">$</span>pop_0<span class="sc">$</span>line_1<span class="sc">$</span>mol_4<span class="sc">$</span>trial_0<span class="sc">$</span>endpoint_0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$dest
$dest$pop
[1] "pop_0"

$dest$line
[1] "line_1"

$dest$mol
[1] "mol_4"

$dest$trial
[1] "trial_0"

$dest$endpoint
[1] "endpoint_0"


$orig
$orig$pop
[1] "pop_0"

$orig$line
[1] "line_1"

$orig$mol
[1] "mol_7"

$orig$trial
[1] "trial_0"

$orig$endpoint
[1] "endpoint_0"

$orig$dist
NULL

$orig$source
NULL


$hr
[1] 0.7935352

$fp
list()</code></pre>
</div>
</div>
<p>Then <code>Model_Structure.R</code> has this commented line of code to view all treatments in the network:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb280"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb280-1"><a href="#cb280-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(<span class="fu">c</span>(<span class="fu">unique</span>(p<span class="sc">$</span>releff<span class="sc">$</span>means<span class="sc">$</span>Molecule),<span class="fu">unique</span>(p<span class="sc">$</span>releff<span class="sc">$</span>means<span class="sc">$</span>Reference.treatment),<span class="fu">unique</span>(i<span class="sc">$</span>R_table_eff_data_settings<span class="sc">$</span>Origin.treatment),<span class="fu">unique</span>(i<span class="sc">$</span>R_table_eff_data_settings<span class="sc">$</span>Treatment)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1]   7   1 999   8   6   0   2   3   4   5   9  10  11  12</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb282"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb282-1"><a href="#cb282-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>releff<span class="sc">$</span>network <span class="ot">&lt;-</span> <span class="fu">f_NMA_linkFPNMA</span>(</span>
<span id="cb282-2"><a href="#cb282-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">network       =</span> p<span class="sc">$</span>releff<span class="sc">$</span>network,</span>
<span id="cb282-3"><a href="#cb282-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">destinations  =</span> p<span class="sc">$</span>releff<span class="sc">$</span>fp_dest,</span>
<span id="cb282-4"><a href="#cb282-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">hr_table      =</span> p<span class="sc">$</span>releff<span class="sc">$</span>CODA<span class="sc">$</span>FP,</span>
<span id="cb282-5"><a href="#cb282-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">time_horizon  =</span> p<span class="sc">$</span>basic<span class="sc">$</span>th</span>
<span id="cb282-6"><a href="#cb282-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-52-contents" aria-controls="callout-52" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-52" class="callout-52-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>This adds the results from <code>p$releff$CODA$FP</code> to <code>$fp$HR</code> in the network.</p>
<p>This matches up to those from before, this time just adding <code>$fp$HR</code> from the FPNMA data.</p>
<p>The example from below is shown, filtering just to <code>$fp$HR</code>. You can see this is long, containing 2089 HR.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb283"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb283-1"><a href="#cb283-1" aria-hidden="true" tabindex="-1"></a>fp_example <span class="ot">&lt;-</span> p<span class="sc">$</span>releff<span class="sc">$</span>network<span class="sc">$</span>pop_0<span class="sc">$</span>line_1<span class="sc">$</span>mol_4<span class="sc">$</span>trial_0<span class="sc">$</span>endpoint_0<span class="sc">$</span>fp<span class="sc">$</span>HR</span>
<span id="cb283-2"><a href="#cb283-2" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(fp_example)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2089</code></pre>
</div>
<div class="sourceCode cell-code" id="cb285"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb285-1"><a href="#cb285-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(fp_example, <span class="dv">50</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 0.9321210 0.7399991 0.7015206 0.6987356 0.7068145 0.7182071 0.7301949
 [8] 0.7417350 0.7524420 0.7622070 0.7710399 0.7790003 0.7861653 0.7926152
[15] 0.7984263 0.8036691 0.8084066 0.8126947 0.8165829 0.8201147 0.8233282
[22] 0.8262571 0.8289309 0.8313755 0.8336141 0.8356668 0.8375518 0.8392850
[29] 0.8408807 0.8423514 0.8437087 0.8449627 0.8461224 0.8471961 0.8481912
[36] 0.8491142 0.8499714 0.8507680 0.8515091 0.8521991 0.8528422 0.8534420
[43] 0.8540020 0.8545253 0.8550147 0.8554728 0.8559019 0.8563044 0.8566821
[50] 0.8570370</code></pre>
</div>
</div>
<p><strong>Why does PHNMA have one HR and FPNMA have loads?</strong></p>
<ul>
<li>PH: Cox proportional hazards model has the “proportional hazards” assumption, which is that we assume the hazard ratio to be constant over time, and so we get a single hazard ratio when comparing two treatments</li>
<li>FP: Fractional polynomial models have mode flexibility and allow the hazard ratio to vary over time, reflecting how the relative risk between treatments might vary throughout the study period</li>
</ul>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb287"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb287-1"><a href="#cb287-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (i<span class="sc">$</span>dd_use_PHnma_for_FPnma <span class="sc">==</span> <span class="st">"Yes"</span>) {</span>
<span id="cb287-2"><a href="#cb287-2" aria-hidden="true" tabindex="-1"></a>  i<span class="sc">$</span>which_fpnma <span class="ot">&lt;-</span> <span class="fu">which</span>(i<span class="sc">$</span>R_table_eff_data_settings<span class="sc">$</span>Effectiveness.data.source <span class="sc">==</span> <span class="st">"FP_NMA"</span>)</span>
<span id="cb287-3"><a href="#cb287-3" aria-hidden="true" tabindex="-1"></a>  i<span class="sc">$</span>R_table_eff_data_settings<span class="sc">$</span>Effectiveness.data.source[i<span class="sc">$</span>which_fpnma] <span class="ot">&lt;-</span> <span class="st">"PH_NMA"</span></span>
<span id="cb287-4"><a href="#cb287-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-53-contents" aria-controls="callout-53" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-53" class="callout-53-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>If the setting <code>dd_use_PHnma_for_FPnma</code> was set to “Yes” in the excel spreadsheet, then it will identify cases where <code>i$R_table_eff_data_settings$Effectiveness.data.source == "FP_NMA"</code> and replace it with <code>PH_NMA</code>. In <code>Model_Strcuture.py</code>, it explains that this will <strong>force the model to use the PH NMA CODA sample</strong> instead of FP NMA. By default though, this is currently set to “No”.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb288"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb288-1"><a href="#cb288-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>dd_use_PHnma_for_FPnma</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "No"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb290"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb290-1"><a href="#cb290-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(i<span class="sc">$</span>R_table_eff_data_settings<span class="sc">$</span>Effectiveness.data.source)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
                      0             Apply HR to         Assume equal to 
                    247                      49                      44 
                 FP_NMA                  PH_NMA Trial survival analysis 
                     22                      39                      19 </code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-54-contents" aria-controls="callout-54" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-54" class="callout-54-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Saving some examples to use below, so you can see what changes before and after running <code>f_NMA_AddAssumptionsToNetwork()</code>…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb292"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb292-1"><a href="#cb292-1" aria-hidden="true" tabindex="-1"></a>example_trial <span class="ot">&lt;-</span> p<span class="sc">$</span>releff<span class="sc">$</span>network<span class="sc">$</span>pop_1<span class="sc">$</span>line_1<span class="sc">$</span>mol_7<span class="sc">$</span>trial_2<span class="sc">$</span>endpoint_0</span>
<span id="cb292-2"><a href="#cb292-2" aria-hidden="true" tabindex="-1"></a>example_fp1 <span class="ot">&lt;-</span> <span class="fu">head</span>(p<span class="sc">$</span>releff<span class="sc">$</span>network<span class="sc">$</span>pop_1<span class="sc">$</span>line_1<span class="sc">$</span>mol_1<span class="sc">$</span>trial_0<span class="sc">$</span>endpoint_0<span class="sc">$</span>fp<span class="sc">$</span>HR, <span class="dv">10</span>)</span>
<span id="cb292-3"><a href="#cb292-3" aria-hidden="true" tabindex="-1"></a>example_fp2 <span class="ot">&lt;-</span> <span class="fu">head</span>(p<span class="sc">$</span>releff<span class="sc">$</span>network<span class="sc">$</span>pop_1<span class="sc">$</span>line_1<span class="sc">$</span>mol_1<span class="sc">$</span>trial_2<span class="sc">$</span>endpoint_0<span class="sc">$</span>fp<span class="sc">$</span>HR, <span class="dv">10</span>)</span>
<span id="cb292-4"><a href="#cb292-4" aria-hidden="true" tabindex="-1"></a>example_ph1 <span class="ot">&lt;-</span> p<span class="sc">$</span>releff<span class="sc">$</span>network<span class="sc">$</span>pop_2<span class="sc">$</span>line_1<span class="sc">$</span>mol_1<span class="sc">$</span>trial_0<span class="sc">$</span>endpoint_0<span class="sc">$</span>hr</span>
<span id="cb292-5"><a href="#cb292-5" aria-hidden="true" tabindex="-1"></a>example_ph2 <span class="ot">&lt;-</span> p<span class="sc">$</span>releff<span class="sc">$</span>network<span class="sc">$</span>pop_2<span class="sc">$</span>line_1<span class="sc">$</span>mol_1<span class="sc">$</span>trial_2<span class="sc">$</span>endpoint_0<span class="sc">$</span>hr</span>
<span id="cb292-6"><a href="#cb292-6" aria-hidden="true" tabindex="-1"></a>example_et <span class="ot">&lt;-</span> p<span class="sc">$</span>releff<span class="sc">$</span>network<span class="sc">$</span>pop_1<span class="sc">$</span>line_1<span class="sc">$</span>mol_5<span class="sc">$</span>trial_1<span class="sc">$</span>endpoint_0<span class="sc">$</span>hr</span>
<span id="cb292-7"><a href="#cb292-7" aria-hidden="true" tabindex="-1"></a>example_ahr <span class="ot">&lt;-</span> p<span class="sc">$</span>releff<span class="sc">$</span>network<span class="sc">$</span>pop_0<span class="sc">$</span>line_3<span class="sc">$</span>mol_0<span class="sc">$</span>trial_2<span class="sc">$</span>endpoint_2<span class="sc">$</span>hr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb293"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb293-1"><a href="#cb293-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>releff<span class="sc">$</span>network <span class="ot">&lt;-</span> <span class="fu">f_NMA_AddAssumptionsToNetwork</span>(</span>
<span id="cb293-2"><a href="#cb293-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">network            =</span> p<span class="sc">$</span>releff<span class="sc">$</span>network,</span>
<span id="cb293-3"><a href="#cb293-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">phnma_table        =</span> p<span class="sc">$</span>releff<span class="sc">$</span>CODA<span class="sc">$</span>PH,</span>
<span id="cb293-4"><a href="#cb293-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">fpnma_table        =</span> p<span class="sc">$</span>releff<span class="sc">$</span>CODA<span class="sc">$</span>FP,</span>
<span id="cb293-5"><a href="#cb293-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">fpnma_destinations =</span> p<span class="sc">$</span>releff<span class="sc">$</span>fp_dest,</span>
<span id="cb293-6"><a href="#cb293-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">excel_table        =</span> <span class="fu">data.table</span>(i<span class="sc">$</span>R_table_eff_data_settings),</span>
<span id="cb293-7"><a href="#cb293-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">trial_flag         =</span> i<span class="sc">$</span>List_eff_datasources[<span class="dv">1</span>],</span>
<span id="cb293-8"><a href="#cb293-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">fpnma_flag         =</span> i<span class="sc">$</span>List_eff_datasources[<span class="dv">3</span>],</span>
<span id="cb293-9"><a href="#cb293-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">phnma_flag         =</span> i<span class="sc">$</span>List_eff_datasources[<span class="dv">2</span>],</span>
<span id="cb293-10"><a href="#cb293-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">et_flag            =</span> i<span class="sc">$</span>List_eff_datasources[<span class="dv">4</span>],</span>
<span id="cb293-11"><a href="#cb293-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">ahr_flag           =</span> i<span class="sc">$</span>List_eff_datasources[<span class="dv">5</span>],</span>
<span id="cb293-12"><a href="#cb293-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose            =</span> qc_mode</span>
<span id="cb293-13"><a href="#cb293-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-55-contents" aria-controls="callout-55" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-55" class="callout-55-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>This function adds “assumption-based” hazard ratios (HRs). It looks at <code>$Effectiveness.data.source</code>…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb294"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb294-1"><a href="#cb294-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(i<span class="sc">$</span>R_table_eff_data_settings<span class="sc">$</span>Effectiveness.data.source)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
                      0             Apply HR to         Assume equal to 
                    247                      49                      44 
                 FP_NMA                  PH_NMA Trial survival analysis 
                     22                      39                      19 </code></pre>
</div>
</div>
<p>And checks if it matches one of the “flags” in <code>i$List_eff_datasources</code>. Each of the five flags are explained below…</p>
<p><strong>Trial flag</strong> - <code>Trial survival analysis</code></p>
<p>This is a reference curve. It is based directly on patient-level data. The origin is the same as the destination. Just seems to ensure origin and destination match, and populate with some info from excel (e.g.&nbsp;dist, source, setting fp to empty list). The <code>fp</code> list is empty as it is based on trial data with a fixed curve fit, and there’s no need for the fractional polynomial element.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb296"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb296-1"><a href="#cb296-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Before f_NMA_AddAssumptionsToNetwork()</span></span>
<span id="cb296-2"><a href="#cb296-2" aria-hidden="true" tabindex="-1"></a>example_trial</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$dest
$dest$pop
[1] "pop_1"

$dest$line
[1] "line_1"

$dest$mol
[1] "mol_7"

$dest$trial
[1] "trial_2"

$dest$endpoint
[1] "endpoint_0"


$orig
$orig$pop
NULL

$orig$line
NULL

$orig$mol
NULL

$orig$trial
NULL

$orig$endpoint
NULL

$orig$dist
NULL

$orig$source
NULL


$hr
[1] 1

$fp
list()</code></pre>
</div>
<div class="sourceCode cell-code" id="cb298"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb298-1"><a href="#cb298-1" aria-hidden="true" tabindex="-1"></a><span class="co"># After f_NMA_AddAssumptionsToNetwork()</span></span>
<span id="cb298-2"><a href="#cb298-2" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>releff<span class="sc">$</span>network<span class="sc">$</span>pop_1<span class="sc">$</span>line_1<span class="sc">$</span>mol_7<span class="sc">$</span>trial_2<span class="sc">$</span>endpoint_0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$dest
$dest$pop
[1] "pop_1"

$dest$line
[1] "line_1"

$dest$mol
[1] "mol_7"

$dest$trial
[1] "trial_2"

$dest$endpoint
[1] "endpoint_0"


$orig
$orig$pop
[1] "pop_1"

$orig$line
[1] "line_1"

$orig$mol
[1] "mol_7"

$orig$trial
[1] "trial_2"

$orig$endpoint
[1] "endpoint_0"

$orig$dist
[1] "Exponential"

$orig$source
[1] "Trial survival analysis"


$hr
[1] 1

$fp
list()

$include
[1] TRUE</code></pre>
</div>
</div>
<p><strong>FPNMA flag</strong> - <code>FP_NMA</code></p>
<p>As I’ve understood it, this populates the hazard ratio for a given comparison using the FP HR from the same comparison in a different trial - so, even though the HR data has come from a different context (different trial), we are saying it is still applicable to this treatment comparison.</p>
<p><strong>PHNMA flag</strong> - <code>PH_NMA</code></p>
<p>Same as FPNMA, but using the PH HR.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb300"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb300-1"><a href="#cb300-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Before f_NMA_AddAssumptionsToNetwork()</span></span>
<span id="cb300-2"><a href="#cb300-2" aria-hidden="true" tabindex="-1"></a>example_ph1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.112411</code></pre>
</div>
<div class="sourceCode cell-code" id="cb302"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb302-1"><a href="#cb302-1" aria-hidden="true" tabindex="-1"></a>example_ph2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb304"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb304-1"><a href="#cb304-1" aria-hidden="true" tabindex="-1"></a><span class="co"># After f_NMA_AddAssumptionsToNetwork()</span></span>
<span id="cb304-2"><a href="#cb304-2" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>releff<span class="sc">$</span>network<span class="sc">$</span>pop_2<span class="sc">$</span>line_1<span class="sc">$</span>mol_1<span class="sc">$</span>trial_0<span class="sc">$</span>endpoint_0<span class="sc">$</span>hr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.112411</code></pre>
</div>
<div class="sourceCode cell-code" id="cb306"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb306-1"><a href="#cb306-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>releff<span class="sc">$</span>network<span class="sc">$</span>pop_2<span class="sc">$</span>line_1<span class="sc">$</span>mol_1<span class="sc">$</span>trial_2<span class="sc">$</span>endpoint_0<span class="sc">$</span>hr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.112411</code></pre>
</div>
</div>
<p><strong>ET flag</strong> - <code>Assume equal to</code></p>
<p>This assumes the treatments are equal, so sets the HR to 1.</p>
<p><strong>AHR flag</strong> - <code>Apply HR to</code></p>
<p>Puts in the HR from the Excel sheet column <code>HR.to.apply</code>.</p>
<p>I’m not certain if these are definitely the two matching parts (as quite a few get set to 1.19), but as an example…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb308"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb308-1"><a href="#cb308-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.list</span>(<span class="fu">data.table</span>(i<span class="sc">$</span>R_table_eff_data_settings)[<span class="dv">309</span>,])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$Population
[1] 0

$Population.name
[1] "All"

$Treatment.line
[1] 3

$Molecule
[1] 0

$Treatment.name
[1] "nivolumab_monotherapy"

$Include.in.this.analysis.
[1] "Yes"

$End.point
[1] 2

$End.point.name
[1] "Time to treatment discontinuation"

$Effectiveness.data.source
[1] "Apply HR to"

$Trial.name.if.effectiveness.source.is.trial
[1] "0"

$Origin.population
[1] 0

$Origin.line
[1] 3

$Origin.treatment
[1] 0

$Origin.trial
[1] 2

$Origin.endpoint
[1] 1

$Curve.fit..for.survival.analysis.
[1] NA

$HR.to.apply
[1] 1.19

$HR.95..CI..LCL.
[1] 1.15

$HR.95..CI..UCL.
[1] 1.24

$Trial
[1] NA</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb310"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb310-1"><a href="#cb310-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Before f_NMA_AddAssumptionsToNetwork()</span></span>
<span id="cb310-2"><a href="#cb310-2" aria-hidden="true" tabindex="-1"></a>example_ahr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb312"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb312-1"><a href="#cb312-1" aria-hidden="true" tabindex="-1"></a><span class="co"># After f_NMA_AddAssumptionsToNetwork()</span></span>
<span id="cb312-2"><a href="#cb312-2" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>releff<span class="sc">$</span>network<span class="sc">$</span>pop_0<span class="sc">$</span>line_3<span class="sc">$</span>mol_0<span class="sc">$</span>trial_2<span class="sc">$</span>endpoint_2<span class="sc">$</span>hr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.19</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb314"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb314-1"><a href="#cb314-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>releff<span class="sc">$</span>network<span class="sc">$</span>pop_0<span class="sc">$</span>line_3<span class="sc">$</span>mol_0<span class="sc">$</span>trial_2<span class="sc">$</span>endpoint_2<span class="sc">$</span>hr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.19</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="survival-times" class="level2">
<h2 class="anchored" data-anchor-id="survival-times">Survival times</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb316"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb316-1"><a href="#cb316-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>extraps <span class="ot">&lt;-</span> <span class="fu">f_surv_getExtrapolations</span>(<span class="at">regs =</span> i<span class="sc">$</span>surv<span class="sc">$</span>reg)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-56-contents" aria-controls="callout-56" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-56" class="callout-56-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Creates <code>i$surv$extraps</code>, which is a copy of <code>st</code> (survival at time t, or st for short) from each PLMTE in <code>i$surv$reg</code>.</p>
<p>Two examples below…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb317"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb317-1"><a href="#cb317-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(i<span class="sc">$</span>surv<span class="sc">$</span>reg<span class="sc">$</span>pop_0<span class="sc">$</span>line_1<span class="sc">$</span>mol_1<span class="sc">$</span>trial_0<span class="sc">$</span>endpoint_3<span class="sc">$</span>st)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      gengamma       exp   weibull     lnorm     gamma  gompertz    llogis
[1,] 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000
[2,] 0.9997227 0.9908053 0.9936401 0.9998529 0.9953793 0.9904323 0.9979870
[3,] 0.9982459 0.9816951 0.9866120 0.9987644 0.9896105 0.9809624 0.9944577
[4,] 0.9953640 0.9726687 0.9793409 0.9963156 0.9833525 0.9715890 0.9900015
[5,] 0.9912066 0.9637253 0.9719280 0.9925210 0.9767799 0.9623112 0.9848347
[6,] 0.9859617 0.9548641 0.9644236 0.9875304 0.9699825 0.9531280 0.9790876</code></pre>
</div>
<div class="sourceCode cell-code" id="cb319"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb319-1"><a href="#cb319-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(i<span class="sc">$</span>surv<span class="sc">$</span>extraps<span class="sc">$</span>pop_0<span class="sc">$</span>line_1<span class="sc">$</span>mol_1<span class="sc">$</span>trial_0<span class="sc">$</span>endpoint_3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      gengamma       exp   weibull     lnorm     gamma  gompertz    llogis
[1,] 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000
[2,] 0.9997227 0.9908053 0.9936401 0.9998529 0.9953793 0.9904323 0.9979870
[3,] 0.9982459 0.9816951 0.9866120 0.9987644 0.9896105 0.9809624 0.9944577
[4,] 0.9953640 0.9726687 0.9793409 0.9963156 0.9833525 0.9715890 0.9900015
[5,] 0.9912066 0.9637253 0.9719280 0.9925210 0.9767799 0.9623112 0.9848347
[6,] 0.9859617 0.9548641 0.9644236 0.9875304 0.9699825 0.9531280 0.9790876</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb321"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb321-1"><a href="#cb321-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>reg<span class="sc">$</span>pop_0<span class="sc">$</span>line_1<span class="sc">$</span>mol_0<span class="sc">$</span>trial_0<span class="sc">$</span>endpoint_0<span class="sc">$</span>st</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NULL</code></pre>
</div>
<div class="sourceCode cell-code" id="cb323"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb323-1"><a href="#cb323-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>surv<span class="sc">$</span>extraps<span class="sc">$</span>pop_0<span class="sc">$</span>line_1<span class="sc">$</span>mol_0<span class="sc">$</span>trial_0<span class="sc">$</span>endpoint_0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NULL</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb325"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb325-1"><a href="#cb325-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>surv<span class="sc">$</span>st <span class="ot">&lt;-</span> <span class="fu">f_releff_PropNetwork</span>(</span>
<span id="cb325-2"><a href="#cb325-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">network =</span> p<span class="sc">$</span>releff<span class="sc">$</span>network,</span>
<span id="cb325-3"><a href="#cb325-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">extraps =</span> i<span class="sc">$</span>surv<span class="sc">$</span>extraps,</span>
<span id="cb325-4"><a href="#cb325-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">dos     =</span> <span class="dv">10</span>,</span>
<span id="cb325-5"><a href="#cb325-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> qc_mode,</span>
<span id="cb325-6"><a href="#cb325-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">dist_lookups =</span> p<span class="sc">$</span>basic<span class="sc">$</span>lookup<span class="sc">$</span>dist,</span>
<span id="cb325-7"><a href="#cb325-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">excel_table =</span> <span class="fu">data.table</span>(i<span class="sc">$</span>R_table_eff_data_settings)</span>
<span id="cb325-8"><a href="#cb325-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-57-contents" aria-controls="callout-57" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-57" class="callout-57-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>For extrapolations not informed by NMA or assumptions, this function applies the chosen HR to the survival data, in order to extend the survival data (i.e.&nbsp;extrapolate it).</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb326"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb326-1"><a href="#cb326-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(i<span class="sc">$</span>dd_adjforprioradjuvant <span class="sc">==</span> <span class="st">"Yes"</span>) {</span>
<span id="cb326-2"><a href="#cb326-2" aria-hidden="true" tabindex="-1"></a>  p<span class="sc">$</span>surv<span class="sc">$</span>st <span class="ot">&lt;-</span> <span class="fu">f_surv_adjuvant_HR</span>(</span>
<span id="cb326-3"><a href="#cb326-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">st              =</span> p<span class="sc">$</span>surv<span class="sc">$</span>st,</span>
<span id="cb326-4"><a href="#cb326-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">adjuvant_impact =</span> i<span class="sc">$</span>R_table_prior_IO_impact_eff,</span>
<span id="cb326-5"><a href="#cb326-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">demo_table      =</span> p<span class="sc">$</span>demo<span class="sc">$</span>table,</span>
<span id="cb326-6"><a href="#cb326-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">lookup          =</span> p<span class="sc">$</span>basic<span class="sc">$</span>lookup,</span>
<span id="cb326-7"><a href="#cb326-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose         =</span> <span class="cn">TRUE</span>)</span>
<span id="cb326-8"><a href="#cb326-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-58-contents" aria-controls="callout-58" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-58" class="callout-58-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Not run in default case…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb327"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb327-1"><a href="#cb327-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>dd_adjforprioradjuvant</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "No"</code></pre>
</div>
</div>
<p>But it applies hazard ratios to the survival data to account for the impact of prior adjuvant treatments. An adjuvant treatment is an additional treatment given alongside the primary treatment.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb329"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb329-1"><a href="#cb329-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>R_table_prior_IO_impact_eff</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb330"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb330-1"><a href="#cb330-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>R_table_ptchar <span class="ot">&lt;-</span> <span class="fu">data.table</span>(i<span class="sc">$</span>R_table_ptchar)</span>
<span id="cb330-2"><a href="#cb330-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb330-3"><a href="#cb330-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">sum</span>(i<span class="sc">$</span>R_table_TE_waning_settings<span class="sc">$</span>apply.waning <span class="sc">==</span> <span class="st">"Yes"</span>) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb330-4"><a href="#cb330-4" aria-hidden="true" tabindex="-1"></a>  p<span class="sc">$</span>surv<span class="sc">$</span>st <span class="ot">&lt;-</span> <span class="fu">f_surv_twaning_apply</span>(</span>
<span id="cb330-5"><a href="#cb330-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">st_list     =</span> p<span class="sc">$</span>surv<span class="sc">$</span>st,</span>
<span id="cb330-6"><a href="#cb330-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">tab_waning  =</span> <span class="fu">data.table</span>(i<span class="sc">$</span>R_table_TE_waning_settings),</span>
<span id="cb330-7"><a href="#cb330-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">tab_eff_set =</span> <span class="fu">data.table</span>(i<span class="sc">$</span>R_table_eff_data_settings),</span>
<span id="cb330-8"><a href="#cb330-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose     =</span> qc_mode</span>
<span id="cb330-9"><a href="#cb330-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb330-10"><a href="#cb330-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in treatment_effect_waning_with_absolute(surv_active = plmte$st, :
Hazard rate in the active treatment is more than the hazard rate in the
reference treatment in 1890 cycles, the first of which is 198 . Using the
higher of the two hazards where they cross!</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-59-contents" aria-controls="callout-59" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-59" class="callout-59-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The function applies treatment effect waning to all PLMTes according to the table provided in the excel inputs…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb332"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb332-1"><a href="#cb332-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>R_table_TE_waning_settings[i<span class="sc">$</span>R_table_TE_waning_settings<span class="sc">$</span>apply.waning <span class="sc">==</span> <span class="st">"Yes"</span>,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
</div>
<p>It uses the function <code>treatment_effect_waning_with_absolute()</code> to apply treatment effect waning, which refers to the loss of a treatment’s benefits over time. It is provided with the cycle in which the treatment effect begins and finishes to wane.</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb333"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb333-1"><a href="#cb333-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>surv<span class="sc">$</span>gpop <span class="ot">&lt;-</span> <span class="cf">if</span> (i<span class="sc">$</span>dd_age_sex_source <span class="sc">==</span> <span class="st">"Mean"</span>) <span class="fu">f_surv_GenOSLines_det</span>(</span>
<span id="cb333-2"><a href="#cb333-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">R_table_ptchar         =</span> i<span class="sc">$</span>R_table_ptchar,</span>
<span id="cb333-3"><a href="#cb333-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">R_table_mort_lifeTable =</span> i<span class="sc">$</span>R_table_mort_lifeTable,</span>
<span id="cb333-4"><a href="#cb333-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">t_yr                   =</span> p<span class="sc">$</span>basic<span class="sc">$</span>t_yr,</span>
<span id="cb333-5"><a href="#cb333-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">lookups                =</span> i<span class="sc">$</span>lookup</span>
<span id="cb333-6"><a href="#cb333-6" aria-hidden="true" tabindex="-1"></a>) <span class="cf">else</span> <span class="fu">f_surv_GenOSLines_ipd</span>(</span>
<span id="cb333-7"><a href="#cb333-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">R_table_patientagesex  =</span> i<span class="sc">$</span>R_table_patientagesex,</span>
<span id="cb333-8"><a href="#cb333-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">R_table_mort_lifeTable =</span> i<span class="sc">$</span>R_table_mort_lifeTable,</span>
<span id="cb333-9"><a href="#cb333-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">t_yr                   =</span> p<span class="sc">$</span>basic<span class="sc">$</span>t_yr,</span>
<span id="cb333-10"><a href="#cb333-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">lookups                =</span> i<span class="sc">$</span>lookup</span>
<span id="cb333-11"><a href="#cb333-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-60-contents" aria-controls="callout-60" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-60" class="callout-60-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>This section calculate the survival curves for the general population, for the overall survival endpoint, for each population and line. It uses two functions:</p>
<ul>
<li><code>f_surv_GenOSLines_det()</code> - calculates curves based on characteristics provided in a table</li>
<li><code>f_surv_GenOSLines_ipd()</code> - calculates curves based on individual patient data</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb334"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb334-1"><a href="#cb334-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>surv<span class="sc">$</span>gpop<span class="sc">$</span>pop_0<span class="sc">$</span>line_1<span class="sc">$</span>d</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$pop
[1] "pop_0"

$line
[1] "line_1"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb336"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb336-1"><a href="#cb336-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(p<span class="sc">$</span>surv<span class="sc">$</span>gpop<span class="sc">$</span>pop_0<span class="sc">$</span>line_1<span class="sc">$</span>os, <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 1.0000000 0.9996541 0.9993084 0.9989626 0.9986170 0.9982715 0.9979260
 [8] 0.9975807 0.9972355 0.9968905</code></pre>
</div>
</div>
<p>In this case:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb338"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb338-1"><a href="#cb338-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>dd_age_sex_source </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "PLD"</code></pre>
</div>
</div>
<p>Hence using:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb340"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb340-1"><a href="#cb340-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(i<span class="sc">$</span>R_table_patientagesex, <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
</div>
<p>However, if it were to use means, it would use data from:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb341"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb341-1"><a href="#cb341-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>R_table_ptchar</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb342"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb342-1"><a href="#cb342-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (qc_mode) {</span>
<span id="cb342-2"><a href="#cb342-2" aria-hidden="true" tabindex="-1"></a>  i<span class="sc">$</span>gpop <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb342-3"><a href="#cb342-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">means =</span> <span class="fu">f_surv_GenOSLines_det</span>(</span>
<span id="cb342-4"><a href="#cb342-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">R_table_ptchar         =</span> i<span class="sc">$</span>R_table_ptchar,</span>
<span id="cb342-5"><a href="#cb342-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">R_table_mort_lifeTable =</span> i<span class="sc">$</span>R_table_mort_lifeTable,</span>
<span id="cb342-6"><a href="#cb342-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">t_yr                   =</span> p<span class="sc">$</span>basic<span class="sc">$</span>t_yr,</span>
<span id="cb342-7"><a href="#cb342-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">lookups                =</span> i<span class="sc">$</span>lookup</span>
<span id="cb342-8"><a href="#cb342-8" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb342-9"><a href="#cb342-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">ipd =</span> <span class="fu">f_surv_GenOSLines_ipd</span>(</span>
<span id="cb342-10"><a href="#cb342-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">R_table_patientagesex  =</span> i<span class="sc">$</span>R_table_patientagesex,</span>
<span id="cb342-11"><a href="#cb342-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">R_table_mort_lifeTable =</span> i<span class="sc">$</span>R_table_mort_lifeTable,</span>
<span id="cb342-12"><a href="#cb342-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">t_yr                   =</span> p<span class="sc">$</span>basic<span class="sc">$</span>t_yr,</span>
<span id="cb342-13"><a href="#cb342-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">lookups                =</span> i<span class="sc">$</span>lookup</span>
<span id="cb342-14"><a href="#cb342-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb342-15"><a href="#cb342-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb342-16"><a href="#cb342-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb342-17"><a href="#cb342-17" aria-hidden="true" tabindex="-1"></a>  i<span class="sc">$</span>gpop<span class="sc">$</span>plotdat <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb342-18"><a href="#cb342-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">t =</span> <span class="fu">rep</span>(p<span class="sc">$</span>basic<span class="sc">$</span>t_yr,<span class="dv">2</span>),</span>
<span id="cb342-19"><a href="#cb342-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">os =</span> <span class="fu">c</span>(i<span class="sc">$</span>gpop<span class="sc">$</span>means<span class="sc">$</span>pop_0<span class="sc">$</span>line_1<span class="sc">$</span>os,i<span class="sc">$</span>gpop<span class="sc">$</span>ipd<span class="sc">$</span>pop_0<span class="sc">$</span>line_1<span class="sc">$</span>os),</span>
<span id="cb342-20"><a href="#cb342-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"Means"</span>,p<span class="sc">$</span>basic<span class="sc">$</span>th<span class="sc">+</span><span class="dv">1</span>),<span class="fu">rep</span>(<span class="st">"Patient data"</span>,p<span class="sc">$</span>basic<span class="sc">$</span>th<span class="sc">+</span><span class="dv">1</span>))</span>
<span id="cb342-21"><a href="#cb342-21" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb342-22"><a href="#cb342-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb342-23"><a href="#cb342-23" aria-hidden="true" tabindex="-1"></a>  i<span class="sc">$</span>gpop<span class="sc">$</span>comp_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(i<span class="sc">$</span>gpop<span class="sc">$</span>plotdat, <span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> os, <span class="at">colour =</span> method)) <span class="sc">+</span> </span>
<span id="cb342-24"><a href="#cb342-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb342-25"><a href="#cb342-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb342-26"><a href="#cb342-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, <span class="at">legend.title=</span><span class="fu">element_blank</span>()) <span class="sc">+</span> </span>
<span id="cb342-27"><a href="#cb342-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="cn">NULL</span>, <span class="at">x =</span> <span class="st">"Time (years)"</span>, <span class="at">y =</span> <span class="st">"% Survival"</span>) <span class="sc">+</span> </span>
<span id="cb342-28"><a href="#cb342-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.05</span>))) <span class="sc">+</span> </span>
<span id="cb342-29"><a href="#cb342-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent)</span>
<span id="cb342-30"><a href="#cb342-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb342-31"><a href="#cb342-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(qc_mode) {</span>
<span id="cb342-32"><a href="#cb342-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggsave</span>(</span>
<span id="cb342-33"><a href="#cb342-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">filename =</span> <span class="fu">file.path</span>(<span class="st">"./4_Output/"</span>,<span class="st">"gpop_1L_method_comparison.png"</span>),</span>
<span id="cb342-34"><a href="#cb342-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot =</span> i<span class="sc">$</span>gpop<span class="sc">$</span>comp_plot,</span>
<span id="cb342-35"><a href="#cb342-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">device =</span> <span class="st">"png"</span>,</span>
<span id="cb342-36"><a href="#cb342-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">units =</span> <span class="st">"cm"</span>,</span>
<span id="cb342-37"><a href="#cb342-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">width =</span> <span class="dv">15</span></span>
<span id="cb342-38"><a href="#cb342-38" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb342-39"><a href="#cb342-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb342-40"><a href="#cb342-40" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-61-contents" aria-controls="callout-61" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-61" class="callout-61-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>This is not currently run…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb343"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb343-1"><a href="#cb343-1" aria-hidden="true" tabindex="-1"></a>qc_mode</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE</code></pre>
</div>
</div>
<p>But if it were, it would compare the general population curves calculation from provided parameters (means) versus from individual patient data.</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb345"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb345-1"><a href="#cb345-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>surv<span class="sc">$</span>st <span class="ot">&lt;-</span> <span class="fu">f_surv_gpopadjust</span>(<span class="at">st      =</span> p<span class="sc">$</span>surv<span class="sc">$</span>st,</span>
<span id="cb345-2"><a href="#cb345-2" aria-hidden="true" tabindex="-1"></a>                               <span class="at">gpop    =</span> p<span class="sc">$</span>surv<span class="sc">$</span>gpop,</span>
<span id="cb345-3"><a href="#cb345-3" aria-hidden="true" tabindex="-1"></a>                               <span class="at">method  =</span> <span class="st">"hazardmax"</span>,</span>
<span id="cb345-4"><a href="#cb345-4" aria-hidden="true" tabindex="-1"></a>                               <span class="at">verbose =</span> qc_mode)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-62-contents" aria-controls="callout-62" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-62" class="callout-62-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>This function adjusts the survival curves based on the general population survival curves. This is necessary as we are comparing outcomes from more than two comparison groups, and so we want to control for any imbalance in confounders between the different groups.</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb346"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb346-1"><a href="#cb346-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>surv<span class="sc">$</span>st <span class="ot">&lt;-</span> <span class="fu">f_surv_PFSxOS</span>(p<span class="sc">$</span>surv<span class="sc">$</span>st, <span class="cf">if</span>(i<span class="sc">$</span>dd_adj_cross_curves <span class="sc">==</span> <span class="st">"Use hazards"</span>){<span class="st">"hazardmax"</span>} <span class="cf">else</span>{<span class="st">"abs"</span>})</span>
<span id="cb346-2"><a href="#cb346-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb346-3"><a href="#cb346-3" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>surv<span class="sc">$</span>st <span class="ot">&lt;-</span> <span class="fu">f_surv_TTDxOS</span>(p<span class="sc">$</span>surv<span class="sc">$</span>st, <span class="cf">if</span>(i<span class="sc">$</span>dd_adj_cross_curves <span class="sc">==</span> <span class="st">"Use hazards"</span>){<span class="st">"hazardmax"</span>} <span class="cf">else</span>{<span class="st">"abs"</span>})</span>
<span id="cb346-4"><a href="#cb346-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb346-5"><a href="#cb346-5" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>surv<span class="sc">$</span>st <span class="ot">&lt;-</span> <span class="fu">f_surv_PFSxTTP</span>(<span class="at">st =</span> p<span class="sc">$</span>surv<span class="sc">$</span>st,<span class="at">method =</span>  <span class="st">"abs"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-63-contents" aria-controls="callout-63" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-63" class="callout-63-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>These functions check that the following curves don’t cross:</p>
<ul>
<li>Progression-free survival (PFS) and overall survival (OS) (<code>f_surv_PFSxOS</code>)</li>
<li>Time to discontinuation (TTD) and overall survival (OS) (<code>f_surv_TTDxOS</code>)</li>
<li>Progression-free survival (PFS) and time to progression (TTP) (<code>f_surv_PFSxTTP</code>)</li>
</ul>
<p>To prevent overlap, the first two use <code>f_surv_hazardmax()</code>, which ensures the hazard rate is at least as high as the corresponding hazard in the reference curve. This ensures that:</p>
<ul>
<li>PFS &lt; OS</li>
<li>TTD &lt; OS</li>
</ul>
<p>The final one uses <code>f_surv_hazardmin()</code> which ensure that the hazard rate is no greater than the corresponding hazard in the reference curve, to ensure a minimum level of survival probability compared to the reference curve. THis ensures that:</p>
<ul>
<li>PFS &lt; TTP</li>
</ul>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb347"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb347-1"><a href="#cb347-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>surv<span class="sc">$</span>st <span class="ot">&lt;-</span> <span class="fu">lapply</span>(p<span class="sc">$</span>surv<span class="sc">$</span>st, <span class="cf">function</span>(popu) {</span>
<span id="cb347-2"><a href="#cb347-2" aria-hidden="true" tabindex="-1"></a>  popu<span class="sc">$</span>line_5 <span class="ot">&lt;-</span> popu<span class="sc">$</span>line_4</span>
<span id="cb347-3"><a href="#cb347-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(popu)</span>
<span id="cb347-4"><a href="#cb347-4" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-64-contents" aria-controls="callout-64" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-64" class="callout-64-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Sets survival times for 5L (best supportive care) to 4L, when its come after four active treatments</p>
</div>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-65-contents" aria-controls="callout-65" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-65" class="callout-65-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Uncommented these. It allows us to look at an example - here, population 0 line 1 molecule 1 trial 2. It shows us the extrapolated survival curves and transition probabilities.</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb348"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb348-1"><a href="#cb348-1" aria-hidden="true" tabindex="-1"></a><span class="fu">f_qc_surv_ExtrapPlot</span>(</span>
<span id="cb348-2"><a href="#cb348-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">st   =</span> p<span class="sc">$</span>surv<span class="sc">$</span>st,</span>
<span id="cb348-3"><a href="#cb348-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">popu =</span> <span class="st">"pop_0"</span>,</span>
<span id="cb348-4"><a href="#cb348-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">li   =</span> <span class="st">"line_1"</span>,</span>
<span id="cb348-5"><a href="#cb348-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">mo   =</span> <span class="st">"mol_1"</span>,</span>
<span id="cb348-6"><a href="#cb348-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">tr   =</span> <span class="st">"trial_2"</span>,</span>
<span id="cb348-7"><a href="#cb348-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">t_yr =</span> p<span class="sc">$</span>basic<span class="sc">$</span>t_yr,</span>
<span id="cb348-8"><a href="#cb348-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">th =</span> p<span class="sc">$</span>basic<span class="sc">$</span>th</span>
<span id="cb348-9"><a href="#cb348-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="code_walkthrough_files/figure-html/unnamed-chunk-151-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb349"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb349-1"><a href="#cb349-1" aria-hidden="true" tabindex="-1"></a><span class="fu">f_qc_surv_EstHazPlot</span>(</span>
<span id="cb349-2"><a href="#cb349-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">st   =</span> p<span class="sc">$</span>surv<span class="sc">$</span>st,</span>
<span id="cb349-3"><a href="#cb349-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">gpop =</span> p<span class="sc">$</span>surv<span class="sc">$</span>gpop,</span>
<span id="cb349-4"><a href="#cb349-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">popu =</span> <span class="st">"pop_0"</span>,</span>
<span id="cb349-5"><a href="#cb349-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">li   =</span> <span class="st">"line_1"</span>,</span>
<span id="cb349-6"><a href="#cb349-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">mo   =</span> <span class="st">"mol_1"</span>,</span>
<span id="cb349-7"><a href="#cb349-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">tr   =</span> <span class="st">"trial_2"</span>,</span>
<span id="cb349-8"><a href="#cb349-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">t_yr =</span> p<span class="sc">$</span>basic<span class="sc">$</span>t_yr,</span>
<span id="cb349-9"><a href="#cb349-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">th   =</span> p<span class="sc">$</span>basic<span class="sc">$</span>th</span>
<span id="cb349-10"><a href="#cb349-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="code_walkthrough_files/figure-html/unnamed-chunk-151-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb350"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb350-1"><a href="#cb350-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (qc_mode) {</span>
<span id="cb350-2"><a href="#cb350-2" aria-hidden="true" tabindex="-1"></a>  i<span class="sc">$</span>excel_destinations <span class="ot">&lt;-</span> <span class="fu">data.table</span>(i<span class="sc">$</span>R_table_eff_data_settings)[Include.in.this.analysis.<span class="sc">==</span><span class="st">"Yes"</span>,<span class="fu">list</span>(Population,Treatment.line,Molecule,Origin.trial,End.point)]</span>
<span id="cb350-3"><a href="#cb350-3" aria-hidden="true" tabindex="-1"></a>  i<span class="sc">$</span>surv<span class="sc">$</span>ExtrapSenseCheck <span class="ot">&lt;-</span> <span class="fu">Reduce</span>(</span>
<span id="cb350-4"><a href="#cb350-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(i<span class="sc">$</span>excel_destinations),</span>
<span id="cb350-5"><a href="#cb350-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">init =</span> <span class="fu">f_NMA_generateNetwork</span>(i<span class="sc">$</span>id<span class="sc">$</span>ipd,i<span class="sc">$</span>lookup<span class="sc">$</span>ipd),</span>
<span id="cb350-6"><a href="#cb350-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">accumulate =</span> <span class="cn">FALSE</span>,</span>
<span id="cb350-7"><a href="#cb350-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">f =</span> <span class="cf">function</span>(prev, dest_row) {</span>
<span id="cb350-8"><a href="#cb350-8" aria-hidden="true" tabindex="-1"></a>      dat <span class="ot">&lt;-</span> <span class="fu">as.list</span>(i<span class="sc">$</span>excel_destinations[dest_row,])</span>
<span id="cb350-9"><a href="#cb350-9" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb350-10"><a href="#cb350-10" aria-hidden="true" tabindex="-1"></a>      d <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb350-11"><a href="#cb350-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">pop =</span> <span class="fu">paste0</span>(<span class="st">"pop_"</span>,dat<span class="sc">$</span>Population),</span>
<span id="cb350-12"><a href="#cb350-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">line =</span> <span class="fu">paste0</span>(<span class="st">"line_"</span>,dat<span class="sc">$</span>Treatment.line),</span>
<span id="cb350-13"><a href="#cb350-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">mol =</span> <span class="fu">paste0</span>(<span class="st">"mol_"</span>,dat<span class="sc">$</span>Molecule),</span>
<span id="cb350-14"><a href="#cb350-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">trial =</span> <span class="fu">paste0</span>(<span class="st">"trial_"</span>,dat<span class="sc">$</span>Origin.trial),</span>
<span id="cb350-15"><a href="#cb350-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">endpoint =</span> <span class="fu">paste0</span>(<span class="st">"endpoint_"</span>,dat<span class="sc">$</span>End.point)</span>
<span id="cb350-16"><a href="#cb350-16" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb350-17"><a href="#cb350-17" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb350-18"><a href="#cb350-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">paste0</span>(</span>
<span id="cb350-19"><a href="#cb350-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Drawing plots: "</span>,</span>
<span id="cb350-20"><a href="#cb350-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">" row "</span>, dest_row, <span class="st">" i$surv$ExtrapSenseCheck$"</span>,</span>
<span id="cb350-21"><a href="#cb350-21" aria-hidden="true" tabindex="-1"></a>        d<span class="sc">$</span>pop, <span class="st">"$"</span>,</span>
<span id="cb350-22"><a href="#cb350-22" aria-hidden="true" tabindex="-1"></a>        d<span class="sc">$</span>line, <span class="st">"$"</span>,</span>
<span id="cb350-23"><a href="#cb350-23" aria-hidden="true" tabindex="-1"></a>        d<span class="sc">$</span>mol, <span class="st">"$"</span>,</span>
<span id="cb350-24"><a href="#cb350-24" aria-hidden="true" tabindex="-1"></a>        d<span class="sc">$</span>trial, <span class="st">"$plots"</span>,</span>
<span id="cb350-25"><a href="#cb350-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"</span><span class="sc">\n</span><span class="st">"</span></span>
<span id="cb350-26"><a href="#cb350-26" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb350-27"><a href="#cb350-27" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb350-28"><a href="#cb350-28" aria-hidden="true" tabindex="-1"></a>      p_extrap <span class="ot">&lt;-</span> <span class="fu">f_qc_surv_ExtrapPlot</span>(</span>
<span id="cb350-29"><a href="#cb350-29" aria-hidden="true" tabindex="-1"></a>        <span class="at">st   =</span> p<span class="sc">$</span>surv<span class="sc">$</span>st,</span>
<span id="cb350-30"><a href="#cb350-30" aria-hidden="true" tabindex="-1"></a>        <span class="at">popu =</span> d<span class="sc">$</span>pop,</span>
<span id="cb350-31"><a href="#cb350-31" aria-hidden="true" tabindex="-1"></a>        <span class="at">li   =</span> d<span class="sc">$</span>line,</span>
<span id="cb350-32"><a href="#cb350-32" aria-hidden="true" tabindex="-1"></a>        <span class="at">mo   =</span> d<span class="sc">$</span>mol,</span>
<span id="cb350-33"><a href="#cb350-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">tr   =</span> d<span class="sc">$</span>trial,</span>
<span id="cb350-34"><a href="#cb350-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">t_yr =</span> p<span class="sc">$</span>basic<span class="sc">$</span>t_yr,</span>
<span id="cb350-35"><a href="#cb350-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">th =</span> p<span class="sc">$</span>basic<span class="sc">$</span>th</span>
<span id="cb350-36"><a href="#cb350-36" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb350-37"><a href="#cb350-37" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb350-38"><a href="#cb350-38" aria-hidden="true" tabindex="-1"></a>      p_haz <span class="ot">&lt;-</span> <span class="fu">f_qc_surv_EstHazPlot</span>(</span>
<span id="cb350-39"><a href="#cb350-39" aria-hidden="true" tabindex="-1"></a>        <span class="at">st   =</span> p<span class="sc">$</span>surv<span class="sc">$</span>st,</span>
<span id="cb350-40"><a href="#cb350-40" aria-hidden="true" tabindex="-1"></a>        <span class="at">gpop =</span> p<span class="sc">$</span>surv<span class="sc">$</span>gpop,</span>
<span id="cb350-41"><a href="#cb350-41" aria-hidden="true" tabindex="-1"></a>        <span class="at">popu =</span> d<span class="sc">$</span>pop,</span>
<span id="cb350-42"><a href="#cb350-42" aria-hidden="true" tabindex="-1"></a>        <span class="at">li   =</span> d<span class="sc">$</span>line,</span>
<span id="cb350-43"><a href="#cb350-43" aria-hidden="true" tabindex="-1"></a>        <span class="at">mo   =</span> d<span class="sc">$</span>mol,</span>
<span id="cb350-44"><a href="#cb350-44" aria-hidden="true" tabindex="-1"></a>        <span class="at">tr   =</span> d<span class="sc">$</span>trial,</span>
<span id="cb350-45"><a href="#cb350-45" aria-hidden="true" tabindex="-1"></a>        <span class="at">t_yr =</span> p<span class="sc">$</span>basic<span class="sc">$</span>t_yr,</span>
<span id="cb350-46"><a href="#cb350-46" aria-hidden="true" tabindex="-1"></a>        <span class="at">th   =</span> p<span class="sc">$</span>basic<span class="sc">$</span>th</span>
<span id="cb350-47"><a href="#cb350-47" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb350-48"><a href="#cb350-48" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb350-49"><a href="#cb350-49" aria-hidden="true" tabindex="-1"></a>      plmt <span class="ot">&lt;-</span> prev[[d<span class="sc">$</span>pop]][[d<span class="sc">$</span>line]][[d<span class="sc">$</span>mol]][[d<span class="sc">$</span>trial]]</span>
<span id="cb350-50"><a href="#cb350-50" aria-hidden="true" tabindex="-1"></a>      plmt<span class="sc">$</span>plots <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb350-51"><a href="#cb350-51" aria-hidden="true" tabindex="-1"></a>        <span class="at">p_extrap =</span> p_extrap,</span>
<span id="cb350-52"><a href="#cb350-52" aria-hidden="true" tabindex="-1"></a>        <span class="at">p_haz =</span> p_haz</span>
<span id="cb350-53"><a href="#cb350-53" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb350-54"><a href="#cb350-54" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb350-55"><a href="#cb350-55" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Save 2 plots for each PLM available. Takes a while to run.</span></span>
<span id="cb350-56"><a href="#cb350-56" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (qc_mode) {</span>
<span id="cb350-57"><a href="#cb350-57" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ggsave</span>(</span>
<span id="cb350-58"><a href="#cb350-58" aria-hidden="true" tabindex="-1"></a>          <span class="at">filename =</span> <span class="fu">file.path</span>(<span class="st">"./4_Output"</span>,<span class="fu">paste0</span>(<span class="st">"p_extrap_"</span>,<span class="fu">paste</span>(d[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>],<span class="at">collapse=</span><span class="st">"_"</span>),<span class="st">".png"</span>)),</span>
<span id="cb350-59"><a href="#cb350-59" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot     =</span> plmt<span class="sc">$</span>plots<span class="sc">$</span>p_extrap,</span>
<span id="cb350-60"><a href="#cb350-60" aria-hidden="true" tabindex="-1"></a>          <span class="at">device =</span> <span class="st">"png"</span>,</span>
<span id="cb350-61"><a href="#cb350-61" aria-hidden="true" tabindex="-1"></a>          <span class="at">units =</span> <span class="st">"cm"</span>,</span>
<span id="cb350-62"><a href="#cb350-62" aria-hidden="true" tabindex="-1"></a>          <span class="at">width =</span> <span class="dv">15</span></span>
<span id="cb350-63"><a href="#cb350-63" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb350-64"><a href="#cb350-64" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ggsave</span>(</span>
<span id="cb350-65"><a href="#cb350-65" aria-hidden="true" tabindex="-1"></a>          <span class="at">filename =</span> <span class="fu">file.path</span>(<span class="st">"./4_Output"</span>,<span class="fu">paste0</span>(<span class="st">"p_tp_"</span>,<span class="fu">paste</span>(d[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>],<span class="at">collapse=</span><span class="st">"_"</span>),<span class="st">".png"</span>)),</span>
<span id="cb350-66"><a href="#cb350-66" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot     =</span> plmt<span class="sc">$</span>plots<span class="sc">$</span>p_haz,</span>
<span id="cb350-67"><a href="#cb350-67" aria-hidden="true" tabindex="-1"></a>          <span class="at">device =</span> <span class="st">"png"</span>,</span>
<span id="cb350-68"><a href="#cb350-68" aria-hidden="true" tabindex="-1"></a>          <span class="at">units =</span> <span class="st">"cm"</span>,</span>
<span id="cb350-69"><a href="#cb350-69" aria-hidden="true" tabindex="-1"></a>          <span class="at">width =</span> <span class="dv">15</span></span>
<span id="cb350-70"><a href="#cb350-70" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb350-71"><a href="#cb350-71" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb350-72"><a href="#cb350-72" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb350-73"><a href="#cb350-73" aria-hidden="true" tabindex="-1"></a>      prev[[d<span class="sc">$</span>pop]][[d<span class="sc">$</span>line]][[d<span class="sc">$</span>mol]][[d<span class="sc">$</span>trial]] <span class="ot">&lt;-</span> plmt</span>
<span id="cb350-74"><a href="#cb350-74" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb350-75"><a href="#cb350-75" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(prev)</span>
<span id="cb350-76"><a href="#cb350-76" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb350-77"><a href="#cb350-77" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb350-78"><a href="#cb350-78" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb350-79"><a href="#cb350-79" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-66-contents" aria-controls="callout-66" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-66" class="callout-66-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>This takes a while to run, but is not currently as qc_mode is FALSE. If we were to run it, it would plot survival extrapolations and hazard curves for each PLMTE (like done for the example above).</p>
</div>
</div>
</div>
</section>
<section id="processing-data" class="level2">
<h2 class="anchored" data-anchor-id="processing-data">Processing data</h2>
<p>This section processes data on demographics, QALYs, costs, AEs, costs, subsequent treatments, and population mappings.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb351"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb351-1"><a href="#cb351-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>surv<span class="sc">$</span>prop_deathinPFS <span class="ot">&lt;-</span> i<span class="sc">$</span>dd_prop_deathinPFS</span>
<span id="cb351-2"><a href="#cb351-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb351-3"><a href="#cb351-3" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>demo<span class="sc">$</span>agg <span class="ot">&lt;-</span> <span class="fu">f_cleaning_ptchar</span>(i<span class="sc">$</span>R_table_ptchar, i<span class="sc">$</span>lookup)</span>
<span id="cb351-4"><a href="#cb351-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb351-5"><a href="#cb351-5" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>demo<span class="sc">$</span>live <span class="ot">&lt;-</span> p<span class="sc">$</span>demo<span class="sc">$</span>agg</span>
<span id="cb351-6"><a href="#cb351-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb351-7"><a href="#cb351-7" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">add_population_utility_params</span>(p, <span class="at">psa =</span> <span class="cn">FALSE</span>, <span class="at">.i =</span> i)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-67-contents" aria-controls="callout-67" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-67" class="callout-67-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Adds a few different parameters to p.</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb352"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb352-1"><a href="#cb352-1" aria-hidden="true" tabindex="-1"></a>base_utility <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">cycle =</span> <span class="dv">0</span><span class="sc">:</span>p<span class="sc">$</span>basic<span class="sc">$</span>th, <span class="at">utility =</span> <span class="dv">1</span>)</span>
<span id="cb352-2"><a href="#cb352-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (i<span class="sc">$</span>dd_ageadjuutilities <span class="sc">==</span> <span class="st">"Yes"</span>) {</span>
<span id="cb352-3"><a href="#cb352-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (i<span class="sc">$</span>dd_age_sex_source <span class="sc">==</span> <span class="st">"Mean"</span>) {</span>
<span id="cb352-4"><a href="#cb352-4" aria-hidden="true" tabindex="-1"></a>    ptc_L1 <span class="ot">&lt;-</span> i<span class="sc">$</span>R_table_ptchar[Treatment.line <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">4</span>)]</span>
<span id="cb352-5"><a href="#cb352-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(ptc_L1) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Population"</span>, <span class="st">"age"</span>, <span class="st">"sex"</span>)</span>
<span id="cb352-6"><a href="#cb352-6" aria-hidden="true" tabindex="-1"></a>    ptc_L1<span class="sc">$</span>sex <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> ptc_L1<span class="sc">$</span>sex</span>
<span id="cb352-7"><a href="#cb352-7" aria-hidden="true" tabindex="-1"></a>    ptc_L1 <span class="ot">&lt;-</span> <span class="fu">merge</span>(ptc_L1, i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>pop, <span class="at">by.x =</span> <span class="st">"Population"</span>, <span class="at">by.y =</span> <span class="st">"Description"</span>)</span>
<span id="cb352-8"><a href="#cb352-8" aria-hidden="true" tabindex="-1"></a>    ptc_L1 <span class="ot">&lt;-</span> ptc_L1[<span class="fu">order</span>(ptc_L1<span class="sc">$</span>Number), <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"sex"</span>, <span class="st">"Number"</span>)]</span>
<span id="cb352-9"><a href="#cb352-9" aria-hidden="true" tabindex="-1"></a>    ptc_L1 <span class="ot">&lt;-</span> <span class="fu">split</span>(ptc_L1[, <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"sex"</span>)], <span class="fu">paste0</span>(<span class="st">"pop_"</span>, ptc_L1<span class="sc">$</span>Number))</span>
<span id="cb352-10"><a href="#cb352-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb352-11"><a href="#cb352-11" aria-hidden="true" tabindex="-1"></a>    p<span class="sc">$</span>util<span class="sc">$</span>gpop <span class="ot">&lt;-</span> <span class="fu">lapply</span>(ptc_L1, <span class="cf">function</span>(pop) <span class="fu">adjust_utility</span>(</span>
<span id="cb352-12"><a href="#cb352-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">age            =</span> pop<span class="sc">$</span>age,</span>
<span id="cb352-13"><a href="#cb352-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">sex            =</span> pop<span class="sc">$</span>sex,</span>
<span id="cb352-14"><a href="#cb352-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">utilities      =</span> base_utility,</span>
<span id="cb352-15"><a href="#cb352-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">.patient_level =</span> <span class="cn">FALSE</span>,</span>
<span id="cb352-16"><a href="#cb352-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">.p             =</span> p</span>
<span id="cb352-17"><a href="#cb352-17" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb352-18"><a href="#cb352-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb352-19"><a href="#cb352-19" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb352-20"><a href="#cb352-20" aria-hidden="true" tabindex="-1"></a>    ipd_L1 <span class="ot">&lt;-</span> i<span class="sc">$</span>R_table_patientagesex<span class="sc">$</span>Line <span class="sc">==</span> <span class="dv">1</span></span>
<span id="cb352-21"><a href="#cb352-21" aria-hidden="true" tabindex="-1"></a>    p<span class="sc">$</span>util<span class="sc">$</span>gpop <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb352-22"><a href="#cb352-22" aria-hidden="true" tabindex="-1"></a>    p<span class="sc">$</span>util<span class="sc">$</span>gpop<span class="sc">$</span>pop_0 <span class="ot">&lt;-</span> <span class="fu">adjust_utility</span>(</span>
<span id="cb352-23"><a href="#cb352-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">age            =</span> i<span class="sc">$</span>R_table_patientagesex<span class="sc">$</span>Age[ipd_L1],</span>
<span id="cb352-24"><a href="#cb352-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">sex            =</span> <span class="fu">if_else</span>(i<span class="sc">$</span>R_table_patientagesex<span class="sc">$</span>Gender[ipd_L1] <span class="sc">==</span> <span class="st">"M"</span>, <span class="st">"male"</span>, <span class="st">"female"</span>),</span>
<span id="cb352-25"><a href="#cb352-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">utilities      =</span> base_utility,</span>
<span id="cb352-26"><a href="#cb352-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">.patient_level =</span> <span class="cn">TRUE</span>,</span>
<span id="cb352-27"><a href="#cb352-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">.p             =</span> p</span>
<span id="cb352-28"><a href="#cb352-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb352-29"><a href="#cb352-29" aria-hidden="true" tabindex="-1"></a>    p<span class="sc">$</span>util<span class="sc">$</span>gpop<span class="sc">$</span>pop_1 <span class="ot">&lt;-</span> p<span class="sc">$</span>util<span class="sc">$</span>gpop<span class="sc">$</span>pop_0</span>
<span id="cb352-30"><a href="#cb352-30" aria-hidden="true" tabindex="-1"></a>    p<span class="sc">$</span>util<span class="sc">$</span>gpop<span class="sc">$</span>pop_2 <span class="ot">&lt;-</span> p<span class="sc">$</span>util<span class="sc">$</span>gpop<span class="sc">$</span>pop_0</span>
<span id="cb352-31"><a href="#cb352-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb352-32"><a href="#cb352-32" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb352-33"><a href="#cb352-33" aria-hidden="true" tabindex="-1"></a>  p<span class="sc">$</span>util<span class="sc">$</span>gpop <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">pop_0 =</span> <span class="dv">1</span>, <span class="at">pop_1 =</span> <span class="dv">1</span>, <span class="at">pop_2 =</span> <span class="dv">1</span>)</span>
<span id="cb352-34"><a href="#cb352-34" aria-hidden="true" tabindex="-1"></a>}                 </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-68-contents" aria-controls="callout-68" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-68" class="callout-68-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>We start with <code>base_utility</code>, which is a table with 2089 rows (which is the time horizon <code>TH</code>), where each row is a cycle. For each, the utility is set to 1. This basically means that every individual in the population starts with a full quality of life (utility value of 1).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb353"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb353-1"><a href="#cb353-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(base_utility<span class="sc">$</span>utility)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
</div>
<p>However, if <code>i$dd_ageadjuutilities=="Yes"</code>, then it is adjusted based on the age and sex of either:</p>
<ul>
<li>The population (if based on means) (<code>i$dd_age_sex_source == "Mean"</code>)</li>
<li>The individual patients (if based on individual patients)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb355"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb355-1"><a href="#cb355-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>dd_ageadjuutilities</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Yes"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb357"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb357-1"><a href="#cb357-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>dd_age_sex_source</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "PLD"</code></pre>
</div>
</div>
<p>The result is utilities for each population (pop_0, pop_1, pop_2) for each cycle - for example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb359"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb359-1"><a href="#cb359-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(p<span class="sc">$</span>util<span class="sc">$</span>gpop<span class="sc">$</span>pop_0, <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.0000000 0.9999149 0.9998297 0.9997446 0.9996594</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb361"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb361-1"><a href="#cb361-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(base_utility)</span>
<span id="cb361-2"><a href="#cb361-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb361-3"><a href="#cb361-3" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>QALYs <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb361-4"><a href="#cb361-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb361-5"><a href="#cb361-5" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>QALYs<span class="sc">$</span>utilities<span class="sc">$</span>means <span class="ot">&lt;-</span> <span class="fu">f_process_utilities</span>(<span class="at">raw_utilities =</span> i<span class="sc">$</span>R_table_util,</span>
<span id="cb361-6"><a href="#cb361-6" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">PSA =</span> <span class="cn">FALSE</span>,</span>
<span id="cb361-7"><a href="#cb361-7" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">samples =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-69-contents" aria-controls="callout-69" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-69" class="callout-69-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The raw table of utilities is as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb362"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb362-1"><a href="#cb362-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(i<span class="sc">$</span>R_table_util, <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
</div>
<p>The function <code>f_process_utilities()</code> extracts and renames some of these columns.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb363"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb363-1"><a href="#cb363-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(i<span class="sc">$</span>QALYs<span class="sc">$</span>utilities<span class="sc">$</span>means, <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
</div>
<p>However, if <code>PSA = TRUE</code>, it would generate multiple samples of utility values for use in probabilistic sensitivity analysis.</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb364"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb364-1"><a href="#cb364-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>util<span class="sc">$</span>mk <span class="ot">&lt;-</span> <span class="fu">data.table</span>(i<span class="sc">$</span>QALYs<span class="sc">$</span>utilities<span class="sc">$</span>means)</span>
<span id="cb364-2"><a href="#cb364-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-3"><a href="#cb364-3" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>ae<span class="sc">$</span>aetype <span class="ot">&lt;-</span> i<span class="sc">$</span>dd_apply_AE_options</span>
<span id="cb364-4"><a href="#cb364-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-5"><a href="#cb364-5" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>ae<span class="sc">$</span>duration <span class="ot">&lt;-</span> <span class="fu">data.table</span>(i<span class="sc">$</span>R_table_AE_rates)</span>
<span id="cb364-6"><a href="#cb364-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-7"><a href="#cb364-7" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>ae<span class="sc">$</span>mk<span class="sc">$</span>per_cycle <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="fu">f_process_adverse_events</span>(</span>
<span id="cb364-8"><a href="#cb364-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">AE_costs =</span> i<span class="sc">$</span>R_table_AE_costs,</span>
<span id="cb364-9"><a href="#cb364-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">AE_disutil =</span> i<span class="sc">$</span>R_table_AE_util,</span>
<span id="cb364-10"><a href="#cb364-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">AE_duration =</span> i<span class="sc">$</span>R_table_duration,</span>
<span id="cb364-11"><a href="#cb364-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">AE_rate =</span> i<span class="sc">$</span>R_table_AE_rates,</span>
<span id="cb364-12"><a href="#cb364-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">comparators =</span> i<span class="sc">$</span>lookup<span class="sc">$</span>trt,</span>
<span id="cb364-13"><a href="#cb364-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">weeks_per_year =</span> p<span class="sc">$</span>basic<span class="sc">$</span>cl_w <span class="sc">/</span> p<span class="sc">$</span>basic<span class="sc">$</span>cl_y,</span>
<span id="cb364-14"><a href="#cb364-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">PSA =</span> <span class="cn">FALSE</span></span>
<span id="cb364-15"><a href="#cb364-15" aria-hidden="true" tabindex="-1"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Mean cost and QALY impact due to AEs per patient per week:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb366"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb366-1"><a href="#cb366-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>ae<span class="sc">$</span>mk<span class="sc">$</span>per_cycle[trt <span class="sc">==</span> <span class="st">"BSC"</span>,]<span class="sc">$</span>trt <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>mol[<span class="fu">match</span>(<span class="dv">999</span>,Number),]<span class="sc">$</span>RCC_input_desc</span>
<span id="cb366-2"><a href="#cb366-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb366-3"><a href="#cb366-3" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>ae<span class="sc">$</span>mk<span class="sc">$</span>per_cycle<span class="sc">$</span>molecule <span class="ot">&lt;-</span> i<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>mol[<span class="fu">match</span>(p<span class="sc">$</span>ae<span class="sc">$</span>mk<span class="sc">$</span>per_cycle<span class="sc">$</span>trt,RCC_input_desc),]<span class="sc">$</span>Number</span>
<span id="cb366-4"><a href="#cb366-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb366-5"><a href="#cb366-5" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>ae<span class="sc">$</span>approach <span class="ot">&lt;-</span> i<span class="sc">$</span>dd_apply_AE_options</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-70-contents" aria-controls="callout-70" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-70" class="callout-70-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Some processing and adding of parameters to <code>p</code>.</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb367"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb367-1"><a href="#cb367-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>cost <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb367-2"><a href="#cb367-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb367-3"><a href="#cb367-3" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>costs<span class="sc">$</span>mk <span class="ot">&lt;-</span> <span class="fu">f_process_cost_data</span>(</span>
<span id="cb367-4"><a href="#cb367-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">drug_and_admin  =</span> i<span class="sc">$</span>R_table_drug_admin_costs,</span>
<span id="cb367-5"><a href="#cb367-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">per_cycle_costs =</span> i<span class="sc">$</span>R_table_MRU,</span>
<span id="cb367-6"><a href="#cb367-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">time_horizon    =</span> p<span class="sc">$</span>basic<span class="sc">$</span>th,</span>
<span id="cb367-7"><a href="#cb367-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">max_trt_lines   =</span> p<span class="sc">$</span>basic<span class="sc">$</span>R_maxlines,</span>
<span id="cb367-8"><a href="#cb367-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">RDI_source      =</span> i<span class="sc">$</span>dd_sc_RDI,</span>
<span id="cb367-9"><a href="#cb367-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose         =</span> <span class="cn">FALSE</span>,</span>
<span id="cb367-10"><a href="#cb367-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">PSA             =</span> <span class="cn">FALSE</span>, </span>
<span id="cb367-11"><a href="#cb367-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">samples         =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in FUN(X[[i]], ...): NAs introduced by coercion</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-71-contents" aria-controls="callout-71" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-71" class="callout-71-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>This function makes a nested list with:</p>
<ul>
<li>Drug costs (<code>drug</code>)</li>
<li>Costs of drug administration (<code>admin</code>)</li>
<li>Medical resource use (MRU) costs (<code>mru_on</code> and <code>mru_off</code>)</li>
</ul>
<p>These costs are per cycle for each molecule and line.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb369"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb369-1"><a href="#cb369-1" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(p<span class="sc">$</span>costs<span class="sc">$</span>mk<span class="sc">$</span>drug<span class="sc">$</span>line_1<span class="sc">$</span>mol_4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2089</code></pre>
</div>
<div class="sourceCode cell-code" id="cb371"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb371-1"><a href="#cb371-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example</span></span>
<span id="cb371-2"><a href="#cb371-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(p<span class="sc">$</span>costs<span class="sc">$</span>mk<span class="sc">$</span>drug<span class="sc">$</span>line_1<span class="sc">$</span>mol_4, <span class="dv">8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5627.810    0.000 2666.496    0.000 5627.810    0.000 2666.496    0.000</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb373"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb373-1"><a href="#cb373-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>costs<span class="sc">$</span>oneoff <span class="ot">&lt;-</span>  <span class="fu">f_process_other_cost_data</span>(</span>
<span id="cb373-2"><a href="#cb373-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">one_off_costs =</span> i<span class="sc">$</span>R_table_MRU_oneoff,</span>
<span id="cb373-3"><a href="#cb373-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">PSA =</span> <span class="cn">FALSE</span></span>
<span id="cb373-4"><a href="#cb373-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb373-5"><a href="#cb373-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb373-6"><a href="#cb373-6" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>costs<span class="sc">$</span>oneoff_mk <span class="ot">&lt;-</span> p<span class="sc">$</span>costs<span class="sc">$</span>oneoff[,.(<span class="at">cost =</span> <span class="fu">sum</span>(cost)),by<span class="ot">=</span><span class="fu">list</span>(Apply.to)]</span>
<span id="cb373-7"><a href="#cb373-7" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>costs<span class="sc">$</span>oneoff_mk <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">structure</span>(</span>
<span id="cb373-8"><a href="#cb373-8" aria-hidden="true" tabindex="-1"></a>  p<span class="sc">$</span>costs<span class="sc">$</span>oneoff_mk<span class="sc">$</span>Apply.to,</span>
<span id="cb373-9"><a href="#cb373-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">.Names =</span> p<span class="sc">$</span>costs<span class="sc">$</span>oneoff_mk<span class="sc">$</span>Apply.to</span>
<span id="cb373-10"><a href="#cb373-10" aria-hidden="true" tabindex="-1"></a>), <span class="cf">function</span>(x) {</span>
<span id="cb373-11"><a href="#cb373-11" aria-hidden="true" tabindex="-1"></a>  p<span class="sc">$</span>costs<span class="sc">$</span>oneoff_mk[Apply.to <span class="sc">==</span> x, ]<span class="sc">$</span>cost</span>
<span id="cb373-12"><a href="#cb373-12" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-72-contents" aria-controls="callout-72" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-72" class="callout-72-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Produces table with some one-off costs - end of life/terminal care, subsequent radiotherapy, and subsequent surgery.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb374"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb374-1"><a href="#cb374-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>costs<span class="sc">$</span>oneoff</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb375"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb375-1"><a href="#cb375-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="cn">FALSE</span>) {</span>
<span id="cb375-2"><a href="#cb375-2" aria-hidden="true" tabindex="-1"></a>  i<span class="sc">$</span>cost<span class="sc">$</span>drug_and_admin_cost_by_tunnel_state<span class="sc">$</span>PSA <span class="ot">&lt;-</span> <span class="fu">f_process_drug_and_admin_cost_data</span>(</span>
<span id="cb375-3"><a href="#cb375-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">raw_table =</span> i<span class="sc">$</span>R_table_drug_admin_costs,</span>
<span id="cb375-4"><a href="#cb375-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">PSA_samples =</span> <span class="cn">TRUE</span>)</span>
<span id="cb375-5"><a href="#cb375-5" aria-hidden="true" tabindex="-1"></a>}  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-73-contents" aria-controls="callout-73" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-73" class="callout-73-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>This code is never run in this file, but is for the probabilistic sensitivity analysis.</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb376"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb376-1"><a href="#cb376-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>substrt<span class="sc">$</span>partsa  <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">f_process_subs_txt_data</span>(</span>
<span id="cb376-2"><a href="#cb376-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">subs_txt =</span> i<span class="sc">$</span>R_table_sub_txt_cum_costs,</span>
<span id="cb376-3"><a href="#cb376-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">PSA             =</span> <span class="cn">FALSE</span></span>
<span id="cb376-4"><a href="#cb376-4" aria-hidden="true" tabindex="-1"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-74-contents" aria-controls="callout-74" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-74" class="callout-74-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>For each treatment and population, table has drug cost, admin cost, and the cost and QALY impact of adverse events.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb377"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb377-1"><a href="#cb377-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(p<span class="sc">$</span>substrt<span class="sc">$</span>partsa, <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb378"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb378-1"><a href="#cb378-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>basic<span class="sc">$</span>lookup<span class="sc">$</span>pop_map <span class="ot">&lt;-</span> <span class="fu">data.table</span>(i<span class="sc">$</span>r_overall_lookup_pop)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-75-contents" aria-controls="callout-75" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-75" class="callout-75-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>As in the <code>Model_Structure.py</code> comments, there are:</p>
<ul>
<li>Three risk populations (all risk, favourable risk, int/poor risk)</li>
<li>Two IO populations - whether or not patients had prior adjuvant therapy with immune-oncology treatment</li>
</ul>
<p>These leads to six possible combinations overall. We can use this table to map from those six, to those used in the analysis:</p>
<ul>
<li>Treatment sequences are sorted into 4 populations (<code>Sequencing.population.number</code>)</li>
<li>Survival extrapolations, costs, QALYs and AEs are sorted into 3 populations (<code>Risk.population.number</code>)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb379"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb379-1"><a href="#cb379-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>basic<span class="sc">$</span>lookup<span class="sc">$</span>pop_map</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
</div>
</div>
</div>
</div>
</section>
<section id="economic-modelling" class="level2">
<h2 class="anchored" data-anchor-id="economic-modelling">Economic modelling</h2>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-76-contents" aria-controls="callout-76" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-76" class="callout-76-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Changed paths</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb380"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb380-1"><a href="#cb380-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>R_table_eff_data_settings <span class="ot">&lt;-</span> <span class="fu">data.table</span>(i<span class="sc">$</span>R_table_eff_data_settings)</span>
<span id="cb380-2"><a href="#cb380-2" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>releff<span class="sc">$</span>excel_table <span class="ot">&lt;-</span> i<span class="sc">$</span>R_table_eff_data_settings</span>
<span id="cb380-3"><a href="#cb380-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb380-4"><a href="#cb380-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">str_trim</span>(i<span class="sc">$</span>dd_model_struct) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"State transition"</span>, <span class="st">"Partitioned survival"</span>)) <span class="fu">stop</span>(</span>
<span id="cb380-5"><a href="#cb380-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"The model structure is not one of the available options. These are 'State transition' and 'Partitioned survival'. Either code or the excel file are out of date or wrongly set up"</span></span>
<span id="cb380-6"><a href="#cb380-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb380-7"><a href="#cb380-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb380-8"><a href="#cb380-8" aria-hidden="true" tabindex="-1"></a>pf <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb380-9"><a href="#cb380-9" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb380-10"><a href="#cb380-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb380-11"><a href="#cb380-11" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(p<span class="sc">$</span>basic<span class="sc">$</span>structure <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"State transition"</span>,<span class="st">"Partitioned survival"</span>))</span>
<span id="cb380-12"><a href="#cb380-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb380-13"><a href="#cb380-13" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(p<span class="sc">$</span>basic<span class="sc">$</span>decision_problem <span class="sc">==</span> <span class="st">"cabo+nivo"</span>) {</span>
<span id="cb380-14"><a href="#cb380-14" aria-hidden="true" tabindex="-1"></a>  p<span class="sc">$</span>basic<span class="sc">$</span>pops_to_run <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span></span>
<span id="cb380-15"><a href="#cb380-15" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb380-16"><a href="#cb380-16" aria-hidden="true" tabindex="-1"></a>  p<span class="sc">$</span>basic<span class="sc">$</span>pops_to_run <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb380-17"><a href="#cb380-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb380-18"><a href="#cb380-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb380-19"><a href="#cb380-19" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(p,<span class="st">"../2_Scripts/standalone scripts/QC/p.rds"</span>)</span>
<span id="cb380-20"><a href="#cb380-20" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(i,<span class="st">"../2_Scripts/standalone scripts/QC/i.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-77-contents" aria-controls="callout-77" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-77" class="callout-77-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Adds the settings from excel to <code>p</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb381"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb381-1"><a href="#cb381-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(p<span class="sc">$</span>releff<span class="sc">$</span>excel_table, <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
</div>
<p>And checks model structure is correct.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb382"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb382-1"><a href="#cb382-1" aria-hidden="true" tabindex="-1"></a>i<span class="sc">$</span>dd_model_struct</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "State transition"</code></pre>
</div>
</div>
<p>Then some settings specifically if decision problem is cabo+nivo only</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb384"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb384-1"><a href="#cb384-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>basic<span class="sc">$</span>decision_problem</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "cabo+nivo"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb386"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb386-1"><a href="#cb386-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>basic<span class="sc">$</span>pops_to_run</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1 2 3</code></pre>
</div>
</div>
<p>Then it saves <code>p</code> and <code>i</code> to R data files, for quality control purposes, so you can easily reload those and repeat results.</p>
</div>
</div>
</div>
<section id="run-the-model" class="level3">
<h3 class="anchored" data-anchor-id="run-the-model">Run the model</h3>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-78-contents" aria-controls="callout-78" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-78" class="callout-78-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Add option to not run this section.</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb388"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb388-1"><a href="#cb388-1" aria-hidden="true" tabindex="-1"></a>run_computepf <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb388-2"><a href="#cb388-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb388-3"><a href="#cb388-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(run_computepf) {</span>
<span id="cb388-4"><a href="#cb388-4" aria-hidden="true" tabindex="-1"></a>  tick <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb388-5"><a href="#cb388-5" aria-hidden="true" tabindex="-1"></a>  pf <span class="ot">&lt;-</span> <span class="fu">f_pf_computePF</span>(</span>
<span id="cb388-6"><a href="#cb388-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">p           =</span> p,</span>
<span id="cb388-7"><a href="#cb388-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">struct      =</span> p<span class="sc">$</span>basic<span class="sc">$</span>structure,</span>
<span id="cb388-8"><a href="#cb388-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose     =</span> <span class="cn">FALSE</span>,</span>
<span id="cb388-9"><a href="#cb388-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">plots       =</span> <span class="cn">FALSE</span>,</span>
<span id="cb388-10"><a href="#cb388-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">just_pop    =</span> p<span class="sc">$</span>basic<span class="sc">$</span>pops_to_run,</span>
<span id="cb388-11"><a href="#cb388-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">just_nlines =</span> <span class="cn">NULL</span>,</span>
<span id="cb388-12"><a href="#cb388-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">just_seq    =</span> <span class="cn">NULL</span></span>
<span id="cb388-13"><a href="#cb388-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb388-14"><a href="#cb388-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">Sys.time</span>() <span class="sc">-</span> tick)</span>
<span id="cb388-15"><a href="#cb388-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb388-16"><a href="#cb388-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb388-17"><a href="#cb388-17" aria-hidden="true" tabindex="-1"></a>save_computepf <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb388-18"><a href="#cb388-18" aria-hidden="true" tabindex="-1"></a>computepf_file <span class="ot">=</span> <span class="fu">file.path</span>(path_data, <span class="st">"computepf_example.rds"</span>)</span>
<span id="cb388-19"><a href="#cb388-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb388-20"><a href="#cb388-20" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(save_computepf) {</span>
<span id="cb388-21"><a href="#cb388-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(pf, <span class="at">file=</span>computepf_file)</span>
<span id="cb388-22"><a href="#cb388-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb388-23"><a href="#cb388-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb388-24"><a href="#cb388-24" aria-hidden="true" tabindex="-1"></a>load_computepf <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb388-25"><a href="#cb388-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb388-26"><a href="#cb388-26" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(load_computepf) {</span>
<span id="cb388-27"><a href="#cb388-27" aria-hidden="true" tabindex="-1"></a>  pf <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(computepf_file)</span>
<span id="cb388-28"><a href="#cb388-28" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-79-contents" aria-controls="callout-79" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-79" class="callout-79-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>We find the patient flow using <code>f_pf_compute_PF()</code>. This function will use either:</p>
<ul>
<li><code>f_pf_computePF_mk()</code> (if state transition model, i.e.&nbsp;Markov model)</li>
<li><code>f_pf_computePF_ps()</code> (if partitioned survival model)</li>
</ul>
<p>The purpose of this is to model how patients move through different health states/treatments, from which we can find outputs like costs and utilities.</p>
<p><strong>State transition model</strong>. Steps include:</p>
<ul>
<li>Getting relevant population data and creating <code>sequence_list</code> with the allowed treatment sequences for a given population</li>
<li>Creating <code>util_gpop_mat</code> - a matrix of health state utility values that account for ageing</li>
<li>Transition probabilities (<code>TPs</code>) are calculated for each sequence, then used to construct Markov traces (<code>TRACE</code>) (ie. matrix of state vectors across all model cycles)</li>
<li>These are used to calculate costs through the treatment sequence (<code>pf_costs</code>) (e.g.&nbsp;cost per cycle <code>cpc</code>, costs on initiation <code>coi</code>, and costs on death <code>cod</code>), QALYs <code>pf_qalys</code>) and adverse events (<code>pf_ae</code>)</li>
</ul>
<p><strong>Partitioned survival model</strong>. Steps include:</p>
<ul>
<li>Getting relevant population data and creating the utility matrix <code>util_gpop_mat</code></li>
<li>Using <code>f_pf_partSA_state_res()</code>, simulates patient states (e.g.&nbsp;PFS) across time horizon for each treatment sequence, returns the costs (<code>costs</code>) and qalys (<code>qalys</code>)</li>
</ul>
</div>
</div>
</div>
</section>
<section id="compile-model-results" class="level3">
<h3 class="anchored" data-anchor-id="compile-model-results">Compile model results</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb389"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb389-1"><a href="#cb389-1" aria-hidden="true" tabindex="-1"></a>Scenario_number <span class="ot">&lt;-</span> i<span class="sc">$</span>R_Scenario_num</span>
<span id="cb389-2"><a href="#cb389-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb389-3"><a href="#cb389-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(Scenario_number <span class="sc">==</span> <span class="dv">0</span>) {detail_level <span class="ot">&lt;-</span> <span class="dv">5</span>} <span class="cf">else</span> {detail_level <span class="ot">&lt;-</span> <span class="dv">4</span>}</span>
<span id="cb389-4"><a href="#cb389-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb389-5"><a href="#cb389-5" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">f_res_compute_results</span>(</span>
<span id="cb389-6"><a href="#cb389-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">pf              =</span> pf,</span>
<span id="cb389-7"><a href="#cb389-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">structure       =</span> p<span class="sc">$</span>basic<span class="sc">$</span>structure,</span>
<span id="cb389-8"><a href="#cb389-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">p               =</span> p,</span>
<span id="cb389-9"><a href="#cb389-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">detail_level    =</span> detail_level,</span>
<span id="cb389-10"><a href="#cb389-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">vs_mol          =</span> <span class="dv">1</span>,</span>
<span id="cb389-11"><a href="#cb389-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">no_active_lines =</span> i<span class="sc">$</span>R_max_trt_lines</span>
<span id="cb389-12"><a href="#cb389-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-80-contents" aria-controls="callout-80" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-80" class="callout-80-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><code>f_res_compute_results()</code> processes the results using:</p>
<ul>
<li><code>f_res_compute_results_mk()</code> for the state transition model</li>
<li><code>f_res_compute_results_ps()</code> for the partitioned survival model</li>
</ul>
<p>These each in turn utilities various other functions to summarise the model results. There are various functions, depending on the level of detail desired in the plots. This is set to either 4 or 5, depending on whether it is scenario 0.</p>
<p>The summary functions include:</p>
<ul>
<li><code>f_pf_mk_summary()</code> to get <code>undisc</code> and <code>disc</code> results (undiscounted and discounted)</li>
<li><code>f_res_mk_incremental()</code> to get <code>incremental</code></li>
<li><code>f_res_wa_model()</code> to get <code>weighted_model</code> discounted or undiscounted, summarised using <code>f_res_sum_weighted_model()</code></li>
<li><code>f_pf_wa_sr_plots()</code> to get <code>weighted_trace_plots</code></li>
</ul>
<p>And more! As summarised in <code>Model_Structure.py</code>, the outcomes of this from each detail level are:</p>
<ol type="1">
<li>Top line results by sequence and weighted average results (costs, QALYs, LYs)</li>
<li>Include incremental analysis (from <code>f_res_mk_incremental()</code>)</li>
<li>Include weighted average pairwise comparisons</li>
<li>Include incremental analysis by sequence</li>
<li>Include trace plots</li>
</ol>
<p>Except for the partitioned survival, 4 is breakdown tables and 4 is state residency plots.</p>
<p>Some examples…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb390"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb390-1"><a href="#cb390-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(res<span class="sc">$</span>undisc<span class="sc">$</span>pop_1<span class="sc">$</span>ly<span class="sc">$</span>breakdown, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
<div class="sourceCode cell-code" id="cb391"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb391-1"><a href="#cb391-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(res<span class="sc">$</span>incremental<span class="sc">$</span>pop_1<span class="sc">$</span>expanded_results, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

</div>
<div class="sourceCode cell-code" id="cb392"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb392-1"><a href="#cb392-1" aria-hidden="true" tabindex="-1"></a>res<span class="sc">$</span>weighted_trace_plots<span class="sc">$</span>pop_1<span class="sc">$</span>plots<span class="sc">$</span>L1_1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="code_walkthrough_files/figure-html/unnamed-chunk-176-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb393"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb393-1"><a href="#cb393-1" aria-hidden="true" tabindex="-1"></a>res<span class="sc">$</span>wa_summarised<span class="sc">$</span>pop_1<span class="sc">$</span>costs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 268538.83  80398.95 100004.76  77049.92</code></pre>
</div>
<div class="sourceCode cell-code" id="cb395"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb395-1"><a href="#cb395-1" aria-hidden="true" tabindex="-1"></a>res<span class="sc">$</span>pairwise_vs_mol<span class="sc">$</span>pop_1<span class="sc">$</span>qalys</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.253814 1.712196 1.674692 1.684174</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb397"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb397-1"><a href="#cb397-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (p<span class="sc">$</span>basic<span class="sc">$</span>structure <span class="sc">==</span> <span class="st">"State transition"</span>) {</span>
<span id="cb397-2"><a href="#cb397-2" aria-hidden="true" tabindex="-1"></a>  population_numbers <span class="ot">&lt;-</span> <span class="cf">if</span>(<span class="fu">sum</span>(p<span class="sc">$</span>basic<span class="sc">$</span>pops_to_run <span class="sc">==</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)<span class="sc">&gt;</span><span class="dv">0</span>){<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>} <span class="cf">else</span>{<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>}</span>
<span id="cb397-3"><a href="#cb397-3" aria-hidden="true" tabindex="-1"></a>  res<span class="sc">$</span>mk<span class="sc">$</span>qaly_shortfall_1_to_3 <span class="ot">&lt;-</span> <span class="fu">lapply</span>(population_numbers, <span class="cf">function</span>(npa_pop) {</span>
<span id="cb397-4"><a href="#cb397-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb397-5"><a href="#cb397-5" aria-hidden="true" tabindex="-1"></a>  lu_pop <span class="ot">&lt;-</span> p<span class="sc">$</span>basic<span class="sc">$</span>lookup<span class="sc">$</span>pop_map</span>
<span id="cb397-6"><a href="#cb397-6" aria-hidden="true" tabindex="-1"></a>  lu_rpop <span class="ot">&lt;-</span> p<span class="sc">$</span>basic<span class="sc">$</span>lookup<span class="sc">$</span>ipd<span class="sc">$</span>pop</span>
<span id="cb397-7"><a href="#cb397-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb397-8"><a href="#cb397-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># npa_pop is overall population, we need to look up risk population from it:</span></span>
<span id="cb397-9"><a href="#cb397-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb397-10"><a href="#cb397-10" aria-hidden="true" tabindex="-1"></a>  risk_pop_n <span class="ot">&lt;-</span> lu_pop[<span class="fu">match</span>(npa_pop,lu_pop<span class="sc">$</span>Overall.population.number),]<span class="sc">$</span>Risk.population.number</span>
<span id="cb397-11"><a href="#cb397-11" aria-hidden="true" tabindex="-1"></a>  risk_pop <span class="ot">&lt;-</span> lu_rpop[<span class="fu">match</span>(risk_pop_n,lu_rpop<span class="sc">$</span>Number),]<span class="sc">$</span>Description  </span>
<span id="cb397-12"><a href="#cb397-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb397-13"><a href="#cb397-13" aria-hidden="true" tabindex="-1"></a>  i<span class="sc">$</span>R_table_ptchar <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(i<span class="sc">$</span>R_table_ptchar)</span>
<span id="cb397-14"><a href="#cb397-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb397-15"><a href="#cb397-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (i<span class="sc">$</span>dd_age_sex_source <span class="sc">==</span> <span class="st">"Mean"</span>) {</span>
<span id="cb397-16"><a href="#cb397-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb397-17"><a href="#cb397-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># So for this risk population, we need the baseline characteristics:</span></span>
<span id="cb397-18"><a href="#cb397-18" aria-hidden="true" tabindex="-1"></a>    bl_chars <span class="ot">&lt;-</span> i<span class="sc">$</span>R_table_ptchar[Population <span class="sc">==</span> risk_pop <span class="sc">&amp;</span> Treatment.line <span class="sc">==</span> <span class="dv">1</span>,]</span>
<span id="cb397-19"><a href="#cb397-19" aria-hidden="true" tabindex="-1"></a>    bl_age  <span class="ot">&lt;-</span> bl_chars<span class="sc">$</span>Starting.age..years..Mean</span>
<span id="cb397-20"><a href="#cb397-20" aria-hidden="true" tabindex="-1"></a>    bl_male <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span>bl_chars<span class="sc">$</span>Starting...female.Mean</span>
<span id="cb397-21"><a href="#cb397-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb397-22"><a href="#cb397-22" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb397-23"><a href="#cb397-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb397-24"><a href="#cb397-24" aria-hidden="true" tabindex="-1"></a>    patient_sex_age_IPD <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(i<span class="sc">$</span>R_table_patientagesex)</span>
<span id="cb397-25"><a href="#cb397-25" aria-hidden="true" tabindex="-1"></a>    patient_sex_age_IPD<span class="sc">$</span>Gender <span class="ot">&lt;-</span> <span class="fu">replace</span>(patient_sex_age_IPD<span class="sc">$</span>Gender, patient_sex_age_IPD<span class="sc">$</span>Gender<span class="sc">==</span><span class="st">"M"</span>,<span class="st">"male"</span>)</span>
<span id="cb397-26"><a href="#cb397-26" aria-hidden="true" tabindex="-1"></a>    patient_sex_age_IPD<span class="sc">$</span>Gender <span class="ot">&lt;-</span> <span class="fu">replace</span>(patient_sex_age_IPD<span class="sc">$</span>Gender, patient_sex_age_IPD<span class="sc">$</span>Gender<span class="sc">==</span><span class="st">"F"</span>,<span class="st">"female"</span>)</span>
<span id="cb397-27"><a href="#cb397-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb397-28"><a href="#cb397-28" aria-hidden="true" tabindex="-1"></a>    bl_age <span class="ot">&lt;-</span> patient_sex_age_IPD[Line <span class="sc">==</span><span class="dv">1</span>]<span class="sc">$</span>Age </span>
<span id="cb397-29"><a href="#cb397-29" aria-hidden="true" tabindex="-1"></a>    bl_male <span class="ot">&lt;-</span> patient_sex_age_IPD[Line <span class="sc">==</span><span class="dv">1</span>]<span class="sc">$</span>Gender</span>
<span id="cb397-30"><a href="#cb397-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb397-31"><a href="#cb397-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb397-32"><a href="#cb397-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb397-33"><a href="#cb397-33" aria-hidden="true" tabindex="-1"></a>  pna_txt <span class="ot">&lt;-</span> <span class="fu">names</span>(res<span class="sc">$</span>wa_summarised)[npa_pop]</span>
<span id="cb397-34"><a href="#cb397-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb397-35"><a href="#cb397-35" aria-hidden="true" tabindex="-1"></a>  tab <span class="ot">&lt;-</span> res<span class="sc">$</span>wa_summarised[[pna_txt]][L1 <span class="sc">!=</span> <span class="dv">1</span>,]</span>
<span id="cb397-36"><a href="#cb397-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb397-37"><a href="#cb397-37" aria-hidden="true" tabindex="-1"></a>  met <span class="ot">&lt;-</span> tab[<span class="fu">which.max</span>(qalys),]</span>
<span id="cb397-38"><a href="#cb397-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb397-39"><a href="#cb397-39" aria-hidden="true" tabindex="-1"></a>  q_met <span class="ot">&lt;-</span> met<span class="sc">$</span>qalys</span>
<span id="cb397-40"><a href="#cb397-40" aria-hidden="true" tabindex="-1"></a>  comp_no_met <span class="ot">&lt;-</span> met<span class="sc">$</span>L1</span>
<span id="cb397-41"><a href="#cb397-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb397-42"><a href="#cb397-42" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span>    <span class="fu">calc_severity_modifier</span>(</span>
<span id="cb397-43"><a href="#cb397-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">age =</span> bl_age,</span>
<span id="cb397-44"><a href="#cb397-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">sex =</span> bl_male,</span>
<span id="cb397-45"><a href="#cb397-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">.patient_level =</span> <span class="cf">if</span>(i<span class="sc">$</span>dd_age_sex_source <span class="sc">==</span> <span class="st">"Mean"</span>) {<span class="cn">FALSE</span>} <span class="cf">else</span> {<span class="cn">TRUE</span>},  </span>
<span id="cb397-46"><a href="#cb397-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">qalys =</span> q_met,</span>
<span id="cb397-47"><a href="#cb397-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">.i =</span> i,</span>
<span id="cb397-48"><a href="#cb397-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">.p =</span> p</span>
<span id="cb397-49"><a href="#cb397-49" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb397-50"><a href="#cb397-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb397-51"><a href="#cb397-51" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">cbind</span>(out, <span class="at">SOC =</span> comp_no_met)</span>
<span id="cb397-52"><a href="#cb397-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb397-53"><a href="#cb397-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(out)</span>
<span id="cb397-54"><a href="#cb397-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb397-55"><a href="#cb397-55" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb397-56"><a href="#cb397-56" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb397-57"><a href="#cb397-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-58"><a href="#cb397-58" aria-hidden="true" tabindex="-1"></a>Scenario_name <span class="ot">&lt;-</span> i<span class="sc">$</span>R_Scenario_name    <span class="co"># Use ST for state transition, PS for Partitioned survival, LP for list price, cPAS for cPAS</span></span>
<span id="cb397-59"><a href="#cb397-59" aria-hidden="true" tabindex="-1"></a>Scenario_number <span class="ot">&lt;-</span> i<span class="sc">$</span>R_Scenario_num</span>
<span id="cb397-60"><a href="#cb397-60" aria-hidden="true" tabindex="-1"></a>Run_date <span class="ot">&lt;-</span> <span class="fu">date</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-81-contents" aria-controls="callout-81" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-81" class="callout-81-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Applies a severity modifier for the weighted average 1L treatment comparison. This calculation is only provided for the state transition model. There is processing for this, then the modifier is calculated using <code>calc_severity_modifier()</code>, which in turn uses <code>get_severity_modifier()</code> to find the appropriate severity modifier according to the discounted QALYs for those with the condition and those without.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb398"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb398-1"><a href="#cb398-1" aria-hidden="true" tabindex="-1"></a>population_numbers</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1 2 3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb400"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb400-1"><a href="#cb400-1" aria-hidden="true" tabindex="-1"></a>res<span class="sc">$</span>mk<span class="sc">$</span>qaly_shortfall_1_to_3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
  qaly_soc qaly_gpop   abs_sf   prop_sf modifier SOC
1 1.712196  10.38197 8.669771 0.8350798        1   5

[[2]]
  qaly_soc qaly_gpop   abs_sf   prop_sf modifier SOC
1 2.243521  10.38197 8.138445 0.7839021        1   5

[[3]]
  qaly_soc qaly_gpop   abs_sf   prop_sf modifier SOC
1 2.013113  10.38197 8.368854 0.8060952        1   3</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-82-contents" aria-controls="callout-82" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-82" class="callout-82-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Changed paths</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb402"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb402-1"><a href="#cb402-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (p<span class="sc">$</span>basic<span class="sc">$</span>structure <span class="sc">==</span> <span class="st">"State transition"</span>) {</span>
<span id="cb402-2"><a href="#cb402-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(res, <span class="fu">paste0</span>(<span class="st">"../4_Output/ST_Scenario "</span>,Scenario_number,<span class="st">"_"</span>,i<span class="sc">$</span>dd_drug_price_options,<span class="fu">gsub</span>(<span class="st">":"</span>,<span class="st">"_"</span>,Run_date),<span class="st">".rds"</span>))</span>
<span id="cb402-3"><a href="#cb402-3" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb402-4"><a href="#cb402-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(res, <span class="fu">paste0</span>(<span class="st">"../4_Output/PartSA_Scenario "</span>,Scenario_number,<span class="st">"_"</span>,i<span class="sc">$</span>dd_drug_price_options,<span class="fu">gsub</span>(<span class="st">":"</span>,<span class="st">"_"</span>,Run_date),<span class="st">".rds"</span>))</span>
<span id="cb402-5"><a href="#cb402-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-83-contents" aria-controls="callout-83" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-83" class="callout-83-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Changed function to have <code>folder</code> input so it allows me to alter the output path</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb403"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb403-1"><a href="#cb403-1" aria-hidden="true" tabindex="-1"></a>Word_width_inches      <span class="ot">&lt;-</span>  <span class="fl">29.7</span><span class="sc">*</span><span class="fl">0.3937</span></span>
<span id="cb403-2"><a href="#cb403-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb403-3"><a href="#cb403-3" aria-hidden="true" tabindex="-1"></a><span class="fu">f_res_ProduceWordDoc</span>(</span>
<span id="cb403-4"><a href="#cb403-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">p                      =</span> p,</span>
<span id="cb403-5"><a href="#cb403-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">res                    =</span> res,</span>
<span id="cb403-6"><a href="#cb403-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">Scenario_name          =</span> i<span class="sc">$</span>R_Scenario_name,</span>
<span id="cb403-7"><a href="#cb403-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">Scenario_number        =</span> i<span class="sc">$</span>R_Scenario_num,</span>
<span id="cb403-8"><a href="#cb403-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">price_options          =</span> i<span class="sc">$</span>dd_drug_price_options,</span>
<span id="cb403-9"><a href="#cb403-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">Run_date               =</span> Run_date,</span>
<span id="cb403-10"><a href="#cb403-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">word_template_location =</span> <span class="st">"../3_Functions/reporting/empty results doc.docx"</span>,</span>
<span id="cb403-11"><a href="#cb403-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">Word_width_inches      =</span> <span class="fl">29.7</span><span class="sc">*</span><span class="fl">0.3937</span>,</span>
<span id="cb403-12"><a href="#cb403-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">auto_save              =</span> <span class="cn">TRUE</span>,</span>
<span id="cb403-13"><a href="#cb403-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">TRUE</span>,</span>
<span id="cb403-14"><a href="#cb403-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">folder =</span> path_output</span>
<span id="cb403-15"><a href="#cb403-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[0;32mWord output for Base case. (scen #0): [0m
[0;31mWord output for Base case. (scen #0): LY breakdown[0m
[0;33mWord output for Base case. (scen #0): QALY breakdown[0m
[0;34mWord output for Base case. (scen #0): Cost breakdown[0m
[0;35mWord output for Base case. (scen #0): Scenario tables[0m
[0;36mWord output for Base case. (scen #0): Severity modifier[0m
[0;37mWord output for Base case. (scen #0): Pairwise results[0m
[0;40mWord output for Base case. (scen #0): Generating word document from results...[0m
$L1_1</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$L1_5</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$L1_7</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$L1_6</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$L1_1</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$L1_5</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$L1_7</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$L1_6</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$L1_8</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$L1_1</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$L1_3</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$L1_2</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$L1_5</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$L1_7</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$L1_6</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Document automatically saved in location: ../4_Output/Scenario_0_PAS_price_Fri_Sep_13_11_39_07_2024.docx</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>NULL</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-84-contents" aria-controls="callout-84" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-84" class="callout-84-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Depending on <code>p$basic$structure</code>, will either use <code>f_res_ProduceWordDoc_ST</code> (st - state transition) or <code>f_res_ProduceWordDoc_PS</code> (ps - partitioned survival) to produce the report content.</p>
<p>In the default case, this is state transition.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb421"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb421-1"><a href="#cb421-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>basic<span class="sc">$</span>structure</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "State transition"</code></pre>
</div>
</div>
<p>This applies results tables specific to the cabo+nivo population to the word document, in the format required by NICE.</p>
</div>
</div>
</div>

</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body" data-entry-spacing="0" role="list">
<div id="ref-national_institute_for_health_and_care_excellence_nice_cabozantinib_2024" class="csl-entry" role="listitem">
<div class="csl-left-margin">[1] </div><div class="csl-right-inline">National Institute for Health and Care Excellence (NICE). <a href="https://www.nice.org.uk/guidance/ta964">Cabozantinib with nivolumab for untreated advanced renal cell carcinoma. <span>Technology</span> appraisal guidance [<span>TA964</span>]</a> 2024.</div>
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>